{% extends "base.html" %}

{% block title %}상품관리{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<!-- Bootstrap Select CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css" rel="stylesheet">
<!-- Custom CSS -->
<style>
th {
    cursor: pointer;
    user-select: none;
}
th:hover {
    background-color: #e9ecef;
}
.search-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}
.search-card .form-control {
    border-radius: 25px;
}
.table-card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}
.btn-excel {
    background: linear-gradient(45deg, #28a745, #20c997);
    border: none;
    color: white;
}
.product-status-active {
    color: #28a745;
    font-weight: bold;
}
.product-status-inactive {
    color: #dc3545;
    font-weight: bold;
}
.price-display {
    color: #0d6efd;
    font-weight: 600;
}
.company-badge-1 {
    background: linear-gradient(45deg, #667eea, #764ba2);
}
.company-badge-2 {
    background: linear-gradient(45deg, #f093fb, #f5576c);
}
.modal-header-add {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}
.modal-header-edit {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}
.required {
    color: #dc3545;
}
.file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
}
.file-upload-area:hover {
    border-color: #667eea;
    background: #e7f1ff;
}
.file-upload-area.dragover {
    border-color: #667eea;
    background: #e7f1ff;
    transform: scale(1.02);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-box me-2"></i>상품관리
            </h1>
            <p class="text-muted mb-0">상품 정보를 등록, 수정, 삭제할 수 있습니다</p>
        </div>
        <div>
            <span class="badge bg-primary fs-6" id="productCount">0</span>개 상품
        </div>
    </div>

    <!-- 검색 영역 -->
    <div class="card mb-4 search-card">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="searchInput" class="form-label">
                        <i class="fas fa-search me-1"></i>통합검색
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="상품명, 코드, 브랜드명..." onkeyup="searchProducts()">
                    </div>
                </div>
                <div class="col-md-2">
                    <label for="companyFilter" class="form-label">회사</label>
                    <select class="form-select" id="companyFilter" onchange="filterProducts()">
                        <option value="">전체</option>
                        <option value="1">에이원</option>
                        <option value="2">에이원월드</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="brandFilter" class="form-label">브랜드</label>
                    <select class="form-select" id="brandFilter" onchange="filterProducts()">
                        <option value="">전체</option>
                        {% for brand in brand_codes %}
                        <option value="{{ brand.seq }}">{{ brand.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="categoryFilter" class="form-label">품목</label>
                    <select class="form-select" id="categoryFilter" onchange="filterProducts()">
                        <option value="">전체</option>
                        {% for category in category_codes %}
                        <option value="{{ category.seq }}">{{ category.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="statusFilter" class="form-label">상태</label>
                    <select class="form-select" id="statusFilter" onchange="filterProducts()">
                        <option value="">전체</option>
                        <option value="true">활성</option>
                        <option value="false">비활성</option>
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-light w-100" onclick="resetFilters()">
                        <i class="fas fa-refresh"></i>
                    </button>
                </div>
            </div>
            
            <!-- 확장 필터 (두 번째 줄) -->
            <div class="row g-3 mt-2">
                <div class="col-md-2">
                    <label for="typeFilter" class="form-label">타입</label>
                    <select class="form-select" id="typeFilter" onchange="filterProducts()">
                        <option value="">전체</option>
                        {% for type in type_codes %}
                        <option value="{{ type.seq }}">{{ type.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="yearFilter" class="form-label">년도</label>
                    <select class="form-select" id="yearFilter" onchange="filterProducts()">
                        <option value="">전체</option>
                        {% for year in year_codes %}
                        <option value="{{ year.seq }}">{{ year.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="colorFilter" class="form-label">색상</label>
                    <select class="form-select" id="colorFilter" onchange="filterProducts()">
                        <option value="">전체</option>
                        {% for color in color_codes %}
                        <option value="{{ color.seq }}">{{ color.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="divTypeFilter" class="form-label">구분타입</label>
                    <select class="form-select" id="divTypeFilter" onchange="filterProducts()">
                        <option value="">전체</option>
                        {% for div_type in div_type_codes %}
                        <option value="{{ div_type.seq }}">{{ div_type.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="productCodeFilter" class="form-label">제품코드</label>
                    <select class="form-select" id="productCodeFilter" onchange="filterProducts()">
                        <option value="">전체</option>
                        {% for prod_code in product_codes %}
                        <option value="{{ prod_code.seq }}">{{ prod_code.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="stdCodeFilter" class="form-label">자가코드</label>
                    <input type="text" class="form-control" id="stdCodeFilter" 
                           placeholder="자가코드 검색..." onkeyup="filterProducts()">
                </div>
            </div>
        </div>
    </div>

    <!-- 액션 버튼 영역 -->
    <div class="row mb-3">
        <div class="col-md-8">
            <button type="button" class="btn btn-primary me-2" onclick="openAddModal()">
                <i class="fas fa-plus me-1"></i>상품 등록
            </button>
            <button type="button" class="btn btn-success me-2" onclick="openExcelUploadModal()">
                <i class="fas fa-upload me-1"></i>엑셀 업로드
            </button>
            <button type="button" class="btn btn-excel me-2" onclick="downloadExcel()">
                <i class="fas fa-download me-1"></i>엑셀 다운로드
            </button>
            <button type="button" class="btn btn-info" onclick="syncWithErpia()">
                <i class="fas fa-sync-alt me-1"></i>ERPia 동기화
            </button>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="viewMode" id="gridView" autocomplete="off" checked>
                <label class="btn btn-outline-secondary" for="gridView">
                    <i class="fas fa-table me-1"></i>테이블
                </label>
                <input type="radio" class="btn-check" name="viewMode" id="cardView" autocomplete="off">
                <label class="btn btn-outline-secondary" for="cardView">
                    <i class="fas fa-th-large me-1"></i>카드
                </label>
            </div>
        </div>
    </div>

    <!-- 테이블 영역 -->
    <div class="card table-card" id="tableView">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>상품 목록
                <span class="badge bg-secondary ms-2" id="tableCount">0</span>
            </h5>
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-primary" onclick="sortProducts('name')">
                    <i class="fas fa-sort-alpha-down me-1"></i>이름순
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="sortProducts('created')">
                    <i class="fas fa-sort-numeric-down me-1"></i>등록순
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="sortProducts('price')">
                    <i class="fas fa-sort-amount-down me-1"></i>가격순
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" id="productTable">
                    <thead class="table-light">
                        <tr>
                            <th onclick="sortTable(0)" style="width: 80px;">
                                번호 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(1)" style="width: 120px;">
                                회사 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(2)" style="width: 150px;">
                                브랜드 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(3)">
                                상품명 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(4)" style="width: 100px;">
                                품목 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(5)" style="width: 100px;">
                                타입 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(6)" style="width: 100px;">
                                년도 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(7)" style="width: 120px;">
                                상품가격(Tag) <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(8)" style="width: 80px;">
                                상태 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(9)" style="width: 120px;">
                                등록일 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th style="width: 120px;">액션</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <!-- 동적으로 로드됨 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 카드 영역 (초기에는 숨김) -->
    <div class="row" id="cardView" style="display: none;">
        <div id="productCards">
            <!-- 동적으로 로드됨 -->
        </div>
    </div>

    <!-- 페이징 컨트롤 (새로 추가) -->
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="상품 페이지네이션">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted" id="pageInfo">
                            총 <span id="totalProducts">0</span>개 상품 (페이지 <span id="currentPageNum">1</span> / <span id="totalPages">1</span>)
                        </small>
                    </div>
                    <ul class="pagination pagination-sm mb-0" id="pagination">
                        <!-- 동적으로 생성됨 -->
                    </ul>
                    <div>
                        <select class="form-select form-select-sm" id="perPageSelect" style="width: auto;">
                            <option value="10">10개씩</option>
                            <option value="25">25개씩</option>
                            <option value="50" selected>50개씩</option>
                            <option value="100">100개씩</option>
                        </select>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- 로딩 인디케이터 -->
    <div class="text-center my-5" id="loadingIndicator" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">상품 정보를 불러오는 중...</p>
    </div>
</div>

<!-- 상품 등록/수정 모달 -->
<div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">상품 등록</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="productForm" enctype="multipart/form-data">
                <input type="hidden" id="productId" name="productId">
                <input type="hidden" id="isEditMode" value="false">
                
                <div class="modal-body">
                    <div class="container-fluid">
                        
                        <!-- 1단계: 기본 상품 정보 (레거시 호환) -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="company_id" class="form-label">회사 <span class="required">*</span></label>
                                    <select class="form-control" id="company_id" name="company_id" required>
                                        <option value="">선택하세요</option>
                                        <option value="1">에이원</option>
                                        <option value="2">에이원 월드</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                    <label for="brand_code_seq" class="form-label">브랜드 <span class="required">*</span></label>
                                    <select class="form-select" id="brand_code_seq" name="brand_code_seq" required>
                                        <option value="">선택하세요</option>
                                        {% for brand in brand_codes %}
                                        <option value="{{ brand.seq }}">{{ brand.code_name }}</option>
                                        {% endfor %}
                                </select>
                            </div>
                        </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-2">
                                <label for="prod_group_code_seq" class="form-label">제품구분 <span class="required">*</span></label>
                                <select class="form-select" id="prod_group_code_seq" name="prod_group_code_seq" required>
                                    <option value="">선택하세요</option>
                                    {% for category in category_codes %}
                                    <option value="{{ category.seq }}">{{ category.code_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-2">
                                <label for="prod_code_seq" class="form-label">품목 <span class="required">*</span></label>
                                <select class="form-select" id="prod_code_seq" name="prod_code_seq" required>
                                    <option value="">선택하세요</option>
                                    {% for product in product_codes %}
                                    <option value="{{ product.seq }}">{{ product.code_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-2">
                                <label for="prod_type_code_seq" class="form-label">타입 <span class="required">*</span></label>
                                <select class="form-select" id="prod_type_code_seq" name="prod_type_code_seq" required>
                                    <option value="">선택하세요</option>
                                    <!-- 품목 선택 시 동적으로 로드됨 -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product_name" class="form-label">상품명 <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="product_name" name="product_name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="year_code_seq" class="form-label">년식 <span class="required">*</span></label>
                                    <select class="form-control" id="year_code_seq" name="year_code_seq" required>
                                        <option value="">선택하세요</option>
                                    {% for year in year_codes %}
                                        <option value="{{ year.seq }}" data-code="{{ year.code }}">{{ year.code_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="price" class="form-label">상품가격(Tag) <span class="required">*</span></label>
                                    <input type="number" class="form-control" id="price" name="price" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                    <label for="use_yn" class="form-label">사용여부 <span class="required">*</span></label>
                                    <select class="form-control" id="use_yn" name="use_yn" required>
                                        <option value="Y">사용</option>
                                        <option value="N">미사용</option>
                                </select>
                            </div>
                        </div>
                        </div>
                        
                        <!-- 히든 필드: 구분타입 "일반"으로 고정 -->
                        <input type="hidden" id="div_type_code_seq" name="div_type_code_seq" value="">
                        
                        <!-- 구분선 -->
                        <hr class="my-4">
                        
                        <!-- 2단계: 제품 모델 등록 -->
                        <div class="bg-primary text-white p-2 mb-3">
                            <h6 class="mb-0"><i class="fas fa-cubes me-2"></i>제품 모델 등록</h6>
                        </div>
                        
                        <!-- 기존 제품모델 목록 표시 (수정 모드에서만) -->
                        <div id="existingProductModels" style="display: none;">
                            <div class="mb-3">
                                <h6 class="text-secondary"><i class="fas fa-list me-2"></i>기존 제품 모델 목록</h6>
                                <div id="productModelsList" class="border rounded p-3 bg-light">
                                    <!-- 동적으로 로드됨 -->
                                </div>
                            </div>
                        </div>
                        
                        <div id="productModelsContainer">
                            <div class="product-model-item border p-3 mb-3" data-index="0">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">색상 <span class="required">*</span></label>
                                            <select class="form-control color-code" name="color_code[]" required>
                                                <option value="">선택하세요</option>
                                                {% for color in color_codes %}
                                                <option value="{{ color.code }}" data-seq="{{ color.seq }}">{{ color.code_name }} ({{ color.code }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">제품명</label>
                                            <input type="text" class="form-control product-model-name" name="product_model_name[]" placeholder="색상별 제품명 (선택사항)">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">자사코드</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control std-product-code" name="std_product_code[]" placeholder="자동생성됨" readonly>
                                                <button type="button" class="btn btn-primary btn-generate-code">자동생성</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-10"></div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-outline-danger btn-sm btn-remove-model w-100">
                                            <i class="fas fa-times me-1"></i>제거
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 추가 정보 (선택사항) -->
                        <hr class="my-4">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="description" class="form-label">설명</label>
                                    <textarea class="form-control" id="description" name="description" rows="3" placeholder="상품에 대한 설명을 입력하세요..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>닫기
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveProductBtn">
                        <i class="fas fa-save me-1"></i>저장
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 상품 상세보기 모달 -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>상품 상세정보
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productDetailContent">
                <!-- 동적으로 로드됨 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="editProductFromDetail()">
                    <i class="fas fa-edit me-1"></i>수정
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>닫기
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 엑셀 업로드 모달 -->
<div class="modal fade" id="excelUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>엑셀 일괄 업로드
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="excelFile" class="form-label">엑셀 파일 선택</label>
                    <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls">
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        .xlsx 또는 .xls 파일만 업로드 가능합니다
                    </div>
                </div>
                <div class="mb-3">
                    <a href="/product/api/download-template" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download me-1"></i>업로드 템플릿 다운로드
                    </a>
                </div>
                <div id="uploadProgress" style="display: none;">
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-center">업로드 중...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-success" onclick="uploadExcel()">
                    <i class="fas fa-upload me-1"></i>업로드
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<!-- Bootstrap Select JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/i18n/defaults-ko_KR.min.js"></script>

<script>
// 전역 변수
let products = [];
let filteredProducts = [];
let currentProductId = null;

// 페이징 변수 (새로 추가)
let currentPage = 1;
let perPage = 50;
let totalProducts = 0;
let totalPages = 1;
let isLoading = false;

// 정렬 변수 (새로 추가)
let currentSort = {
    column: 'created_at',
    direction: 'desc'
};

$(document).ready(function() {
    console.log('상품 관리 시스템 초기화');
    loadProducts();
    setupEventHandlers();
    initializeDivType();
});

// 구분타입을 "일반"으로 기본 설정
function initializeDivType() {
    // 구분타입 코드 중에서 "일반"에 해당하는 값을 찾아서 설정
    const divTypeSelect = document.getElementById('div_type_code_seq');
    // 구분타입은 일반적으로 첫 번째 값 또는 "1"로 설정
    const divTypeOptions = $('#div_type_code_seq option');
    if (divTypeOptions.length > 1) {
        divTypeSelect.value = divTypeOptions.eq(1).val(); // 첫 번째 옵션은 공백이므로 두 번째 선택
    }
}

// 이벤트 핸들러 설정
function setupEventHandlers() {
    // 자가코드 자동생성 버튼
    $(document).on('click', '.btn-generate-code', function() {
        generateProductCode(this);
    });

    // 제품모델 추가 버튼
    $(document).on('click', '.btn-add-model', function() {
        addProductModelRow();
    });

    // 제품모델 삭제 버튼
    $(document).on('click', '.btn-remove-model', function() {
        removeProductModelRow(this);
    });

    // 폼 제출
    $('#productForm').on('submit', function(e) {
        e.preventDefault();
        saveProduct();
    });
    
    // 품목 변경 시 타입 필터링 (새로운 구조)
    $('#prod_code_seq').on('change', function() {
        updateTypesForProduct(this.value);
    });
    
    // 제품구분 변경 시 타입 필터링 (기존 호환)
    $('#prod_group_code_seq').on('change', function() {
        updateTypesForCategory(this.value);
    });
    
    // 제품코드 변경 시 타입2 필터링 (새로 추가)
    $(document).on('change', '.product-code', function() {
        updateType2ForProductCode(this);
    });
    
    // 모달 이벤트 핸들러 개선 (aria-hidden 문제 완전 해결)
    $('#productModal').on('show.bs.modal', function(e) {
        console.log('모달 열림 이벤트');
        $(this).removeAttr('aria-hidden');
        // 포커스가 있는 요소에서 포커스 제거
        if (document.activeElement && document.activeElement.blur) {
            document.activeElement.blur();
        }
    });
    
    $('#productModal').on('shown.bs.modal', function(e) {
        console.log('모달 완전히 열림');
        // 첫 번째 입력 필드에 포커스 설정
        const firstInput = $(this).find('input, select').filter(':visible').first();
        if (firstInput.length) {
            setTimeout(() => firstInput.focus(), 100);
        }
    });
    
    $('#productModal').on('hide.bs.modal', function(e) {
        console.log('모달 닫힘 시작');
        // 모든 포커스 제거
        $(this).find('*').blur();
    });
    
    $('#productModal').on('hidden.bs.modal', function(e) {
        console.log('모달 완전히 닫힘');
        $(this).attr('aria-hidden', 'true');
    });
    
    // 통합 검색 개선 (코드 기준)
    $('#searchInput').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        if (searchTerm.length >= 2 || searchTerm.length === 0) {
            searchProducts();
        }
    });
    
    // 필터 변경 시 검색 실행 (무한 렌더링 방지)
    $('.form-select').on('change', function() {
        if (!isLoading) {
            filterProducts();
        }
    });
}

// 제품코드에 따른 타입2 업데이트 (새로 추가)
function updateType2ForProductCode(productCodeSelect) {
    const modelItem = $(productCodeSelect).closest('.product-model-item');
    const type2Select = modelItem.find('.prod-type2');
    const selectedProductCode = $(productCodeSelect).val();
    
    // 타입2 선택창 초기화
    type2Select.empty().append('<option value="">타입 선택</option>');
    
    if (!selectedProductCode) {
        return;
    }
    
    // API로 해당 제품코드의 타입2들 가져오기
    fetch(`/product/api/get-types-by-product-code/${selectedProductCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.types) {
                data.types.forEach(type => {
                    type2Select.append(`
                        <option value="${type.code}" data-code="${type.code}">
                            ${type.code_name} (${type.code})
                        </option>
                    `);
                });
            }
        })
        .catch(error => {
            console.error('타입2 로드 실패:', error);
        });
}

// 품목에 따른 타입 업데이트
function updateTypesForCategory(categorySeq) {
    const typeSelect = document.getElementById('prod_type_code_seq');
    
    // 초기화
    typeSelect.innerHTML = '<option value="">선택하세요</option>';
    
    if (!categorySeq) {
        return Promise.resolve();
    }
    
    return fetch(`/product/api/get-types-by-category/${categorySeq}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.types) {
                data.types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.seq;
                    option.textContent = type.code_name;
                    typeSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('타입 로드 오류:', error);
        });
}

// 자사코드 자동 생성
function generateProductCode(buttonElement) {
    const container = $(buttonElement).closest('.product-model-item');
    
    // 상품 기본 정보에서 코드값들 가져오기
    const brandSelect = document.getElementById('brand_code_seq');
    const prodGroupSelect = document.getElementById('prod_group_code_seq'); // 제품구분
    const prodCodeSelect = document.getElementById('prod_code_seq'); // 품목
    const prodTypeSelect = document.getElementById('prod_type_code_seq'); // 타입
    const yearSelect = document.getElementById('year_code_seq');
    const divTypeSelect = document.getElementById('div_type_code_seq');
    
    // 제품모델 개별 정보
    const colorSelect = container.find('.color-code')[0];
    
    // 필수 값들 확인
    if (!brandSelect.value || !prodGroupSelect.value || !prodCodeSelect.value || 
        !prodTypeSelect.value || !yearSelect.value || !colorSelect.value) {
        alert('자사코드 생성을 위해 브랜드, 제품구분, 품목, 타입, 년식, 색상을 모두 선택해주세요.');
        return;
    }
    
    // 선택된 옵션에서 code 값 추출
    const brandCode = brandSelect.value;  // SEQ 값을 그대로 전달
    const prodGroupCode = prodGroupSelect.value;  // SEQ 값을 그대로 전달
    const prodCode = prodCodeSelect.value;  // SEQ 값을 그대로 전달
    const prodTypeCode = prodTypeSelect.value;  // SEQ 값을 그대로 전달
    const yearCode = yearSelect.value;  // SEQ 값을 그대로 전달
    const divTypeCode = divTypeSelect ? divTypeSelect.value : '3';  // 기본값
    const colorCode = $(colorSelect).find('option:selected').val();
    
    // 자사코드 생성 API 호출
    const formData = new FormData();
    formData.append('brand_code', brandCode);
    formData.append('div_type_code', divTypeCode);
    formData.append('prod_group_code', prodGroupCode);
    formData.append('prod_type_code', prodTypeCode);
    formData.append('prod_code', prodCode);
    formData.append('prod_type2_code', '00'); // 기본값
    formData.append('year_code', yearCode);
    formData.append('color_code', colorCode);
    
    fetch('/product/api/generate-std-code', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            container.find('.std-product-code').val(data.std_code);
            console.log('자사코드 생성 성공:', data.std_code);
        } else {
            alert('자사코드 생성 실패: ' + (data.message || '알 수 없는 오류'));
        }
    })
    .catch(error => {
        console.error('자사코드 생성 오류:', error);
        alert('자사코드 생성 중 오류가 발생했습니다.');
    });
}

// 색상 선택 시 자동으로 자사코드 생성
$(document).on('change', '.color-code', function() {
    const container = $(this).closest('.product-model-item');
    const generateButton = container.find('.btn-generate-code')[0];
    
    if (this.value && generateButton) {
        // 약간의 지연 후 자동생성 (다른 필드들이 선택될 시간을 줌)
        setTimeout(() => {
            generateProductCode(generateButton);
        }, 100);
    }
});

// 제품모델 행 추가
function addProductModelRow() {
    const container = $('#productModelsContainer');
    const currentCount = container.find('.product-model-item').length;
    const newIndex = currentCount;
    
    const newRow = `
        <div class="product-model-item border p-3 mb-3" data-index="${newIndex}">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">색상 <span class="required">*</span></label>
                        <select class="form-control color-code" name="color_code[]" required>
                            <option value="">선택하세요</option>
                            {% for color in color_codes %}
                            <option value="{{ color.code }}" data-seq="{{ color.seq }}">{{ color.code_name }} ({{ color.code }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">제품명</label>
                        <input type="text" class="form-control product-model-name" name="product_model_name[]" placeholder="색상별 제품명 (선택사항)">
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">자사코드</label>
                        <div class="input-group">
                            <input type="text" class="form-control std-product-code" name="std_product_code[]" placeholder="자동생성됨" readonly>
                            <button type="button" class="btn btn-primary btn-generate-code">자동생성</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-10"></div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm btn-remove-model w-100">
                        <i class="fas fa-times me-1"></i>제거
                    </button>
                </div>
            </div>
        </div>
    `;
    
    container.append(newRow);
}

// 제품모델 행 삭제
function removeProductModelRow(button) {
    const modelItem = $(button).closest('.product-model-item');
    const container = $('#productModelsContainer');
    
    if (container.find('.product-model-item').length <= 1) {
        alert('첫 행은 지울 수 없습니다.');
        return false;
    }
    
    if (confirm('해당 행을 삭제하시겠습니까?')) {
        modelItem.remove();
    }
}

// 상품 저장
function saveProduct() {
    const formData = new FormData();
    const isEdit = document.getElementById('isEditMode').value === 'true';
    
    // 기본 상품 정보
    formData.append('company_id', document.getElementById('company_id').value);
    formData.append('brand_code_seq', document.getElementById('brand_code_seq').value);
    formData.append('prod_group_code_seq', document.getElementById('prod_group_code_seq').value);
    formData.append('prod_type_code_seq', document.getElementById('prod_type_code_seq').value);
    formData.append('product_name', document.getElementById('product_name').value);
    formData.append('year_code_seq', document.getElementById('year_code_seq').value);
    formData.append('price', document.getElementById('price').value);
    formData.append('use_yn', document.getElementById('use_yn').value);
    formData.append('div_type_code_seq', document.getElementById('div_type_code_seq').value);
    formData.append('description', document.getElementById('description').value);

    // 제품모델 정보 수집
    const productModels = [];
    $('.product-model-item').each(function(index) {
        const modelName = $(this).find('.product-model-name').val();
        const productCode = $(this).find('.product-code').val();
        const prodType2 = $(this).find('.prod-type2').val();
        const productColor = $(this).find('.product-color').val();
        const stdProductCode = $(this).find('.std-product-code').val();
        
        if (modelName && productCode && prodType2 && productColor && stdProductCode) {
            productModels.push({
                name: modelName,
                product_code: productCode,
                prod_type2: prodType2,
                color: productColor,
                std_code: stdProductCode
            });
        }
    });

    if (productModels.length === 0) {
        alert('최소 하나의 제품모델을 등록해야 합니다.');
        return;
    }

    formData.append('product_models', JSON.stringify(productModels));

    const url = isEdit ? `/product/api/update/${document.getElementById('productId').value}` : '/product/api/create';
    const method = isEdit ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            $('#productModal').modal('hide');
            loadProducts();
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('저장 중 오류가 발생했습니다.', 'error');
    });
}

// 정렬 기능
function sortProducts(column) {
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
    }
    
    updateSortIcons();
    loadProducts();
}

// 정렬 아이콘 업데이트
function updateSortIcons() {
    $('.sort-header').removeClass('asc desc');
    $(`.sort-header[data-column="${currentSort.column}"]`).addClass(currentSort.direction);
}

// 상품 목록 로드 (페이징 지원 + 중복 호출 방지)
function loadProducts(page = 1) {
    if (isLoading) return;
    
    isLoading = true;
    showLoading(true);
    
    // 검색 파라미터 수집
    const searchTerm = document.getElementById('searchInput').value || '';
    const brandCodeSeq = document.getElementById('brandFilter').value || '';
    const categoryCodeSeq = document.getElementById('categoryFilter').value || '';
    const typeCodeSeq = document.getElementById('typeFilter').value || '';
    
    // API 요청 URL 구성
    const params = new URLSearchParams({
        page: page,
        per_page: perPage,
        sort_by: currentSort.column,        // 정렬 컬럼 추가
        sort_direction: currentSort.direction  // 정렬 방향 추가
    });
    
    if (searchTerm) params.append('search', searchTerm);
    if (brandCodeSeq) params.append('brand_code_seq', brandCodeSeq);
    if (categoryCodeSeq) params.append('category_code_seq', categoryCodeSeq);
    if (typeCodeSeq) params.append('type_code_seq', typeCodeSeq);
    
    fetch(`/product/api/list?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                products = data.products || [];
                filteredProducts = [...products]; // filteredProducts를 products와 동일하게 설정
                
                // 페이징 정보 업데이트
                if (data.pagination) {
                    currentPage = data.pagination.page;
                    perPage = data.pagination.per_page;
                    totalProducts = data.pagination.total;
                    totalPages = data.pagination.pages;
                }
                
                renderProducts();
                renderPagination();
                updatePageInfo();
                updateCounters(); // 카운터 업데이트 추가
                updateSortIcons();  // 정렬 아이콘 업데이트 추가
            } else {
                console.error('API 오류:', data.message);
                showAlert('상품 목록을 불러오는데 실패했습니다: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('서버 오류가 발생했습니다', 'error');
        })
        .finally(() => {
            isLoading = false;
            showLoading(false);
        });
}

// 상품 렌더링
function renderProducts() {
    const viewMode = document.querySelector('input[name="viewMode"]:checked').id;
    
    if (viewMode === 'gridView') {
        renderTableView();
    } else {
        renderCardView();
    }
}

// 테이블 뷰 렌더링
function renderTableView() {
    const tbody = document.getElementById('productTableBody');
    tbody.innerHTML = '';
    
    console.log('렌더링할 상품 수:', filteredProducts.length); // 디버그 로그 추가
    
    if (!filteredProducts || filteredProducts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="text-center py-4">
                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-0">등록된 상품이 없습니다</p>
                </td>
            </tr>
        `;
        return;
    }
    
    filteredProducts.forEach((product, index) => {
        const row = `
            <tr onclick="editProduct(${product.id})" style="cursor: pointer;">
                <td>${(currentPage - 1) * perPage + index + 1}</td>
                <td>
                    <span class="badge company-badge-${product.company_id}">
                        ${product.company_id === 1 ? '에이원' : '에이원월드'}
                    </span>
                </td>
                <td>${product.brand_name || '미지정'}</td>
                <td>
                    <strong>${product.product_name}</strong>
                    ${product.product_code ? `<br><small class="text-muted">${product.product_code}</small>` : ''}
                </td>
                <td>${product.category_name || '-'}</td>
                <td>${product.type_name || '-'}</td>
                <td>${product.year_code_name || '-'}</td>
                <td class="price-display">
                    ${product.price ? formatPrice(product.price) + '원' : '-'}
                </td>
                <td>
                    <span class="product-status-${product.is_active ? 'active' : 'inactive'}">
                        ${product.is_active ? '활성' : '비활성'}
                    </span>
                </td>
                <td>${formatDate(product.created_at)}</td>
                <td onclick="event.stopPropagation();">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="editProduct(${product.id})" title="수정">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showProductDetail(${product.id})" title="상세보기">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteProduct(${product.id})" title="삭제">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// 카드 뷰 렌더링
function renderCardView() {
    const container = document.getElementById('productCards');
    container.innerHTML = '';
    
    if (filteredProducts.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">등록된 상품이 없습니다</h5>
            </div>
        `;
        return;
    }
    
    filteredProducts.forEach(product => {
        const card = `
            <div class="col-md-4 col-lg-3 mb-4">
                <div class="card h-100 shadow-sm" onclick="showProductDetail(${product.id})" style="cursor: pointer;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="badge company-badge-${product.company_id}">
                            ${product.company_id === 1 ? '에이원' : '에이원월드'}
                        </span>
                        <span class="product-status-${product.is_active ? 'active' : 'inactive'}">
                            ${product.is_active ? '활성' : '비활성'}
                        </span>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">${product.product_name}</h6>
                        <p class="card-text">
                            <small class="text-muted">브랜드: ${product.brand_name || '미지정'}</small><br>
                            <small class="text-muted">품목: ${product.category_name || '-'}</small><br>
                            <small class="text-muted">타입: ${product.type_name || '-'}</small><br>
                            <small class="text-muted">년도: ${product.year_code_name || '-'}</small><br>
                            <span class="price-display">
                                ${product.price ? formatPrice(product.price) + '원' : '가격 미정'}
                            </span>
                        </p>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="btn-group w-100" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); editProduct(${product.id})">
                                <i class="fas fa-edit"></i> 수정
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteProduct(${product.id})">
                                <i class="fas fa-trash"></i> 삭제
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += card;
    });
}

// 검색 함수 (코드 기준으로 개선)
function searchProducts() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    if (!search) {
        loadProducts(1); // 검색어가 없으면 전체 목록 로드
        return;
    }
    
    // API에 검색 요청
    const params = new URLSearchParams({
        page: 1,
        per_page: perPage,
        search: search,
        sort_by: currentSort.column,
        sort_direction: currentSort.direction
    });
    
    // 현재 필터값들도 포함
    const brandFilter = document.getElementById('brandFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    if (brandFilter) params.append('brand_code_seq', brandFilter);
    if (categoryFilter) params.append('category_code_seq', categoryFilter);
    if (statusFilter) params.append('status', statusFilter);
    
    if (isLoading) return;
    
    isLoading = true;
    showLoading(true);
    
    fetch(`/product/api/list?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                products = data.products || [];
                filteredProducts = [...products];
                
                // 페이징 정보 업데이트
                if (data.pagination) {
                    currentPage = data.pagination.page;
                    perPage = data.pagination.per_page;
                    totalProducts = data.pagination.total;
                    totalPages = data.pagination.pages;
                }
                
                renderProducts();
                renderPagination();
                updatePageInfo();
                updateCounters();
            } else {
                console.error('검색 오류:', data.message);
                showAlert('검색에 실패했습니다: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('검색 오류:', error);
            showAlert('검색 중 오류가 발생했습니다', 'error');
        })
        .finally(() => {
            isLoading = false;
            showLoading(false);
        });
}

// 필터 적용
function filterProducts() {
    const companyFilter = document.getElementById('companyFilter').value;
    const brandFilter = document.getElementById('brandFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    // 확장 필터 (새로 추가)
    const typeFilter = document.getElementById('typeFilter').value;
    const yearFilter = document.getElementById('yearFilter').value;
    const colorFilter = document.getElementById('colorFilter').value;
    const divTypeFilter = document.getElementById('divTypeFilter').value;
    const productCodeFilter = document.getElementById('productCodeFilter').value;
    const stdCodeFilter = document.getElementById('stdCodeFilter').value.toLowerCase();
    
    filteredProducts = products.filter(product => {
        if (companyFilter && product.company_id.toString() !== companyFilter) return false;
        if (brandFilter && product.brand_code_seq && product.brand_code_seq.toString() !== brandFilter) return false;
        if (categoryFilter && product.category_code_seq && product.category_code_seq.toString() !== categoryFilter) return false;
        if (statusFilter && product.is_active.toString() !== statusFilter) return false;
        
        // 확장 필터 검사 (새로 추가)
        if (typeFilter && product.type_code_seq && product.type_code_seq.toString() !== typeFilter) return false;
        if (yearFilter && product.year_code_seq && product.year_code_seq.toString() !== yearFilter) return false;
        if (colorFilter && product.color_code_seq && product.color_code_seq.toString() !== colorFilter) return false;
        if (divTypeFilter && product.div_type_code_seq && product.div_type_code_seq.toString() !== divTypeFilter) return false;
        if (productCodeFilter && product.product_code_seq && product.product_code_seq.toString() !== productCodeFilter) return false;
        if (stdCodeFilter && product.std_product_code && !product.std_product_code.toLowerCase().includes(stdCodeFilter)) return false;
        
        // 검색어도 함께 적용
        const search = document.getElementById('searchInput').value.toLowerCase();
        if (search) {
            return Object.values(product).some(value => {
                if (value === null || value === undefined) return false;
                return value.toString().toLowerCase().includes(search);
            });
        }
        
        return true;
    });
    
    renderProducts();
    updateCounters();
}

// 필터 초기화
function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('companyFilter').value = '';
    document.getElementById('brandFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('statusFilter').value = '';
    
    // 확장 필터 초기화 (새로 추가)
    document.getElementById('typeFilter').value = '';
    document.getElementById('yearFilter').value = '';
    document.getElementById('colorFilter').value = '';
    document.getElementById('divTypeFilter').value = '';
    document.getElementById('productCodeFilter').value = '';
    document.getElementById('stdCodeFilter').value = '';
    
    filteredProducts = [...products];
    renderProducts();
    updateCounters();
}

// 테이블 정렬
function sortTable(columnIndex) {
    const columns = ['id', 'company_id', 'brand_name', 'product_name', 'product_code', 
                    'category_name', 'type_name', 'price', 'is_active', 'created_at'];
    const column = columns[columnIndex];
    
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
    }
    
    filteredProducts.sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];
        
        // null 값 처리
        if (aVal === null || aVal === undefined) aVal = '';
        if (bVal === null || bVal === undefined) bVal = '';
        
        // 숫자형 컬럼 처리
        if (['id', 'company_id', 'price'].includes(column)) {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
        } else {
            aVal = aVal.toString().toLowerCase();
            bVal = bVal.toString().toLowerCase();
        }
        
        if (currentSort.direction === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });
    
    renderProducts();
}

// 정렬 (새로 추가)
function sortProducts(column) {
    // 현재 정렬 컬럼과 같으면 방향을 바꾸고, 다르면 오름차순으로 시작
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
    }
    
    // 정렬 아이콘 업데이트
    updateSortIcons();
    
    // 현재 페이지를 1로 리셋하고 새로 로드
    currentPage = 1;
    loadProducts(1);
}

// 정렬 아이콘 업데이트 (새로 추가)
function updateSortIcons() {
    // 모든 정렬 아이콘 초기화
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.className = 'sort-icon fas fa-sort';
    });
    
    // 현재 정렬 컬럼의 아이콘 업데이트
    const currentIcon = document.querySelector(`[onclick="sortProducts('${currentSort.column}')"] .sort-icon`);
    if (currentIcon) {
        if (currentSort.direction === 'asc') {
            currentIcon.className = 'sort-icon fas fa-sort-up';
        } else {
            currentIcon.className = 'sort-icon fas fa-sort-down';
        }
    }
}

// 상품 등록 모달 열기
function openAddModal() {
    currentProductId = null;
    document.getElementById('productModalLabel').innerHTML = '<i class="fas fa-plus me-2"></i>상품 등록';
    document.getElementById('productModalLabel').className = 'modal-title';
    document.querySelector('.modal-header').className = 'modal-header modal-header-add';
    
    // 폼 완전 초기화
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('isEditMode').value = 'false';
    
    // 모든 셀렉트 박스 초기화
    const selectFields = ['company_id', 'brand_code_seq', 'prod_group_code_seq', 'prod_type_code_seq', 'year_code_seq', 'div_type_code_seq'];
    selectFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
            element.selectedIndex = 0;
        }
    });
    
    // 기본값 설정
    document.getElementById('company_id').value = '1'; // 에이원 기본 선택
    document.getElementById('use_yn').value = 'Y'; // 사용여부 기본값
    
    // 기존 제품모델 목록 숨김
    const existingModelsDiv = document.getElementById('existingProductModels');
    if (existingModelsDiv) {
        existingModelsDiv.style.display = 'none';
    }
    
    // 제품모델 목록 초기화
    window.productModels = [];
    renderProductModels();
    
    // 모달 표시 (aria-hidden 문제 해결)
    const modalElement = document.getElementById('productModal');
    modalElement.setAttribute('aria-hidden', 'false');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // 모달이 닫힐 때 aria-hidden 복원
    modalElement.addEventListener('hidden.bs.modal', function() {
        this.setAttribute('aria-hidden', 'true');
    }, { once: true });
}

// 상품 수정
function editProduct(id) {
    currentProductId = id;
    
    fetch('/product/api/get/' + id)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const product = data.product;
                
                document.getElementById('productModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>상품 수정';
                document.getElementById('productModalLabel').className = 'modal-title';
                document.querySelector('.modal-header').className = 'modal-header modal-header-edit';
                
                // 폼 데이터 설정 (필드명 정확히 매핑)
                document.getElementById('productId').value = product.id;
                document.getElementById('isEditMode').value = 'true';
                document.getElementById('company_id').value = product.company_id || '1';
                document.getElementById('product_name').value = product.product_name || '';
                document.getElementById('price').value = product.price || '';
                document.getElementById('use_yn').value = product.is_active ? 'Y' : 'N';
                document.getElementById('div_type_code_seq').value = product.div_type_code_seq || '';
                document.getElementById('description').value = product.description || '';
                
                // 셀렉트 박스 값 설정 - 올바른 순서로 설정
                setTimeout(() => {
                    // 브랜드 설정
                    if (product.brand_code_seq) {
                        const brandSelect = document.getElementById('brand_code_seq');
                        brandSelect.value = product.brand_code_seq;
                        console.log('브랜드 설정:', product.brand_code_seq, '현재값:', brandSelect.value);
                    }
                    
                    // 품목 설정
                    if (product.category_code_seq) {
                        const groupSelect = document.getElementById('prod_group_code_seq');
                        groupSelect.value = product.category_code_seq;
                        console.log('품목 설정:', product.category_code_seq, '현재값:', groupSelect.value);
                        
                        // 품목 설정 후 타입 로드
                        updateTypesForCategory(product.category_code_seq).then(() => {
                            if (product.type_code_seq) {
                                const typeSelect = document.getElementById('prod_type_code_seq');
                                typeSelect.value = product.type_code_seq;
                                console.log('타입 설정:', product.type_code_seq, '현재값:', typeSelect.value);
                            }
                        });
                    }
                    
                    // 년식 설정
                    if (product.year_code_seq) {
                        const yearSelect = document.getElementById('year_code_seq');
                        yearSelect.value = product.year_code_seq;
                        console.log('년식 설정:', product.year_code_seq, '현재값:', yearSelect.value);
                    }
                }, 100);
                
                console.log('제품 수정 데이터 설정:', {
                    id: product.id,
                    brand_code_seq: product.brand_code_seq,
                    category_code_seq: product.category_code_seq,
                    type_code_seq: product.type_code_seq,
                    year_code_seq: product.year_code_seq,
                    div_type_code_seq: product.div_type_code_seq
                });
                
                // 제품모델 목록 로드 및 표시
                loadProductModelsForProduct(product.id);
                
                // 모달 표시
                const modal = new bootstrap.Modal(document.getElementById('productModal'));
                modal.show();
                
            } else {
                showAlert('상품 정보를 불러오는데 실패했습니다', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('서버 오류가 발생했습니다', 'error');
        });
}

// 상품 저장
function saveProduct() {
    const form = document.getElementById('productForm');
    const formData = new FormData(form);
    
    // 파일 추가
    const fileInput = document.getElementById('modal_manual_file');
    if (fileInput.files[0]) {
        formData.append('manual_file', fileInput.files[0]);
    }
    
    const url = currentProductId ? '/product/api/update/' + currentProductId : '/product/api/create';
    const method = 'POST';
    
    fetch(url, {
        method: method,
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(currentProductId ? '상품이 수정되었습니다' : '상품이 등록되었습니다', 'success');
            bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
            loadProducts(); // 목록 새로고침
        } else {
            showAlert('저장에 실패했습니다: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('서버 오류가 발생했습니다', 'error');
    });
}

// 상품 삭제
function deleteProduct(id) {
    if (!confirm('정말로 이 상품을 삭제하시겠습니까?')) {
        return;
    }
    
    fetch('/product/api/delete/' + id, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('상품이 삭제되었습니다', 'success');
            loadProducts(); // 목록 새로고침
        } else {
            showAlert('삭제에 실패했습니다: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('서버 오류가 발생했습니다', 'error');
    });
}

// 상품 상세보기
function showProductDetail(id) {
    fetch('/product/api/get/' + id)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const product = data.product;
                
                const detailContent = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold">기본 정보</h6>
                            <table class="table table-borderless table-sm">
                                <tr><td class="fw-bold">상품명:</td><td>${product.product_name}</td></tr>
                                <tr><td class="fw-bold">상품코드:</td><td>${product.product_code || '-'}</td></tr>
                                <tr><td class="fw-bold">회사:</td><td>${product.company_id === 1 ? '에이원' : '에이원월드'}</td></tr>
                                <tr><td class="fw-bold">브랜드:</td><td>${product.brand_name || '미지정'}</td></tr>
                                <tr><td class="fw-bold">가격:</td><td>${product.price ? formatPrice(product.price) + '원' : '미정'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">분류 정보</h6>
                            <table class="table table-borderless table-sm">
                                <tr><td class="fw-bold">품목:</td><td>${product.category_name || '미지정'}</td></tr>
                                <tr><td class="fw-bold">타입:</td><td>${product.type_name || '미지정'}</td></tr>
                                <tr><td class="fw-bold">년도:</td><td>${product.year_code_name || '-'}</td></tr>
                                <tr><td class="fw-bold">상태:</td><td><span class="product-status-${product.is_active ? 'active' : 'inactive'}">${product.is_active ? '활성' : '비활성'}</span></td></tr>
                                <tr><td class="fw-bold">등록일:</td><td>${formatDate(product.created_at)}</td></tr>
                            </table>
                        </div>
                    </div>
                    ${product.description ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="fw-bold">상품 설명</h6>
                                <p class="text-muted">${product.description}</p>
                            </div>
                        </div>
                    ` : ''}
                    ${product.manual_file_path ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="fw-bold">사용설명서</h6>
                                <a href="${product.manual_file_path}" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-file-pdf me-1"></i>PDF 다운로드
                                </a>
                            </div>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('productDetailContent').innerHTML = detailContent;
                currentProductId = id;
                
                const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
                modal.show();
            } else {
                showAlert('상품 정보를 불러오는데 실패했습니다', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('서버 오류가 발생했습니다', 'error');
        });
}

// 상세보기에서 수정
function editProductFromDetail() {
    bootstrap.Modal.getInstance(document.getElementById('productDetailModal')).hide();
    setTimeout(() => {
        editProduct(currentProductId);
    }, 300);
}

// 엑셀 업로드 모달 열기
function openExcelUploadModal() {
    const modal = new bootstrap.Modal(document.getElementById('excelUploadModal'));
    modal.show();
}

// 엑셀 업로드
function uploadExcel() {
    const fileInput = document.getElementById('excelFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('파일을 선택해주세요', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    document.getElementById('uploadProgress').style.display = 'block';
    
    fetch('/product/api/upload-excel', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`엑셀 업로드가 완료되었습니다. (성공: ${data.success_count}개, 실패: ${data.error_count}개)`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('excelUploadModal')).hide();
            loadProducts(); // 목록 새로고침
        } else {
            showAlert('업로드에 실패했습니다: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('서버 오류가 발생했습니다', 'error');
    })
    .finally(() => {
        document.getElementById('uploadProgress').style.display = 'none';
    });
}

// 엑셀 다운로드
function downloadExcel() {
    window.location.href = '/product/api/download-excel';
}

// ERPia 동기화
function syncWithErpia() {
    if (!confirm('ERPia와 동기화하시겠습니까? 시간이 오래 걸릴 수 있습니다.')) {
        return;
    }
    
    showAlert('ERPia 동기화를 시작합니다...', 'info');
    
    fetch('/product/api/sync-erpia', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('ERPia 동기화가 완료되었습니다', 'success');
            loadProducts(); // 목록 새로고침
        } else {
            showAlert('동기화에 실패했습니다: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('서버 오류가 발생했습니다', 'error');
    });
}

// 이벤트 핸들러 초기화
function initializeEventHandlers() {
    // 저장 버튼
    document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
    
    // 파일 입력 변경
    document.getElementById('modal_manual_file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileInfo = document.getElementById('fileInfo');
        
        if (file) {
            fileInfo.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-file-pdf me-2"></i>
                    선택된 파일: ${file.name} (${formatFileSize(file.size)})
                </div>
            `;
            fileInfo.style.display = 'block';
        } else {
            fileInfo.style.display = 'none';
        }
    });
}

// 파일 업로드 설정
function setupFileUpload() {
    const uploadArea = document.querySelector('.file-upload-area');
    const fileInput = document.getElementById('modal_manual_file');
    
    // 드래그 앤 드롭
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'application/pdf') {
            fileInput.files = files;
            fileInput.dispatchEvent(new Event('change'));
        } else {
            showAlert('PDF 파일만 업로드 가능합니다', 'warning');
        }
    });
}

// 뷰 모드 토글 설정
function setupViewModeToggle() {
    document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const tableView = document.getElementById('tableView');
            const cardView = document.getElementById('cardView');
            
            if (this.id === 'gridView') {
                tableView.style.display = 'block';
                cardView.style.display = 'none';
            } else {
                tableView.style.display = 'none';
                cardView.style.display = 'flex';
            }
            
            renderProducts();
        });
    });
}

// 유틸리티 함수들
function applyFilters() {
    renderProducts();
    updateCounters();
}

function updateCounters() {
    document.getElementById('productCount').textContent = filteredProducts.length;
    document.getElementById('tableCount').textContent = filteredProducts.length;
}

// 로딩 인디케이터 표시/숨김
function showLoading(show = true) {
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (loadingIndicator) {
        loadingIndicator.style.display = show ? 'block' : 'none';
    }
}

function formatPrice(price) {
    return new Intl.NumberFormat('ko-KR').format(price);
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showAlert(message, type = 'info') {
    // 부트스트랩 토스트 또는 간단한 alert 사용
    // 여기서는 간단하게 alert 사용
    if (type === 'error') {
        alert('오류: ' + message);
    } else if (type === 'success') {
        alert('성공: ' + message);
    } else if (type === 'warning') {
        alert('경고: ' + message);
    } else {
        alert(message);
    }
}

// 제품모델 추가 함수 (새로 추가)
function addProductModel() {
    const modelName = document.getElementById('new_model_name').value.trim();
    const colorSelect = document.getElementById('new_model_color');
    const additionalPrice = document.getElementById('new_model_additional_price').value || 0;
    const stock = document.getElementById('new_model_stock').value || 0;
    
    if (!modelName) {
        showAlert('제품모델명을 입력하세요.', 'warning');
        return;
    }
    
    if (!colorSelect.value) {
        showAlert('색상을 선택하세요.', 'warning');
        return;
    }
    
    // 자가코드 생성
    const brandCode = getSelectedCode('modal_brand_code_seq');
    const divTypeCode = getSelectedCode('modal_div_type_code_seq');
    const prodGroupCode = getSelectedCode('modal_prod_group_code_seq');
    const prodTypeCode = getSelectedCode('modal_prod_type_code_seq');
    const productCode = getSelectedCode('modal_product_code_seq');
    const type2Code = getSelectedCode('modal_prod_type2_code_seq');
    const yearCode = getSelectedCode('modal_year_code_seq');
    const colorCode = getSelectedCode('new_model_color');
    
    if (!brandCode || !divTypeCode || !prodGroupCode || !prodTypeCode || 
        !productCode || !type2Code || !yearCode || !colorCode) {
        showAlert('모든 코드를 선택해주세요.', 'warning');
        return;
    }
    
    const stdCode = `${brandCode}${divTypeCode}${prodGroupCode}${prodTypeCode}${productCode}${type2Code}${yearCode}${colorCode}`;
    
    // 제품모델 객체 생성
    const productModel = {
        id: Date.now(), // 임시 ID
        product_name: modelName,
        color_seq: colorSelect.value,
        color_name: colorSelect.options[colorSelect.selectedIndex].text,
        color_code: colorCode,
        additional_price: parseInt(additionalPrice),
        stock_quantity: parseInt(stock),
        std_div_prod_code: stdCode
    };
    
    // 글로벌 배열에 추가 (나중에 서버로 전송)
    if (!window.productModels) {
        window.productModels = [];
    }
    window.productModels.push(productModel);
    
    // UI 업데이트
    renderProductModels();
    
    // 폼 초기화
    document.getElementById('new_model_name').value = '';
    document.getElementById('new_model_color').value = '';
    document.getElementById('new_model_additional_price').value = '0';
    document.getElementById('new_model_stock').value = '0';
    
    // 완성된 코드 미리보기 숨김
    document.getElementById('completeCodePreview').style.display = 'none';
    
    showAlert('제품모델이 추가되었습니다.', 'success');
}

// 제품모델 목록 렌더링 (새로 추가)
function renderProductModels() {
    const container = document.getElementById('productModelsList');
    
    // DOM 요소가 없으면 오류 방지
    if (!container) {
        console.warn('productModelsList 요소를 찾을 수 없습니다. 제품모델 렌더링을 건너뜁니다.');
        return;
    }
    
    // 기존 제품모델 목록 영역 표시/숨김 제어
    const existingModelsDiv = document.getElementById('existingProductModels');
    const isEditMode = document.getElementById('isEditMode').value === 'true';
    
    if (existingModelsDiv) {
        existingModelsDiv.style.display = isEditMode ? 'block' : 'none';
    }
    
    if (!window.productModels || window.productModels.length === 0) {
        container.innerHTML = '<p class="text-muted text-center m-0">등록된 제품모델이 없습니다.</p>';
        return;
    }
    
    let html = '';
    window.productModels.forEach((model, index) => {
        // API에서 받은 데이터 구조에 맞게 처리
        const productName = model.product_name || model.name || '제품명 없음';
        const colorName = model.color_name || '색상 정보 없음';
        const stdCode = model.std_div_prod_code || model.std_code || '코드 없음';
        const additionalPrice = model.additional_price || 0;
        const stockQuantity = model.stock_quantity || 0;
        
        html += `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div class="flex-grow-1">
                    <strong>${productName}</strong>
                    <small class="text-muted d-block">
                        색상: ${colorName} | 자가코드: <code>${stdCode}</code>
                    </small>
                    <small class="text-muted">
                        추가가격: ${additionalPrice.toLocaleString()}원 | 재고: ${stockQuantity}개
                    </small>
                </div>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="editProductModel(${model.id || index})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeProductModel(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    console.log('제품모델 목록 렌더링 완료:', window.productModels.length + '개');
}

// 제품모델 제거 (새로 추가)
function removeProductModel(index) {
    if (window.productModels && window.productModels.length > index) {
        window.productModels.splice(index, 1);
        renderProductModels();
        showAlert('제품모델이 제거되었습니다.', 'info');
    }
}

// 페이지 로드 완료 시 이벤트 리스너 등록
document.addEventListener('DOMContentLoaded', function() {
    // 기존 초기화 함수들
    setupViewModeToggle();
    loadProducts(); // 상품 목록만 로드 (제품모델은 별도 탭에서 로드)
    
    // 페이징 이벤트 리스너 추가 (새로 추가)
    const perPageSelect = document.getElementById('perPageSelect');
    if (perPageSelect) {
        perPageSelect.addEventListener('change', changePerPage);
    }
    
    // 자가코드 생성 버튼 이벤트 리스너 (새로 추가)
    const generateBtn = document.getElementById('generateStdCodeBtn');
    if (generateBtn) {
        generateBtn.addEventListener('click', generateStdCode);
    }

    // 제품모델 자가코드 생성 버튼 이벤트 리스너 (새로 추가)
    const generateModelStdCodeBtn = document.getElementById('generateModelStdCodeBtn');
    if (generateModelStdCodeBtn) {
        generateModelStdCodeBtn.addEventListener('click', generateStdCode);
    }
    
    // 연관 셀렉트박스 이벤트 리스너 등록 (새로 추가)
    setupDependentSelects();
});

// 연관 셀렉트박스 설정 (새로 추가)
function setupDependentSelects() {
    // 품목그룹 변경 시 제품타입 필터링
    const prodGroupSelect = document.getElementById('modal_prod_group_code_seq');
    const prodTypeSelect = document.getElementById('modal_prod_type_code_seq');
    
    if (prodGroupSelect && prodTypeSelect) {
        // 제품타입의 전체 옵션을 저장 (초기화용)
        const allProdTypeOptions = Array.from(prodTypeSelect.options).slice(1); // 첫번째 "선택하세요" 제외
        
        prodGroupSelect.addEventListener('change', function() {
            const selectedGroup = this.value;
            
            // 제품타입 초기화
            prodTypeSelect.innerHTML = '<option value="">선택하세요</option>';
            
            if (selectedGroup) {
                // 선택된 품목그룹에 따라 관련 제품타입만 표시
                // 여기서는 단순히 모든 타입을 표시하지만, 실제로는 API에서 필터링된 데이터를 가져와야 함
                allProdTypeOptions.forEach(option => {
                    const newOption = option.cloneNode(true);
                    prodTypeSelect.appendChild(newOption);
                });
            }
        });
    }
    
    // 브랜드 변경 시 구분타입 필터링 (필요시 구현)
    const brandSelect = document.getElementById('modal_brand_code_seq');
    const divTypeSelect = document.getElementById('modal_div_type_code_seq');
    
    if (brandSelect && divTypeSelect) {
        const allDivTypeOptions = Array.from(divTypeSelect.options).slice(1);
        
        brandSelect.addEventListener('change', function() {
            // 필요시 브랜드별 구분타입 필터링 로직 구현
        });
    }
    
    // 코드 변경 시 미리보기 업데이트
    const codeSelects = [
        'modal_brand_code_seq',
        'modal_div_type_code_seq', 
        'modal_prod_group_code_seq',
        'modal_prod_type_code_seq',
        'modal_product_code_seq',
        'modal_prod_type2_code_seq',
        'modal_year_code_seq'
    ];
    
    codeSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.addEventListener('change', updateCodePreview);
        }
    });
    
    // 색상 변경 시 완성된 코드 미리보기 업데이트
    const colorSelect = document.getElementById('new_model_color');
    if (colorSelect) {
        colorSelect.addEventListener('change', updateCompleteCodePreview);
    }
}

// 코드 미리보기 업데이트 (새로 추가)
function updateCodePreview() {
    const brandCode = getSelectedCode('modal_brand_code_seq') || 'XX';
    const divTypeCode = getSelectedCode('modal_div_type_code_seq') || 'X';
    const prodGroupCode = getSelectedCode('modal_prod_group_code_seq') || 'XX';
    const prodTypeCode = getSelectedCode('modal_prod_type_code_seq') || 'XX';
    const productCode = getSelectedCode('modal_product_code_seq') || 'XX';
    const type2Code = getSelectedCode('modal_prod_type2_code_seq') || 'XX';
    const yearCode = getSelectedCode('modal_year_code_seq') || 'XX';
    
    const preview = `${brandCode}-${divTypeCode}-${prodGroupCode}-${prodTypeCode}-${productCode}-${type2Code}-${yearCode}-???`;
    document.getElementById('codePreview').textContent = preview;
    
    // 완성된 코드 미리보기도 업데이트
    updateCompleteCodePreview();
}

// 완성된 코드 미리보기 업데이트 (새로 추가)
function updateCompleteCodePreview() {
    const brandCode = getSelectedCode('modal_brand_code_seq') || 'XX';
    const divTypeCode = getSelectedCode('modal_div_type_code_seq') || 'X';
    const prodGroupCode = getSelectedCode('modal_prod_group_code_seq') || 'XX';
    const prodTypeCode = getSelectedCode('modal_prod_type_code_seq') || 'XX';
    const productCode = getSelectedCode('modal_product_code_seq') || 'XX';
    const type2Code = getSelectedCode('modal_prod_type2_code_seq') || 'XX';
    const yearCode = getSelectedCode('modal_year_code_seq') || 'XX';
    const colorCode = getSelectedCode('new_model_color') || 'XXX';
    
    if (colorCode !== 'XXX') {
        const completeCode = `${brandCode}${divTypeCode}${prodGroupCode}${prodTypeCode}${productCode}${type2Code}${yearCode}${colorCode}`;
        document.getElementById('completeCode').textContent = completeCode;
        document.getElementById('completeCodePreview').style.display = 'block';
    } else {
        document.getElementById('completeCodePreview').style.display = 'none';
    }
}

// 선택된 옵션의 코드 값 가져오기 (새로 추가)
function getSelectedCode(selectId) {
    const select = document.getElementById(selectId);
    if (!select || !select.value) return null;
    
    const selectedOption = select.options[select.selectedIndex];
    return selectedOption.getAttribute('data-code');
}

// 제품모델 추가 (새로 수정)
function addProductModel() {
    const modelName = document.getElementById('new_model_name').value.trim();
    const colorSelect = document.getElementById('new_model_color');
    const additionalPrice = document.getElementById('new_model_additional_price').value || 0;
    const stock = document.getElementById('new_model_stock').value || 0;
    
    if (!modelName) {
        showAlert('제품모델명을 입력하세요.', 'warning');
        return;
    }
    
    if (!colorSelect.value) {
        showAlert('색상을 선택하세요.', 'warning');
        return;
    }
    
    // 자가코드 생성
    const brandCode = getSelectedCode('modal_brand_code_seq');
    const divTypeCode = getSelectedCode('modal_div_type_code_seq');
    const prodGroupCode = getSelectedCode('modal_prod_group_code_seq');
    const prodTypeCode = getSelectedCode('modal_prod_type_code_seq');
    const productCode = getSelectedCode('modal_product_code_seq');
    const type2Code = getSelectedCode('modal_prod_type2_code_seq');
    const yearCode = getSelectedCode('modal_year_code_seq');
    const colorCode = getSelectedCode('new_model_color');
    
    if (!brandCode || !divTypeCode || !prodGroupCode || !prodTypeCode || 
        !productCode || !type2Code || !yearCode || !colorCode) {
        showAlert('모든 코드를 선택해주세요.', 'warning');
        return;
    }
    
    const stdCode = `${brandCode}${divTypeCode}${prodGroupCode}${prodTypeCode}${productCode}${type2Code}${yearCode}${colorCode}`;
    
    // 제품모델 객체 생성
    const productModel = {
        id: Date.now(), // 임시 ID
        product_name: modelName,
        color_seq: colorSelect.value,
        color_name: colorSelect.options[colorSelect.selectedIndex].text,
        color_code: colorCode,
        additional_price: parseInt(additionalPrice),
        stock_quantity: parseInt(stock),
        std_div_prod_code: stdCode
    };
    
    // 글로벌 배열에 추가 (나중에 서버로 전송)
    if (!window.productModels) {
        window.productModels = [];
    }
    window.productModels.push(productModel);
    
    // UI 업데이트
    renderProductModels();
    
    // 폼 초기화
    document.getElementById('new_model_name').value = '';
    document.getElementById('new_model_color').value = '';
    document.getElementById('new_model_additional_price').value = '0';
    document.getElementById('new_model_stock').value = '0';
    
    // 완성된 코드 미리보기 숨김
    document.getElementById('completeCodePreview').style.display = 'none';
    
    showAlert('제품모델이 추가되었습니다.', 'success');
}

// 제품모델 목록 렌더링 (새로 추가)
function renderProductModels() {
    const container = document.getElementById('productModelsList');
    
    if (!window.productModels || window.productModels.length === 0) {
        container.innerHTML = '<p class="text-muted text-center m-0">등록된 제품모델이 없습니다.</p>';
        return;
    }
    
    let html = '';
    window.productModels.forEach((model, index) => {
        html += `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div class="flex-grow-1">
                    <strong>${model.product_name}</strong>
                    <small class="text-muted d-block">
                        색상: ${model.color_name} | 자가코드: <code>${model.std_div_prod_code}</code>
                    </small>
                    <small class="text-muted">
                        추가가격: ${model.additional_price.toLocaleString()}원 | 재고: ${model.stock_quantity}개
                    </small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeProductModel(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// 제품모델 제거 (새로 추가)
function removeProductModel(index) {
    if (window.productModels && window.productModels.length > index) {
        window.productModels.splice(index, 1);
        renderProductModels();
        showAlert('제품모델이 제거되었습니다.', 'info');
    }
}

// 페이징 UI 렌더링 (새로 추가)
function renderPagination() {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // 이전 버튼
    pagination.innerHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `;
    
    // 페이지 번호들
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        pagination.innerHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(1); return false;">1</a>
            </li>
        `;
        if (startPage > 2) {
            pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        pagination.innerHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        pagination.innerHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>
            </li>
        `;
    }
    
    // 다음 버튼
    pagination.innerHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `;
}

// 페이지 정보 업데이트 (새로 추가)
function updatePageInfo() {
    document.getElementById('totalProducts').textContent = totalProducts;
    document.getElementById('currentPageNum').textContent = currentPage;
    document.getElementById('totalPages').textContent = totalPages;
}

// 페이지 변경 (새로 추가)
function changePage(page) {
    if (page < 1 || page > totalPages || page === currentPage) return;
    loadProducts(page);
}

// 페이지당 항목 수 변경 (새로 추가)
function changePerPage() {
    perPage = parseInt(document.getElementById('perPageSelect').value);
    currentPage = 1; // 첫 페이지로 리셋
    loadProducts(1);
}

// 제품에 대한 제품모델 목록 로드 (누락된 함수 추가)
function loadProductModelsForProduct(productId) {
    if (!productId) {
        // 새 제품 등록인 경우 빈 목록으로 초기화
        window.productModels = [];
        renderProductModels();
        return;
    }
    
    // 기존 제품 수정인 경우 해당 제품의 제품모델 목록 로드
    fetch(`/product/api/get-product-models/${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.productModels = data.product_models || [];
                renderProductModels();
            } else {
                console.warn('제품모델 목록 로드 실패:', data.message);
                window.productModels = [];
                renderProductModels();
            }
        })
        .catch(error => {
            console.error('제품모델 목록 로드 오류:', error);
            window.productModels = [];
            renderProductModels();
        });
}

// 제품모델 수정 (누락된 함수 추가)
function editProductModel(modelId) {
    // 제품모델 수정 기능 (향후 구현)
    showAlert('제품모델 수정 기능은 향후 구현 예정입니다.', 'info');
}

// 제품모델 목록 렌더링 (수정 - DOM 안전성과 기존 모델 표시 개선)
function renderProductModels() {
    const container = document.getElementById('productModelsList');
    
    // DOM 요소가 없으면 오류 방지
    if (!container) {
        console.warn('productModelsList 요소를 찾을 수 없습니다. 제품모델 렌더링을 건너뜁니다.');
        return;
    }
    
    // 기존 제품모델 목록 영역 표시/숨김 제어
    const existingModelsDiv = document.getElementById('existingProductModels');
    const isEditMode = document.getElementById('isEditMode').value === 'true';
    
    if (existingModelsDiv) {
        existingModelsDiv.style.display = isEditMode ? 'block' : 'none';
    }
    
    if (!window.productModels || window.productModels.length === 0) {
        container.innerHTML = '<p class="text-muted text-center m-0">등록된 제품모델이 없습니다.</p>';
        return;
    }
    
    let html = '';
    window.productModels.forEach((model, index) => {
        // API에서 받은 데이터 구조에 맞게 처리
        const productName = model.product_name || model.name || '제품명 없음';
        const colorName = model.color_name || '색상 정보 없음';
        const stdCode = model.std_div_prod_code || model.std_code || '코드 없음';
        const additionalPrice = model.additional_price || 0;
        const stockQuantity = model.stock_quantity || 0;
        
        html += `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div class="flex-grow-1">
                    <strong>${productName}</strong>
                    <small class="text-muted d-block">
                        색상: ${colorName} | 자가코드: <code>${stdCode}</code>
                    </small>
                    <small class="text-muted">
                        추가가격: ${additionalPrice.toLocaleString()}원 | 재고: ${stockQuantity}개
                    </small>
                </div>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="editProductModel(${model.id || index})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeProductModel(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    console.log('제품모델 목록 렌더링 완료:', window.productModels.length + '개');
}

// 품목 변경에 따른 타입 업데이트 (개선)
function updateTypesForCategory(categorySeq) {
    const typeSelect = document.getElementById('prod_type_code_seq');
    
    // 초기화
    typeSelect.innerHTML = '<option value="">선택하세요</option>';
    
    if (!categorySeq) {
        return Promise.resolve();
    }
    
    return fetch(`/product/api/get-types-by-category/${categorySeq}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.types) {
                data.types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.seq;
                    option.textContent = type.code_name;
                    typeSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('타입 로드 오류:', error);
        });
}

// 품목 선택 시 해당 품목의 하위 타입들 로드 (새로운 구조)
function updateTypesForProduct(productSeq) {
    const typeSelect = document.getElementById('prod_type_code_seq');
    
    // 초기화
    typeSelect.innerHTML = '<option value="">선택하세요</option>';
    
    if (!productSeq) {
        return;
    }
    
    // 품목의 하위 타입들 조회
    fetch(`/product/api/get-types-by-product-category/${productSeq}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.types) {
                data.types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.seq;
                    option.textContent = type.code_name;
                    typeSelect.appendChild(option);
                });
            } else {
                console.warn('품목별 타입 로드 실패:', data.message || '알 수 없는 오류');
            }
        })
        .catch(error => {
            console.error('품목별 타입 로드 오류:', error);
        });
}
</script>
{% endblock %} 