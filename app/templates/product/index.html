{% extends "base.html" %}

{% block title %}ìƒí’ˆê´€ë¦¬{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<!-- Bootstrap Select CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css" rel="stylesheet">
<!-- Custom CSS -->
<style>
th {
    cursor: pointer;
    user-select: none;
}
th:hover {
    background-color: #e9ecef;
}
.search-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}
.search-card .form-control {
    border-radius: 25px;
}
.table-card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}
.btn-excel {
    background: linear-gradient(45deg, #28a745, #20c997);
    border: none;
    color: white;
}
.product-status-active {
    color: #28a745;
    font-weight: bold;
}
.product-status-inactive {
    color: #dc3545;
    font-weight: bold;
}
.price-display {
    color: #0d6efd;
    font-weight: 600;
}
.company-badge-1 {
    background: linear-gradient(45deg, #667eea, #764ba2);
}
.company-badge-2 {
    background: linear-gradient(45deg, #f093fb, #f5576c);
}
.modal-header-add {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}
.modal-header-edit {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}
.required {
    color: #dc3545;
}
.file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
}
.file-upload-area:hover {
    border-color: #667eea;
    background: #e7f1ff;
}
.file-upload-area.dragover {
    border-color: #667eea;
    background: #e7f1ff;
    transform: scale(1.02);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-box me-2"></i>ìƒí’ˆê´€ë¦¬
            </h1>
            <p class="text-muted mb-0">ìƒí’ˆ ì •ë³´ë¥¼ ë“±ë¡, ìˆ˜ì •, ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
        </div>
        <div>
            <span class="badge bg-primary fs-6" id="productCount">0</span>ê°œ ìƒí’ˆ
        </div>
    </div>

    <!-- ê²€ìƒ‰ ì˜ì—­ -->
    <div class="card mb-4 search-card">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="searchInput" class="form-label">
                        <i class="fas fa-search me-1"></i>í†µí•©ê²€ìƒ‰
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="ìƒí’ˆëª…, ì½”ë“œ, ë¸Œëœë“œëª…..." onkeyup="searchProducts()">
                    </div>
                </div>
                <div class="col-md-2">
                    <label for="companyFilter" class="form-label">íšŒì‚¬</label>
                    <select class="form-select" id="companyFilter" onchange="filterProducts()">
                        <option value="">ì „ì²´</option>
                        <option value="1">ì—ì´ì›</option>
                        <option value="2">ì—ì´ì›ì›”ë“œ</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="brandFilter" class="form-label">ë¸Œëœë“œ</label>
                    <select class="form-select" id="brandFilter" onchange="filterProducts()">
                        <option value="">ì „ì²´</option>
                        {% for brand in brand_codes %}
                        <option value="{{ brand.seq }}">{{ brand.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="categoryFilter" class="form-label">í’ˆëª©</label>
                    <select class="form-select" id="categoryFilter" onchange="filterProducts()">
                        <option value="">ì „ì²´</option>
                        {% for category in category_codes %}
                        <option value="{{ category.seq }}">{{ category.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="statusFilter" class="form-label">ìƒíƒœ</label>
                    <select class="form-select" id="statusFilter" onchange="filterProducts()">
                        <option value="">ì „ì²´</option>
                        <option value="true">í™œì„±</option>
                        <option value="false">ë¹„í™œì„±</option>
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-light w-100" onclick="resetFilters()">
                        <i class="fas fa-refresh"></i>
                    </button>
                </div>
            </div>
            
            <!-- í™•ì¥ í•„í„° (ë‘ ë²ˆì§¸ ì¤„) -->
            <div class="row g-3 mt-2">
                <div class="col-md-2">
                    <label for="typeFilter" class="form-label">íƒ€ì…</label>
                    <select class="form-select" id="typeFilter" onchange="filterProducts()">
                        <option value="">ì „ì²´</option>
                        {% for type in type_codes %}
                        <option value="{{ type.seq }}">{{ type.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="yearFilter" class="form-label">ë…„ë„</label>
                    <select class="form-select" id="yearFilter" onchange="filterProducts()">
                        <option value="">ì „ì²´</option>
                        {% for year in year_codes %}
                        <option value="{{ year.seq }}">{{ year.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="colorFilter" class="form-label">ìƒ‰ìƒ</label>
                    <select class="form-select" id="colorFilter" onchange="filterProducts()">
                        <option value="">ì „ì²´</option>
                        {% for color in color_codes %}
                        <option value="{{ color.seq }}">{{ color.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="divTypeFilter" class="form-label">êµ¬ë¶„íƒ€ì…</label>
                    <select class="form-select" id="divTypeFilter" onchange="filterProducts()">
                        <option value="">ì „ì²´</option>
                        {% for div_type in div_type_codes %}
                        <option value="{{ div_type.seq }}">{{ div_type.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="productCodeFilter" class="form-label">ì œí’ˆì½”ë“œ</label>
                    <select class="form-select" id="productCodeFilter" onchange="filterProducts()">
                        <option value="">ì „ì²´</option>
                        {% for prod_code in product_codes %}
                        <option value="{{ prod_code.seq }}">{{ prod_code.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="stdCodeFilter" class="form-label">ìê°€ì½”ë“œ</label>
                    <input type="text" class="form-control" id="stdCodeFilter" 
                           placeholder="ìê°€ì½”ë“œ ê²€ìƒ‰..." onkeyup="filterProducts()">
                </div>
            </div>
        </div>
    </div>

    <!-- ì•¡ì…˜ ë²„íŠ¼ ì˜ì—­ -->
    <div class="row mb-3">
        <div class="col-md-8">
            <button type="button" class="btn btn-primary me-2" onclick="openAddModal()">
                <i class="fas fa-plus me-1"></i>ìƒí’ˆ ë“±ë¡
            </button>
            <button type="button" class="btn btn-success me-2" onclick="openExcelUploadModal()">
                <i class="fas fa-upload me-1"></i>ì—‘ì…€ ì—…ë¡œë“œ
            </button>
            <button type="button" class="btn btn-excel me-2" onclick="downloadExcel()">
                <i class="fas fa-download me-1"></i>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            </button>
            <button type="button" class="btn btn-info" onclick="syncWithErpia()">
                <i class="fas fa-sync-alt me-1"></i>ERPia ë™ê¸°í™”
            </button>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="viewMode" id="gridView" autocomplete="off" checked>
                <label class="btn btn-outline-secondary" for="gridView">
                    <i class="fas fa-table me-1"></i>í…Œì´ë¸”
                </label>
                <input type="radio" class="btn-check" name="viewMode" id="cardView" autocomplete="off">
                <label class="btn btn-outline-secondary" for="cardView">
                    <i class="fas fa-th-large me-1"></i>ì¹´ë“œ
                </label>
            </div>
        </div>
    </div>

    <!-- í…Œì´ë¸” ì˜ì—­ -->
    <div class="card table-card" id="tableView">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>ìƒí’ˆ ëª©ë¡
                <span class="badge bg-secondary ms-2" id="tableCount">0</span>
            </h5>
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-primary" onclick="sortProducts('name')">
                    <i class="fas fa-sort-alpha-down me-1"></i>ì´ë¦„ìˆœ
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="sortProducts('created')">
                    <i class="fas fa-sort-numeric-down me-1"></i>ë“±ë¡ìˆœ
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="sortProducts('price')">
                    <i class="fas fa-sort-amount-down me-1"></i>ê°€ê²©ìˆœ
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" id="productTable">
                    <thead class="table-light">
                        <tr>
                            <th onclick="sortTable(0)" style="width: 80px;">
                                ë²ˆí˜¸ <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(1)" style="width: 120px;">
                                íšŒì‚¬ <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(2)" style="width: 150px;">
                                ë¸Œëœë“œ <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(3)">
                                ìƒí’ˆëª… <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(4)" style="width: 100px;">
                                í’ˆëª© <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(5)" style="width: 100px;">
                                íƒ€ì… <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(6)" style="width: 100px;">
                                ë…„ë„ <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(7)" style="width: 120px;">
                                ìƒí’ˆê°€ê²©(Tag) <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(8)" style="width: 80px;">
                                ìƒíƒœ <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(9)" style="width: 120px;">
                                ë“±ë¡ì¼ <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th style="width: 120px;">ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ì¹´ë“œ ì˜ì—­ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
    <div class="row" id="cardView" style="display: none;">
        <div id="productCards">
            <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
        </div>
    </div>

    <!-- í˜ì´ì§• ì»¨íŠ¸ë¡¤ (ìƒˆë¡œ ì¶”ê°€) -->
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="ìƒí’ˆ í˜ì´ì§€ë„¤ì´ì…˜">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted" id="pageInfo">
                            ì´ <span id="totalProducts">0</span>ê°œ ìƒí’ˆ (í˜ì´ì§€ <span id="currentPageNum">1</span> / <span id="totalPages">1</span>)
                        </small>
                    </div>
                    <ul class="pagination pagination-sm mb-0" id="pagination">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </ul>
                    <div>
                        <select class="form-select form-select-sm" id="perPageSelect" style="width: auto;">
                            <option value="10">10ê°œì”©</option>
                            <option value="25">25ê°œì”©</option>
                            <option value="50" selected>50ê°œì”©</option>
                            <option value="100">100ê°œì”©</option>
                        </select>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
    <div class="text-center my-5" id="loadingIndicator" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</div>

<!-- ìƒí’ˆ ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">ìƒí’ˆ ë“±ë¡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="productForm" enctype="multipart/form-data">
                <input type="hidden" id="productId" name="productId">
                <input type="hidden" id="isEditMode" value="false">
                
                <div class="modal-body">
                    <div class="container-fluid">
                        
                        <!-- 1ë‹¨ê³„: ê¸°ë³¸ ìƒí’ˆ ì •ë³´ (ë ˆê±°ì‹œ í˜¸í™˜) -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="company_id" class="form-label">íšŒì‚¬ <span class="required">*</span></label>
                                    <select class="form-control" id="company_id" name="company_id" required>
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="1">ì—ì´ì›</option>
                                        <option value="2">ì—ì´ì› ì›”ë“œ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                    <label for="brand_code_seq" class="form-label">ë¸Œëœë“œ <span class="required">*</span></label>
                                    <select class="form-select" id="brand_code_seq" name="brand_code_seq" required>
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        {% for brand in brand_codes %}
                                        <option value="{{ brand.seq }}">{{ brand.code_name }}</option>
                                        {% endfor %}
                                </select>
                            </div>
                        </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-2">
                                <label for="prod_group_code_seq" class="form-label">ì œí’ˆêµ¬ë¶„ <span class="required">*</span></label>
                                <select class="form-select" id="prod_group_code_seq" name="prod_group_code_seq" required>
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    {% for category in category_codes %}
                                    <option value="{{ category.seq }}">{{ category.code_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-2">
                                <label for="prod_code_seq" class="form-label">í’ˆëª© <span class="required">*</span></label>
                                <select class="form-select" id="prod_code_seq" name="prod_code_seq" required>
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    {% for product in product_codes %}
                                    <option value="{{ product.seq }}">{{ product.code_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-2">
                                <label for="prod_type_code_seq" class="form-label">íƒ€ì… <span class="required">*</span></label>
                                <select class="form-select" id="prod_type_code_seq" name="prod_type_code_seq" required>
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    <!-- í’ˆëª© ì„ íƒ ì‹œ ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product_name" class="form-label">ìƒí’ˆëª… <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="product_name" name="product_name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="year_code_seq" class="form-label">ë…„ì‹ <span class="required">*</span></label>
                                    <select class="form-control" id="year_code_seq" name="year_code_seq" required>
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    {% for year in year_codes %}
                                        <option value="{{ year.seq }}" data-code="{{ year.code }}">{{ year.code_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="price" class="form-label">ìƒí’ˆê°€ê²©(Tag) <span class="required">*</span></label>
                                    <input type="number" class="form-control" id="price" name="price" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                    <label for="use_yn" class="form-label">ì‚¬ìš©ì—¬ë¶€ <span class="required">*</span></label>
                                    <select class="form-control" id="use_yn" name="use_yn" required>
                                        <option value="Y">ì‚¬ìš©</option>
                                        <option value="N">ë¯¸ì‚¬ìš©</option>
                                </select>
                            </div>
                        </div>
                        </div>
                        
                        <!-- íˆë“  í•„ë“œ: êµ¬ë¶„íƒ€ì… "ì¼ë°˜"ìœ¼ë¡œ ê³ ì • -->
                        <input type="hidden" id="div_type_code_seq" name="div_type_code_seq" value="3">
                        
                        <!-- êµ¬ë¶„ì„  -->
                        <hr class="my-4">
                        
                        <!-- 2ë‹¨ê³„: ì œí’ˆ ëª¨ë¸ ë“±ë¡ -->
                        <div class="bg-primary text-white p-2 mb-3">
                            <h6 class="mb-0"><i class="fas fa-cubes me-2"></i>ì œí’ˆ ëª¨ë¸ ë“±ë¡</h6>
                        </div>
                        
                        <!-- ê¸°ì¡´ ì œí’ˆëª¨ë¸ ëª©ë¡ í‘œì‹œ (ìˆ˜ì • ëª¨ë“œì—ì„œë§Œ) -->
                        <div id="existingProductModels" style="display: none;">
                            <div class="mb-3">
                                <h6 class="text-secondary"><i class="fas fa-list me-2"></i>ê¸°ì¡´ ì œí’ˆ ëª¨ë¸ ëª©ë¡</h6>
                                <div id="productModelsList" class="border rounded p-3 bg-light">
                                    <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
                                </div>
                            </div>
                        </div>
                        
                        <div id="productModelsContainer">
                            <div class="product-model-item border p-3 mb-3" data-index="0">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="color_code_0" class="form-label">ìƒ‰ìƒ <span class="required">*</span></label>
                                            <select id="color_code_0" class="form-control color-code" name="color_code[]" required>
                                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                                {% for color in color_codes %}
                                                <option value="{{ color.code }}" data-seq="{{ color.seq }}">{{ color.code_name }} ({{ color.code }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="product_model_name_0" class="form-label">ì œí’ˆëª…</label>
                                            <input type="text" id="product_model_name_0" class="form-control product-model-name" name="product_model_name[]" placeholder="ìƒ‰ìƒë³„ ì œí’ˆëª… (ì„ íƒì‚¬í•­)">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="std_product_code_0" class="form-label">ìì‚¬ì½”ë“œ</label>
                                            <div class="input-group">
                                                <input type="text" id="std_product_code_0" class="form-control std-product-code" name="std_product_code[]" placeholder="ìë™ìƒì„±ë¨" readonly>
                                                <button type="button" class="btn btn-primary btn-generate-code">ìë™ìƒì„±</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-10"></div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-outline-danger btn-sm btn-remove-model w-100">
                                            <i class="fas fa-times me-1"></i>ì œê±°
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ì¶”ê°€ ì •ë³´ (ì„ íƒì‚¬í•­) -->
                        <hr class="my-4">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="description" class="form-label">ì„¤ëª…</label>
                                    <textarea class="form-control" id="description" name="description" rows="3" placeholder="ìƒí’ˆì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ë‹«ê¸°
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveProductBtn">
                        <i class="fas fa-save me-1"></i>ì €ì¥
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ìƒí’ˆ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>ìƒí’ˆ ìƒì„¸ì •ë³´
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productDetailContent">
                <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="editProductFromDetail()">
                    <i class="fas fa-edit me-1"></i>ìˆ˜ì •
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ì—‘ì…€ ì—…ë¡œë“œ ëª¨ë‹¬ -->
<div class="modal fade" id="excelUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>ì—‘ì…€ ì¼ê´„ ì—…ë¡œë“œ
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="excelFile" class="form-label">ì—‘ì…€ íŒŒì¼ ì„ íƒ</label>
                    <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls">
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        .xlsx ë˜ëŠ” .xls íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤
                    </div>
                </div>
                <div class="mb-3">
                    <a href="/product/api/download-template" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download me-1"></i>ì—…ë¡œë“œ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
                    </a>
                </div>
                <div id="uploadProgress" style="display: none;">
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-center">ì—…ë¡œë“œ ì¤‘...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" onclick="uploadExcel()">
                    <i class="fas fa-upload me-1"></i>ì—…ë¡œë“œ
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<!-- Bootstrap Select JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/i18n/defaults-ko_KR.min.js"></script>

<script>
// ì „ì—­ ë³€ìˆ˜
let products = [];
let filteredProducts = [];
let currentPage = 1;
let currentPerPage = 50;
let pagination = {};
let currentSort = {
    column: 'created_at',
    direction: 'desc'
};
let isLoading = false;
let currentProductId = null;

$(document).ready(function() {
    console.log('ìƒí’ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™”');
    
    // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ ì¶”ê°€
    window.addEventListener('error', function(e) {
        console.error('ì „ì—­ ì—ëŸ¬:', e.error);
        $('#simple-loading').remove(); // ì—ëŸ¬ ì‹œ ë¡œë”© ì œê±°
    });
    
    // jQuery AJAX ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬
    $(document).ajaxError(function(event, xhr, settings, error) {
        console.error('AJAX ì—ëŸ¬:', error);
        $('#simple-loading').remove(); // AJAX ì—ëŸ¬ ì‹œ ë¡œë”© ì œê±°
    });
    
    // DOMì— false ê°’ì´ ì‚½ì…ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ì „ì—­ ê°ì‹œ
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === Node.TEXT_NODE && node.textContent === 'false') {
                    console.warn('âš ï¸ false í…ìŠ¤íŠ¸ ë…¸ë“œ ê°ì§€ ë° ì œê±°:', node);
                    node.remove();
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    // ìš”ì†Œ ë…¸ë“œì˜ í…ìŠ¤íŠ¸ê°€ 'false'ì¸ ê²½ìš°ë„ í™•ì¸
                    if (node.textContent === 'false' && node.children.length === 0) {
                        console.warn('âš ï¸ false ìš”ì†Œ ë…¸ë“œ ê°ì§€ ë° ì œê±°:', node);
                        node.remove();
                    }
                }
            });
        });
    });
    
    // bodyì— ëŒ€í•œ ë³€í™” ê°ì‹œ ì‹œì‘
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
    
    loadProducts();
    setupEventHandlers();
    initializeDivType();
});

// êµ¬ë¶„íƒ€ì…ì„ "ì¼ë°˜"ìœ¼ë¡œ ê¸°ë³¸ ì„¤ì •
function initializeDivType() {
    // êµ¬ë¶„íƒ€ì… ì½”ë“œ ì¤‘ì—ì„œ "ì¼ë°˜"ì— í•´ë‹¹í•˜ëŠ” ê°’ì„ ì°¾ì•„ì„œ ì„¤ì •
    const divTypeSelect = document.getElementById('div_type_code_seq');
    // êµ¬ë¶„íƒ€ì…ì€ ì¼ë°˜ì ìœ¼ë¡œ ì²« ë²ˆì§¸ ê°’ ë˜ëŠ” "1"ë¡œ ì„¤ì •
    const divTypeOptions = $('#div_type_code_seq option');
    if (divTypeOptions.length > 1) {
        divTypeSelect.value = divTypeOptions.eq(1).val(); // ì²« ë²ˆì§¸ ì˜µì…˜ì€ ê³µë°±ì´ë¯€ë¡œ ë‘ ë²ˆì§¸ ì„ íƒ
    }
}

// ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
function setupEventHandlers() {
    // ìê°€ì½”ë“œ ìë™ìƒì„± ë²„íŠ¼
    $(document).on('click', '.btn-generate-code', function() {
        generateProductCode(this);
    });

    // ì œí’ˆëª¨ë¸ ì¶”ê°€ ë²„íŠ¼
    $(document).on('click', '.btn-add-model', function() {
        addProductModelRow();
    });

    // ì œí’ˆëª¨ë¸ ì‚­ì œ ë²„íŠ¼
    $(document).on('click', '.btn-remove-model', function() {
        removeProductModelRow(this);
    });

    // í¼ ì œì¶œ
    $('#productForm').on('submit', function(e) {
        e.preventDefault();
        saveProduct();
    });
    
    // í’ˆëª© ë³€ê²½ ì‹œ íƒ€ì… í•„í„°ë§ (ìƒˆë¡œìš´ êµ¬ì¡°)
    $('#prod_code_seq').on('change', function() {
        updateTypesForProduct(this.value);
    });
    
    // ì œí’ˆêµ¬ë¶„ ë³€ê²½ ì‹œ íƒ€ì… í•„í„°ë§ (ê¸°ì¡´ í˜¸í™˜)
    $('#prod_group_code_seq').on('change', function() {
        updateTypesForCategory(this.value);
    });
    
    // ì œí’ˆì½”ë“œ ë³€ê²½ ì‹œ íƒ€ì…2 í•„í„°ë§ (ìƒˆë¡œ ì¶”ê°€)
    $(document).on('change', '.product-code', function() {
        updateType2ForProductCode(this);
    });
    
    // ëª¨ë‹¬ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ê°œì„  (aria-hidden ë¬¸ì œ ì™„ì „ í•´ê²°)
    $('#productModal').on('show.bs.modal', function(e) {
        console.log('ëª¨ë‹¬ ì—´ë¦¼ ì´ë²¤íŠ¸');
        $(this).removeAttr('aria-hidden');
        // í¬ì»¤ìŠ¤ê°€ ìˆëŠ” ìš”ì†Œì—ì„œ í¬ì»¤ìŠ¤ ì œê±°
        if (document.activeElement && document.activeElement.blur) {
            document.activeElement.blur();
        }
    });
    
    $('#productModal').on('shown.bs.modal', function(e) {
        console.log('ëª¨ë‹¬ ì™„ì „íˆ ì—´ë¦¼');
        // ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ ì„¤ì •
        const firstInput = $(this).find('input, select').filter(':visible').first();
        if (firstInput.length) {
            setTimeout(() => firstInput.focus(), 100);
        }
    });
    
    $('#productModal').on('hide.bs.modal', function(e) {
        console.log('ëª¨ë‹¬ ë‹«í˜ ì‹œì‘');
        // ëª¨ë“  í¬ì»¤ìŠ¤ ì œê±°
        $(this).find('*').blur();
    });
    
    $('#productModal').on('hidden.bs.modal', function(e) {
        console.log('ëª¨ë‹¬ ì™„ì „íˆ ë‹«í˜');
        $(this).attr('aria-hidden', 'true');
    });
    
    // í†µí•© ê²€ìƒ‰ ê°œì„  (ì½”ë“œ ê¸°ì¤€)
    $('#searchInput').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        if (searchTerm.length >= 2 || searchTerm.length === 0) {
            searchProducts();
        }
    });
    
    // í•„í„° ë³€ê²½ ì‹œ ê²€ìƒ‰ ì‹¤í–‰ (ë¬´í•œ ë Œë”ë§ ë°©ì§€)
    $('.form-select').on('change', function() {
        if (!isLoading) {
            filterProducts();
        }
    });
}

// ì œí’ˆì½”ë“œì— ë”°ë¥¸ íƒ€ì…2 ì—…ë°ì´íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
function updateType2ForProductCode(productCodeSelect) {
    const modelItem = $(productCodeSelect).closest('.product-model-item');
    const type2Select = modelItem.find('.prod-type2');
    const selectedProductCode = $(productCodeSelect).val();
    
    // íƒ€ì…2 ì„ íƒì°½ ì´ˆê¸°í™”
    type2Select.empty().append('<option value="">íƒ€ì… ì„ íƒ</option>');
    
    if (!selectedProductCode) {
        return;
    }
    
    // APIë¡œ í•´ë‹¹ ì œí’ˆì½”ë“œì˜ íƒ€ì…2ë“¤ ê°€ì ¸ì˜¤ê¸°
    fetch(`/product/api/get-types-by-product-code/${selectedProductCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.types) {
                data.types.forEach(type => {
                    type2Select.append(`
                        <option value="${type.code}" data-code="${type.code}">
                            ${type.code_name} (${type.code})
                        </option>
                    `);
                });
            }
        })
        .catch(error => {
            console.error('íƒ€ì…2 ë¡œë“œ ì‹¤íŒ¨:', error);
        });
}

// í’ˆëª©ì— ë”°ë¥¸ íƒ€ì… ì—…ë°ì´íŠ¸
function updateTypesForCategory(categorySeq) {
    const typeSelect = document.getElementById('prod_type_code_seq');
    
    // ì´ˆê¸°í™”
    typeSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    
    if (!categorySeq) {
        return Promise.resolve();
    }
    
    return fetch(`/product/api/get-types-by-category/${categorySeq}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.types) {
                data.types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.seq;
                    option.textContent = type.code_name;
                    typeSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('íƒ€ì… ë¡œë“œ ì˜¤ë¥˜:', error);
        });
}

// ìì‚¬ì½”ë“œ ìë™ ìƒì„±
function generateProductCode(buttonElement) {
    const container = $(buttonElement).closest('.product-model-item');
    
    // ìƒí’ˆ ê¸°ë³¸ ì •ë³´ì—ì„œ ì½”ë“œê°’ë“¤ ê°€ì ¸ì˜¤ê¸°
    const brandSelect = document.getElementById('brand_code_seq');
    const prodGroupSelect = document.getElementById('prod_group_code_seq'); // ì œí’ˆêµ¬ë¶„
    const prodCodeSelect = document.getElementById('prod_code_seq'); // í’ˆëª©
    const prodTypeSelect = document.getElementById('prod_type_code_seq'); // íƒ€ì…
    const yearSelect = document.getElementById('year_code_seq');
    const divTypeInput = document.getElementById('div_type_code_seq'); // hidden í•„ë“œ
    
    // ì œí’ˆëª¨ë¸ ê°œë³„ ì •ë³´
    const colorSelect = container.find('.color-code')[0];
    
    // ë””ë²„ê¹…: ê° í•„ë“œì˜ ìƒíƒœ í™•ì¸ (ë” ìƒì„¸í•˜ê²Œ)
    console.log('ğŸ” ìì‚¬ì½”ë“œ ìƒì„± í•„ë“œ ì²´í¬:', {
        brandSelect: {
            element: !!brandSelect,
            value: brandSelect?.value || 'null',
            selectedIndex: brandSelect?.selectedIndex || -1,
            optionsCount: brandSelect?.options?.length || 0
        },
        prodGroupSelect: {
            element: !!prodGroupSelect,
            value: prodGroupSelect?.value || 'null',
            selectedIndex: prodGroupSelect?.selectedIndex || -1,
            optionsCount: prodGroupSelect?.options?.length || 0
        },
        prodCodeSelect: {
            element: !!prodCodeSelect,
            value: prodCodeSelect?.value || 'null',
            selectedIndex: prodCodeSelect?.selectedIndex || -1,
            optionsCount: prodCodeSelect?.options?.length || 0
        },
        prodTypeSelect: {
            element: !!prodTypeSelect,
            value: prodTypeSelect?.value || 'null',
            selectedIndex: prodTypeSelect?.selectedIndex || -1,
            optionsCount: prodTypeSelect?.options?.length || 0
        },
        yearSelect: {
            element: !!yearSelect,
            value: yearSelect?.value || 'null',
            selectedIndex: yearSelect?.selectedIndex || -1,
            optionsCount: yearSelect?.options?.length || 0
        },
        colorSelect: {
            element: !!colorSelect,
            value: colorSelect ? $(colorSelect).val() : 'null',
            selectedIndex: colorSelect?.selectedIndex || -1,
            optionsCount: colorSelect?.options?.length || 0
        },
        divTypeInput: {
            element: !!divTypeInput,
            value: divTypeInput?.value || 'null'
        }
    });
    
    // í•„ìˆ˜ ê°’ë“¤ í™•ì¸ (ë” ì—„ê²©í•œ ì²´í¬)
    const missingFields = [];
    
    if (!brandSelect?.value || brandSelect.value === '' || brandSelect.selectedIndex <= 0) {
        missingFields.push('ë¸Œëœë“œ');
    }
    if (!prodGroupSelect?.value || prodGroupSelect.value === '' || prodGroupSelect.selectedIndex <= 0) {
        missingFields.push('ì œí’ˆêµ¬ë¶„');
    }
    if (!prodCodeSelect?.value || prodCodeSelect.value === '' || prodCodeSelect.selectedIndex <= 0) {
        missingFields.push('í’ˆëª©');
    }
    if (!prodTypeSelect?.value || prodTypeSelect.value === '' || prodTypeSelect.selectedIndex <= 0) {
        missingFields.push('íƒ€ì…');
    }
    if (!yearSelect?.value || yearSelect.value === '' || yearSelect.selectedIndex <= 0) {
        missingFields.push('ë…„ì‹');
    }
    if (!colorSelect || !$(colorSelect).val() || $(colorSelect).val() === '' || colorSelect.selectedIndex <= 0) {
        missingFields.push('ìƒ‰ìƒ');
    }
    
    if (missingFields.length > 0) {
        console.log('âŒ ëˆ„ë½ëœ í•„ë“œ:', missingFields);
        alert(`ìì‚¬ì½”ë“œ ìƒì„±ì„ ìœ„í•´ ë‹¤ìŒ í•„ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”: ${missingFields.join(', ')}`);
        return;
    }
    
    // ì„ íƒëœ ì˜µì…˜ì—ì„œ SEQ ê°’ë“¤ ì¶”ì¶œ
    const brandCode = brandSelect.value;
    const prodGroupCode = prodGroupSelect.value;
    const prodCode = prodCodeSelect.value;
    const prodTypeCode = prodTypeSelect.value;
    const yearCode = yearSelect.value;
    const divTypeCode = divTypeInput ? divTypeInput.value : '3'; // ê¸°ë³¸ê°’ 3
    const colorCode = $(colorSelect).val();
    
    console.log('âœ… ìì‚¬ì½”ë“œ ìƒì„± íŒŒë¼ë¯¸í„°:', {
        brand_code: brandCode,
        div_type_code: divTypeCode,
        prod_group_code: prodGroupCode,
        prod_type_code: prodTypeCode,
        prod_code: prodCode,
        year_code: yearCode,
        color_code: colorCode
    });
    
    // ìì‚¬ì½”ë“œ ìƒì„± API í˜¸ì¶œ
    const formData = new FormData();
    formData.append('brand_code', brandCode);
    formData.append('div_type_code', divTypeCode);
    formData.append('prod_group_code', prodGroupCode);
    formData.append('prod_type_code', prodTypeCode);
    formData.append('prod_code', prodCode);
    formData.append('prod_type2_code', '00'); // ê¸°ë³¸ê°’
    formData.append('year_code', yearCode);
    formData.append('color_code', colorCode);
    
    fetch('/product/api/generate-std-code', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            container.find('.std-product-code').val(data.std_code);
            console.log('âœ… ìì‚¬ì½”ë“œ ìƒì„± ì„±ê³µ:', data.std_code);
        } else {
            console.error('âŒ ìì‚¬ì½”ë“œ ìƒì„± ì‹¤íŒ¨:', data.message);
            alert('ìì‚¬ì½”ë“œ ìƒì„± ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    })
    .catch(error => {
        console.error('âŒ ìì‚¬ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', error);
        alert('ìì‚¬ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ìƒ‰ìƒ ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ ìì‚¬ì½”ë“œ ìƒì„±
$(document).on('change', '.color-code', function() {
    const container = $(this).closest('.product-model-item');
    const generateButton = container.find('.btn-generate-code')[0];
    
    if (this.value && generateButton) {
        // ì•½ê°„ì˜ ì§€ì—° í›„ ìë™ìƒì„± (ë‹¤ë¥¸ í•„ë“œë“¤ì´ ì„ íƒë  ì‹œê°„ì„ ì¤Œ)
        setTimeout(() => {
            generateProductCode(generateButton);
        }, 100);
    }
});

// ì œí’ˆëª¨ë¸ í–‰ ì¶”ê°€
function addProductModelRow() {
    const container = $('#productModelsContainer');
    const currentCount = container.find('.product-model-item').length;
    const newIndex = currentCount;
    
    const newRow = `
        <div class="product-model-item border p-3 mb-3" data-index="${newIndex}">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="color_code_${newIndex}" class="form-label">ìƒ‰ìƒ <span class="required">*</span></label>
                        <select id="color_code_${newIndex}" class="form-control color-code" name="color_code[]" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            {% for color in color_codes %}
                            <option value="{{ color.code }}" data-seq="{{ color.seq }}">{{ color.code_name }} ({{ color.code }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="product_model_name_${newIndex}" class="form-label">ì œí’ˆëª…</label>
                        <input type="text" id="product_model_name_${newIndex}" class="form-control product-model-name" name="product_model_name[]" placeholder="ìƒ‰ìƒë³„ ì œí’ˆëª… (ì„ íƒì‚¬í•­)">
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="std_product_code_${newIndex}" class="form-label">ìì‚¬ì½”ë“œ</label>
                        <div class="input-group">
                            <input type="text" id="std_product_code_${newIndex}" class="form-control std-product-code" name="std_product_code[]" placeholder="ìë™ìƒì„±ë¨" readonly>
                            <button type="button" class="btn btn-primary btn-generate-code">ìë™ìƒì„±</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-10"></div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm btn-remove-model w-100">
                        <i class="fas fa-times me-1"></i>ì œê±°
                    </button>
                </div>
            </div>
        </div>
    `;
    
    container.append(newRow);
}

// ì œí’ˆëª¨ë¸ í–‰ ì‚­ì œ
function removeProductModelRow(button) {
    const modelItem = $(button).closest('.product-model-item');
    const container = $('#productModelsContainer');
    
    if (container.find('.product-model-item').length <= 1) {
        alert('ì²« í–‰ì€ ì§€ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return false;
    }
    
    if (confirm('í•´ë‹¹ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        modelItem.remove();
    }
}

// ìƒí’ˆ ì €ì¥
function saveProduct() {
    const formData = new FormData();
    const isEdit = document.getElementById('isEditMode').value === 'true';
    
    // ê¸°ë³¸ ìƒí’ˆ ì •ë³´
    formData.append('company_id', document.getElementById('company_id').value);
    formData.append('brand_code_seq', document.getElementById('brand_code_seq').value);
    formData.append('prod_group_code_seq', document.getElementById('prod_group_code_seq').value);
    formData.append('prod_type_code_seq', document.getElementById('prod_type_code_seq').value);
    formData.append('product_name', document.getElementById('product_name').value);
    formData.append('year_code_seq', document.getElementById('year_code_seq').value);
    formData.append('price', document.getElementById('price').value);
    formData.append('use_yn', document.getElementById('use_yn').value);
    formData.append('div_type_code_seq', document.getElementById('div_type_code_seq').value);
    formData.append('description', document.getElementById('description').value);

    // ì œí’ˆëª¨ë¸ ì •ë³´ ìˆ˜ì§‘
    const productModels = [];
    $('.product-model-item').each(function(index) {
        const modelName = $(this).find('.product-model-name').val();
        const productCode = $(this).find('.product-code').val();
        const prodType2 = $(this).find('.prod-type2').val();
        const productColor = $(this).find('.product-color').val();
        const stdProductCode = $(this).find('.std-product-code').val();
        
        if (modelName && productCode && prodType2 && productColor && stdProductCode) {
            productModels.push({
                name: modelName,
                product_code: productCode,
                prod_type2: prodType2,
                color: productColor,
                std_code: stdProductCode
            });
        }
    });

    if (productModels.length === 0) {
        alert('ìµœì†Œ í•˜ë‚˜ì˜ ì œí’ˆëª¨ë¸ì„ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }

    formData.append('product_models', JSON.stringify(productModels));

    const url = isEdit ? `/product/api/update/${document.getElementById('productId').value}` : '/product/api/create';
    const method = isEdit ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            $('#productModal').modal('hide');
            loadProducts();
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    });
}

// ì •ë ¬ ê¸°ëŠ¥
function sortProducts(column) {
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
    }
    
    updateSortIcons();
    loadProducts();
}

// ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
function updateSortIcons() {
    $('.sort-header').removeClass('asc desc');
    $(`.sort-header[data-column="${currentSort.column}"]`).addClass(currentSort.direction);
}

// ìƒí’ˆ ëª©ë¡ ë¡œë“œ (í˜ì´ì§• ì§€ì› + ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€)
function loadProducts(page = 1) {
    if (isLoading) {
        console.log('â³ ì´ë¯¸ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤.');
        return;
    }
    
    isLoading = true;
    showLoading(true);
    
    // ê²€ìƒ‰ íŒŒë¼ë¯¸í„° ìˆ˜ì§‘
    const searchTerm = document.getElementById('searchInput').value || '';
    const brandCodeSeq = document.getElementById('brandFilter').value || '';
    const categoryCodeSeq = document.getElementById('categoryFilter').value || '';
    const typeCodeSeq = document.getElementById('typeFilter').value || '';
    const yearCodeSeq = document.getElementById('yearFilter').value || '';
    const showInactive = document.getElementById('statusFilter').value === 'false' ? 'true' : 'false';
    
    const params = new URLSearchParams({
        page: page,
        per_page: currentPerPage,
        sort_by: currentSort.column,
        sort_direction: currentSort.direction
    });
    
    // ê²€ìƒ‰ì–´ì™€ í•„í„° ì¶”ê°€
    if (searchTerm) params.append('search', searchTerm);
    if (brandCodeSeq) params.append('brand_code_seq', brandCodeSeq);
    if (categoryCodeSeq) params.append('category_code_seq', categoryCodeSeq);
    if (typeCodeSeq) params.append('type_code_seq', typeCodeSeq);
    if (yearCodeSeq) params.append('year_code_seq', yearCodeSeq);
    if (showInactive === 'true') params.append('show_inactive', 'true');
    
    console.log('ğŸ“¡ ìƒí’ˆ ëª©ë¡ ë¡œë“œ ìš”ì²­:', params.toString());
    
    fetch(`/product/api/list?${params.toString()}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('âœ… ìƒí’ˆ ëª©ë¡ ë¡œë“œ ì„±ê³µ:', data);
            
            if (data.success) {
                products = data.products || [];
                pagination = data.pagination || {};
                
                filteredProducts = [...products];
                renderProducts();
                updatePagination();
                updateCounters();
                
                console.log(`ğŸ“¦ ë¡œë“œëœ ìƒí’ˆ ìˆ˜: ${products.length}`);
            } else {
                throw new Error(data.message || 'ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('âŒ ìƒí’ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            showAlert(`ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
            
            // ë¹ˆ ëª©ë¡ í‘œì‹œ
            products = [];
            filteredProducts = [];
            renderProducts();
            updateCounters();
        })
        .finally(() => {
            isLoading = false;
            showLoading(false);
            console.log('ğŸ ë¡œë”© ì™„ë£Œ');
        });
}

// ìƒí’ˆ ë Œë”ë§
function renderProducts() {
    const viewMode = document.querySelector('input[name="viewMode"]:checked').id;
    
    if (viewMode === 'gridView') {
        renderTableView();
    } else {
        renderCardView();
    }
}

// í…Œì´ë¸” ë·° ë Œë”ë§
function renderTableView() {
    const tbody = document.getElementById('productTableBody');
    tbody.innerHTML = '';
    
    console.log('ë Œë”ë§í•  ìƒí’ˆ ìˆ˜:', filteredProducts.length); // ë””ë²„ê·¸ ë¡œê·¸ ì¶”ê°€
    
    if (!filteredProducts || filteredProducts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="text-center py-4">
                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-0">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>
                </td>
            </tr>
        `;
        return;
    }
    
    filteredProducts.forEach((product, index) => {
        const row = `
            <tr onclick="editProduct(${product.id})" style="cursor: pointer;">
                <td>${(currentPage - 1) * currentPerPage + index + 1}</td>
                <td>
                    <span class="badge company-badge-${product.company_id}">
                        ${product.company_id === 1 ? 'ì—ì´ì›' : 'ì—ì´ì›ì›”ë“œ'}
                    </span>
                </td>
                <td>${product.brand_name || 'ë¯¸ì§€ì •'}</td>
                <td>
                    <strong>${product.product_name}</strong>
                    ${product.product_code ? `<br><small class="text-muted">${product.product_code}</small>` : ''}
                </td>
                <td>${product.category_name || '-'}</td>
                <td>${product.type_name || '-'}</td>
                <td>${product.year_code_name || '-'}</td>
                <td class="price-display">
                    ${product.price ? formatPrice(product.price) + 'ì›' : '-'}
                </td>
                <td>
                    <span class="product-status-${product.is_active ? 'active' : 'inactive'}">
                        ${product.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                    </span>
                </td>
                <td>${formatDate(product.created_at)}</td>
                <td onclick="event.stopPropagation();">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="editProduct(${product.id})" title="ìˆ˜ì •">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showProductDetail(${product.id})" title="ìƒì„¸ë³´ê¸°">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteProduct(${product.id})" title="ì‚­ì œ">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// ì¹´ë“œ ë·° ë Œë”ë§
function renderCardView() {
    const container = document.getElementById('productCards');
    container.innerHTML = '';
    
    if (filteredProducts.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h5>
            </div>
        `;
        return;
    }
    
    filteredProducts.forEach(product => {
        const card = `
            <div class="col-md-4 col-lg-3 mb-4">
                <div class="card h-100 shadow-sm" onclick="showProductDetail(${product.id})" style="cursor: pointer;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="badge company-badge-${product.company_id}">
                            ${product.company_id === 1 ? 'ì—ì´ì›' : 'ì—ì´ì›ì›”ë“œ'}
                        </span>
                        <span class="product-status-${product.is_active ? 'active' : 'inactive'}">
                            ${product.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                        </span>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">${product.product_name}</h6>
                        <p class="card-text">
                            <small class="text-muted">ë¸Œëœë“œ: ${product.brand_name || 'ë¯¸ì§€ì •'}</small><br>
                            <small class="text-muted">í’ˆëª©: ${product.category_name || '-'}</small><br>
                            <small class="text-muted">íƒ€ì…: ${product.type_name || '-'}</small><br>
                            <small class="text-muted">ë…„ë„: ${product.year_code_name || '-'}</small><br>
                            <span class="price-display">
                                ${product.price ? formatPrice(product.price) + 'ì›' : 'ê°€ê²© ë¯¸ì •'}
                            </span>
                        </p>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="btn-group w-100" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); editProduct(${product.id})">
                                <i class="fas fa-edit"></i> ìˆ˜ì •
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteProduct(${product.id})">
                                <i class="fas fa-trash"></i> ì‚­ì œ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += card;
    });
}

// ê²€ìƒ‰ í•¨ìˆ˜ (ì½”ë“œ ê¸°ì¤€ìœ¼ë¡œ ê°œì„ )
function searchProducts() {
    const searchTerm = document.getElementById('searchInput').value.trim();
    
    if (searchTerm.length === 0) {
        // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì „ì²´ ëª©ë¡ ë¡œë“œ
        loadProducts();
        return;
    }
    
    if (searchTerm.length < 2) {
        // 2ê¸€ì ë¯¸ë§Œì´ë©´ ê²€ìƒ‰í•˜ì§€ ì•ŠìŒ
        return;
    }
    
    showLoading(true);
    
    const params = new URLSearchParams({
        page: 1,
        per_page: currentPerPage,
        search: searchTerm,
        sort_by: currentSort.column,
        sort_direction: currentSort.direction
    });
    
    fetch(`/product/api/list?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                products = data.products || [];
                pagination = data.pagination || {};
                
                filteredProducts = [...products];
                renderProducts();
                updatePagination();
                updateCounters();
            } else {
                showAlert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            showAlert('ê²€ìƒ‰ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        })
        .finally(() => {
            showLoading(false);
        });
}

// í•„í„° ì ìš©
function filterProducts() {
    const companyFilter = document.getElementById('companyFilter').value;
    const brandFilter = document.getElementById('brandFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    // í™•ì¥ í•„í„° (ìƒˆë¡œ ì¶”ê°€)
    const typeFilter = document.getElementById('typeFilter').value;
    const yearFilter = document.getElementById('yearFilter').value;
    const colorFilter = document.getElementById('colorFilter').value;
    const divTypeFilter = document.getElementById('divTypeFilter').value;
    const productCodeFilter = document.getElementById('productCodeFilter').value;
    const stdCodeFilter = document.getElementById('stdCodeFilter').value.toLowerCase();
    
    filteredProducts = products.filter(product => {
        if (companyFilter && product.company_id.toString() !== companyFilter) return false;
        if (brandFilter && product.brand_code_seq && product.brand_code_seq.toString() !== brandFilter) return false;
        if (categoryFilter && product.category_code_seq && product.category_code_seq.toString() !== categoryFilter) return false;
        if (statusFilter && product.is_active.toString() !== statusFilter) return false;
        
        // í™•ì¥ í•„í„° ê²€ì‚¬ (ìƒˆë¡œ ì¶”ê°€)
        if (typeFilter && product.type_code_seq && product.type_code_seq.toString() !== typeFilter) return false;
        if (yearFilter && product.year_code_seq && product.year_code_seq.toString() !== yearFilter) return false;
        if (colorFilter && product.color_code_seq && product.color_code_seq.toString() !== colorFilter) return false;
        if (divTypeFilter && product.div_type_code_seq && product.div_type_code_seq.toString() !== divTypeFilter) return false;
        if (productCodeFilter && product.product_code_seq && product.product_code_seq.toString() !== productCodeFilter) return false;
        if (stdCodeFilter && product.std_product_code && !product.std_product_code.toLowerCase().includes(stdCodeFilter)) return false;
        
        // ê²€ìƒ‰ì–´ë„ í•¨ê»˜ ì ìš©
        const search = document.getElementById('searchInput').value.toLowerCase();
        if (search) {
            return Object.values(product).some(value => {
                if (value === null || value === undefined) return false;
                return value.toString().toLowerCase().includes(search);
            });
        }
        
        return true;
    });
    
    renderProducts();
    updateCounters();
}

// í•„í„° ì´ˆê¸°í™”
function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('companyFilter').value = '';
    document.getElementById('brandFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('statusFilter').value = '';
    
    // í™•ì¥ í•„í„° ì´ˆê¸°í™” (ìƒˆë¡œ ì¶”ê°€)
    document.getElementById('typeFilter').value = '';
    document.getElementById('yearFilter').value = '';
    document.getElementById('colorFilter').value = '';
    document.getElementById('divTypeFilter').value = '';
    document.getElementById('productCodeFilter').value = '';
    document.getElementById('stdCodeFilter').value = '';
    
    filteredProducts = [...products];
    renderProducts();
    updateCounters();
}

// í…Œì´ë¸” ì •ë ¬
function sortTable(columnIndex) {
    const columns = ['id', 'company_id', 'brand_name', 'product_name', 'product_code', 
                    'category_name', 'type_name', 'price', 'is_active', 'created_at'];
    const column = columns[columnIndex];
    
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
    }
    
    filteredProducts.sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];
        
        // null ê°’ ì²˜ë¦¬
        if (aVal === null || aVal === undefined) aVal = '';
        if (bVal === null || bVal === undefined) bVal = '';
        
        // ìˆ«ìí˜• ì»¬ëŸ¼ ì²˜ë¦¬
        if (['id', 'company_id', 'price'].includes(column)) {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
        } else {
            aVal = aVal.toString().toLowerCase();
            bVal = bVal.toString().toLowerCase();
        }
        
        if (currentSort.direction === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });
    
    renderProducts();
}

// ì •ë ¬ (ìƒˆë¡œ ì¶”ê°€)
function sortProducts(column) {
    // í˜„ì¬ ì •ë ¬ ì»¬ëŸ¼ê³¼ ê°™ìœ¼ë©´ ë°©í–¥ì„ ë°”ê¾¸ê³ , ë‹¤ë¥´ë©´ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì‹œì‘
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
    }
    
    // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
    updateSortIcons();
    
    // í˜„ì¬ í˜ì´ì§€ë¥¼ 1ë¡œ ë¦¬ì…‹í•˜ê³  ìƒˆë¡œ ë¡œë“œ
    currentPage = 1;
    loadProducts(1);
}

// ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
function updateSortIcons() {
    // ëª¨ë“  ì •ë ¬ ì•„ì´ì½˜ ì´ˆê¸°í™”
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.className = 'sort-icon fas fa-sort';
    });
    
    // í˜„ì¬ ì •ë ¬ ì»¬ëŸ¼ì˜ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
    const currentIcon = document.querySelector(`[onclick="sortProducts('${currentSort.column}')"] .sort-icon`);
    if (currentIcon) {
        if (currentSort.direction === 'asc') {
            currentIcon.className = 'sort-icon fas fa-sort-up';
        } else {
            currentIcon.className = 'sort-icon fas fa-sort-down';
        }
    }
}

// ìƒí’ˆ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
function openAddModal() {
    currentProductId = null;
    document.getElementById('productModalLabel').innerHTML = '<i class="fas fa-plus me-2"></i>ìƒí’ˆ ë“±ë¡';
    document.getElementById('productModalLabel').className = 'modal-title';
    document.querySelector('.modal-header').className = 'modal-header modal-header-add';
    
    // í¼ ì™„ì „ ì´ˆê¸°í™”
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('isEditMode').value = 'false';
    
    // ëª¨ë“  ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì´ˆê¸°í™”
    const selectFields = ['company_id', 'brand_code_seq', 'prod_group_code_seq', 'prod_type_code_seq', 'year_code_seq', 'div_type_code_seq'];
    selectFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
            element.selectedIndex = 0;
        }
    });
    
    // ê¸°ë³¸ê°’ ì„¤ì •
    document.getElementById('company_id').value = '1'; // ì—ì´ì› ê¸°ë³¸ ì„ íƒ
    document.getElementById('use_yn').value = 'Y'; // ì‚¬ìš©ì—¬ë¶€ ê¸°ë³¸ê°’
    
    // ê¸°ì¡´ ì œí’ˆëª¨ë¸ ëª©ë¡ ìˆ¨ê¹€
    const existingModelsDiv = document.getElementById('existingProductModels');
    if (existingModelsDiv) {
        existingModelsDiv.style.display = 'none';
    }
    
    // ì œí’ˆëª¨ë¸ ëª©ë¡ ì´ˆê¸°í™”
    window.productModels = [];
    renderProductModels();
    
    // ëª¨ë‹¬ í‘œì‹œ (aria-hidden ë¬¸ì œ í•´ê²°)
    const modalElement = document.getElementById('productModal');
    modalElement.setAttribute('aria-hidden', 'false');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // ëª¨ë‹¬ì´ ë‹«í ë•Œ aria-hidden ë³µì›
    modalElement.addEventListener('hidden.bs.modal', function() {
        this.setAttribute('aria-hidden', 'true');
    }, { once: true });
}

// ìƒí’ˆ ìˆ˜ì •
function editProduct(productId) {
    console.log('ğŸ”§ ìƒí’ˆ ìˆ˜ì • ì‹œì‘:', productId);
    
    if (!productId) {
        alert('ìƒí’ˆ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ë¡œë”© í‘œì‹œ
    showLoading('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
    
    // ì œí’ˆ ì •ë³´ ì¡°íšŒ
    fetch(`/product/api/get/${productId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            hideLoading();
            
            if (data.success) {
                const product = data.product;
                console.log('ğŸ“ ì œí’ˆ ìˆ˜ì • ë°ì´í„° ì„¤ì •:', product);
                
                // ëª¨ë‹¬ ì œëª© ë³€ê²½
                document.getElementById('productModalLabel').textContent = 'ìƒí’ˆ ìˆ˜ì •';
                
                // í¼ í•„ë“œ ì„¤ì •
                document.getElementById('company_id').value = product.company_id || '';
                document.getElementById('product_name').value = product.product_name || '';
                document.getElementById('description').value = product.description || '';
                document.getElementById('price').value = product.price || '';
                document.getElementById('use_yn').value = product.use_yn || 'Y';
                
                // ì„ íƒ í•„ë“œë“¤ ì„¤ì •
                setTimeout(() => {
                    const selectFields = [
                        { id: 'brand_code_seq', value: product.brand_code_seq },
                        { id: 'prod_group_code_seq', value: product.prod_group_code_seq || product.category_code_seq },
                        { id: 'prod_code_seq', value: product.prod_code_seq },
                        { id: 'prod_type_code_seq', value: product.prod_type_code_seq || product.type_code_seq },
                        { id: 'year_code_seq', value: product.year_code_seq },
                        { id: 'div_type_code_seq', value: product.div_type_code_seq || '3' }
                    ];
                    
                    selectFields.forEach(field => {
                        const element = document.getElementById(field.id);
                        if (element && field.value) {
                            element.value = field.value;
                            console.log(`âœ… ${field.id} ì„¤ì •:`, field.value);
                        }
                    });
                    
                    // íƒ€ì… ë¡œë“œ (ì œí’ˆêµ¬ë¶„ ì„ íƒì— ë”°ë¼)
                    const prodGroupSeq = product.prod_group_code_seq || product.category_code_seq;
                    if (prodGroupSeq) {
                        updateTypesForCategory(prodGroupSeq).then(() => {
                            const prodTypeElement = document.getElementById('prod_type_code_seq');
                            if (prodTypeElement && (product.prod_type_code_seq || product.type_code_seq)) {
                                prodTypeElement.value = product.prod_type_code_seq || product.type_code_seq;
                            }
                        });
                    }
                    
                    // í’ˆëª©ë³„ íƒ€ì… ë¡œë“œ
                    const prodCodeSeq = product.prod_code_seq;
                    if (prodCodeSeq) {
                        updateTypesForProduct(prodCodeSeq);
                    }
                    
                    // ì œí’ˆ ëª¨ë¸ ë¡œë“œ
                    loadProductModelsForProduct(productId);
                }, 100);
                
                // í˜„ì¬ ì œí’ˆ ID ì €ì¥
                currentProductId = productId;
                
                // ëª¨ë‹¬ í‘œì‹œ
                const modal = new bootstrap.Modal(document.getElementById('productModal'));
                modal.show();
                
            } else {
                alert('ìƒí’ˆ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + data.message);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('âŒ ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
            alert('ìƒí’ˆ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        });
}

// ìƒí’ˆ ì €ì¥
function saveProduct() {
    const form = document.getElementById('productForm');
    const formData = new FormData(form);
    
    // íŒŒì¼ ì¶”ê°€
    const fileInput = document.getElementById('modal_manual_file');
    if (fileInput.files[0]) {
        formData.append('manual_file', fileInput.files[0]);
    }
    
    const url = currentProductId ? '/product/api/update/' + currentProductId : '/product/api/create';
    const method = 'POST';
    
    fetch(url, {
        method: method,
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(currentProductId ? 'ìƒí’ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
            loadProducts(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
            showAlert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    });
}

// ìƒí’ˆ ì‚­ì œ
function deleteProduct(id) {
    if (!confirm('ì •ë§ë¡œ ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    fetch('/product/api/delete/' + id, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            loadProducts(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
            showAlert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    });
}

// ìƒí’ˆ ìƒì„¸ë³´ê¸°
function showProductDetail(id) {
    fetch('/product/api/get/' + id)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const product = data.product;
                
                const detailContent = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold">ê¸°ë³¸ ì •ë³´</h6>
                            <table class="table table-borderless table-sm">
                                <tr><td class="fw-bold">ìƒí’ˆëª…:</td><td>${product.product_name}</td></tr>
                                <tr><td class="fw-bold">ìƒí’ˆì½”ë“œ:</td><td>${product.product_code || '-'}</td></tr>
                                <tr><td class="fw-bold">íšŒì‚¬:</td><td>${product.company_id === 1 ? 'ì—ì´ì›' : 'ì—ì´ì›ì›”ë“œ'}</td></tr>
                                <tr><td class="fw-bold">ë¸Œëœë“œ:</td><td>${product.brand_name || 'ë¯¸ì§€ì •'}</td></tr>
                                <tr><td class="fw-bold">ê°€ê²©:</td><td>${product.price ? formatPrice(product.price) + 'ì›' : 'ë¯¸ì •'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">ë¶„ë¥˜ ì •ë³´</h6>
                            <table class="table table-borderless table-sm">
                                <tr><td class="fw-bold">í’ˆëª©:</td><td>${product.category_name || 'ë¯¸ì§€ì •'}</td></tr>
                                <tr><td class="fw-bold">íƒ€ì…:</td><td>${product.type_name || 'ë¯¸ì§€ì •'}</td></tr>
                                <tr><td class="fw-bold">ë…„ë„:</td><td>${product.year_code_name || '-'}</td></tr>
                                <tr><td class="fw-bold">ìƒíƒœ:</td><td><span class="product-status-${product.is_active ? 'active' : 'inactive'}">${product.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}</span></td></tr>
                                <tr><td class="fw-bold">ë“±ë¡ì¼:</td><td>${formatDate(product.created_at)}</td></tr>
                            </table>
                        </div>
                    </div>
                    ${product.description ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="fw-bold">ìƒí’ˆ ì„¤ëª…</h6>
                                <p class="text-muted">${product.description}</p>
                            </div>
                        </div>
                    ` : ''}
                    ${product.manual_file_path ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="fw-bold">ì‚¬ìš©ì„¤ëª…ì„œ</h6>
                                <a href="${product.manual_file_path}" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-file-pdf me-1"></i>PDF ë‹¤ìš´ë¡œë“œ
                                </a>
                            </div>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('productDetailContent').innerHTML = detailContent;
                currentProductId = id;
                
                const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
                modal.show();
            } else {
                showAlert('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        });
}

// ìƒì„¸ë³´ê¸°ì—ì„œ ìˆ˜ì •
function editProductFromDetail() {
    bootstrap.Modal.getInstance(document.getElementById('productDetailModal')).hide();
    setTimeout(() => {
        editProduct(currentProductId);
    }, 300);
}

// ì—‘ì…€ ì—…ë¡œë“œ ëª¨ë‹¬ ì—´ê¸°
function openExcelUploadModal() {
    const modal = new bootstrap.Modal(document.getElementById('excelUploadModal'));
    modal.show();
}

// ì—‘ì…€ ì—…ë¡œë“œ
function uploadExcel() {
    const fileInput = document.getElementById('excelFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    document.getElementById('uploadProgress').style.display = 'block';
    
    fetch('/product/api/upload-excel', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`ì—‘ì…€ ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ì„±ê³µ: ${data.success_count}ê°œ, ì‹¤íŒ¨: ${data.error_count}ê°œ)`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('excelUploadModal')).hide();
            loadProducts(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
            showAlert('ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    })
    .finally(() => {
        document.getElementById('uploadProgress').style.display = 'none';
    });
}

// ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
function downloadExcel() {
    window.location.href = '/product/api/download-excel';
}

// ERPia ë™ê¸°í™”
function syncWithErpia() {
    if (!confirm('ERPiaì™€ ë™ê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
        return;
    }
    
    showAlert('ERPia ë™ê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
    
    fetch('/product/api/sync-erpia', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('ERPia ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            loadProducts(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
            showAlert('ë™ê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    });
}

// ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™”
function initializeEventHandlers() {
    // ì €ì¥ ë²„íŠ¼
    document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
    
    // íŒŒì¼ ì…ë ¥ ë³€ê²½
    document.getElementById('modal_manual_file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileInfo = document.getElementById('fileInfo');
        
        if (file) {
            fileInfo.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-file-pdf me-2"></i>
                    ì„ íƒëœ íŒŒì¼: ${file.name} (${formatFileSize(file.size)})
                </div>
            `;
            fileInfo.style.display = 'block';
        } else {
            fileInfo.style.display = 'none';
        }
    });
}

// íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
function setupFileUpload() {
    const uploadArea = document.querySelector('.file-upload-area');
    const fileInput = document.getElementById('modal_manual_file');
    
    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'application/pdf') {
            fileInput.files = files;
            fileInput.dispatchEvent(new Event('change'));
        } else {
            showAlert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'warning');
        }
    });
}

// ë·° ëª¨ë“œ í† ê¸€ ì„¤ì •
function setupViewModeToggle() {
    document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const tableView = document.getElementById('tableView');
            const cardView = document.getElementById('cardView');
            
            if (this.id === 'gridView') {
                tableView.style.display = 'block';
                cardView.style.display = 'none';
            } else {
                tableView.style.display = 'none';
                cardView.style.display = 'flex';
            }
            
            renderProducts();
        });
    });
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function applyFilters() {
    renderProducts();
    updateCounters();
}

function updateCounters() {
    document.getElementById('productCount').textContent = filteredProducts.length;
    document.getElementById('tableCount').textContent = filteredProducts.length;
}

// ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ/ìˆ¨ê¹€
function showLoading(show = true) {
    console.log('ğŸ”§ showLoading í˜¸ì¶œë¨:', show, typeof show);
    
    // false ê°’ì´ ë¬¸ìì—´ë¡œ ë³€í™˜ë˜ì–´ í‘œì‹œë˜ëŠ” ê²ƒì„ ë°©ì§€
    if (show === false || show === 'false') {
        console.log('âš ï¸ showLoading: ë¡œë”© ìˆ¨ê¹€');
        $('#simple-loading').remove();
        return;
    }
    
    if (show === true || show === 'true' || show) {
        console.log('âš ï¸ showLoading: ë¡œë”© í‘œì‹œ');
        // ê¸°ì¡´ ë¡œë”© ì œê±°
        $('#simple-loading').remove();
        
        // ê°„ë‹¨í•œ ë¡œë”© í‘œì‹œ
        if (!$('#simple-loading').length) {
            $('body').append('<div id="simple-loading" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;background:white;padding:20px;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.3)"><div class="spinner-border text-primary"></div><div class="mt-2">ë¡œë”© ì¤‘...</div></div>');
        }
    } else {
        console.log('âš ï¸ showLoading: ì˜ˆìƒì¹˜ ëª»í•œ ê°’:', show);
        $('#simple-loading').remove();
    }
}

function formatPrice(price) {
    return new Intl.NumberFormat('ko-KR').format(price);
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showAlert(message, type = 'info') {
    // ë¶€íŠ¸ìŠ¤íŠ¸ë© í† ìŠ¤íŠ¸ ë˜ëŠ” ê°„ë‹¨í•œ alert ì‚¬ìš©
    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ alert ì‚¬ìš©
    if (type === 'error') {
        alert('ì˜¤ë¥˜: ' + message);
    } else if (type === 'success') {
        alert('ì„±ê³µ: ' + message);
    } else if (type === 'warning') {
        alert('ê²½ê³ : ' + message);
    } else {
        alert(message);
    }
}

// ì œí’ˆëª¨ë¸ ì¶”ê°€ í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€)
function addProductModel() {
    const modelName = document.getElementById('new_model_name').value.trim();
    const colorSelect = document.getElementById('new_model_color');
    const additionalPrice = document.getElementById('new_model_additional_price').value || 0;
    const stock = document.getElementById('new_model_stock').value || 0;
    
    if (!modelName) {
        showAlert('ì œí’ˆëª¨ë¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.', 'warning');
        return;
    }
    
    if (!colorSelect.value) {
        showAlert('ìƒ‰ìƒì„ ì„ íƒí•˜ì„¸ìš”.', 'warning');
        return;
    }
    
    // ìê°€ì½”ë“œ ìƒì„±
    const brandCode = getSelectedCode('modal_brand_code_seq');
    const divTypeCode = getSelectedCode('modal_div_type_code_seq');
    const prodGroupCode = getSelectedCode('modal_prod_group_code_seq');
    const prodTypeCode = getSelectedCode('modal_prod_type_code_seq');
    const productCode = getSelectedCode('modal_product_code_seq');
    const type2Code = getSelectedCode('modal_prod_type2_code_seq');
    const yearCode = getSelectedCode('modal_year_code_seq');
    const colorCode = getSelectedCode('new_model_color');
    
    if (!brandCode || !divTypeCode || !prodGroupCode || !prodTypeCode || 
        !productCode || !type2Code || !yearCode || !colorCode) {
        showAlert('ëª¨ë“  ì½”ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    const stdCode = `${brandCode}${divTypeCode}${prodGroupCode}${prodTypeCode}${productCode}${type2Code}${yearCode}${colorCode}`;
    
    // ì œí’ˆëª¨ë¸ ê°ì²´ ìƒì„±
    const productModel = {
        id: Date.now(), // ì„ì‹œ ID
        product_name: modelName,
        color_seq: colorSelect.value,
        color_name: colorSelect.options[colorSelect.selectedIndex].text,
        color_code: colorCode,
        additional_price: parseInt(additionalPrice),
        stock_quantity: parseInt(stock),
        std_div_prod_code: stdCode
    };
    
    // ê¸€ë¡œë²Œ ë°°ì—´ì— ì¶”ê°€ (ë‚˜ì¤‘ì— ì„œë²„ë¡œ ì „ì†¡)
    if (!window.productModels) {
        window.productModels = [];
    }
    window.productModels.push(productModel);
    
    // UI ì—…ë°ì´íŠ¸
    renderProductModels();
    
    // í¼ ì´ˆê¸°í™”
    document.getElementById('new_model_name').value = '';
    document.getElementById('new_model_color').value = '';
    document.getElementById('new_model_additional_price').value = '0';
    document.getElementById('new_model_stock').value = '0';
    
    // ì™„ì„±ëœ ì½”ë“œ ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¹€
    document.getElementById('completeCodePreview').style.display = 'none';
    
    showAlert('ì œí’ˆëª¨ë¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

// ì œí’ˆëª¨ë¸ ëª©ë¡ ë Œë”ë§ (ìƒˆë¡œ ì¶”ê°€)
function renderProductModels() {
    const container = document.getElementById('productModelsList');
    
    // DOM ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì˜¤ë¥˜ ë°©ì§€
    if (!container) {
        console.warn('productModelsList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì œí’ˆëª¨ë¸ ë Œë”ë§ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
        return;
    }
    
    // ê¸°ì¡´ ì œí’ˆëª¨ë¸ ëª©ë¡ ì˜ì—­ í‘œì‹œ/ìˆ¨ê¹€ ì œì–´
    const existingModelsDiv = document.getElementById('existingProductModels');
    const isEditMode = document.getElementById('isEditMode').value === 'true';
    
    if (existingModelsDiv) {
        existingModelsDiv.style.display = isEditMode ? 'block' : 'none';
    }
    
    if (!window.productModels || window.productModels.length === 0) {
        container.innerHTML = '<p class="text-muted text-center m-0">ë“±ë¡ëœ ì œí’ˆëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    let html = '';
    window.productModels.forEach((model, index) => {
        // APIì—ì„œ ë°›ì€ ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ ì²˜ë¦¬
        const productName = model.product_name || model.name || 'ì œí’ˆëª… ì—†ìŒ';
        const colorName = model.color_name || 'ìƒ‰ìƒ ì •ë³´ ì—†ìŒ';
        const stdCode = model.std_div_prod_code || model.std_code || 'ì½”ë“œ ì—†ìŒ';
        const additionalPrice = model.additional_price || 0;
        const stockQuantity = model.stock_quantity || 0;
        
        html += `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div class="flex-grow-1">
                    <strong>${productName}</strong>
                    <small class="text-muted d-block">
                        ìƒ‰ìƒ: ${colorName} | ìê°€ì½”ë“œ: <code>${stdCode}</code>
                    </small>
                    <small class="text-muted">
                        ì¶”ê°€ê°€ê²©: ${additionalPrice.toLocaleString()}ì› | ì¬ê³ : ${stockQuantity}ê°œ
                    </small>
                </div>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="editProductModel(${model.id || index})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeProductModel(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    console.log('ì œí’ˆëª¨ë¸ ëª©ë¡ ë Œë”ë§ ì™„ë£Œ:', window.productModels.length + 'ê°œ');
}

// ì œí’ˆëª¨ë¸ ì œê±° (ìƒˆë¡œ ì¶”ê°€)
function removeProductModel(index) {
    if (window.productModels && window.productModels.length > index) {
        window.productModels.splice(index, 1);
        renderProductModels();
        showAlert('ì œí’ˆëª¨ë¸ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
}

// í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener('DOMContentLoaded', function() {
    // ê¸°ì¡´ ì´ˆê¸°í™” í•¨ìˆ˜ë“¤
    setupViewModeToggle();
    loadProducts(); // ìƒí’ˆ ëª©ë¡ë§Œ ë¡œë“œ (ì œí’ˆëª¨ë¸ì€ ë³„ë„ íƒ­ì—ì„œ ë¡œë“œ)
    
    // í˜ì´ì§• ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ìƒˆë¡œ ì¶”ê°€)
    const perPageSelect = document.getElementById('perPageSelect');
    if (perPageSelect) {
        perPageSelect.addEventListener('change', changePerPage);
    }
    
    // ìê°€ì½”ë“œ ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ìƒˆë¡œ ì¶”ê°€)
    const generateBtn = document.getElementById('generateStdCodeBtn');
    if (generateBtn) {
        generateBtn.addEventListener('click', generateStdCode);
    }

    // ì œí’ˆëª¨ë¸ ìê°€ì½”ë“œ ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ìƒˆë¡œ ì¶”ê°€)
    const generateModelStdCodeBtn = document.getElementById('generateModelStdCodeBtn');
    if (generateModelStdCodeBtn) {
        generateModelStdCodeBtn.addEventListener('click', generateStdCode);
    }
    
    // ì—°ê´€ ì…€ë ‰íŠ¸ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ìƒˆë¡œ ì¶”ê°€)
    setupDependentSelects();
});

// ì—°ê´€ ì…€ë ‰íŠ¸ë°•ìŠ¤ ì„¤ì • (ìƒˆë¡œ ì¶”ê°€)
function setupDependentSelects() {
    // í’ˆëª©ê·¸ë£¹ ë³€ê²½ ì‹œ ì œí’ˆíƒ€ì… í•„í„°ë§
    const prodGroupSelect = document.getElementById('modal_prod_group_code_seq');
    const prodTypeSelect = document.getElementById('modal_prod_type_code_seq');
    
    if (prodGroupSelect && prodTypeSelect) {
        // ì œí’ˆíƒ€ì…ì˜ ì „ì²´ ì˜µì…˜ì„ ì €ì¥ (ì´ˆê¸°í™”ìš©)
        const allProdTypeOptions = Array.from(prodTypeSelect.options).slice(1); // ì²«ë²ˆì§¸ "ì„ íƒí•˜ì„¸ìš”" ì œì™¸
        
        prodGroupSelect.addEventListener('change', function() {
            const selectedGroup = this.value;
            
            // ì œí’ˆíƒ€ì… ì´ˆê¸°í™”
            prodTypeSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            if (selectedGroup) {
                // ì„ íƒëœ í’ˆëª©ê·¸ë£¹ì— ë”°ë¼ ê´€ë ¨ ì œí’ˆíƒ€ì…ë§Œ í‘œì‹œ
                // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ ëª¨ë“  íƒ€ì…ì„ í‘œì‹œí•˜ì§€ë§Œ, ì‹¤ì œë¡œëŠ” APIì—ì„œ í•„í„°ë§ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
                allProdTypeOptions.forEach(option => {
                    const newOption = option.cloneNode(true);
                    prodTypeSelect.appendChild(newOption);
                });
            }
        });
    }
    
    // ë¸Œëœë“œ ë³€ê²½ ì‹œ êµ¬ë¶„íƒ€ì… í•„í„°ë§ (í•„ìš”ì‹œ êµ¬í˜„)
    const brandSelect = document.getElementById('modal_brand_code_seq');
    const divTypeSelect = document.getElementById('modal_div_type_code_seq');
    
    if (brandSelect && divTypeSelect) {
        const allDivTypeOptions = Array.from(divTypeSelect.options).slice(1);
        
        brandSelect.addEventListener('change', function() {
            // í•„ìš”ì‹œ ë¸Œëœë“œë³„ êµ¬ë¶„íƒ€ì… í•„í„°ë§ ë¡œì§ êµ¬í˜„
        });
    }
    
    // ì½”ë“œ ë³€ê²½ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    const codeSelects = [
        'modal_brand_code_seq',
        'modal_div_type_code_seq', 
        'modal_prod_group_code_seq',
        'modal_prod_type_code_seq',
        'modal_product_code_seq',
        'modal_prod_type2_code_seq',
        'modal_year_code_seq'
    ];
    
    codeSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.addEventListener('change', updateCodePreview);
        }
    });
    
    // ìƒ‰ìƒ ë³€ê²½ ì‹œ ì™„ì„±ëœ ì½”ë“œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    const colorSelect = document.getElementById('new_model_color');
    if (colorSelect) {
        colorSelect.addEventListener('change', updateCompleteCodePreview);
    }
}

// ì½”ë“œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
function updateCodePreview() {
    const brandCode = getSelectedCode('modal_brand_code_seq') || 'XX';
    const divTypeCode = getSelectedCode('modal_div_type_code_seq') || 'X';
    const prodGroupCode = getSelectedCode('modal_prod_group_code_seq') || 'XX';
    const prodTypeCode = getSelectedCode('modal_prod_type_code_seq') || 'XX';
    const productCode = getSelectedCode('modal_product_code_seq') || 'XX';
    const type2Code = getSelectedCode('modal_prod_type2_code_seq') || 'XX';
    const yearCode = getSelectedCode('modal_year_code_seq') || 'XX';
    
    const preview = `${brandCode}-${divTypeCode}-${prodGroupCode}-${prodTypeCode}-${productCode}-${type2Code}-${yearCode}-???`;
    document.getElementById('codePreview').textContent = preview;
    
    // ì™„ì„±ëœ ì½”ë“œ ë¯¸ë¦¬ë³´ê¸°ë„ ì—…ë°ì´íŠ¸
    updateCompleteCodePreview();
}

// ì™„ì„±ëœ ì½”ë“œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
function updateCompleteCodePreview() {
    const brandCode = getSelectedCode('modal_brand_code_seq') || 'XX';
    const divTypeCode = getSelectedCode('modal_div_type_code_seq') || 'X';
    const prodGroupCode = getSelectedCode('modal_prod_group_code_seq') || 'XX';
    const prodTypeCode = getSelectedCode('modal_prod_type_code_seq') || 'XX';
    const productCode = getSelectedCode('modal_product_code_seq') || 'XX';
    const type2Code = getSelectedCode('modal_prod_type2_code_seq') || 'XX';
    const yearCode = getSelectedCode('modal_year_code_seq') || 'XX';
    const colorCode = getSelectedCode('new_model_color') || 'XXX';
    
    if (colorCode !== 'XXX') {
        const completeCode = `${brandCode}${divTypeCode}${prodGroupCode}${prodTypeCode}${productCode}${type2Code}${yearCode}${colorCode}`;
        document.getElementById('completeCode').textContent = completeCode;
        document.getElementById('completeCodePreview').style.display = 'block';
    } else {
        document.getElementById('completeCodePreview').style.display = 'none';
    }
}

// ì„ íƒëœ ì˜µì…˜ì˜ ì½”ë“œ ê°’ ê°€ì ¸ì˜¤ê¸° (ìƒˆë¡œ ì¶”ê°€)
function getSelectedCode(selectId) {
    const select = document.getElementById(selectId);
    if (!select || !select.value) return null;
    
    const selectedOption = select.options[select.selectedIndex];
    return selectedOption.getAttribute('data-code');
}

// ì œí’ˆëª¨ë¸ ì¶”ê°€ (ìƒˆë¡œ ìˆ˜ì •)
function addProductModel() {
    const modelName = document.getElementById('new_model_name').value.trim();
    const colorSelect = document.getElementById('new_model_color');
    const additionalPrice = document.getElementById('new_model_additional_price').value || 0;
    const stock = document.getElementById('new_model_stock').value || 0;
    
    if (!modelName) {
        showAlert('ì œí’ˆëª¨ë¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.', 'warning');
        return;
    }
    
    if (!colorSelect.value) {
        showAlert('ìƒ‰ìƒì„ ì„ íƒí•˜ì„¸ìš”.', 'warning');
        return;
    }
    
    // ìê°€ì½”ë“œ ìƒì„±
    const brandCode = getSelectedCode('modal_brand_code_seq');
    const divTypeCode = getSelectedCode('modal_div_type_code_seq');
    const prodGroupCode = getSelectedCode('modal_prod_group_code_seq');
    const prodTypeCode = getSelectedCode('modal_prod_type_code_seq');
    const productCode = getSelectedCode('modal_product_code_seq');
    const type2Code = getSelectedCode('modal_prod_type2_code_seq');
    const yearCode = getSelectedCode('modal_year_code_seq');
    const colorCode = getSelectedCode('new_model_color');
    
    if (!brandCode || !divTypeCode || !prodGroupCode || !prodTypeCode || 
        !productCode || !type2Code || !yearCode || !colorCode) {
        showAlert('ëª¨ë“  ì½”ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    const stdCode = `${brandCode}${divTypeCode}${prodGroupCode}${prodTypeCode}${productCode}${type2Code}${yearCode}${colorCode}`;
    
    // ì œí’ˆëª¨ë¸ ê°ì²´ ìƒì„±
    const productModel = {
        id: Date.now(), // ì„ì‹œ ID
        product_name: modelName,
        color_seq: colorSelect.value,
        color_name: colorSelect.options[colorSelect.selectedIndex].text,
        color_code: colorCode,
        additional_price: parseInt(additionalPrice),
        stock_quantity: parseInt(stock),
        std_div_prod_code: stdCode
    };
    
    // ê¸€ë¡œë²Œ ë°°ì—´ì— ì¶”ê°€ (ë‚˜ì¤‘ì— ì„œë²„ë¡œ ì „ì†¡)
    if (!window.productModels) {
        window.productModels = [];
    }
    window.productModels.push(productModel);
    
    // UI ì—…ë°ì´íŠ¸
    renderProductModels();
    
    // í¼ ì´ˆê¸°í™”
    document.getElementById('new_model_name').value = '';
    document.getElementById('new_model_color').value = '';
    document.getElementById('new_model_additional_price').value = '0';
    document.getElementById('new_model_stock').value = '0';
    
    // ì™„ì„±ëœ ì½”ë“œ ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¹€
    document.getElementById('completeCodePreview').style.display = 'none';
    
    showAlert('ì œí’ˆëª¨ë¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

// ì œí’ˆëª¨ë¸ ëª©ë¡ ë Œë”ë§ (ìƒˆë¡œ ì¶”ê°€)
function renderProductModels() {
    const container = document.getElementById('productModelsList');
    
    if (!window.productModels || window.productModels.length === 0) {
        container.innerHTML = '<p class="text-muted text-center m-0">ë“±ë¡ëœ ì œí’ˆëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    let html = '';
    window.productModels.forEach((model, index) => {
        html += `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div class="flex-grow-1">
                    <strong>${model.product_name}</strong>
                    <small class="text-muted d-block">
                        ìƒ‰ìƒ: ${model.color_name} | ìê°€ì½”ë“œ: <code>${model.std_div_prod_code}</code>
                    </small>
                    <small class="text-muted">
                        ì¶”ê°€ê°€ê²©: ${model.additional_price.toLocaleString()}ì› | ì¬ê³ : ${model.stock_quantity}ê°œ
                    </small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeProductModel(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ì œí’ˆëª¨ë¸ ì œê±° (ìƒˆë¡œ ì¶”ê°€)
function removeProductModel(index) {
    if (window.productModels && window.productModels.length > index) {
        window.productModels.splice(index, 1);
        renderProductModels();
        showAlert('ì œí’ˆëª¨ë¸ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
}

// í˜ì´ì§• UI ë Œë”ë§ (ìƒˆë¡œ ì¶”ê°€)
function renderPagination() {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // ì´ì „ ë²„íŠ¼
    pagination.innerHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `;
    
    // í˜ì´ì§€ ë²ˆí˜¸ë“¤
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        pagination.innerHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(1); return false;">1</a>
            </li>
        `;
        if (startPage > 2) {
            pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        pagination.innerHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        pagination.innerHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>
            </li>
        `;
    }
    
    // ë‹¤ìŒ ë²„íŠ¼
    pagination.innerHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `;
}

// í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
function updatePageInfo() {
    document.getElementById('totalProducts').textContent = totalProducts;
    document.getElementById('currentPageNum').textContent = currentPage;
    document.getElementById('totalPages').textContent = totalPages;
}

// í˜ì´ì§€ ë³€ê²½ (ìƒˆë¡œ ì¶”ê°€)
function changePage(page) {
    if (page < 1 || page > totalPages || page === currentPage) return;
    loadProducts(page);
}

// í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜ ë³€ê²½ (ìƒˆë¡œ ì¶”ê°€)
function changePerPage() {
    currentPerPage = parseInt(document.getElementById('perPageSelect').value);
    currentPage = 1; // ì²« í˜ì´ì§€ë¡œ ë¦¬ì…‹
    loadProducts(1);
}

// ì œí’ˆì— ëŒ€í•œ ì œí’ˆëª¨ë¸ ëª©ë¡ ë¡œë“œ (ëˆ„ë½ëœ í•¨ìˆ˜ ì¶”ê°€)
function loadProductModelsForProduct(productId) {
    if (!productId) {
        // ìƒˆ ì œí’ˆ ë“±ë¡ì¸ ê²½ìš° ë¹ˆ ëª©ë¡ìœ¼ë¡œ ì´ˆê¸°í™”
        window.productModels = [];
        renderProductModels();
        return;
    }
    
    // ê¸°ì¡´ ì œí’ˆ ìˆ˜ì •ì¸ ê²½ìš° í•´ë‹¹ ì œí’ˆì˜ ì œí’ˆëª¨ë¸ ëª©ë¡ ë¡œë“œ
    fetch(`/product/api/get-product-models/${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.productModels = data.product_models || [];
                renderProductModels();
            } else {
                console.warn('ì œí’ˆëª¨ë¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', data.message);
                window.productModels = [];
                renderProductModels();
            }
        })
        .catch(error => {
            console.error('ì œí’ˆëª¨ë¸ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            window.productModels = [];
            renderProductModels();
        });
}

// ì œí’ˆëª¨ë¸ ìˆ˜ì • (ëˆ„ë½ëœ í•¨ìˆ˜ ì¶”ê°€)
function editProductModel(modelId) {
    // ì œí’ˆëª¨ë¸ ìˆ˜ì • ê¸°ëŠ¥ (í–¥í›„ êµ¬í˜„)
    showAlert('ì œí’ˆëª¨ë¸ ìˆ˜ì • ê¸°ëŠ¥ì€ í–¥í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.', 'info');
}

// ì œí’ˆëª¨ë¸ ëª©ë¡ ë Œë”ë§ (ìˆ˜ì • - DOM ì•ˆì „ì„±ê³¼ ê¸°ì¡´ ëª¨ë¸ í‘œì‹œ ê°œì„ )
function renderProductModels() {
    const container = document.getElementById('productModelsList');
    
    // DOM ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì˜¤ë¥˜ ë°©ì§€
    if (!container) {
        console.warn('productModelsList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì œí’ˆëª¨ë¸ ë Œë”ë§ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
        return;
    }
    
    // ê¸°ì¡´ ì œí’ˆëª¨ë¸ ëª©ë¡ ì˜ì—­ í‘œì‹œ/ìˆ¨ê¹€ ì œì–´
    const existingModelsDiv = document.getElementById('existingProductModels');
    const isEditMode = document.getElementById('isEditMode').value === 'true';
    
    if (existingModelsDiv) {
        existingModelsDiv.style.display = isEditMode ? 'block' : 'none';
    }
    
    if (!window.productModels || window.productModels.length === 0) {
        container.innerHTML = '<p class="text-muted text-center m-0">ë“±ë¡ëœ ì œí’ˆëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    let html = '';
    window.productModels.forEach((model, index) => {
        // APIì—ì„œ ë°›ì€ ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ ì²˜ë¦¬
        const productName = model.product_name || model.name || 'ì œí’ˆëª… ì—†ìŒ';
        const colorName = model.color_name || 'ìƒ‰ìƒ ì •ë³´ ì—†ìŒ';
        const stdCode = model.std_div_prod_code || model.std_code || 'ì½”ë“œ ì—†ìŒ';
        const additionalPrice = model.additional_price || 0;
        const stockQuantity = model.stock_quantity || 0;
        
        html += `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div class="flex-grow-1">
                    <strong>${productName}</strong>
                    <small class="text-muted d-block">
                        ìƒ‰ìƒ: ${colorName} | ìê°€ì½”ë“œ: <code>${stdCode}</code>
                    </small>
                    <small class="text-muted">
                        ì¶”ê°€ê°€ê²©: ${additionalPrice.toLocaleString()}ì› | ì¬ê³ : ${stockQuantity}ê°œ
                    </small>
                </div>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="editProductModel(${model.id || index})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeProductModel(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    console.log('ì œí’ˆëª¨ë¸ ëª©ë¡ ë Œë”ë§ ì™„ë£Œ:', window.productModels.length + 'ê°œ');
}

// í’ˆëª© ë³€ê²½ì— ë”°ë¥¸ íƒ€ì… ì—…ë°ì´íŠ¸ (ê°œì„ )
function updateTypesForCategory(categorySeq) {
    const typeSelect = document.getElementById('prod_type_code_seq');
    
    // ì´ˆê¸°í™”
    typeSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    
    if (!categorySeq) {
        return Promise.resolve();
    }
    
    return fetch(`/product/api/get-types-by-category/${categorySeq}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.types) {
                data.types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.seq;
                    option.textContent = type.code_name;
                    typeSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('íƒ€ì… ë¡œë“œ ì˜¤ë¥˜:', error);
        });
}

// í’ˆëª© ì„ íƒ ì‹œ í•´ë‹¹ í’ˆëª©ì˜ í•˜ìœ„ íƒ€ì…ë“¤ ë¡œë“œ (ìƒˆë¡œìš´ êµ¬ì¡°)
function updateTypesForProduct(productSeq) {
    const typeSelect = document.getElementById('prod_type_code_seq');
    
    // ì´ˆê¸°í™”
    typeSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    
    if (!productSeq) {
        return;
    }
    
    // í’ˆëª©ì˜ í•˜ìœ„ íƒ€ì…ë“¤ ì¡°íšŒ
    fetch(`/product/api/get-types-by-product-category/${productSeq}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.types) {
                data.types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.seq;
                    option.textContent = type.code_name;
                    typeSelect.appendChild(option);
                });
            } else {
                console.warn('í’ˆëª©ë³„ íƒ€ì… ë¡œë“œ ì‹¤íŒ¨:', data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
            }
        })
        .catch(error => {
            console.error('í’ˆëª©ë³„ íƒ€ì… ë¡œë“œ ì˜¤ë¥˜:', error);
        });
}

// ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€
function showLoading(message = 'ì²˜ë¦¬ ì¤‘...') {
    if (!document.getElementById('loadingModal')) {
        const loadingHtml = `
            <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
                <div class="modal-dialog modal-sm modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div id="loadingMessage">${message}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', loadingHtml);
    }
    
    document.getElementById('loadingMessage').textContent = message;
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
}

function hideLoading() {
    const loadingModal = document.getElementById('loadingModal');
    if (loadingModal) {
        const modal = bootstrap.Modal.getInstance(loadingModal);
        if (modal) {
            modal.hide();
        }
    }
}

// ìƒí’ˆ ìƒì„¸ ë³´ê¸°
function viewProduct(productId) {
    console.log('ğŸ‘ï¸ ìƒí’ˆ ë³´ê¸°:', productId);
    
    if (!productId) {
        showAlert('ìƒí’ˆ IDê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
    }
    
    // ë¡œë”© í‘œì‹œ
    showLoading(true);
    
    // ì œí’ˆ ì •ë³´ ì¡°íšŒ
    fetch(`/product/api/get/${productId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.product) {
                showProductDetailModal(data.product);
            } else {
                showAlert('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        })
        .finally(() => {
            showLoading(false);
        });
}

// ìƒí’ˆ ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ
function showProductDetailModal(product) {
    const modalHtml = `
        <div class="modal fade" id="productDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-eye me-2"></i>ìƒí’ˆ ìƒì„¸ ì •ë³´
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold">ê¸°ë³¸ ì •ë³´</h6>
                                <table class="table table-sm">
                                    <tr><td class="fw-bold">ìƒí’ˆëª…</td><td>${product.product_name || '-'}</td></tr>
                                    <tr><td class="fw-bold">ìƒí’ˆì½”ë“œ:</td><td>${product.product_code || '-'}</td></tr>
                                    <tr><td class="fw-bold">íšŒì‚¬:</td><td>${product.company_id === 1 ? 'ì—ì´ì›' : 'ì—ì´ì›ì›”ë“œ'}</td></tr>
                                    <tr><td class="fw-bold">ë¸Œëœë“œ:</td><td>${product.brand_name || 'ë¯¸ì§€ì •'}</td></tr>
                                    <tr><td class="fw-bold">ê°€ê²©:</td><td>${product.price ? formatPrice(product.price) + 'ì›' : 'ë¯¸ì •'}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold">ë¶„ë¥˜ ì •ë³´</h6>
                                <table class="table table-sm">
                                    <tr><td class="fw-bold">í’ˆëª©:</td><td>${product.category_name || 'ë¯¸ì§€ì •'}</td></tr>
                                    <tr><td class="fw-bold">íƒ€ì…:</td><td>${product.type_name || 'ë¯¸ì§€ì •'}</td></tr>
                                    <tr><td class="fw-bold">ë…„ë„:</td><td>${product.year_code_name || '-'}</td></tr>
                                    <tr><td class="fw-bold">ìƒíƒœ:</td><td><span class="product-status-${product.is_active ? 'active' : 'inactive'}">${product.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}</span></td></tr>
                                    <tr><td class="fw-bold">ë“±ë¡ì¼:</td><td>${formatDate(product.created_at)}</td></tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="editProduct(${product.id})">
                            <i class="fas fa-edit me-1"></i>ìˆ˜ì •
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
    const existingModal = document.getElementById('productDetailModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // ëª¨ë‹¬ í‘œì‹œ
    const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
    modal.show();
    
    // ëª¨ë‹¬ ìˆ¨ê²¨ì§„ í›„ ì œê±°
    document.getElementById('productDetailModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

// í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
function updatePagination() {
    if (!pagination) return;
    
    const paginationEl = document.getElementById('pagination');
    let paginationHTML = '';
    
    const { page: currentPage, pages: totalPages, total: totalItems, per_page: perPage } = pagination;
    
    // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
    document.getElementById('currentPageNum').textContent = currentPage;
    document.getElementById('totalPages').textContent = totalPages;
    document.getElementById('totalProducts').textContent = totalItems;
    
    if (totalPages <= 1) {
        paginationEl.innerHTML = '';
        return;
    }
    
    // ì´ì „ í˜ì´ì§€ ë²„íŠ¼
    if (currentPage > 1) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;
    }
    
    // í˜ì´ì§€ ë²ˆí˜¸ë“¤
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    // ì²« í˜ì´ì§€
    if (startPage > 1) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(1); return false;">1</a>
            </li>
        `;
        if (startPage > 2) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    // ì¤‘ê°„ í˜ì´ì§€ë“¤
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    // ë§ˆì§€ë§‰ í˜ì´ì§€
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>
            </li>
        `;
    }
    
    // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼
    if (currentPage < totalPages) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;
    }
    
    paginationEl.innerHTML = paginationHTML;
}

// í˜ì´ì§€ ë³€ê²½
function changePage(page) {
    if (isLoading) return;
    
    currentPage = page;
    loadProducts(page);
}

// í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜ ë³€ê²½
function changePerPage() {
    const newPerPage = parseInt(document.getElementById('perPageSelect').value);
    if (newPerPage !== currentPerPage) {
        currentPerPage = newPerPage;
        currentPage = 1; // ì²« í˜ì´ì§€ë¡œ ë¦¬ì…‹
        loadProducts(1);
    }
}
</script>
{% endblock %} 