{% extends "base.html" %}

{% block title %}상품관리{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<!-- Bootstrap Select CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css" rel="stylesheet">
<!-- Custom CSS -->
<style>
th {
    cursor: pointer;
    user-select: none;
}
th:hover {
    background-color: #e9ecef;
}
.search-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}
.search-card .form-control {
    border-radius: 25px;
}
.table-card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}
.btn-excel {
    background: linear-gradient(45deg, #28a745, #20c997);
    border: none;
    color: white;
}
.product-status-active {
    color: #28a745;
    font-weight: bold;
}
.product-status-inactive {
    color: #dc3545;
    font-weight: bold;
}
.price-display {
    color: #0d6efd;
    font-weight: 600;
}
.company-badge-1 {
    background: linear-gradient(45deg, #667eea, #764ba2);
}
.company-badge-2 {
    background: linear-gradient(45deg, #f093fb, #f5576c);
}
.modal-header-add {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}
.modal-header-edit {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}
.required {
    color: #dc3545;
}
.file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
}
.file-upload-area:hover {
    border-color: #667eea;
    background: #e7f1ff;
}
.file-upload-area.dragover {
    border-color: #667eea;
    background: #e7f1ff;
    transform: scale(1.02);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-box me-2"></i>상품관리
            </h1>
            <p class="text-muted mb-0">상품 정보를 등록, 수정, 삭제할 수 있습니다</p>
        </div>
        <div>
            <span class="badge bg-primary fs-6" id="productCount">0</span>개 상품
        </div>
    </div>

    <!-- 검색 영역 -->
    <div class="card mb-4 search-card">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="searchInput" class="form-label">
                        <i class="fas fa-search me-1"></i>통합검색
                    </label>
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="상품명, 코드, 브랜드명..." onkeyup="searchProducts()">
                    </div>
                </div>
                <div class="col-md-2">
                    <label for="companyFilter" class="form-label">회사</label>
                    <select class="form-select" id="companyFilter" onchange="filterProducts()">
                        <option value="">전체</option>
                        <option value="1">에이원</option>
                        <option value="2">에이원월드</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="brandFilter" class="form-label">브랜드</label>
                    <select class="form-select" id="brandFilter" onchange="filterProducts()">
                        <option value="">전체</option>
                        {% for brand in brand_codes %}
                        <option value="{{ brand.seq }}">{{ brand.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="categoryFilter" class="form-label">품목</label>
                    <select class="form-select" id="categoryFilter" onchange="filterProducts()">
                        <option value="">전체</option>
                        {% for category in category_codes %}
                        <option value="{{ category.seq }}">{{ category.code_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="statusFilter" class="form-label">상태</label>
                    <select class="form-select" id="statusFilter" onchange="filterProducts()">
                        <option value="">전체</option>
                        <option value="true">활성</option>
                        <option value="false">비활성</option>
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-light w-100" onclick="resetFilters()">
                        <i class="fas fa-refresh"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 액션 버튼 영역 -->
    <div class="row mb-3">
        <div class="col-md-8">
            <button type="button" class="btn btn-primary me-2" onclick="openAddModal()">
                <i class="fas fa-plus me-1"></i>상품 등록
            </button>
            <button type="button" class="btn btn-success me-2" onclick="openExcelUploadModal()">
                <i class="fas fa-upload me-1"></i>엑셀 업로드
            </button>
            <button type="button" class="btn btn-excel me-2" onclick="downloadExcel()">
                <i class="fas fa-download me-1"></i>엑셀 다운로드
            </button>
            <button type="button" class="btn btn-info" onclick="syncWithErpia()">
                <i class="fas fa-sync-alt me-1"></i>ERPia 동기화
            </button>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="viewMode" id="gridView" autocomplete="off" checked>
                <label class="btn btn-outline-secondary" for="gridView">
                    <i class="fas fa-table me-1"></i>테이블
                </label>
                <input type="radio" class="btn-check" name="viewMode" id="cardView" autocomplete="off">
                <label class="btn btn-outline-secondary" for="cardView">
                    <i class="fas fa-th-large me-1"></i>카드
                </label>
            </div>
        </div>
    </div>

    <!-- 테이블 영역 -->
    <div class="card table-card" id="tableView">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>상품 목록
                <span class="badge bg-secondary ms-2" id="tableCount">0</span>
            </h5>
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-primary" onclick="sortProducts('name')">
                    <i class="fas fa-sort-alpha-down me-1"></i>이름순
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="sortProducts('created')">
                    <i class="fas fa-sort-numeric-down me-1"></i>등록순
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="sortProducts('price')">
                    <i class="fas fa-sort-amount-down me-1"></i>가격순
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" id="productTable">
                    <thead class="table-light">
                        <tr>
                            <th onclick="sortTable(0)" style="width: 80px;">
                                No. <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(1)" style="width: 120px;">
                                회사 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(2)" style="width: 150px;">
                                브랜드 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(3)">
                                상품명 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(4)" style="width: 120px;">
                                상품코드 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(5)" style="width: 100px;">
                                품목 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(6)" style="width: 100px;">
                                타입 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(7)" style="width: 120px;">
                                가격 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(8)" style="width: 80px;">
                                상태 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th onclick="sortTable(9)" style="width: 120px;">
                                등록일 <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th style="width: 120px;">액션</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <!-- 동적으로 로드됨 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 카드 영역 (초기에는 숨김) -->
    <div class="row" id="cardView" style="display: none;">
        <div id="productCards">
            <!-- 동적으로 로드됨 -->
        </div>
    </div>

    <!-- 로딩 인디케이터 -->
    <div class="text-center my-5" id="loadingIndicator" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">상품 정보를 불러오는 중...</p>
    </div>
</div>

<!-- 상품 등록/수정 모달 -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">
                <h5 class="modal-title" id="modalTitle">
                    <i class="fas fa-plus me-2"></i>상품 등록
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId" name="id">
                    
                    <!-- 기본 정보 -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modal_company_id" class="form-label">
                                    회사 <span class="required">*</span>
                                </label>
                                <select class="form-select" id="modal_company_id" name="company_id" required>
                                    <option value="">선택하세요</option>
                                    <option value="1">에이원</option>
                                    <option value="2">에이원월드</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modal_brand_seq" class="form-label">브랜드</label>
                                <select class="form-select" id="modal_brand_seq" name="brand_seq">
                                    <option value="">선택하세요</option>
                                    {% for brand in brand_codes %}
                                    <option value="{{ brand.seq }}">{{ brand.code_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="modal_product_name" class="form-label">
                                    상품명 <span class="required">*</span>
                                </label>
                                <input type="text" class="form-control" id="modal_product_name" 
                                       name="product_name" required placeholder="상품명을 입력하세요">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="modal_product_code" class="form-label">상품코드</label>
                                <input type="text" class="form-control" id="modal_product_code" 
                                       name="product_code" placeholder="상품코드 (선택)">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="modal_product_year" class="form-label">년도</label>
                                <input type="text" class="form-control" id="modal_product_year" 
                                       name="product_year" placeholder="예: 2024" maxlength="4">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="modal_price" class="form-label">가격</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="modal_price" 
                                           name="price" placeholder="0" min="0">
                                    <span class="input-group-text">원</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modal_category_code_seq" class="form-label">품목</label>
                                <select class="form-select" id="modal_category_code_seq" name="category_code_seq">
                                    <option value="">선택하세요</option>
                                    {% for category in category_codes %}
                                    <option value="{{ category.seq }}">{{ category.code_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modal_type_code_seq" class="form-label">타입</label>
                                <select class="form-select" id="modal_type_code_seq" name="type_code_seq">
                                    <option value="">선택하세요</option>
                                    {% for type in type_codes %}
                                    <option value="{{ type.seq }}">{{ type.code_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="modal_description" class="form-label">상품 설명</label>
                        <textarea class="form-control" id="modal_description" name="description" 
                                  rows="3" placeholder="상품에 대한 상세한 설명을 입력하세요"></textarea>
                    </div>

                    <!-- 파일 업로드 -->
                    <div class="mb-3">
                        <label for="modal_manual_file" class="form-label">사용설명서 (PDF)</label>
                        <div class="file-upload-area" onclick="document.getElementById('modal_manual_file').click()">
                            <i class="fas fa-file-pdf fa-2x text-muted mb-2"></i>
                            <p class="mb-0">클릭하여 PDF 파일을 선택하거나 드래그하여 업로드</p>
                            <small class="text-muted">최대 10MB, PDF 파일만 지원</small>
                        </div>
                        <input type="file" class="form-control d-none" id="modal_manual_file" 
                               name="manual_file" accept=".pdf">
                        <div id="fileInfo" class="mt-2" style="display: none;"></div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="modal_is_active" 
                                   name="is_active" checked>
                            <label class="form-check-label" for="modal_is_active">
                                활성 상태
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>취소
                </button>
                <button type="button" class="btn btn-primary" id="saveProductBtn">
                    <i class="fas fa-save me-1"></i>저장
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 상품 상세보기 모달 -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>상품 상세정보
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productDetailContent">
                <!-- 동적으로 로드됨 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="editProductFromDetail()">
                    <i class="fas fa-edit me-1"></i>수정
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>닫기
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 엑셀 업로드 모달 -->
<div class="modal fade" id="excelUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>엑셀 일괄 업로드
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="excelFile" class="form-label">엑셀 파일 선택</label>
                    <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls">
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        .xlsx 또는 .xls 파일만 업로드 가능합니다
                    </div>
                </div>
                <div class="mb-3">
                    <a href="/product/api/download-template" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download me-1"></i>업로드 템플릿 다운로드
                    </a>
                </div>
                <div id="uploadProgress" style="display: none;">
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-center">업로드 중...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-success" onclick="uploadExcel()">
                    <i class="fas fa-upload me-1"></i>업로드
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<!-- Bootstrap Select JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/i18n/defaults-ko_KR.min.js"></script>

<script>
let products = [];
let filteredProducts = [];
let currentSort = { column: null, direction: 'asc' };
let currentProductId = null;

$(document).ready(function() {
    loadProducts();
    initializeEventHandlers();
    setupFileUpload();
    setupViewModeToggle();
});

// 상품 목록 로드
function loadProducts() {
    showLoading(true);
    
    fetch('/product/api/list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                products = data.products;
                filteredProducts = [...products];
                renderProducts();
                updateCounters();
            } else {
                showAlert('상품 목록을 불러오는데 실패했습니다: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('서버 오류가 발생했습니다', 'error');
        })
        .finally(() => {
            showLoading(false);
        });
}

// 상품 렌더링
function renderProducts() {
    const viewMode = document.querySelector('input[name="viewMode"]:checked').id;
    
    if (viewMode === 'gridView') {
        renderTableView();
    } else {
        renderCardView();
    }
}

// 테이블 뷰 렌더링
function renderTableView() {
    const tbody = document.getElementById('productTableBody');
    tbody.innerHTML = '';
    
    if (filteredProducts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="text-center py-4">
                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-0">등록된 상품이 없습니다</p>
                </td>
            </tr>
        `;
        return;
    }
    
    filteredProducts.forEach((product, index) => {
        const row = `
            <tr onclick="showProductDetail(${product.id})" style="cursor: pointer;">
                <td>${index + 1}</td>
                <td>
                    <span class="badge company-badge-${product.company_id}">
                        ${product.company_id === 1 ? '에이원' : '에이원월드'}
                    </span>
                </td>
                <td>${product.brand_name || '미지정'}</td>
                <td>
                    <strong>${product.product_name}</strong>
                    ${product.product_code ? `<br><small class="text-muted">${product.product_code}</small>` : ''}
                </td>
                <td>${product.product_code || '-'}</td>
                <td>${product.category_name || '-'}</td>
                <td>${product.type_name || '-'}</td>
                <td class="price-display">
                    ${product.price ? formatPrice(product.price) + '원' : '-'}
                </td>
                <td>
                    <span class="product-status-${product.is_active ? 'active' : 'inactive'}">
                        ${product.is_active ? '활성' : '비활성'}
                    </span>
                </td>
                <td>${formatDate(product.created_at)}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); editProduct(${product.id})" title="수정">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteProduct(${product.id})" title="삭제">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// 카드 뷰 렌더링
function renderCardView() {
    const container = document.getElementById('productCards');
    container.innerHTML = '';
    
    if (filteredProducts.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">등록된 상품이 없습니다</h5>
            </div>
        `;
        return;
    }
    
    filteredProducts.forEach(product => {
        const card = `
            <div class="col-md-4 col-lg-3 mb-4">
                <div class="card h-100 shadow-sm" onclick="showProductDetail(${product.id})" style="cursor: pointer;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="badge company-badge-${product.company_id}">
                            ${product.company_id === 1 ? '에이원' : '에이원월드'}
                        </span>
                        <span class="product-status-${product.is_active ? 'active' : 'inactive'}">
                            ${product.is_active ? '활성' : '비활성'}
                        </span>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">${product.product_name}</h6>
                        <p class="card-text">
                            <small class="text-muted">브랜드: ${product.brand_name || '미지정'}</small><br>
                            <small class="text-muted">코드: ${product.product_code || '-'}</small><br>
                            <span class="price-display">
                                ${product.price ? formatPrice(product.price) + '원' : '가격 미정'}
                            </span>
                        </p>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="btn-group w-100" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); editProduct(${product.id})">
                                <i class="fas fa-edit"></i> 수정
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteProduct(${product.id})">
                                <i class="fas fa-trash"></i> 삭제
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += card;
    });
}

// 검색 함수
function searchProducts() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    filteredProducts = products.filter(product => {
        return Object.values(product).some(value => {
            if (value === null || value === undefined) return false;
            return value.toString().toLowerCase().includes(search);
        });
    });
    
    applyFilters();
}

// 필터 적용
function filterProducts() {
    const companyFilter = document.getElementById('companyFilter').value;
    const brandFilter = document.getElementById('brandFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    filteredProducts = products.filter(product => {
        if (companyFilter && product.company_id.toString() !== companyFilter) return false;
        if (brandFilter && product.brand_seq && product.brand_seq.toString() !== brandFilter) return false;
        if (categoryFilter && product.category_code_seq && product.category_code_seq.toString() !== categoryFilter) return false;
        if (statusFilter && product.is_active.toString() !== statusFilter) return false;
        
        // 검색어도 함께 적용
        const search = document.getElementById('searchInput').value.toLowerCase();
        if (search) {
            return Object.values(product).some(value => {
                if (value === null || value === undefined) return false;
                return value.toString().toLowerCase().includes(search);
            });
        }
        
        return true;
    });
    
    renderProducts();
    updateCounters();
}

// 필터 초기화
function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('companyFilter').value = '';
    document.getElementById('brandFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('statusFilter').value = '';
    
    filteredProducts = [...products];
    renderProducts();
    updateCounters();
}

// 테이블 정렬
function sortTable(columnIndex) {
    const columns = ['id', 'company_id', 'brand_name', 'product_name', 'product_code', 
                    'category_name', 'type_name', 'price', 'is_active', 'created_at'];
    const column = columns[columnIndex];
    
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
    }
    
    filteredProducts.sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];
        
        // null 값 처리
        if (aVal === null || aVal === undefined) aVal = '';
        if (bVal === null || bVal === undefined) bVal = '';
        
        // 숫자형 컬럼 처리
        if (['id', 'company_id', 'price'].includes(column)) {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
        } else {
            aVal = aVal.toString().toLowerCase();
            bVal = bVal.toString().toLowerCase();
        }
        
        if (currentSort.direction === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });
    
    renderProducts();
}

// 빠른 정렬
function sortProducts(type) {
    switch(type) {
        case 'name':
            sortTable(3); // product_name
            break;
        case 'created':
            sortTable(9); // created_at
            break;
        case 'price':
            sortTable(7); // price
            break;
    }
}

// 상품 등록 모달 열기
function openAddModal() {
    currentProductId = null;
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>상품 등록';
    document.getElementById('modalHeader').className = 'modal-header modal-header-add';
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('modal_is_active').checked = true;
    
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
}

// 상품 수정
function editProduct(id) {
    currentProductId = id;
    
    fetch('/product/api/get/' + id)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const product = data.product;
                
                document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>상품 수정';
                document.getElementById('modalHeader').className = 'modal-header modal-header-edit';
                
                // 폼 데이터 설정
                document.getElementById('productId').value = product.id;
                document.getElementById('modal_company_id').value = product.company_id;
                document.getElementById('modal_brand_seq').value = product.brand_seq || '';
                document.getElementById('modal_product_name').value = product.product_name;
                document.getElementById('modal_product_code').value = product.product_code || '';
                document.getElementById('modal_product_year').value = product.product_year || '';
                document.getElementById('modal_price').value = product.price || '';
                document.getElementById('modal_category_code_seq').value = product.category_code_seq || '';
                document.getElementById('modal_type_code_seq').value = product.type_code_seq || '';
                document.getElementById('modal_description').value = product.description || '';
                document.getElementById('modal_is_active').checked = product.is_active;
                
                const modal = new bootstrap.Modal(document.getElementById('productModal'));
                modal.show();
            } else {
                showAlert('상품 정보를 불러오는데 실패했습니다', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('서버 오류가 발생했습니다', 'error');
        });
}

// 상품 저장
function saveProduct() {
    const form = document.getElementById('productForm');
    const formData = new FormData(form);
    
    // 파일 추가
    const fileInput = document.getElementById('modal_manual_file');
    if (fileInput.files[0]) {
        formData.append('manual_file', fileInput.files[0]);
    }
    
    const url = currentProductId ? '/product/api/update/' + currentProductId : '/product/api/create';
    const method = 'POST';
    
    fetch(url, {
        method: method,
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(currentProductId ? '상품이 수정되었습니다' : '상품이 등록되었습니다', 'success');
            bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
            loadProducts(); // 목록 새로고침
        } else {
            showAlert('저장에 실패했습니다: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('서버 오류가 발생했습니다', 'error');
    });
}

// 상품 삭제
function deleteProduct(id) {
    if (!confirm('정말로 이 상품을 삭제하시겠습니까?')) {
        return;
    }
    
    fetch('/product/api/delete/' + id, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('상품이 삭제되었습니다', 'success');
            loadProducts(); // 목록 새로고침
        } else {
            showAlert('삭제에 실패했습니다: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('서버 오류가 발생했습니다', 'error');
    });
}

// 상품 상세보기
function showProductDetail(id) {
    fetch('/product/api/get/' + id)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const product = data.product;
                
                const detailContent = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold">기본 정보</h6>
                            <table class="table table-borderless table-sm">
                                <tr><td class="fw-bold">상품명:</td><td>${product.product_name}</td></tr>
                                <tr><td class="fw-bold">상품코드:</td><td>${product.product_code || '-'}</td></tr>
                                <tr><td class="fw-bold">회사:</td><td>${product.company_id === 1 ? '에이원' : '에이원월드'}</td></tr>
                                <tr><td class="fw-bold">브랜드:</td><td>${product.brand_name || '미지정'}</td></tr>
                                <tr><td class="fw-bold">가격:</td><td>${product.price ? formatPrice(product.price) + '원' : '미정'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">분류 정보</h6>
                            <table class="table table-borderless table-sm">
                                <tr><td class="fw-bold">품목:</td><td>${product.category_name || '미지정'}</td></tr>
                                <tr><td class="fw-bold">타입:</td><td>${product.type_name || '미지정'}</td></tr>
                                <tr><td class="fw-bold">년도:</td><td>${product.product_year || '-'}</td></tr>
                                <tr><td class="fw-bold">상태:</td><td><span class="product-status-${product.is_active ? 'active' : 'inactive'}">${product.is_active ? '활성' : '비활성'}</span></td></tr>
                                <tr><td class="fw-bold">등록일:</td><td>${formatDate(product.created_at)}</td></tr>
                            </table>
                        </div>
                    </div>
                    ${product.description ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="fw-bold">상품 설명</h6>
                                <p class="text-muted">${product.description}</p>
                            </div>
                        </div>
                    ` : ''}
                    ${product.manual_file_path ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="fw-bold">사용설명서</h6>
                                <a href="${product.manual_file_path}" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-file-pdf me-1"></i>PDF 다운로드
                                </a>
                            </div>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('productDetailContent').innerHTML = detailContent;
                currentProductId = id;
                
                const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
                modal.show();
            } else {
                showAlert('상품 정보를 불러오는데 실패했습니다', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('서버 오류가 발생했습니다', 'error');
        });
}

// 상세보기에서 수정
function editProductFromDetail() {
    bootstrap.Modal.getInstance(document.getElementById('productDetailModal')).hide();
    setTimeout(() => {
        editProduct(currentProductId);
    }, 300);
}

// 엑셀 업로드 모달 열기
function openExcelUploadModal() {
    const modal = new bootstrap.Modal(document.getElementById('excelUploadModal'));
    modal.show();
}

// 엑셀 업로드
function uploadExcel() {
    const fileInput = document.getElementById('excelFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('파일을 선택해주세요', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    document.getElementById('uploadProgress').style.display = 'block';
    
    fetch('/product/api/upload-excel', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`엑셀 업로드가 완료되었습니다. (성공: ${data.success_count}개, 실패: ${data.error_count}개)`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('excelUploadModal')).hide();
            loadProducts(); // 목록 새로고침
        } else {
            showAlert('업로드에 실패했습니다: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('서버 오류가 발생했습니다', 'error');
    })
    .finally(() => {
        document.getElementById('uploadProgress').style.display = 'none';
    });
}

// 엑셀 다운로드
function downloadExcel() {
    window.location.href = '/product/api/download-excel';
}

// ERPia 동기화
function syncWithErpia() {
    if (!confirm('ERPia와 동기화하시겠습니까? 시간이 오래 걸릴 수 있습니다.')) {
        return;
    }
    
    showAlert('ERPia 동기화를 시작합니다...', 'info');
    
    fetch('/product/api/sync-erpia', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('ERPia 동기화가 완료되었습니다', 'success');
            loadProducts(); // 목록 새로고침
        } else {
            showAlert('동기화에 실패했습니다: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('서버 오류가 발생했습니다', 'error');
    });
}

// 이벤트 핸들러 초기화
function initializeEventHandlers() {
    // 저장 버튼
    document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
    
    // 파일 입력 변경
    document.getElementById('modal_manual_file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileInfo = document.getElementById('fileInfo');
        
        if (file) {
            fileInfo.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-file-pdf me-2"></i>
                    선택된 파일: ${file.name} (${formatFileSize(file.size)})
                </div>
            `;
            fileInfo.style.display = 'block';
        } else {
            fileInfo.style.display = 'none';
        }
    });
}

// 파일 업로드 설정
function setupFileUpload() {
    const uploadArea = document.querySelector('.file-upload-area');
    const fileInput = document.getElementById('modal_manual_file');
    
    // 드래그 앤 드롭
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'application/pdf') {
            fileInput.files = files;
            fileInput.dispatchEvent(new Event('change'));
        } else {
            showAlert('PDF 파일만 업로드 가능합니다', 'warning');
        }
    });
}

// 뷰 모드 토글 설정
function setupViewModeToggle() {
    document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const tableView = document.getElementById('tableView');
            const cardView = document.getElementById('cardView');
            
            if (this.id === 'gridView') {
                tableView.style.display = 'block';
                cardView.style.display = 'none';
            } else {
                tableView.style.display = 'none';
                cardView.style.display = 'flex';
            }
            
            renderProducts();
        });
    });
}

// 유틸리티 함수들
function applyFilters() {
    renderProducts();
    updateCounters();
}

function updateCounters() {
    document.getElementById('productCount').textContent = filteredProducts.length;
    document.getElementById('tableCount').textContent = filteredProducts.length;
}

function showLoading(show) {
    document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
}

function formatPrice(price) {
    return new Intl.NumberFormat('ko-KR').format(price);
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showAlert(message, type = 'info') {
    // 부트스트랩 토스트 또는 간단한 alert 사용
    // 여기서는 간단하게 alert 사용
    if (type === 'error') {
        alert('오류: ' + message);
    } else if (type === 'success') {
        alert('성공: ' + message);
    } else if (type === 'warning') {
        alert('경고: ' + message);
    } else {
        alert('정보: ' + message);
    }
}
</script>
{% endblock %} 