{% extends 'base.html' %}

{% block page_title %}ì½”ë“œ ê´€ë¦¬{% endblock %}

{% block extra_css %}
<!-- HTML5 ë„¤ì´í‹°ë¸Œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì‚¬ìš© -->
<style>
    /* ë ˆê±°ì‹œ AdminController.csì™€ ë™ì¼í•œ êµ¬ì¡° */
    .child-code {
        background-color: #f8f9fa;
        display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ - ë ˆê±°ì‹œì™€ ë™ì¼ */
    }
    .parent-code {
        background-color: #fff;
        cursor: pointer;
        transition: background-color 0.15s ease;
    }
    .parent-code:hover {
        background-color: #e3f2fd;
    }
    .group-code {
        background-color: #fff3cd;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.15s ease;
    }
    .group-code:hover {
        background-color: #ffeaa7;
    }
    
    /* ê¹Šì´ë³„ ë°°ê²½ìƒ‰ (3ë‹¨ê³„ê¹Œì§€ë§Œ) */
    .depth-0 { 
        background-color: #fff9e6 !important; 
        font-weight: bold; 
    }
    .depth-1 { 
        background-color: #e8f4fd !important; 
    }
    .depth-2 { 
        background-color: #e8f5e8 !important; 
    }
    .depth-3 { 
        background-color: #f0f0f0 !important; 
    }
    
    /* ì½”ë“œ ì…€ì—ë§Œ ë“¤ì—¬ì“°ê¸° ì ìš© */
    .depth-0 .code-cell { padding-left: 8px !important; }
    .depth-1 .code-cell { padding-left: 32px !important; }
    .depth-2 .code-cell { padding-left: 56px !important; }
    .depth-3 .code-cell { padding-left: 80px !important; }
    
    /* í…Œì´ë¸” í—¤ë” ìŠ¤íƒ€ì¼ ê°•í™” - ì§„í•˜ê³  ì„ ëª…í•˜ê²Œ */
    .table-dark th {
        background-color: #212529 !important;
        color: #ffffff !important;
        font-weight: 900 !important;
        font-size: 14px !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important;
        border-color: #32383e !important;
    }
    
    /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ ê°•í™” */
    .sortable-row {
        cursor: move;
        transition: all 0.2s ease;
    }
    .sortable-row:hover {
        background-color: #f5f5f5 !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .drag-handle {
        cursor: grab !important;
        text-align: center;
        width: 30px;
        color: #999;
        transition: all 0.2s ease;
        padding: 8px !important;
        font-size: 16px !important;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }
    .drag-handle:hover {
        color: #007bff !important;
        background-color: #e3f2fd !important;
        cursor: grab !important;
        transform: scale(1.1);
    }
    .drag-handle:active {
        cursor: grabbing !important;
        color: #0056b3 !important;
        background-color: #bbdefb !important;
    }
    
    /* TableDnD ë“œë˜ê·¸ ì‹œ ìŠ¤íƒ€ì¼ ëŒ€í­ ê°•í™” */
    .tDnD_whileDrag {
        background-color: #fff3cd !important;
        border: 3px solid #ffc107 !important;
        opacity: 0.8 !important;
        box-shadow: 0 8px 16px rgba(255, 193, 7, 0.4) !important;
        transform: scale(1.05) !important;
        z-index: 9999 !important;
        font-weight: bold !important;
    }
    
    .tDnD_whileDrag td {
        background-color: #fff3cd !important;
        border-color: #ffc107 !important;
    }
    
    /* ë“œë˜ê·¸ ëŒ€ìƒ ìœ„ì¹˜ í‘œì‹œ ê°•í™” */
    .tDnD_insertMarker {
        background-color: #007bff !important;
        height: 4px !important;
        margin: 0 !important;
        border: none !important;
        box-shadow: 0 2px 4px rgba(0,123,255,0.5) !important;
    }
    
    /* ë“œë˜ê·¸ ì¤‘ì¸ í–‰ ìŠ¤íƒ€ì¼ ê°•í™” */
    .being-dragged {
        opacity: 0.6 !important;
        background-color: #e3f2fd !important;
        transform: scale(0.98) !important;
    }
    
    /* ë“œë˜ê·¸ í™œì„±í™” ìƒíƒœ */
    .dragging-active {
        cursor: grabbing !important;
    }
    
    .dragging-active .drag-handle {
        cursor: grabbing !important;
    }
    
    /* ìš°ì¸¡ íŒ¨ë„ ê°•ì¡° íš¨ê³¼ */
    .highlight-panel {
        border: 2px solid #007bff !important;
        box-shadow: 0 0 10px rgba(0,123,255,0.3) !important;
        background-color: #f8f9fa !important;
        transition: all 0.3s ease !important;
    }
    
    /* ë“œë¡­ ê°€ëŠ¥í•œ ì˜ì—­ í‘œì‹œ */
    .nodrag, .nodrop {
        cursor: default !important;
    }
    
    /* ì„ íƒëœ í–‰ ìŠ¤íƒ€ì¼ (ë ˆê±°ì‹œì™€ ë™ì¼) */
    .selected-row {
        background-color: #007bff !important;
        color: white !important;
    }
    .selected-row td {
        background-color: #007bff !important;
        color: white !important;
    }
    
    /* í† ê¸€ ì•„ì´ì½˜ */
    .toggle-icon {
        cursor: pointer;
        margin-right: 8px;
        transition: transform 0.2s ease;
        font-size: 12px;
        width: 16px;
        text-align: center;
        display: inline-block;
    }
    .toggle-icon.expanded {
        transform: rotate(90deg);
    }
    .toggle-icon.empty {
        visibility: hidden;
    }
    
    /* ê³„ì¸µ ì•„ì´ì½˜ */
    .hierarchy-icon {
        margin-right: 8px;
        width: 16px;
        text-align: center;
    }
    
    /* ì½”ë“œ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .code-text {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        color: #495057;
    }
    
    /* í¼ ìŠ¤íƒ€ì¼ */
    .form-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .stats-card {
        background: linear-gradient(45deg, #74b9ff, #0984e3);
        color: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom: none;
    }
    
    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-gradient {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border: none;
        color: white;
    }
    .btn-gradient:hover {
        background: linear-gradient(45deg, #764ba2, #667eea);
        color: white;
    }

    /* HTML5 ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
    .sortable-row[draggable="true"] {
        cursor: move;
        transition: all 0.2s ease;
    }
    
    .sortable-row[draggable="true"]:hover {
        background-color: #f5f5f5 !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* ë“œë˜ê·¸ ì¤‘ì¸ í–‰ ìŠ¤íƒ€ì¼ */
    .being-dragged {
        opacity: 0.5 !important;
        background-color: #fff3cd !important;
        border: 2px solid #ffc107 !important;
        transform: scale(0.95) !important;
        z-index: 1000 !important;
    }
    
    /* ë“œë¡­ íƒ€ê²Ÿ ìŠ¤íƒ€ì¼ */
    .drop-target {
        background-color: #e3f2fd !important;
        border-top: 4px solid #007bff !important;
        box-shadow: 0 4px 8px rgba(0,123,255,0.3) !important;
    }
    
    /* ë“œë˜ê·¸ í™œì„±í™” ìƒíƒœ */
    .dragging-active {
        cursor: grabbing !important;
    }
    
    .dragging-active * {
        cursor: grabbing !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- ì½”ë“œ ëª©ë¡ (ì™¼ìª½, 8ì»¬ëŸ¼) -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-code text-primary"></i> 
                        ì½”ë“œ ê´€ë¦¬ (ë ˆê±°ì‹œ í˜¸í™˜)
                    </h5>
                </div>
                <div class="card-body p-0">
                    <!-- í†µê³„ ì •ë³´ -->
                    <div class="stats-card m-3">
                        <div class="row text-center">
                            <div class="col">
                                <h6 class="mb-0" id="total-codes">{{ codes|length }}</h6>
                                <small>ì „ì²´ ì½”ë“œ</small>
                            </div>
                            <div class="col">
                                <h6 class="mb-0" id="depth-stats">-</h6>
                                <small>ìµœëŒ€ ê¹Šì´</small>
                            </div>
                            <div class="col">
                                <h6 class="mb-0" id="group-count">-</h6>
                                <small>ê·¸ë£¹ ìˆ˜</small>
                            </div>
                        </div>
                    </div>
    
                    <!-- ì½”ë“œ í…Œì´ë¸” -->
                    <div class="table-responsive">
                        <table id="codeTable" class="table table-sm table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th width="30">
                                        <i class="fas fa-grip-vertical" title="ë“œë˜ê·¸ ì•¤ ë“œë¡­"></i>
                                    </th>
                                    <th width="200">ì½”ë“œ</th>
                                    <th>ì½”ë“œëª…</th>
                                    <th width="150">ì„¤ëª…</th>
                                    <th width="60" class="text-center">ê¹Šì´</th>
                                    <th width="60" class="text-center">ìˆœì„œ</th>
                                    <th width="120" class="text-center">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody id="codeTableBody">
                                <!-- Root í–‰ (ë“œë˜ê·¸ ë¶ˆê°€) -->
                                <tr id="Root" class="parent-code nodrag nodrop group-code depth-0" 
                                    data-seq="0" data-depth="0" data-parent-seq="0">
                                    <td class="text-center">
                                        <i class="fas fa-anchor text-muted" title="ë£¨íŠ¸ (ê³ ì •)"></i>
                                    </td>
                                    <td class="depth-0 code-cell">
                                        <i class="toggle-icon fas fa-chevron-right" 
                                           data-seq="0" 
                                           data-depth="0"
                                           title="í•˜ìœ„ ì½”ë“œ í† ê¸€"></i>
                                        <i class="fas fa-folder-open hierarchy-icon text-warning"></i>
                                        <span class="code-text">ROOT</span>
                                    </td>
                                    <td class="depth-0 code-cell">
                                        <strong>ë£¨íŠ¸ (ìµœìƒìœ„)</strong>
                                    </td>
                                    <td class="depth-0 code-cell">
                                        <em>ì „ì²´ ì½”ë“œì˜ ë£¨íŠ¸</em>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-warning">0</span>
                                    </td>
                                    <td class="text-center">-</td>
                                    <td class="text-center">
                                        <button class="btn btn-outline-success btn-sm add-child-btn" 
                                                data-parent-seq="0" 
                                                data-depth="1" 
                                                title="ìµœìƒìœ„ ê·¸ë£¹ ì¶”ê°€">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                </tr>
                                
                                <!-- ë™ì  ì½”ë“œ ëª©ë¡ -->
                                {% for code in codes %}
                                {% if code.depth == 0 %}
                                <!-- ìµœìƒìœ„ ì½”ë“œ (depth=0)ëŠ” í•­ìƒ í‘œì‹œ -->
                                <tr class="sortable-row depth-row-{{ code.depth }} code-item group-code depth-{{ code.depth }}" 
                                    id="row-{{ code.seq }}" 
                                    data-seq="{{ code.seq }}" 
                                    data-depth="{{ code.depth }}" 
                                    data-parent-seq="{{ code.parent_seq or 0 }}"
                                    data-sort="{{ code.sort or 1 }}"
                                    data-has-children="false">
                                {% else %}
                                <!-- í•˜ìœ„ ì½”ë“œ (depth > 0)ëŠ” ì´ˆê¸°ì— ìˆ¨ê¹€ -->
                                <tr class="sortable-row depth-row-{{ code.depth }} code-item child-code depth-{{ code.depth }}" 
                                    id="row-{{ code.seq }}" 
                                    data-seq="{{ code.seq }}" 
                                    data-depth="{{ code.depth }}" 
                                    data-parent-seq="{{ code.parent_seq or 0 }}"
                                    data-sort="{{ code.sort or 1 }}"
                                    data-has-children="false"
                                    style="display: none;">
                                {% endif %}
                                    <td class="drag-handle">
                                        <i class="fas fa-grip-vertical" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½"></i>
                                    </td>
                                    <td class="depth-{{ code.depth }} code-cell">
                                        <!-- í† ê¸€ ì•„ì´ì½˜ -->
                                        <i class="toggle-icon fas fa-chevron-right" 
                                           data-seq="{{ code.seq }}" 
                                           data-depth="{{ code.depth }}"
                                           title="í•˜ìœ„ ì½”ë“œ í† ê¸€"></i>
                                        
                                        {% if code.depth == 0 %}
                                            <i class="fas fa-folder hierarchy-icon text-warning"></i>
                                        {% elif code.depth == 1 %}
                                            <i class="fas fa-folder-open hierarchy-icon text-info"></i>
                                        {% elif code.depth == 2 %}
                                            <i class="fas fa-file-alt hierarchy-icon text-success"></i>
                                        {% else %}
                                            <i class="fas fa-file hierarchy-icon text-secondary"></i>
                                        {% endif %}
                                        
                                        <span class="code-text">{{ code.code }}</span>
                                    </td>
                                    <td class="depth-{{ code.depth }} code-cell">{{ code.code_name }}</td>
                                    <td class="depth-{{ code.depth }} code-cell">{{ code.code_info or '-' }}</td>
                                    <td class="text-center">
                                        {% if code.depth == 0 %}
                                            <span class="badge bg-warning">{{ code.depth }}</span>
                                        {% elif code.depth == 1 %}
                                            <span class="badge bg-info">{{ code.depth }}</span>
                                        {% elif code.depth == 2 %}
                                            <span class="badge bg-success">{{ code.depth }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ code.depth }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center sort-number">{{ code.sort or 1 }}</td>
                                    <td class="code-actions">
                                        <div class="btn-group btn-group-sm">
                                            {% if code.depth < 3 %}
                                            <button class="btn btn-outline-success btn-sm add-child-btn" 
                                                    data-parent-seq="{{ code.seq }}" 
                                                    data-depth="{{ code.depth + 1 }}" 
                                                    title="í•˜ìœ„ ì½”ë“œ ì¶”ê°€">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-outline-primary btn-sm edit-code-btn" 
                                                    data-seq="{{ code.seq }}" 
                                                    title="ìˆ˜ì •">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm delete-code-btn" 
                                                    data-seq="{{ code.seq }}" 
                                                    title="ì‚­ì œ">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-muted">
                    <small>
                        <i class="fas fa-info-circle"></i>
                        í´ë¦­ìœ¼ë¡œ í•˜ìœ„ ì½”ë“œ í† ê¸€, ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½, í–‰ í´ë¦­ìœ¼ë¡œ ìš°ì¸¡ì— ìƒì„¸ì •ë³´ í‘œì‹œ
                    </small>
                </div>
            </div>
        </div>
        
        <!-- ì½”ë“œ ë“±ë¡/ìˆ˜ì • í¼ (ì˜¤ë¥¸ìª½, 4ì»¬ëŸ¼) -->
        <div class="col-md-4">
            <div class="card" id="codeFormSection">
                <div class="card-header bg-gradient text-white">
                    <h6 class="card-title mb-0" style="font-weight: 900; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                        <i class="fas fa-info-circle"></i>
                        <span id="form-title">ì½”ë“œ ì •ë³´</span>
                    </h6>
                </div>
                <div class="card-body">
                    <form id="codeForm">
                        <input type="hidden" id="edit_seq" name="edit_seq">
                        <input type="hidden" id="parent_seq" name="parent_seq" value="0">
                        <input type="hidden" id="depth" name="depth" value="1">
                        
                        <div class="mb-3">
                            <label for="parent_info" class="form-label">ìƒìœ„ ì½”ë“œ</label>
                            <input type="text" class="form-control" id="parent_info" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label for="code" class="form-label">ì½”ë“œ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="code" name="code" required maxlength="50">
                        </div>
                        
                        <div class="mb-3">
                            <label for="code_name" class="form-label">ì½”ë“œëª… <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="code_name" name="code_name" required maxlength="100">
                        </div>
                        
                        <div class="mb-3">
                            <label for="code_info" class="form-label">ì„¤ëª…</label>
                            <textarea class="form-control" id="code_info" name="code_info" rows="2" maxlength="255"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sort" class="form-label">ì •ë ¬ ìˆœì„œ</label>
                            <input type="number" class="form-control" id="sort" name="sort" value="1" min="1">
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-gradient" onclick="submitForm()">
                                <i class="fas fa-save"></i>
                                <span id="submit-text">ì €ì¥</span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="fas fa-times"></i>
                                ì´ˆê¸°í™”
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜ - JSON ë°ì´í„° ì•ˆì „í•˜ê²Œ ë¡œë“œ
var allCodes = [];
{% if codes %}
allCodes = {{ codes|tojson|safe }};
{% endif %}

$(document).ready(function() {
    console.log('ğŸ”§ ì½”ë“œ ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” (ë ˆê±°ì‹œ í˜¸í™˜ ëª¨ë“œ)');
    console.log('ğŸ“Š ë¡œë“œëœ ì½”ë“œ ìˆ˜:', allCodes.length);
    
    try {
        // 1. ê³„ì¸µ êµ¬ì¡° ì´ˆê¸°í™” (ì´ˆê¸°ì—ëŠ” ëª¨ë‘ ì ‘íŒ ìƒíƒœ)
        initializeHierarchy();
        
        // 2. ì´ë²¤íŠ¸ ë°”ì¸ë”©
        bindEvents();
        
        // 3. í†µê³„ ì—…ë°ì´íŠ¸
        updateStatistics();
        
        // 4. TableDnD ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ˆê¸°í™” (ì§€ì—° ë¡œë”©)
        setTimeout(function() {
            if (typeof $.fn.tableDnD === 'function') {
                initializeTableDnD();
                console.log('âœ… TableDnD ì´ˆê¸°í™” ì™„ë£Œ');
            } else {
                console.warn('âš ï¸ TableDnD ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                // ë‹¤ì‹œ ì‹œë„
                setTimeout(function() {
                    if (typeof $.fn.tableDnD === 'function') {
                        initializeTableDnD();
                    } else {
                        console.error('âŒ TableDnD ë¡œë“œ ì‹¤íŒ¨');
                    }
                }, 1000);
            }
        }, 500);
        
        console.log('âœ… ì½”ë“œ ê´€ë¦¬ ì´ˆê¸°í™” ì™„ë£Œ');
        
    } catch (error) {
        console.error('âŒ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
    }
});

// ê³„ì¸µ êµ¬ì¡° ì´ˆê¸°í™” (ë ˆê±°ì‹œì™€ ë™ì¼í•˜ê²Œ ì´ˆê¸°ì—ëŠ” ì ‘íŒ ìƒíƒœ)
function initializeHierarchy() {
    console.log('ğŸŒ³ ê³„ì¸µ êµ¬ì¡° ì´ˆê¸°í™”');
    
    // í•˜ìœ„ ì½”ë“œê°€ ìˆëŠ” ë¶€ëª¨ë“¤ì˜ í† ê¸€ ì•„ì´ì½˜ í‘œì‹œ
    allCodes.forEach(function(code) {
        var hasChildren = allCodes.some(function(child) {
            return child.parent_seq === code.seq;
        });
        if (hasChildren) {
            updateToggleIcon(code.seq, code.depth, hasChildren);
        }
    });
    
    // Rootì˜ í† ê¸€ ì•„ì´ì½˜ í‘œì‹œ  
    var hasRootChildren = allCodes.some(function(code) {
        return (code.parent_seq === 0 || !code.parent_seq) && code.depth === 0;
    });
    if (hasRootChildren) {
        updateToggleIcon(0, 0, true);
    }
    
    console.log('âœ… ê³„ì¸µ êµ¬ì¡° ì´ˆê¸°í™” ì™„ë£Œ');
}

// ì´ë²¤íŠ¸ ë°”ì¸ë”©
function bindEvents() {
    console.log('ğŸ”— ì´ë²¤íŠ¸ ë°”ì¸ë”©');
    
    // í† ê¸€ í´ë¦­ ì´ë²¤íŠ¸ (ê³„ì¸µ êµ¬ì¡° ìˆ˜ì •)
    $(document).off('click', '.toggle-icon').on('click', '.toggle-icon:not(.empty)', function(e) {
        e.stopPropagation();
        var parentSeq = $(this).data('seq');
        var $icon = $(this);
        var isExpanded = $icon.hasClass('expanded');
        
        console.log('ğŸ”„ í† ê¸€ í´ë¦­:', parentSeq, 'í¼ì¹¨ìƒíƒœ:', isExpanded);
        
        if (isExpanded) {
            // ì ‘ê¸° - í•´ë‹¹ ë¶€ëª¨ì˜ ì§ê³„ ìì‹ë“¤ë§Œ ìˆ¨ê¹€
            hideChildren(parentSeq);
            $icon.removeClass('expanded');
        } else {
            // í¼ì¹˜ê¸° - í•´ë‹¹ ë¶€ëª¨ì˜ ì§ê³„ ìì‹ë“¤ë§Œ í‘œì‹œ
            showChildren(parentSeq);
            $icon.addClass('expanded');
        }
    });
    
    // ì½”ë“œ í–‰ í´ë¦­ ì´ë²¤íŠ¸ (ìš°ì¸¡ì— ì •ë³´ í‘œì‹œ)
    $(document).off('click', '.code-item').on('click', '.code-item', function(e) {
        if ($(e.target).closest('.code-actions, .toggle-icon, .drag-handle').length) {
            return; // ë²„íŠ¼ì´ë‚˜ í† ê¸€, ë“œë˜ê·¸ í•¸ë“¤ í´ë¦­ì€ ì œì™¸
        }
        
        // ì„ íƒ ìƒíƒœ í† ê¸€
        $('.code-item').removeClass('selected-row');
        $(this).addClass('selected-row');
        
        // ìš°ì¸¡ì— í•´ë‹¹ ì½”ë“œ ì •ë³´ í‘œì‹œ
        var seq = $(this).data('seq');
        console.log('ğŸ¯ ì½”ë“œ í–‰ í´ë¦­:', seq);
        showCodeInfo(seq);
    });
    
    // ë²„íŠ¼ ì´ë²¤íŠ¸ë“¤
    $(document).off('click', '.add-child-btn').on('click', '.add-child-btn', function(e) {
        e.stopPropagation();
        var parentSeq = $(this).data('parent-seq');
        var depth = $(this).data('depth');
        showAddForm(parentSeq, depth);
    });
    
    $(document).off('click', '.edit-code-btn').on('click', '.edit-code-btn', function(e) {
        e.stopPropagation();
        var seq = $(this).data('seq');
        showEditForm(seq);
    });
    
    $(document).off('click', '.delete-code-btn').on('click', '.delete-code-btn', function(e) {
        e.stopPropagation();
        var seq = $(this).data('seq');
        if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            deleteCode(seq);
        }
    });
    
    console.log('âœ… ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ');
}

// í•˜ìœ„ ì½”ë“œ í‘œì‹œ í•¨ìˆ˜ (ì •í™•í•œ ê³„ì¸µ êµ¬ì¡°)
function showChildren(parentSeq) {
    console.log('ğŸ“‚ í•˜ìœ„ ì½”ë“œ í‘œì‹œ:', parentSeq);
    
    // í•´ë‹¹ ë¶€ëª¨ì˜ ì§ê³„ ìì‹ë“¤ë§Œ ì°¾ê¸°
    var directChildren = allCodes.filter(function(code) {
        return code.parent_seq === parentSeq;
    });
    
    console.log('ì§ê³„ ìì‹ ìˆ˜:', directChildren.length);
    
    // ë¶€ëª¨ í–‰ ì°¾ê¸°
    var $parentRow = $('#row-' + parentSeq);
    if (parentSeq === 0) {
        $parentRow = $('#Root');
    }
    
    // ì§ê³„ ìì‹ë“¤ì„ ë¶€ëª¨ ë°”ë¡œ ë‹¤ìŒì— ì‚½ì…
    directChildren.forEach(function(child) {
        var $childRow = $('#row-' + child.seq);
        if ($childRow.length) {
            $childRow.detach(); // ê¸°ì¡´ ìœ„ì¹˜ì—ì„œ ì œê±°
            $parentRow.after($childRow); // ë¶€ëª¨ ë°”ë¡œ ë‹¤ìŒì— ì‚½ì…
            $childRow.show(); // í‘œì‹œ
            $parentRow = $childRow; // ë‹¤ìŒ ìì‹ì„ ìœ„í•´ ì—…ë°ì´íŠ¸
        }
    });
}

// í•˜ìœ„ ì½”ë“œ ìˆ¨ê¹€ í•¨ìˆ˜ (ì¬ê·€ì ìœ¼ë¡œ ëª¨ë“  í›„ì† ìˆ¨ê¹€)
function hideChildren(parentSeq) {
    console.log('ğŸ“ í•˜ìœ„ ì½”ë“œ ìˆ¨ê¹€:', parentSeq);
    
    // ì¬ê·€ì ìœ¼ë¡œ ëª¨ë“  í›„ì† ì°¾ê¸°
    function findAllDescendants(seq) {
        var descendants = [];
        var directChildren = allCodes.filter(function(code) {
            return code.parent_seq === seq;
        });
        
        directChildren.forEach(function(child) {
            descendants.push(child);
            descendants = descendants.concat(findAllDescendants(child.seq));
        });
        
        return descendants;
    }
    
    var allDescendants = findAllDescendants(parentSeq);
    console.log('ëª¨ë“  í›„ì† ìˆ˜:', allDescendants.length);
    
    // ëª¨ë“  í›„ì† ìˆ¨ê¹€
    allDescendants.forEach(function(descendant) {
        var $row = $('#row-' + descendant.seq);
        $row.hide();
        
        // í›„ì†ì˜ í† ê¸€ ì•„ì´ì½˜ë„ ì ‘íŒ ìƒíƒœë¡œ ë³€ê²½
        var $icon = $('.toggle-icon[data-seq="' + descendant.seq + '"]');
        $icon.removeClass('expanded');
    });
}

// HTML5 ë„¤ì´í‹°ë¸Œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ êµ¬í˜„ (TableDnD ëŒ€ì‹ )
function initializeTableDnD() {
    console.log('ğŸ”§ HTML5 ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ˆê¸°í™” ì‹œì‘...');
    
    // ëª¨ë“  ë“œë˜ê·¸ ê°€ëŠ¥í•œ í–‰ ì„¤ì •
    $('.sortable-row').each(function() {
        var $row = $(this);
        $row.attr('draggable', 'true');
        
        // ë“œë˜ê·¸ ì‹œì‘
        $row.on('dragstart', function(e) {
            var seq = $(this).data('seq');
            console.log('ğŸ¯ ë“œë˜ê·¸ ì‹œì‘ - SEQ:', seq);
            
            // ë“œë˜ê·¸ ë°ì´í„° ì„¤ì •
            e.originalEvent.dataTransfer.setData('text/plain', seq);
            e.originalEvent.dataTransfer.effectAllowed = 'move';
            
            // ì‹œê°ì  íš¨ê³¼
            $(this).addClass('being-dragged');
            $('body').addClass('dragging-active');
            
            // ë“œë˜ê·¸ ì´ë¯¸ì§€ ì„¤ì • (ì„ íƒì‚¬í•­)
            var dragImage = $(this).clone();
            dragImage.css({
                'position': 'absolute',
                'top': '-1000px',
                'background-color': '#fff3cd',
                'border': '2px solid #ffc107',
                'opacity': '0.8'
            });
            $('body').append(dragImage);
            e.originalEvent.dataTransfer.setDragImage(dragImage[0], 0, 0);
            
            setTimeout(function() {
                dragImage.remove();
            }, 0);
        });
        
        // ë“œë˜ê·¸ ì¤‘
        $row.on('dragover', function(e) {
            e.preventDefault();
            e.originalEvent.dataTransfer.dropEffect = 'move';
            
            // ë“œë¡­ ìœ„ì¹˜ í‘œì‹œ
            $(this).addClass('drop-target');
        });
        
        // ë“œë˜ê·¸ ë²—ì–´ë‚¨
        $row.on('dragleave', function(e) {
            $(this).removeClass('drop-target');
        });
        
        // ë“œë¡­
        $row.on('drop', function(e) {
            e.preventDefault();
            var draggedSeq = e.originalEvent.dataTransfer.getData('text/plain');
            var targetSeq = $(this).data('seq');
            
            console.log('ğŸ¯ ë“œë¡­ ì™„ë£Œ - ë“œë˜ê·¸ëœ SEQ:', draggedSeq, '-> íƒ€ê²Ÿ SEQ:', targetSeq);
            
            // ì‹œê°ì  íš¨ê³¼ ì œê±°
            $('.being-dragged').removeClass('being-dragged');
            $('.drop-target').removeClass('drop-target');
            $('body').removeClass('dragging-active');
            
            // ìˆœì„œ ë³€ê²½ ì²˜ë¦¬
            if (draggedSeq !== targetSeq) {
                handleNativeDragDrop(draggedSeq, targetSeq);
            }
        });
        
        // ë“œë˜ê·¸ ë
        $row.on('dragend', function(e) {
            console.log('ğŸ ë“œë˜ê·¸ ì¢…ë£Œ');
            $('.being-dragged').removeClass('being-dragged');
            $('.drop-target').removeClass('drop-target');
            $('body').removeClass('dragging-active');
        });
    });
    
    // ë“œë˜ê·¸ í•¸ë“¤ ì„¤ì •
    $('.drag-handle').each(function() {
        $(this).css({
            'cursor': 'grab',
            'user-select': 'none'
        });
        
        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
        $(this).on('mouseenter', function() {
            console.log('ğŸ¯ ë“œë˜ê·¸ í•¸ë“¤ì— ë§ˆìš°ìŠ¤ ì§„ì…');
            $(this).css('background-color', '#e3f2fd');
        }).on('mouseleave', function() {
            $(this).css('background-color', '');
        }).on('mousedown', function() {
            $(this).css('cursor', 'grabbing');
        }).on('mouseup', function() {
            $(this).css('cursor', 'grab');
        });
    });
    
    console.log('âœ… HTML5 ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ˆê¸°í™” ì™„ë£Œ');
    console.log('ğŸ® ë“œë˜ê·¸ ê°€ëŠ¥í•œ í–‰ ê°œìˆ˜:', $('.sortable-row').length);
}

// ë„¤ì´í‹°ë¸Œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬ í•¨ìˆ˜
function handleNativeDragDrop(draggedSeq, targetSeq) {
    console.log('ğŸ”„ ìˆœì„œ ë³€ê²½ ì²˜ë¦¬:', draggedSeq, '->', targetSeq);
    
    var $draggedRow = $('#row-' + draggedSeq);
    var $targetRow = $('#row-' + targetSeq);
    
    if ($draggedRow.length === 0 || $targetRow.length === 0) {
        console.error('âŒ ë“œë˜ê·¸ëœ í–‰ ë˜ëŠ” íƒ€ê²Ÿ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    
    var draggedDepth = parseInt($draggedRow.data('depth'));
    var draggedParent = parseInt($draggedRow.data('parent-seq'));
    var targetDepth = parseInt($targetRow.data('depth'));
    var targetParent = parseInt($targetRow.data('parent-seq'));
    
    // ê°™ì€ ë¶€ëª¨ì˜ ê°™ì€ ê¹Šì´ì¸ì§€ í™•ì¸
    if (draggedDepth !== targetDepth || draggedParent !== targetParent) {
        alert('ê°™ì€ ê·¸ë£¹ ë‚´ì—ì„œë§Œ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    // DOMì—ì„œ í–‰ ì´ë™
    $draggedRow.detach();
    $targetRow.after($draggedRow);
    
    // ì‹œê°ì  íš¨ê³¼
    $draggedRow.css('background-color', '#d4edda');
    setTimeout(function() {
        $draggedRow.css('background-color', '');
    }, 1000);
    
    // ìƒˆë¡œìš´ ìˆœì„œ ê³„ì‚°
    var parentSeq = draggedParent;
    var depth = draggedDepth;
    var $siblings = $('tr[data-parent-seq="' + parentSeq + '"][data-depth="' + depth + '"]:visible');
    var newOrder = [];
    
    $siblings.each(function(index) {
        var siblingSeq = parseInt($(this).data('seq'));
        newOrder.push(siblingSeq);
        $(this).find('.sort-number').text(index + 1);
    });
    
    console.log('ìƒˆë¡œìš´ ìˆœì„œ:', newOrder);
    
    // ì„œë²„ì— ìˆœì„œ ë³€ê²½ ì €ì¥
    $.ajax({
        url: "/admin/api/codes/update-sort",
        method: "POST",
        data: {
            parent_seq: parentSeq,
            depth: depth,
            order: JSON.stringify(newOrder)
        },
        success: function(data) {
            if (data.success) {
                console.log('âœ… ìˆœì„œ ë³€ê²½ ì €ì¥ ì™„ë£Œ');
                // ì„±ê³µ ì•Œë¦¼
                showNotification('ìˆœì„œê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                alert("ìˆœì„œ ë³€ê²½ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + (data.message || ''));
                location.reload();
            }
        },
        error: function() {
            alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            location.reload();
        }
    });
}

// ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
function showNotification(message, type) {
    var notification = $('<div class="alert alert-' + (type === 'success' ? 'success' : 'danger') + ' alert-dismissible fade show" style="position: fixed; top: 20px; right: 20px; z-index: 10000;">' +
        '<strong>' + message + '</strong>' +
        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
        '</div>');
    
    $('body').append(notification);
    
    setTimeout(function() {
        notification.alert('close');
    }, 3000);
}

// í† ê¸€ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
function updateToggleIcon(seq, depth, hasChildren) {
    var $icon = $('.toggle-icon[data-seq="' + seq + '"]');
    
    if (hasChildren === undefined || hasChildren === null) {
        hasChildren = allCodes.some(function(code) {
            return code.parent_seq === seq;
        });
    }
    
    if (hasChildren) {
        $icon.removeClass('empty').show();
    } else {
        $icon.addClass('empty').hide();
    }
}

// í†µê³„ ì—…ë°ì´íŠ¸
function updateStatistics() {
    var depths = allCodes.map(function(code) { return code.depth; });
    var maxDepth = Math.max.apply(Math, depths.concat([0]));
    var groupCount = allCodes.filter(function(code) { return code.depth === 0; }).length;
    
    $('#total-codes').text(allCodes.length);
    $('#depth-stats').text(maxDepth);
    $('#group-count').text(groupCount);
}

// ìš°ì¸¡ì— ì½”ë“œ ì •ë³´ í‘œì‹œ
function showCodeInfo(seq) {
    var code = allCodes.find(function(c) { return c.seq == seq; });
    if (!code) {
        resetForm();
        $('#form-title').text('ì½”ë“œ ì •ë³´');
        return;
    }
    
    // í¸ì§‘ ëª¨ë“œë¡œ í¼ ì±„ìš°ê¸°
    $('#edit_seq').val(seq);
    $('#parent_seq').val(code.parent_seq || 0);
    $('#depth').val(code.depth);
    $('#code').val(code.code);
    $('#code_name').val(code.code_name);
    $('#code_info').val(code.code_info || '');
    $('#sort').val(code.sort || 1);
    
    $('#form-title').text(`ì½”ë“œ ì •ë³´: ${code.code} - ${code.code_name}`);
    $('#submit-text').text('ìˆ˜ì •');
    
    // ìš°ì¸¡ íŒ¨ë„ ê°•ì¡° í‘œì‹œ
    $('#codeFormSection').addClass('highlight-panel');
    setTimeout(function() {
        $('#codeFormSection').removeClass('highlight-panel');
    }, 1500);
    
    // ìƒìœ„ ì½”ë“œ ì •ë³´ í‘œì‹œ
    if (code.parent_seq == 0 || !code.parent_seq) {
        $('#parent_info').val('Root (ìµœìƒìœ„)');
    } else {
        var parentCode = allCodes.find(function(c) { return c.seq == code.parent_seq; });
        if (parentCode) {
            $('#parent_info').val(parentCode.code + ' - ' + parentCode.code_name);
        }
    }
    
    console.log('ğŸ“ ì½”ë“œ ì •ë³´ í‘œì‹œ:', code.code);
}

// í¼ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜ë“¤
function showAddForm(parentSeq, depth) {
    resetForm();
    
    $('#parent_seq').val(parentSeq);
    $('#depth').val(depth);
    $('#form-title').text('ì½”ë“œ ì¶”ê°€ (Depth ' + depth + ')');
    $('#submit-text').text('ì¶”ê°€');
    
    // ìƒìœ„ ì½”ë“œ ì •ë³´ í‘œì‹œ
    if (parentSeq == 0) {
        $('#parent_info').val('Root (ìµœìƒìœ„)');
    } else {
        var parentCode = allCodes.find(function(c) { return c.seq == parentSeq; });
        if (parentCode) {
            $('#parent_info').val(parentCode.code + ' - ' + parentCode.code_name);
        }
    }
}

function showEditForm(seq) {
    showCodeInfo(seq); // ë™ì¼í•œ ë¡œì§ ì‚¬ìš©
}

function resetForm() {
    $('#codeForm')[0].reset();
    $('#edit_seq').val('');
    $('#parent_seq').val('0');
    $('#depth').val('1');
    $('#sort').val('1');
    $('#form-title').text('ì½”ë“œ ì •ë³´');
    $('#submit-text').text('ì €ì¥');
    $('#parent_info').val('');
    $('.code-item').removeClass('selected-row');
}

// í¼ ì œì¶œ
function submitForm() {
    var formData = new FormData($('#codeForm')[0]);
    var isEdit = $('#edit_seq').val() !== '';
    
    var url = isEdit ? '/admin/api/codes/update' : '/admin/api/codes/create';
    
    $.ajax({
        url: url,
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                alert(isEdit ? 'ì½”ë“œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì½”ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ê°„ë‹¨í•˜ê²Œ ì²˜ë¦¬
            } else {
                alert('ì˜¤ë¥˜: ' + (response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        },
        error: function() {
            alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
}

// ì½”ë“œ ì‚­ì œ
function deleteCode(seq) {
    $.ajax({
        url: '/admin/api/codes/delete',
        method: 'POST',
        data: { seq: seq },
        success: function(response) {
            if (response.success) {
                alert('ì½”ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            } else {
                alert('ì˜¤ë¥˜: ' + (response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        },
        error: function() {
            alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
}
</script>
{% endblock %}