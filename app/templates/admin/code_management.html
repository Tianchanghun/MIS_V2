{% extends 'base.html' %}

{% block page_title %}코드 관리{% endblock %}

{% block extra_css %}
<style>
    .child-code {
        display: none;
        background-color: #f8f9fa;
    }
    .parent-code {
        background-color: #fff;
        cursor: pointer;
    }
    .parent-code:hover {
        background-color: #e3f2fd;
    }
    .group-code {
        background-color: #fff3cd;
        cursor: pointer;
        font-weight: bold;
    }
    .group-code:hover {
        background-color: #ffeaa7;
    }
    .code-actions {
        white-space: nowrap;
    }
    #code-insert-panel {
        display: none;
    }
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }
    /* 컬럼 폭 고정 */
    #codeTable {
        table-layout: fixed;
        width: 100%;
    }
    #codeTable th:nth-child(1) { width: 15%; }  /* 드래그 핸들 */
    #codeTable th:nth-child(2) { width: 20%; }  /* 코드 */
    #codeTable th:nth-child(3) { width: 25%; }  /* 코드명 */
    #codeTable th:nth-child(4) { width: 25%; }  /* 설명 */
    #codeTable th:nth-child(5) { width: 8%; }   /* 깊이 */
    #codeTable th:nth-child(6) { width: 7%; }   /* 정렬 */
    
    .table tr.selected {
        background-color: #d1ecf1 !important;
    }
    
    /* 계층별 들여쓰기 */
    .depth-0 { padding-left: 8px; }
    .depth-1 { padding-left: 24px; }
    .depth-2 { padding-left: 40px; }
    .depth-3 { padding-left: 56px; }
    
    /* 드래그 앤 드롭 스타일 */
    .sortable-row {
        cursor: move;
    }
    .ui-sortable-helper {
        background-color: #fff3cd !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        border: 2px solid #ffc107;
    }
    .ui-sortable-placeholder {
        background-color: #e3f2fd !important;
        border: 2px dashed #2196f3;
        height: 40px;
        visibility: visible !important;
    }
    .drag-handle {
        cursor: move;
        color: #6c757d;
        font-size: 14px;
    }
    .drag-handle:hover {
        color: #495057;
    }
    .sort-number {
        font-weight: bold;
        color: #007bff;
        min-width: 30px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-code"></i> 코드 관리</h2>
        <button class="btn btn-primary add-child-btn" data-parent-seq="0" data-depth="0">
            <i class="fas fa-plus"></i> 코드 그룹 추가
        </button>
    </div>
    
    <div class="row">
        <!-- 좌측: 코드 목록 (7컬럼) -->
        <div class="col-md-7">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> 코드 그룹 목록
                    </h5>
                    <small class="text-muted">상위 코드를 클릭하면 하위 코드가 표시됩니다.</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm" id="codeTable">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="fas fa-arrows-alt"></i></th>
                                    <th>코드</th>
                                    <th>코드명</th>
                                    <th>설명</th>
                                    <th>깊이</th>
                                    <th>순서</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="sortableCodeList">
                                <!-- Root 행 -->
                                <tr class="parent-code" id="Root" data-seq="0" data-depth="0" data-parent-seq="0">
                                    <td><i class="fas fa-lock text-muted" title="이동 불가"></i></td>
                                    <td><i class="fas fa-home text-primary"></i></td>
                                    <td><strong>Root</strong></td>
                                    <td>최상위 코드</td>
                                    <td>0</td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                                {% for code in codes %}
                                <tr class="sortable-row {{ 'parent-code' if code.depth == 0 else ('group-code' if code.depth == 1 else 'child-code') }}" 
                                    id="row-{{ code.seq }}" 
                                    data-seq="{{ code.seq }}" 
                                    data-depth="{{ code.depth }}" 
                                    data-parent-seq="{{ code.parent_seq or 0 }}"
                                    data-sort="{{ code.sort or 1 }}">
                                    <td class="drag-handle">
                                        <i class="fas fa-grip-vertical" title="드래그하여 순서 변경"></i>
                                    </td>
                                    <td class="depth-{{ code.depth }}">
                                        {% if code.depth == 0 %}
                                            <i class="fas fa-folder text-warning"></i>
                                        {% elif code.depth == 1 %}
                                            <i class="fas fa-folder-open text-info"></i>
                                        {% else %}
                                            <i class="fas fa-file text-secondary"></i>
                                        {% endif %}
                                        <strong>{{ code.code }}</strong>
                                    </td>
                                    <td class="depth-{{ code.depth }}">{{ code.code_name }}</td>
                                    <td class="depth-{{ code.depth }}">{{ code.code_info or '-' }}</td>
                                    <td class="text-center">{{ code.depth }}</td>
                                    <td class="text-center sort-number">{{ code.sort or 1 }}</td>
                                    <td class="code-actions">
                                        <div class="btn-group btn-group-sm">
                                            {% if code.depth < 2 %}
                                            <button class="btn btn-outline-success btn-sm add-child-btn" data-parent-seq="{{ code.seq }}" data-depth="{{ code.depth + 1 }}" title="하위 코드 추가">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-outline-primary btn-sm edit-code-btn" data-seq="{{ code.seq }}" title="수정">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm delete-code-btn" data-seq="{{ code.seq }}" title="삭제">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 우측: 코드 등록 폼 (5컬럼) -->
        <div class="col-md-5" id="rightPanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle"></i> <span id="form-title">코드 등록</span>
                    </h5>
                </div>
                <div class="card-body">
                    <form id="codeForm">
                        <input type="hidden" id="parent_seq" name="parent_seq" value="0">
                        <input type="hidden" id="depth" name="depth" value="0">
                        <input type="hidden" id="edit_seq" name="edit_seq" value="">
                        
                        <div class="mb-3">
                            <label for="code" class="form-label">코드 *</label>
                            <input type="text" class="form-control" id="code" name="code" required 
                                   placeholder="예: USER, DEPT, MENU">
                        </div>
                        
                        <div class="mb-3">
                            <label for="code_name" class="form-label">코드명 *</label>
                            <input type="text" class="form-control" id="code_name" name="code_name" required 
                                   placeholder="예: 사용자, 부서, 메뉴">
                        </div>
                        
                        <div class="mb-3">
                            <label for="code_info" class="form-label">코드 설명</label>
                            <textarea class="form-control" id="code_info" name="code_info" rows="3" 
                                      placeholder="코드에 대한 상세 설명을 입력하세요"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sort" class="form-label">정렬 순서</label>
                            <input type="number" class="form-control" id="sort" name="sort" value="1" min="1">
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> 저장
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 하위 코드 조회 모달 -->
<div class="modal fade" id="childCodesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">하위 코드 목록</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="childCodesContent">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> 로딩 중...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('✅ 코드 관리 페이지 시작');
    
    // 초기 설정
    setupInitialView();
    setupEventHandlers();
    
    console.log('✅ 코드 관리 페이지 초기화 완료');
});

// 초기 화면 설정
function setupInitialView() {
    // 모든 하위 코드 숨기기
    $('tr[data-depth]').each(function() {
        const depth = parseInt($(this).data('depth'));
        if (depth > 0) {
            $(this).hide();
        }
    });
    
    // depth 0만 표시
    $('tr[data-depth="0"]').show();
    
    console.log('✅ 초기 화면 설정 완료');
}

// 이벤트 핸들러 설정
function setupEventHandlers() {
    // 코드 행 클릭
    $(document).on('click', '.parent-code, .group-code', function(e) {
        e.preventDefault();
        const seq = $(this).data('seq');
        const depth = $(this).data('depth');
        
        console.log('코드 클릭:', seq, 'depth:', depth);
        
        if (seq && seq > 0) {
            showCodeInfo(seq);
        }
        
        if (depth === 0) {
            toggleChildren(seq);
        }
    });
    
    // 버튼 클릭
    $(document).on('click', '.add-child-btn', function() {
        const parentSeq = $(this).data('parent-seq');
        const depth = $(this).data('depth');
        console.log('하위 코드 추가:', parentSeq, depth);
        alert('하위 코드 추가 기능은 개발 예정입니다.');
    });
    
    $(document).on('click', '.edit-code-btn', function() {
        const seq = $(this).data('seq');
        console.log('코드 수정:', seq);
        alert('코드 수정 기능은 개발 예정입니다.');
    });
    
    $(document).on('click', '.delete-code-btn', function() {
        const seq = $(this).data('seq');
        console.log('코드 삭제:', seq);
        if (confirm('정말 삭제하시겠습니까?')) {
            alert('코드 삭제 기능은 개발 예정입니다.');
        }
    });
}

// 하위 항목 토글
function toggleChildren(parentSeq) {
    const parentRow = $(`.sortable-row[data-seq="${parentSeq}"]`);
    const childRows = $(`tr[data-parent-seq="${parentSeq}"]`);
    const isExpanded = parentRow.hasClass('expanded');
    
    if (isExpanded) {
        // 축소
        childRows.hide();
        parentRow.removeClass('expanded');
        console.log('축소:', parentSeq);
    } else {
        // 확장
        childRows.show();
        parentRow.addClass('expanded');
        console.log('확장:', parentSeq);
    }
}

// 코드 정보 표시
function showCodeInfo(seq) {
    console.log('코드 정보 조회:', seq);
    
    $('#rightPanel').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> 로딩 중...</div>');
    
    $.ajax({
        url: '/admin/api/codes/get',
        method: 'POST',
        data: { seq: seq },
        success: function(data) {
            if (data.success && data.data) {
                displayCodeInfo(data.data);
            } else {
                $('#rightPanel').html('<div class="alert alert-warning">코드 정보를 불러올 수 없습니다.</div>');
            }
        },
        error: function() {
            $('#rightPanel').html('<div class="alert alert-danger">오류가 발생했습니다.</div>');
        }
    });
}

// 코드 정보 표시
function displayCodeInfo(code) {
    const html = `
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>코드 정보</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">코드</label>
                    <input type="text" class="form-control" value="${code.code || ''}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">코드명</label>
                    <input type="text" class="form-control" value="${code.code_name || ''}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">설명</label>
                    <textarea class="form-control" rows="3" readonly>${code.code_info || ''}</textarea>
                </div>
                <div class="row">
                    <div class="col-6">
                        <label class="form-label">깊이</label>
                        <input type="text" class="form-control" value="${code.depth || 0}" readonly>
                    </div>
                    <div class="col-6">
                        <label class="form-label">순서</label>
                        <input type="text" class="form-control" value="${code.sort || 1}" readonly>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('#rightPanel').html(html);
}
</script>
{% endblock %}