{% extends 'base.html' %}

{% block page_title %}코드 관리{% endblock %}

{% block extra_css %}
<style>
    .child-code {
        display: none;
        background-color: #f8f9fa;
    }
    .parent-code {
        background-color: #fff;
        cursor: pointer;
    }
    .parent-code:hover {
        background-color: #e3f2fd;
    }
    .group-code {
        background-color: #fff3cd;
        cursor: pointer;
        font-weight: bold;
    }
    .group-code:hover {
        background-color: #ffeaa7;
    }
    .code-actions {
        white-space: nowrap;
    }
    #code-insert-panel {
        display: none;
    }
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }
    /* 컬럼 폭 고정 */
    #codeTable {
        table-layout: fixed;
        width: 100%;
    }
    #codeTable th:nth-child(1) { width: 15%; }  /* 드래그 핸들 */
    #codeTable th:nth-child(2) { width: 20%; }  /* 코드 */
    #codeTable th:nth-child(3) { width: 25%; }  /* 코드명 */
    #codeTable th:nth-child(4) { width: 25%; }  /* 설명 */
    #codeTable th:nth-child(5) { width: 8%; }   /* 깊이 */
    #codeTable th:nth-child(6) { width: 7%; }   /* 정렬 */
    
    .table tr.selected {
        background-color: #d1ecf1 !important;
    }
    
    /* 계층별 들여쓰기 */
    .depth-0 { padding-left: 8px; }
    .depth-1 { padding-left: 24px; }
    .depth-2 { padding-left: 40px; }
    .depth-3 { padding-left: 56px; }
    
    /* 드래그 앤 드롭 스타일 */
    .sortable-row {
        cursor: move;
    }
    .ui-sortable-helper {
        background-color: #fff3cd !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        border: 2px solid #ffc107;
    }
    .ui-sortable-placeholder {
        background-color: #e3f2fd !important;
        border: 2px dashed #2196f3;
        height: 40px;
        visibility: visible !important;
    }
    .drag-handle {
        cursor: move;
        color: #6c757d;
        font-size: 14px;
    }
    .drag-handle:hover {
        color: #495057;
    }
    .sort-number {
        font-weight: bold;
        color: #007bff;
        min-width: 30px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-code"></i> 코드 관리</h2>
        <button class="btn btn-primary" onclick="showInsertPanel(0, 0)">
            <i class="fas fa-plus"></i> 코드 그룹 추가
        </button>
    </div>
    
    <div class="row">
        <!-- 좌측: 코드 목록 (7컬럼) -->
        <div class="col-md-7">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> 코드 그룹 목록
                    </h5>
                    <small class="text-muted">상위 코드를 클릭하면 하위 코드가 표시됩니다.</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm" id="codeTable">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="fas fa-arrows-alt"></i></th>
                                    <th>코드</th>
                                    <th>코드명</th>
                                    <th>설명</th>
                                    <th>깊이</th>
                                    <th>순서</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="sortableCodeList">
                                <!-- Root 행 -->
                                <tr class="parent-code" id="Root" data-seq="0" data-depth="0" data-parent-seq="0">
                                    <td><i class="fas fa-lock text-muted" title="이동 불가"></i></td>
                                    <td><i class="fas fa-home text-primary"></i></td>
                                    <td><strong>Root</strong></td>
                                    <td>최상위 코드</td>
                                    <td>0</td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                                {% for code in codes %}
                                <tr class="sortable-row {{ 'parent-code' if code.depth == 0 else ('group-code' if code.depth == 1 else 'child-code') }}" 
                                    id="row-{{ code.seq }}" 
                                    data-seq="{{ code.seq }}" 
                                    data-depth="{{ code.depth }}" 
                                    data-parent-seq="{{ code.parent_seq or 0 }}"
                                    data-sort="{{ code.sort or 1 }}">
                                    <td class="drag-handle">
                                        <i class="fas fa-grip-vertical" title="드래그하여 순서 변경"></i>
                                    </td>
                                    <td class="depth-{{ code.depth }}">
                                        {% if code.depth == 0 %}
                                            <i class="fas fa-folder text-warning"></i>
                                        {% elif code.depth == 1 %}
                                            <i class="fas fa-folder-open text-info"></i>
                                        {% else %}
                                            <i class="fas fa-file text-secondary"></i>
                                        {% endif %}
                                        <strong>{{ code.code }}</strong>
                                    </td>
                                    <td class="depth-{{ code.depth }}">{{ code.code_name }}</td>
                                    <td class="depth-{{ code.depth }}">{{ code.code_info or '-' }}</td>
                                    <td class="text-center">{{ code.depth }}</td>
                                    <td class="text-center sort-number">{{ code.sort or 1 }}</td>
                                    <td class="code-actions">
                                        <div class="btn-group btn-group-sm">
                                            {% if code.depth < 2 %}
                                            <button class="btn btn-outline-success btn-sm" onclick="showInsertPanel({{ code.seq }}, {{ code.depth + 1 }})" title="하위 코드 추가">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-outline-primary btn-sm" onclick="editCode({{ code.seq }})" title="수정">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteCode({{ code.seq }})" title="삭제">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 우측: 코드 등록 폼 (5컬럼) -->
        <div class="col-md-5" id="code-insert-panel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle"></i> <span id="form-title">코드 등록</span>
                    </h5>
                </div>
                <div class="card-body">
                    <form id="codeForm">
                        <input type="hidden" id="parent_seq" name="parent_seq" value="0">
                        <input type="hidden" id="depth" name="depth" value="0">
                        <input type="hidden" id="edit_seq" name="edit_seq" value="">
                        
                        <div class="mb-3">
                            <label for="code" class="form-label">코드 *</label>
                            <input type="text" class="form-control" id="code" name="code" required 
                                   placeholder="예: USER, DEPT, MENU">
                        </div>
                        
                        <div class="mb-3">
                            <label for="code_name" class="form-label">코드명 *</label>
                            <input type="text" class="form-control" id="code_name" name="code_name" required 
                                   placeholder="예: 사용자, 부서, 메뉴">
                        </div>
                        
                        <div class="mb-3">
                            <label for="code_info" class="form-label">설명</label>
                            <textarea class="form-control" id="code_info" name="code_info" rows="3" 
                                      placeholder="코드에 대한 설명을 입력하세요"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sort" class="form-label">정렬 순서</label>
                            <input type="number" class="form-control" id="sort" name="sort" value="1" min="1">
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" onclick="saveCode()">
                                <i class="fas fa-save"></i> <span id="btn-text">등록</span>
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="cancelForm()">
                                <i class="fas fa-times"></i> 취소
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 하위 코드 조회 모달 -->
<div class="modal fade" id="childCodesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">하위 코드 목록</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="childCodesContent">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> 로딩 중...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery UI 라이브러리 -->
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/ui-lightness/jquery-ui.css">

<script>
$(document).ready(function() {
    // 드래그 앤 드롭 정렬 초기화
    initSortable();
    
    // 기존 기능들
    loadCodeData();
    
    // 계층 구조 토글 기능
    $('.parent-code, .group-code').click(function() {
        const seq = $(this).data('seq');
        const depth = $(this).data('depth');
        toggleChildren(seq, depth);
    });
});

// 드래그 앤 드롭 정렬 초기화
function initSortable() {
    $('#sortableCodeList').sortable({
        handle: '.drag-handle',
        placeholder: 'ui-sortable-placeholder',
        helper: function(e, tr) {
            var helper = tr.clone();
            helper.children().each(function() {
                $(this).width(tr.children().eq($(this).index()).width());
            });
            return helper;
        },
        start: function(e, ui) {
            ui.placeholder.height(ui.item.height());
            ui.item.addClass('ui-sortable-helper');
        },
        stop: function(e, ui) {
            ui.item.removeClass('ui-sortable-helper');
            updateSortOrder();
        },
        update: function(e, ui) {
            // 정렬 순서가 변경되었을 때
            updateSortNumbers();
        }
    });
    
    // Root 행은 정렬에서 제외
    $('#Root').addClass('ui-sortable-disabled');
}

// 정렬 순서 업데이트
function updateSortOrder() {
    const orders = [];
    
    $('#sortableCodeList .sortable-row').each(function(index) {
        const seq = $(this).data('seq');
        const parentSeq = $(this).data('parent-seq');
        const depth = $(this).data('depth');
        
        orders.push({
            seq: seq,
            parent_seq: parentSeq,
            depth: depth,
            sort: index + 1
        });
    });
    
    // 서버에 정렬 순서 저장
    saveSortOrder(orders);
}

// 정렬 번호 시각적 업데이트
function updateSortNumbers() {
    $('#sortableCodeList .sortable-row').each(function(index) {
        $(this).find('.sort-number').text(index + 1);
        $(this).data('sort', index + 1);
    });
}

// 서버에 정렬 순서 저장
function saveSortOrder(orders) {
    $.ajax({
        url: '/admin/api/codes/update-sort-order',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ orders: orders }),
        success: function(response) {
            if (response.success) {
                showAlert('정렬 순서가 저장되었습니다.', 'success');
            } else {
                showAlert('정렬 순서 저장에 실패했습니다: ' + response.message, 'error');
                location.reload(); // 실패 시 페이지 새로고침
            }
        },
        error: function() {
            showAlert('정렬 순서 저장 중 오류가 발생했습니다.', 'error');
            location.reload(); // 오류 시 페이지 새로고침
        }
    });
}

// 계층 구조 토글
function toggleChildren(parentSeq, parentDepth) {
    const childDepth = parentDepth + 1;
    
    $(`tr[data-parent-seq="${parentSeq}"][data-depth="${childDepth}"]`).each(function() {
        if ($(this).is(':visible')) {
            $(this).hide();
            // 하위의 하위도 숨기기
            hideAllChildren($(this).data('seq'));
        } else {
            $(this).show();
        }
    });
}

// 모든 하위 요소 숨기기
function hideAllChildren(parentSeq) {
    $(`tr[data-parent-seq="${parentSeq}"]`).each(function() {
        $(this).hide();
        hideAllChildren($(this).data('seq'));
    });
}

// 기존 함수들...
function loadCodeData() {
    // 기존 코드...
}

// 등록 패널 표시
function showInsertPanel(parentSeq, depth) {
    resetForm();
    $('#code-insert-panel').slideUp(200).slideDown(400);
    
    if (parentSeq === 0) {
        $('#form-title').text('최상위 코드 그룹 등록');
        $('#parent_seq').val('0');
        $('#depth').val('0');
    } else {
        var nextDepth = depth;
        $('#form-title').text(`${depth === 1 ? '분류 그룹' : '하위 코드'} 등록`);
        $('#parent_seq').val(parentSeq);
        $('#depth').val(nextDepth);
    }
    
    $('#btn-text').text('등록');
    isEditMode = false;
}

// 코드 수정
function editCode(seq) {
    $.post('/admin/api/codes/get', {seq: seq}, function(data) {
        if (data.success) {
            const code = data.data;
            $('#code-insert-panel').slideUp(200).slideDown(400);
            $('#form-title').text('코드 수정');
            $('#btn-text').text('수정');
            $('#edit_seq').val(code.seq);
            $('#parent_seq').val(code.parent_seq || '0');
            $('#depth').val(code.depth);
            $('#code').val(code.code);
            $('#code_name').val(code.code_name);
            $('#code_info').val(code.code_info || '');
            $('#sort').val(code.sort);
            isEditMode = true;
        } else {
            showAlert('코드 정보 조회 실패: ' + data.message, 'error');
        }
    });
}

// 코드 삭제
function deleteCode(seq) {
    if (!confirm('정말로 이 코드를 삭제하시겠습니까?\n하위 코드가 있는 경우 함께 삭제됩니다.')) {
        return;
    }
    
    $.post('/admin/api/codes/delete', {seq: seq}, function(data) {
        if (data.success) {
            showAlert('코드가 삭제되었습니다.', 'success');
            location.reload();
        } else {
            showAlert('삭제 실패: ' + data.message, 'error');
        }
    });
}

// 코드 저장
function saveCode() {
    const formData = {
        seq: $('#edit_seq').val(),
        parent_seq: $('#parent_seq').val(),
        depth: $('#depth').val(),
        code: $('#code').val().trim(),
        code_name: $('#code_name').val().trim(),
        code_info: $('#code_info').val().trim(),
        sort: $('#sort').val()
    };
    
    // 유효성 검사
    if (!formData.code || !formData.code_name) {
        showAlert('코드와 코드명은 필수입니다.', 'error');
        return;
    }
    
    const url = isEditMode ? '/admin/api/codes/update' : '/admin/api/codes/create';
    
    $.post(url, formData, function(data) {
        if (data.success) {
            showAlert(isEditMode ? '코드가 수정되었습니다.' : '코드가 등록되었습니다.', 'success');
            location.reload();
        } else {
            showAlert((isEditMode ? '수정' : '등록') + ' 실패: ' + data.message, 'error');
        }
    });
}

// 폼 리셋
function resetForm() {
    $('#codeForm')[0].reset();
    $('#edit_seq').val('');
    $('#parent_seq').val('0');
    $('#depth').val('0');
    $('#sort').val('1');
}

// 취소
function cancelForm() {
    $('#code-insert-panel').slideUp(400);
    resetForm();
}

// 전역 변수
let isEditMode = false;

function showAlert(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // 기존 알림 제거
    $('.alert').remove();
    
    // 새 알림 추가
    $('.container-fluid').prepend(alertHtml);
    
    // 3초 후 자동 제거
    setTimeout(() => {
        $('.alert').fadeOut();
    }, 3000);
}
</script>
{% endblock %}