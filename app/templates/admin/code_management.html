{% extends 'base.html' %}

{% block page_title %}코드 관리{% endblock %}

{% block extra_css %}
<!-- HTML5 네이티브 드래그 앤 드롭 사용 -->
<style>
    /* 레거시 AdminController.cs와 동일한 구조 */
    .child-code {
        background-color: #f8f9fa;
        display: none; /* 초기에는 숨김 - 레거시와 동일 */
    }
    .parent-code {
        background-color: #fff;
        cursor: pointer;
        transition: background-color 0.15s ease;
    }
    .parent-code:hover {
        background-color: #e3f2fd;
    }
    .group-code {
        background-color: #fff3cd;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.15s ease;
    }
    .group-code:hover {
        background-color: #ffeaa7;
    }
    
    /* 깊이별 배경색 (3단계까지만) */
    .depth-0 { 
        background-color: #fff9e6 !important; 
        font-weight: bold; 
    }
    .depth-1 { 
        background-color: #e8f4fd !important; 
    }
    .depth-2 { 
        background-color: #e8f5e8 !important; 
    }
    .depth-3 { 
        background-color: #f0f0f0 !important; 
    }
    
    /* 코드 셀에만 들여쓰기 적용 */
    .depth-0 .code-cell { padding-left: 8px !important; }
    .depth-1 .code-cell { padding-left: 32px !important; }
    .depth-2 .code-cell { padding-left: 56px !important; }
    .depth-3 .code-cell { padding-left: 80px !important; }
    
    /* 테이블 헤더 스타일 강화 - 진하고 선명하게 */
    .table-dark th {
        background-color: #212529 !important;
        color: #ffffff !important;
        font-weight: 900 !important;
        font-size: 14px !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important;
        border-color: #32383e !important;
    }
    
    /* 드래그 앤 드롭 스타일 강화 */
    .sortable-row {
        cursor: move;
        transition: all 0.2s ease;
    }
    .sortable-row:hover {
        background-color: #f5f5f5 !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .drag-handle {
        cursor: grab !important;
        text-align: center;
        width: 30px;
        color: #999;
        transition: all 0.2s ease;
        padding: 8px !important;
        font-size: 16px !important;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }
    .drag-handle:hover {
        color: #007bff !important;
        background-color: #e3f2fd !important;
        cursor: grab !important;
        transform: scale(1.1);
    }
    .drag-handle:active {
        cursor: grabbing !important;
        color: #0056b3 !important;
        background-color: #bbdefb !important;
    }
    
    /* TableDnD 드래그 시 스타일 대폭 강화 */
    .tDnD_whileDrag {
        background-color: #fff3cd !important;
        border: 3px solid #ffc107 !important;
        opacity: 0.8 !important;
        box-shadow: 0 8px 16px rgba(255, 193, 7, 0.4) !important;
        transform: scale(1.05) !important;
        z-index: 9999 !important;
        font-weight: bold !important;
    }
    
    .tDnD_whileDrag td {
        background-color: #fff3cd !important;
        border-color: #ffc107 !important;
    }
    
    /* 드래그 대상 위치 표시 강화 */
    .tDnD_insertMarker {
        background-color: #007bff !important;
        height: 4px !important;
        margin: 0 !important;
        border: none !important;
        box-shadow: 0 2px 4px rgba(0,123,255,0.5) !important;
    }
    
    /* 드래그 중인 행 스타일 강화 */
    .being-dragged {
        opacity: 0.6 !important;
        background-color: #e3f2fd !important;
        transform: scale(0.98) !important;
    }
    
    /* 드래그 활성화 상태 */
    .dragging-active {
        cursor: grabbing !important;
    }
    
    .dragging-active .drag-handle {
        cursor: grabbing !important;
    }
    
    /* 우측 패널 강조 효과 */
    .highlight-panel {
        border: 2px solid #007bff !important;
        box-shadow: 0 0 10px rgba(0,123,255,0.3) !important;
        background-color: #f8f9fa !important;
        transition: all 0.3s ease !important;
    }
    
    /* 드롭 가능한 영역 표시 */
    .nodrag, .nodrop {
        cursor: default !important;
    }
    
    /* 선택된 행 스타일 (레거시와 동일) */
    .selected-row {
        background-color: #007bff !important;
        color: white !important;
    }
    .selected-row td {
        background-color: #007bff !important;
        color: white !important;
    }
    
    /* 토글 아이콘 */
    .toggle-icon {
        cursor: pointer;
        margin-right: 8px;
        transition: transform 0.2s ease;
        font-size: 12px;
        width: 16px;
        text-align: center;
        display: inline-block;
    }
    .toggle-icon.expanded {
        transform: rotate(90deg);
    }
    .toggle-icon.empty {
        visibility: hidden;
    }
    
    /* 계층 아이콘 */
    .hierarchy-icon {
        margin-right: 8px;
        width: 16px;
        text-align: center;
    }
    
    /* 코드 텍스트 스타일 */
    .code-text {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        color: #495057;
    }
    
    /* 폼 스타일 */
    .form-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .stats-card {
        background: linear-gradient(45deg, #74b9ff, #0984e3);
        color: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    /* 모달 스타일 */
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom: none;
    }
    
    /* 버튼 스타일 */
    .btn-gradient {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border: none;
        color: white;
    }
    .btn-gradient:hover {
        background: linear-gradient(45deg, #764ba2, #667eea);
        color: white;
    }

    /* HTML5 드래그 앤 드롭 스타일 */
    .sortable-row[draggable="true"] {
        cursor: move;
        transition: all 0.2s ease;
    }
    
    .sortable-row[draggable="true"]:hover {
        background-color: #f5f5f5 !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* 드래그 중인 행 스타일 */
    .being-dragged {
        opacity: 0.5 !important;
        background-color: #fff3cd !important;
        border: 2px solid #ffc107 !important;
        transform: scale(0.95) !important;
        z-index: 1000 !important;
    }
    
    /* 드롭 타겟 스타일 */
    .drop-target {
        background-color: #e3f2fd !important;
        border-top: 4px solid #007bff !important;
        box-shadow: 0 4px 8px rgba(0,123,255,0.3) !important;
    }
    
    /* 드래그 활성화 상태 */
    .dragging-active {
        cursor: grabbing !important;
    }
    
    .dragging-active * {
        cursor: grabbing !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- 코드 목록 (왼쪽, 8컬럼) -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-code text-primary"></i> 
                        코드 관리 (레거시 호환)
                    </h5>
                </div>
                <div class="card-body p-0">
                    <!-- 통계 정보 -->
                    <div class="stats-card m-3">
                        <div class="row text-center">
                            <div class="col">
                                <h6 class="mb-0" id="total-codes">{{ codes|length }}</h6>
                                <small>전체 코드</small>
                            </div>
                            <div class="col">
                                <h6 class="mb-0" id="depth-stats">-</h6>
                                <small>최대 깊이</small>
                            </div>
                            <div class="col">
                                <h6 class="mb-0" id="group-count">-</h6>
                                <small>그룹 수</small>
                            </div>
                        </div>
                    </div>
    
                    <!-- 코드 테이블 -->
                    <div class="table-responsive">
                        <table id="codeTable" class="table table-sm table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th width="30">
                                        <i class="fas fa-grip-vertical" title="드래그 앤 드롭"></i>
                                    </th>
                                    <th width="200">코드</th>
                                    <th>코드명</th>
                                    <th width="150">설명</th>
                                    <th width="60" class="text-center">깊이</th>
                                    <th width="60" class="text-center">순서</th>
                                    <th width="120" class="text-center">관리</th>
                                </tr>
                            </thead>
                            <tbody id="codeTableBody">
                                <!-- Root 행 (드래그 불가) -->
                                <tr id="Root" class="parent-code nodrag nodrop group-code depth-0" 
                                    data-seq="0" data-depth="0" data-parent-seq="0">
                                    <td class="text-center">
                                        <i class="fas fa-anchor text-muted" title="루트 (고정)"></i>
                                    </td>
                                    <td class="depth-0 code-cell">
                                        <i class="toggle-icon fas fa-chevron-right" 
                                           data-seq="0" 
                                           data-depth="0"
                                           title="하위 코드 토글"></i>
                                        <i class="fas fa-folder-open hierarchy-icon text-warning"></i>
                                        <span class="code-text">ROOT</span>
                                    </td>
                                    <td class="depth-0 code-cell">
                                        <strong>루트 (최상위)</strong>
                                    </td>
                                    <td class="depth-0 code-cell">
                                        <em>전체 코드의 루트</em>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-warning">0</span>
                                    </td>
                                    <td class="text-center">-</td>
                                    <td class="text-center">
                                        <button class="btn btn-outline-success btn-sm add-child-btn" 
                                                data-parent-seq="0" 
                                                data-depth="1" 
                                                title="최상위 그룹 추가">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                </tr>
                                
                                <!-- 동적 코드 목록 -->
                                {% for code in codes %}
                                {% if code.depth == 0 %}
                                <!-- 최상위 코드 (depth=0)는 항상 표시 -->
                                <tr class="sortable-row depth-row-{{ code.depth }} code-item group-code depth-{{ code.depth }}" 
                                    id="row-{{ code.seq }}" 
                                    data-seq="{{ code.seq }}" 
                                    data-depth="{{ code.depth }}" 
                                    data-parent-seq="{{ code.parent_seq or 0 }}"
                                    data-sort="{{ code.sort or 1 }}"
                                    data-has-children="false">
                                {% else %}
                                <!-- 하위 코드 (depth > 0)는 초기에 숨김 -->
                                <tr class="sortable-row depth-row-{{ code.depth }} code-item child-code depth-{{ code.depth }}" 
                                    id="row-{{ code.seq }}" 
                                    data-seq="{{ code.seq }}" 
                                    data-depth="{{ code.depth }}" 
                                    data-parent-seq="{{ code.parent_seq or 0 }}"
                                    data-sort="{{ code.sort or 1 }}"
                                    data-has-children="false"
                                    style="display: none;">
                                {% endif %}
                                    <td class="drag-handle">
                                        <i class="fas fa-grip-vertical" title="드래그하여 순서 변경"></i>
                                    </td>
                                    <td class="depth-{{ code.depth }} code-cell">
                                        <!-- 토글 아이콘 -->
                                        <i class="toggle-icon fas fa-chevron-right" 
                                           data-seq="{{ code.seq }}" 
                                           data-depth="{{ code.depth }}"
                                           title="하위 코드 토글"></i>
                                        
                                        {% if code.depth == 0 %}
                                            <i class="fas fa-folder hierarchy-icon text-warning"></i>
                                        {% elif code.depth == 1 %}
                                            <i class="fas fa-folder-open hierarchy-icon text-info"></i>
                                        {% elif code.depth == 2 %}
                                            <i class="fas fa-file-alt hierarchy-icon text-success"></i>
                                        {% else %}
                                            <i class="fas fa-file hierarchy-icon text-secondary"></i>
                                        {% endif %}
                                        
                                        <span class="code-text">{{ code.code }}</span>
                                    </td>
                                    <td class="depth-{{ code.depth }} code-cell">{{ code.code_name }}</td>
                                    <td class="depth-{{ code.depth }} code-cell">{{ code.code_info or '-' }}</td>
                                    <td class="text-center">
                                        {% if code.depth == 0 %}
                                            <span class="badge bg-warning">{{ code.depth }}</span>
                                        {% elif code.depth == 1 %}
                                            <span class="badge bg-info">{{ code.depth }}</span>
                                        {% elif code.depth == 2 %}
                                            <span class="badge bg-success">{{ code.depth }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ code.depth }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center sort-number">{{ code.sort or 1 }}</td>
                                    <td class="code-actions">
                                        <div class="btn-group btn-group-sm">
                                            {% if code.depth < 3 %}
                                            <button class="btn btn-outline-success btn-sm add-child-btn" 
                                                    data-parent-seq="{{ code.seq }}" 
                                                    data-depth="{{ code.depth + 1 }}" 
                                                    title="하위 코드 추가">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-outline-primary btn-sm edit-code-btn" 
                                                    data-seq="{{ code.seq }}" 
                                                    title="수정">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm delete-code-btn" 
                                                    data-seq="{{ code.seq }}" 
                                                    title="삭제">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-muted">
                    <small>
                        <i class="fas fa-info-circle"></i>
                        클릭으로 하위 코드 토글, 드래그로 순서 변경, 행 클릭으로 우측에 상세정보 표시
                    </small>
                </div>
            </div>
        </div>
        
        <!-- 코드 등록/수정 폼 (오른쪽, 4컬럼) -->
        <div class="col-md-4">
            <div class="card" id="codeFormSection">
                <div class="card-header bg-gradient text-white">
                    <h6 class="card-title mb-0" style="font-weight: 900; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                        <i class="fas fa-info-circle"></i>
                        <span id="form-title">코드 정보</span>
                    </h6>
                </div>
                <div class="card-body">
                    <form id="codeForm">
                        <input type="hidden" id="edit_seq" name="edit_seq">
                        <input type="hidden" id="parent_seq" name="parent_seq" value="0">
                        <input type="hidden" id="depth" name="depth" value="1">
                        
                        <div class="mb-3">
                            <label for="parent_info" class="form-label">상위 코드</label>
                            <input type="text" class="form-control" id="parent_info" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label for="code" class="form-label">코드 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="code" name="code" required maxlength="50">
                        </div>
                        
                        <div class="mb-3">
                            <label for="code_name" class="form-label">코드명 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="code_name" name="code_name" required maxlength="100">
                        </div>
                        
                        <div class="mb-3">
                            <label for="code_info" class="form-label">설명</label>
                            <textarea class="form-control" id="code_info" name="code_info" rows="2" maxlength="255"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sort" class="form-label">정렬 순서</label>
                            <input type="number" class="form-control" id="sort" name="sort" value="1" min="1">
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-gradient" onclick="submitForm()">
                                <i class="fas fa-save"></i>
                                <span id="submit-text">저장</span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="fas fa-times"></i>
                                초기화
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 전역 변수 - JSON 데이터 안전하게 로드
var allCodes = [];
{% if codes %}
allCodes = {{ codes|tojson|safe }};
{% endif %}

$(document).ready(function() {
    console.log('🔧 코드 관리 페이지 초기화 (레거시 호환 모드)');
    console.log('📊 로드된 코드 수:', allCodes.length);
    
    try {
        // 1. 계층 구조 초기화 (초기에는 모두 접힌 상태)
        initializeHierarchy();
        
        // 2. 이벤트 바인딩
        bindEvents();
        
        // 3. 통계 업데이트
        updateStatistics();
        
        // 4. TableDnD 드래그 앤 드롭 초기화 (지연 로딩)
        setTimeout(function() {
            if (typeof $.fn.tableDnD === 'function') {
                initializeTableDnD();
                console.log('✅ TableDnD 초기화 완료');
            } else {
                console.warn('⚠️ TableDnD 라이브러리가 로드되지 않았습니다');
                // 다시 시도
                setTimeout(function() {
                    if (typeof $.fn.tableDnD === 'function') {
                        initializeTableDnD();
                    } else {
                        console.error('❌ TableDnD 로드 실패');
                    }
                }, 1000);
            }
        }, 500);
        
        console.log('✅ 코드 관리 초기화 완료');
        
    } catch (error) {
        console.error('❌ 초기화 중 오류:', error);
    }
});

// 계층 구조 초기화 (레거시와 동일하게 초기에는 접힌 상태)
function initializeHierarchy() {
    console.log('🌳 계층 구조 초기화');
    
    // 하위 코드가 있는 부모들의 토글 아이콘 표시
    allCodes.forEach(function(code) {
        var hasChildren = allCodes.some(function(child) {
            return child.parent_seq === code.seq;
        });
        if (hasChildren) {
            updateToggleIcon(code.seq, code.depth, hasChildren);
        }
    });
    
    // Root의 토글 아이콘 표시  
    var hasRootChildren = allCodes.some(function(code) {
        return (code.parent_seq === 0 || !code.parent_seq) && code.depth === 0;
    });
    if (hasRootChildren) {
        updateToggleIcon(0, 0, true);
    }
    
    console.log('✅ 계층 구조 초기화 완료');
}

// 이벤트 바인딩
function bindEvents() {
    console.log('🔗 이벤트 바인딩');
    
    // 토글 클릭 이벤트 (계층 구조 수정)
    $(document).off('click', '.toggle-icon').on('click', '.toggle-icon:not(.empty)', function(e) {
        e.stopPropagation();
        var parentSeq = $(this).data('seq');
        var $icon = $(this);
        var isExpanded = $icon.hasClass('expanded');
        
        console.log('🔄 토글 클릭:', parentSeq, '펼침상태:', isExpanded);
        
        if (isExpanded) {
            // 접기 - 해당 부모의 직계 자식들만 숨김
            hideChildren(parentSeq);
            $icon.removeClass('expanded');
        } else {
            // 펼치기 - 해당 부모의 직계 자식들만 표시
            showChildren(parentSeq);
            $icon.addClass('expanded');
        }
    });
    
    // 코드 행 클릭 이벤트 (우측에 정보 표시)
    $(document).off('click', '.code-item').on('click', '.code-item', function(e) {
        if ($(e.target).closest('.code-actions, .toggle-icon, .drag-handle').length) {
            return; // 버튼이나 토글, 드래그 핸들 클릭은 제외
        }
        
        // 선택 상태 토글
        $('.code-item').removeClass('selected-row');
        $(this).addClass('selected-row');
        
        // 우측에 해당 코드 정보 표시
        var seq = $(this).data('seq');
        console.log('🎯 코드 행 클릭:', seq);
        showCodeInfo(seq);
    });
    
    // 버튼 이벤트들
    $(document).off('click', '.add-child-btn').on('click', '.add-child-btn', function(e) {
        e.stopPropagation();
        var parentSeq = $(this).data('parent-seq');
        var depth = $(this).data('depth');
        showAddForm(parentSeq, depth);
    });
    
    $(document).off('click', '.edit-code-btn').on('click', '.edit-code-btn', function(e) {
        e.stopPropagation();
        var seq = $(this).data('seq');
        showEditForm(seq);
    });
    
    $(document).off('click', '.delete-code-btn').on('click', '.delete-code-btn', function(e) {
        e.stopPropagation();
        var seq = $(this).data('seq');
        if (confirm('정말 삭제하시겠습니까?')) {
            deleteCode(seq);
        }
    });
    
    console.log('✅ 이벤트 바인딩 완료');
}

// 하위 코드 표시 함수 (정확한 계층 구조)
function showChildren(parentSeq) {
    console.log('📂 하위 코드 표시:', parentSeq);
    
    // 해당 부모의 직계 자식들만 찾기
    var directChildren = allCodes.filter(function(code) {
        return code.parent_seq === parentSeq;
    });
    
    console.log('직계 자식 수:', directChildren.length);
    
    // 부모 행 찾기
    var $parentRow = $('#row-' + parentSeq);
    if (parentSeq === 0) {
        $parentRow = $('#Root');
    }
    
    // 직계 자식들을 부모 바로 다음에 삽입
    directChildren.forEach(function(child) {
        var $childRow = $('#row-' + child.seq);
        if ($childRow.length) {
            $childRow.detach(); // 기존 위치에서 제거
            $parentRow.after($childRow); // 부모 바로 다음에 삽입
            $childRow.show(); // 표시
            $parentRow = $childRow; // 다음 자식을 위해 업데이트
        }
    });
}

// 하위 코드 숨김 함수 (재귀적으로 모든 후손 숨김)
function hideChildren(parentSeq) {
    console.log('📁 하위 코드 숨김:', parentSeq);
    
    // 재귀적으로 모든 후손 찾기
    function findAllDescendants(seq) {
        var descendants = [];
        var directChildren = allCodes.filter(function(code) {
            return code.parent_seq === seq;
        });
        
        directChildren.forEach(function(child) {
            descendants.push(child);
            descendants = descendants.concat(findAllDescendants(child.seq));
        });
        
        return descendants;
    }
    
    var allDescendants = findAllDescendants(parentSeq);
    console.log('모든 후손 수:', allDescendants.length);
    
    // 모든 후손 숨김
    allDescendants.forEach(function(descendant) {
        var $row = $('#row-' + descendant.seq);
        $row.hide();
        
        // 후손의 토글 아이콘도 접힌 상태로 변경
        var $icon = $('.toggle-icon[data-seq="' + descendant.seq + '"]');
        $icon.removeClass('expanded');
    });
}

// HTML5 네이티브 드래그 앤 드롭 구현 (TableDnD 대신)
function initializeTableDnD() {
    console.log('🔧 HTML5 드래그 앤 드롭 초기화 시작...');
    
    // 모든 드래그 가능한 행 설정
    $('.sortable-row').each(function() {
        var $row = $(this);
        $row.attr('draggable', 'true');
        
        // 드래그 시작
        $row.on('dragstart', function(e) {
            var seq = $(this).data('seq');
            console.log('🎯 드래그 시작 - SEQ:', seq);
            
            // 드래그 데이터 설정
            e.originalEvent.dataTransfer.setData('text/plain', seq);
            e.originalEvent.dataTransfer.effectAllowed = 'move';
            
            // 시각적 효과
            $(this).addClass('being-dragged');
            $('body').addClass('dragging-active');
            
            // 드래그 이미지 설정 (선택사항)
            var dragImage = $(this).clone();
            dragImage.css({
                'position': 'absolute',
                'top': '-1000px',
                'background-color': '#fff3cd',
                'border': '2px solid #ffc107',
                'opacity': '0.8'
            });
            $('body').append(dragImage);
            e.originalEvent.dataTransfer.setDragImage(dragImage[0], 0, 0);
            
            setTimeout(function() {
                dragImage.remove();
            }, 0);
        });
        
        // 드래그 중
        $row.on('dragover', function(e) {
            e.preventDefault();
            e.originalEvent.dataTransfer.dropEffect = 'move';
            
            // 드롭 위치 표시
            $(this).addClass('drop-target');
        });
        
        // 드래그 벗어남
        $row.on('dragleave', function(e) {
            $(this).removeClass('drop-target');
        });
        
        // 드롭
        $row.on('drop', function(e) {
            e.preventDefault();
            var draggedSeq = e.originalEvent.dataTransfer.getData('text/plain');
            var targetSeq = $(this).data('seq');
            
            console.log('🎯 드롭 완료 - 드래그된 SEQ:', draggedSeq, '-> 타겟 SEQ:', targetSeq);
            
            // 시각적 효과 제거
            $('.being-dragged').removeClass('being-dragged');
            $('.drop-target').removeClass('drop-target');
            $('body').removeClass('dragging-active');
            
            // 순서 변경 처리
            if (draggedSeq !== targetSeq) {
                handleNativeDragDrop(draggedSeq, targetSeq);
            }
        });
        
        // 드래그 끝
        $row.on('dragend', function(e) {
            console.log('🏁 드래그 종료');
            $('.being-dragged').removeClass('being-dragged');
            $('.drop-target').removeClass('drop-target');
            $('body').removeClass('dragging-active');
        });
    });
    
    // 드래그 핸들 설정
    $('.drag-handle').each(function() {
        $(this).css({
            'cursor': 'grab',
            'user-select': 'none'
        });
        
        // 마우스 이벤트
        $(this).on('mouseenter', function() {
            console.log('🎯 드래그 핸들에 마우스 진입');
            $(this).css('background-color', '#e3f2fd');
        }).on('mouseleave', function() {
            $(this).css('background-color', '');
        }).on('mousedown', function() {
            $(this).css('cursor', 'grabbing');
        }).on('mouseup', function() {
            $(this).css('cursor', 'grab');
        });
    });
    
    console.log('✅ HTML5 드래그 앤 드롭 초기화 완료');
    console.log('🎮 드래그 가능한 행 개수:', $('.sortable-row').length);
}

// 네이티브 드래그 앤 드롭 처리 함수
function handleNativeDragDrop(draggedSeq, targetSeq) {
    console.log('🔄 순서 변경 처리:', draggedSeq, '->', targetSeq);
    
    var $draggedRow = $('#row-' + draggedSeq);
    var $targetRow = $('#row-' + targetSeq);
    
    if ($draggedRow.length === 0 || $targetRow.length === 0) {
        console.error('❌ 드래그된 행 또는 타겟 행을 찾을 수 없습니다');
        return;
    }
    
    var draggedDepth = parseInt($draggedRow.data('depth'));
    var draggedParent = parseInt($draggedRow.data('parent-seq'));
    var targetDepth = parseInt($targetRow.data('depth'));
    var targetParent = parseInt($targetRow.data('parent-seq'));
    
    // 같은 부모의 같은 깊이인지 확인
    if (draggedDepth !== targetDepth || draggedParent !== targetParent) {
        alert('같은 그룹 내에서만 순서를 변경할 수 있습니다.');
        return;
    }
    
    // DOM에서 행 이동
    $draggedRow.detach();
    $targetRow.after($draggedRow);
    
    // 시각적 효과
    $draggedRow.css('background-color', '#d4edda');
    setTimeout(function() {
        $draggedRow.css('background-color', '');
    }, 1000);
    
    // 새로운 순서 계산
    var parentSeq = draggedParent;
    var depth = draggedDepth;
    var $siblings = $('tr[data-parent-seq="' + parentSeq + '"][data-depth="' + depth + '"]:visible');
    var newOrder = [];
    
    $siblings.each(function(index) {
        var siblingSeq = parseInt($(this).data('seq'));
        newOrder.push(siblingSeq);
        $(this).find('.sort-number').text(index + 1);
    });
    
    console.log('새로운 순서:', newOrder);
    
    // 서버에 순서 변경 저장
    $.ajax({
        url: "/admin/api/codes/update-sort",
        method: "POST",
        data: {
            parent_seq: parentSeq,
            depth: depth,
            order: JSON.stringify(newOrder)
        },
        success: function(data) {
            if (data.success) {
                console.log('✅ 순서 변경 저장 완료');
                // 성공 알림
                showNotification('순서가 성공적으로 변경되었습니다.', 'success');
            } else {
                alert("순서 변경 저장에 실패했습니다: " + (data.message || ''));
                location.reload();
            }
        },
        error: function() {
            alert("서버 오류가 발생했습니다.");
            location.reload();
        }
    });
}

// 알림 표시 함수
function showNotification(message, type) {
    var notification = $('<div class="alert alert-' + (type === 'success' ? 'success' : 'danger') + ' alert-dismissible fade show" style="position: fixed; top: 20px; right: 20px; z-index: 10000;">' +
        '<strong>' + message + '</strong>' +
        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
        '</div>');
    
    $('body').append(notification);
    
    setTimeout(function() {
        notification.alert('close');
    }, 3000);
}

// 토글 아이콘 업데이트
function updateToggleIcon(seq, depth, hasChildren) {
    var $icon = $('.toggle-icon[data-seq="' + seq + '"]');
    
    if (hasChildren === undefined || hasChildren === null) {
        hasChildren = allCodes.some(function(code) {
            return code.parent_seq === seq;
        });
    }
    
    if (hasChildren) {
        $icon.removeClass('empty').show();
    } else {
        $icon.addClass('empty').hide();
    }
}

// 통계 업데이트
function updateStatistics() {
    var depths = allCodes.map(function(code) { return code.depth; });
    var maxDepth = Math.max.apply(Math, depths.concat([0]));
    var groupCount = allCodes.filter(function(code) { return code.depth === 0; }).length;
    
    $('#total-codes').text(allCodes.length);
    $('#depth-stats').text(maxDepth);
    $('#group-count').text(groupCount);
}

// 우측에 코드 정보 표시
function showCodeInfo(seq) {
    var code = allCodes.find(function(c) { return c.seq == seq; });
    if (!code) {
        resetForm();
        $('#form-title').text('코드 정보');
        return;
    }
    
    // 편집 모드로 폼 채우기
    $('#edit_seq').val(seq);
    $('#parent_seq').val(code.parent_seq || 0);
    $('#depth').val(code.depth);
    $('#code').val(code.code);
    $('#code_name').val(code.code_name);
    $('#code_info').val(code.code_info || '');
    $('#sort').val(code.sort || 1);
    
    $('#form-title').text(`코드 정보: ${code.code} - ${code.code_name}`);
    $('#submit-text').text('수정');
    
    // 우측 패널 강조 표시
    $('#codeFormSection').addClass('highlight-panel');
    setTimeout(function() {
        $('#codeFormSection').removeClass('highlight-panel');
    }, 1500);
    
    // 상위 코드 정보 표시
    if (code.parent_seq == 0 || !code.parent_seq) {
        $('#parent_info').val('Root (최상위)');
    } else {
        var parentCode = allCodes.find(function(c) { return c.seq == code.parent_seq; });
        if (parentCode) {
            $('#parent_info').val(parentCode.code + ' - ' + parentCode.code_name);
        }
    }
    
    console.log('📝 코드 정보 표시:', code.code);
}

// 폼 표시/숨김 함수들
function showAddForm(parentSeq, depth) {
    resetForm();
    
    $('#parent_seq').val(parentSeq);
    $('#depth').val(depth);
    $('#form-title').text('코드 추가 (Depth ' + depth + ')');
    $('#submit-text').text('추가');
    
    // 상위 코드 정보 표시
    if (parentSeq == 0) {
        $('#parent_info').val('Root (최상위)');
    } else {
        var parentCode = allCodes.find(function(c) { return c.seq == parentSeq; });
        if (parentCode) {
            $('#parent_info').val(parentCode.code + ' - ' + parentCode.code_name);
        }
    }
}

function showEditForm(seq) {
    showCodeInfo(seq); // 동일한 로직 사용
}

function resetForm() {
    $('#codeForm')[0].reset();
    $('#edit_seq').val('');
    $('#parent_seq').val('0');
    $('#depth').val('1');
    $('#sort').val('1');
    $('#form-title').text('코드 정보');
    $('#submit-text').text('저장');
    $('#parent_info').val('');
    $('.code-item').removeClass('selected-row');
}

// 폼 제출
function submitForm() {
    var formData = new FormData($('#codeForm')[0]);
    var isEdit = $('#edit_seq').val() !== '';
    
    var url = isEdit ? '/admin/api/codes/update' : '/admin/api/codes/create';
    
    $.ajax({
        url: url,
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                alert(isEdit ? '코드가 수정되었습니다.' : '코드가 추가되었습니다.');
                location.reload(); // 페이지 새로고침으로 간단하게 처리
            } else {
                alert('오류: ' + (response.message || '알 수 없는 오류'));
            }
        },
        error: function() {
            alert('서버 오류가 발생했습니다.');
        }
    });
}

// 코드 삭제
function deleteCode(seq) {
    $.ajax({
        url: '/admin/api/codes/delete',
        method: 'POST',
        data: { seq: seq },
        success: function(response) {
            if (response.success) {
                alert('코드가 삭제되었습니다.');
                location.reload();
            } else {
                alert('오류: ' + (response.message || '알 수 없는 오류'));
            }
        },
        error: function() {
            alert('서버 오류가 발생했습니다.');
        }
    });
}
</script>
{% endblock %}