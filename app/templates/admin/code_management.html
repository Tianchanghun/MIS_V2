{% extends 'base.html' %}

{% block page_title %}ì½”ë“œ ê´€ë¦¬{% endblock %}

{% block extra_css %}
<style>
    /* ëª¨ë“  ì½”ë“œ í‘œì‹œ - child-code ìˆ¨ê¹€ ì œê±° */
    .child-code {
        background-color: #f8f9fa;
        /* display: none ì œê±° - ëª¨ë“  í•˜ìœ„ ì½”ë“œ í‘œì‹œ */
    }
    .parent-code {
        background-color: #fff;
        cursor: pointer;
        transition: background-color 0.15s ease;
    }
    .parent-code:hover {
        background-color: #e3f2fd;
    }
    .group-code {
        background-color: #fff3cd;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.15s ease;
    }
    .group-code:hover {
        background-color: #ffeaa7;
    }
    
    /* ê¹Šì´ë³„ ë°°ê²½ìƒ‰ ì¶”ê°€ (Depth 0-4ê¹Œì§€) */
    .depth-0 { 
        padding-left: 8px; 
        background-color: #fff3cd; /* ìµœìƒìœ„ - ë…¸ë€ìƒ‰ */
        font-weight: bold;
    }
    .depth-1 { 
        padding-left: 24px; 
        background-color: #d1ecf1; /* 1ë‹¨ê³„ - í•˜ëŠ˜ìƒ‰ */
        font-weight: 600;
    }
    .depth-2 { 
        padding-left: 40px; 
        background-color: #d4edda; /* 2ë‹¨ê³„ - ì—°ë‘ìƒ‰ */
    }
    .depth-3 { 
        padding-left: 56px; 
        background-color: #f8d7da; /* 3ë‹¨ê³„ - ë¶„í™ìƒ‰ */
    }
    .depth-4 { 
        padding-left: 72px; 
        background-color: #e2e3e5; /* 4ë‹¨ê³„ - íšŒìƒ‰ (ìµœëŒ€ ê¹Šì´) */
    }
    
    /* ê¹Šì´ë³„ ë°°ê²½ìƒ‰ê³¼ ë“¤ì—¬ì“°ê¸° - ë” ëª…í™•í•œ ì‹œê°í™” */
    .depth-0 { 
        background-color: #fff9e6 !important; 
        font-weight: bold; 
    }
    .depth-1 { 
        background-color: #e8f4fd !important; 
    }
    .depth-2 { 
        background-color: #e8f5e8 !important; 
    }
    .depth-3 { 
        background-color: #f0f0f0 !important; 
    }
    .depth-4 { 
        background-color: #f8f8f8 !important; 
    }
    
    /* ì½”ë“œ ì…€ì—ë§Œ ë“¤ì—¬ì“°ê¸° ì ìš© */
    .depth-0 .code-cell { padding-left: 8px !important; }
    .depth-1 .code-cell { padding-left: 32px !important; }
    .depth-2 .code-cell { padding-left: 56px !important; }
    .depth-3 .code-cell { padding-left: 80px !important; }
    .depth-4 .code-cell { padding-left: 104px !important; }
    
    /* íŠ¸ë¦¬ ë¼ì¸ í‘œì‹œ */
    .code-cell {
        position: relative;
    }
    
    .depth-1 .code-cell::before {
        content: 'â”œâ”€';
        position: absolute;
        left: 8px;
        color: #dee2e6;
        font-weight: normal;
    }
    
    .depth-2 .code-cell::before {
        content: 'â”‚ â”œâ”€';
        position: absolute;
        left: 8px;
        color: #dee2e6;
        font-weight: normal;
    }
    
    .depth-3 .code-cell::before {
        content: 'â”‚ â”‚ â”œâ”€';
        position: absolute;
        left: 8px;
        color: #dee2e6;
        font-weight: normal;
    }
    
    .depth-4 .code-cell::before {
        content: 'â”‚ â”‚ â”‚ â”œâ”€';
        position: absolute;
        left: 8px;
        color: #dee2e6;
        font-weight: normal;
    }
    
    /* ë§ˆì§€ë§‰ ìì‹ ìš”ì†ŒëŠ” â””â”€ ë¡œ í‘œì‹œ */
    .depth-1.last-child .code-cell::before {
        content: 'â””â”€';
    }
    
    .depth-2.last-child .code-cell::before {
        content: 'â”‚ â””â”€';
    }
    
    .depth-3.last-child .code-cell::before {
        content: 'â”‚ â”‚ â””â”€';
    }
    
    .depth-4.last-child .code-cell::before {
        content: 'â”‚ â”‚ â”‚ â””â”€';
    }
    
    /* íŠ¸ë¦¬ êµ¬ì¡° ì‹œê°í™” */
    .tree-line {
        position: relative;
    }
    
    .tree-line::before {
        content: '';
        position: absolute;
        left: -16px;
        top: 0;
        bottom: 50%;
        width: 1px;
        background-color: #dee2e6;
    }
    
    .tree-line::after {
        content: '';
        position: absolute;
        left: -16px;
        top: 50%;
        width: 12px;
        height: 1px;
        background-color: #dee2e6;
    }
    
    /* ë§ˆì§€ë§‰ ìì‹ ìš”ì†Œ */
    .tree-line.last-child::before {
        bottom: 50%;
    }
    
    /* í† ê¸€ ê°€ëŠ¥í•œ ì½”ë“œ í–‰ ìŠ¤íƒ€ì¼ */
    .toggleable-code {
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }
    
    .toggleable-code:hover {
        background-color: #f8f9fa !important;
        border-left-color: #007bff;
    }
    
    .toggleable-code.expanded {
        background-color: #e3f2fd !important;
        border-left-color: #2196f3;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .toggleable-code.has-children {
        font-weight: 500;
    }
    
    /* í† ê¸€ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ ê°•í™” */
    .toggle-icon {
        display: inline-block;
        width: 20px;
        height: 20px;
        margin-right: 8px;
        text-align: center;
        line-height: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #6c757d;
        border-radius: 3px;
        font-size: 12px;
    }
    
    .toggle-icon:hover {
        color: #495057;
        background-color: #e9ecef;
    }
    
    .toggle-icon.expanded {
        transform: rotate(90deg);
        color: #007bff;
        background-color: #e3f2fd;
    }
    
    .toggle-icon.empty {
        visibility: hidden;
    }
    
    /* ê³„ì¸µë³„ ì•„ì´ì½˜ í¬ê¸° ì¡°ì • */
    .hierarchy-icon {
        margin-right: 8px;
        width: 16px;
        text-align: center;
    }
    
    /* ì„ íƒëœ í–‰ ìŠ¤íƒ€ì¼ */
    .toggleable-code.selected {
        background-color: #fff3cd !important;
        border-left-color: #ffc107 !important;
        box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3) !important;
    }
    
    /* ì½”ë“œ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .code-text {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        color: #495057;
    }
    
    /* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
    .code-item {
        transition: all 0.3s ease;
    }
    
    .code-item.slide-down {
        animation: slideDown 0.3s ease-out;
    }
    
    .code-item.slide-up {
        animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            max-height: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            max-height: 100px;
            transform: translateY(0);
        }
    }
    
    @keyframes slideUp {
        from {
            opacity: 1;
            max-height: 100px;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            max-height: 0;
            transform: translateY(-10px);
        }
    }
    
    .code-actions {
        white-space: nowrap;
    }
    .table-responsive {
        max-height: 700px; /* ë†’ì´ í™•ì¥ */
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        will-change: scroll-position;
    }
    
    /* ì»¬ëŸ¼ í­ ê³ ì • */
    #codeTable {
        table-layout: fixed;
        width: 100%;
        transform: translateZ(0);
        backface-visibility: hidden;
    }
    #codeTable th:nth-child(1) { width: 12%; }  /* ë“œë˜ê·¸ í•¸ë“¤ */
    #codeTable th:nth-child(2) { width: 25%; }  /* ì½”ë“œ */
    #codeTable th:nth-child(3) { width: 25%; }  /* ì½”ë“œëª… */
    #codeTable th:nth-child(4) { width: 20%; }  /* ì„¤ëª… */
    #codeTable th:nth-child(5) { width: 8%; }   /* ê¹Šì´ */
    #codeTable th:nth-child(6) { width: 6%; }   /* ì •ë ¬ */
    #codeTable th:nth-child(7) { width: 14%; }  /* ì‘ì—… */
    
    .table tr.selected {
        background-color: #d1ecf1 !important;
        transition: background-color 0.2s ease;
    }
    
    /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
    .sortable-row {
        cursor: move;
        will-change: transform;
    }
    .ui-sortable-helper {
        background-color: #fff3cd !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        border: 2px solid #ffc107;
        transform: translateZ(0);
    }
    .ui-sortable-placeholder {
        background-color: #e3f2fd !important;
        border: 2px dashed #2196f3;
        height: 40px;
        visibility: visible !important;
    }
    .drag-handle {
        cursor: move;
        color: #6c757d;
        font-size: 14px;
        transition: color 0.15s ease;
    }
    .drag-handle:hover {
        color: #495057;
    }
    .sort-number {
        font-weight: bold;
        color: #007bff;
        min-width: 30px;
        text-align: center;
    }
    
    /* í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .toggle-btn {
        border: none;
        background: none;
        color: #6c757d;
        padding: 2px 6px;
        margin-right: 5px;
        cursor: pointer;
        transition: color 0.15s ease;
        font-size: 12px;
    }
    .toggle-btn:hover {
        color: #495057;
    }
    .toggle-btn.collapsed .fa-minus {
        display: none;
    }
    .toggle-btn:not(.collapsed) .fa-plus {
        display: none;
    }
    
    /* ê³„ì¸µ ì•„ì´ì½˜ */
    .hierarchy-icon {
        margin-right: 5px;
        font-size: 14px;
    }
    
    /* í•˜ìœ„ ì½”ë“œ ìˆ¨ê¹€/í‘œì‹œë¥¼ ìœ„í•œ í´ë˜ìŠ¤ */
    .hidden-child {
        display: none !important;
    }
    
    /* í•˜ìœ„ ì½”ë“œ ë“¤ì—¬ì“°ê¸° ê°•ì¡° */
    .child-indicator {
        border-left: 2px solid #dee2e6;
        margin-left: 10px;
        padding-left: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-code"></i> ì½”ë“œ ê´€ë¦¬
                            <small class="text-muted">(ê³„ì¸µí˜• êµ¬ì¡° - ìµœëŒ€ Depth 4)</small>
                        </h4>
                        <div>
                            <button type="button" class="btn btn-outline-success btn-sm" id="expandAllBtn">
                                <i class="fas fa-expand-arrows-alt"></i> ëª¨ë‘ í¼ì¹˜ê¸°
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="collapseAllBtn">
                                <i class="fas fa-compress-arrows-alt"></i> ëª¨ë‘ ì ‘ê¸°
                            </button>
                            <button type="button" class="btn btn-primary btn-sm" id="addRootCodeBtn">
                                <i class="fas fa-plus"></i> ìµœìƒìœ„ ì½”ë“œ ì¶”ê°€
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- ì¢Œì¸¡: ì½”ë“œ ëª©ë¡ (7ì»¬ëŸ¼) -->
        <div class="col-md-7" id="leftPanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> ì½”ë“œ ëª©ë¡
                        <span class="badge bg-info ms-2">{{ codes|length }}ê°œ</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0" id="codeTable">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th><i class="fas fa-arrows-alt"></i></th>
                                    <th>ì½”ë“œ</th>
                                    <th>ì½”ë“œëª…</th>
                                    <th>ì„¤ëª…</th>
                                    <th>ê¹Šì´</th>
                                    <th>ì •ë ¬</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="sortableCodeList">
                                <!-- Root í–‰ -->
                                <tr class="parent-code toggleable-code" id="Root" data-seq="0" data-depth="0" data-parent-seq="0" data-has-children="true">
                                    <td><i class="fas fa-lock text-muted" title="ì´ë™ ë¶ˆê°€"></i></td>
                                    <td class="code-cell">
                                        <!-- Rootìš© í† ê¸€ ì•„ì´ì½˜ -->
                                        <i class="toggle-icon fas fa-chevron-right" 
                                           data-seq="0" 
                                           data-depth="0"
                                           title="í•˜ìœ„ ì½”ë“œ í† ê¸€"></i>
                                        <i class="fas fa-home text-primary hierarchy-icon"></i>
                                        <span class="code-text">Root</span>
                                    </td>
                                    <td class="code-cell"><strong>ìµœìƒìœ„ ì½”ë“œ</strong></td>
                                    <td class="code-cell">ì‹œìŠ¤í…œ ë£¨íŠ¸</td>
                                    <td class="text-center">0</td>
                                    <td class="text-center">-</td>
                                    <td>
                                        <button class="btn btn-outline-success btn-sm add-child-btn" data-parent-seq="0" data-depth="1" title="í•˜ìœ„ ì½”ë“œ ì¶”ê°€">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                </tr>
                                <!-- ì½”ë“œ ëª©ë¡ - ì„±ëŠ¥ ìµœì í™” ë²„ì „ -->
                                {% for code in codes %}
                                <tr class="sortable-row depth-row-{{ code.depth }} code-item toggleable-code" 
                                    id="row-{{ code.seq }}" 
                                    data-seq="{{ code.seq }}" 
                                    data-depth="{{ code.depth }}" 
                                    data-parent-seq="{{ code.parent_seq or 0 }}"
                                    data-sort="{{ code.sort or 1 }}"
                                    data-has-children="false"
                                    style="display: none;">
                                    <td class="drag-handle">
                                        <i class="fas fa-grip-vertical" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½"></i>
                                    </td>
                                    <td class="depth-{{ code.depth }} code-cell">
                                        <!-- í† ê¸€ ì•„ì´ì½˜ (í•˜ìœ„ ì½”ë“œê°€ ìˆëŠ” ê²½ìš°ë§Œ í‘œì‹œ) -->
                                        <i class="toggle-icon fas fa-chevron-right empty" 
                                           data-seq="{{ code.seq }}" 
                                           data-depth="{{ code.depth }}"
                                           title="í•˜ìœ„ ì½”ë“œ í† ê¸€" style="display: none;"></i>
                                        
                                        <!-- ê³„ì¸µ ì•„ì´ì½˜ -->
                                        {% if code.depth == 0 %}
                                            <i class="fas fa-folder text-warning hierarchy-icon"></i>
                                        {% elif code.depth == 1 %}
                                            <i class="fas fa-folder-open text-info hierarchy-icon"></i>
                                        {% elif code.depth == 2 %}
                                            <i class="fas fa-file-alt text-success hierarchy-icon"></i>
                                        {% elif code.depth == 3 %}
                                            <i class="fas fa-file text-secondary hierarchy-icon"></i>
                                        {% elif code.depth == 4 %}
                                            <i class="fas fa-dot-circle text-muted hierarchy-icon"></i>
                                        {% endif %}
                                        
                                        <span class="code-text">{{ code.code }}</span>
                                    </td>
                                    <td class="depth-{{ code.depth }} code-cell">{{ code.code_name }}</td>
                                    <td class="depth-{{ code.depth }} code-cell">{{ code.code_info or '-' }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-{{ 'warning' if code.depth == 0 else ('info' if code.depth == 1 else ('success' if code.depth == 2 else ('secondary' if code.depth == 3 else 'dark'))) }}">
                                            {{ code.depth }}
                                        </span>
                                    </td>
                                    <td class="text-center sort-number">{{ code.sort or 1 }}</td>
                                    <td class="code-actions">
                                        <div class="btn-group btn-group-sm">
                                            <!-- Depth 4 ë¯¸ë§Œì—ì„œë§Œ í•˜ìœ„ ì½”ë“œ ì¶”ê°€ ê°€ëŠ¥ -->
                                            {% if code.depth < 4 %}
                                            <button class="btn btn-outline-success btn-sm add-child-btn" 
                                                    data-parent-seq="{{ code.seq }}" 
                                                    data-depth="{{ code.depth + 1 }}" 
                                                    title="í•˜ìœ„ ì½”ë“œ ì¶”ê°€">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-outline-primary btn-sm edit-code-btn" 
                                                    data-seq="{{ code.seq }}" 
                                                    title="ìˆ˜ì •">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm delete-code-btn" 
                                                    data-seq="{{ code.seq }}" 
                                                    title="ì‚­ì œ">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                
                                <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
                                <tr id="loadingRow" style="display: none;">
                                    <td colspan="7" class="text-center p-3">
                                        <i class="fas fa-spinner fa-spin"></i> ë” ë§ì€ ì½”ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                                    </td>
                                </tr>
                                
                                <!-- ë”ë³´ê¸° ë²„íŠ¼ -->
                                {% if codes|length > 100 %}
                                <tr id="loadMoreRow">
                                    <td colspan="7" class="text-center p-3">
                                        <button class="btn btn-outline-primary" id="loadMoreBtn">
                                            <i class="fas fa-plus"></i> ë” ë³´ê¸° ({{ codes|length - 100 }}ê°œ ë‚¨ìŒ)
                                        </button>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ìš°ì¸¡: ì½”ë“œ ë“±ë¡ í¼ (5ì»¬ëŸ¼) -->
        <div class="col-md-5" id="rightPanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle"></i> <span id="form-title">ì½”ë“œ ë“±ë¡</span>
                    </h5>
                </div>
                <div class="card-body">
                    <form id="codeForm">
                        <input type="hidden" id="parent_seq" name="parent_seq" value="0">
                        <input type="hidden" id="depth" name="depth" value="0">
                        <input type="hidden" id="edit_seq" name="edit_seq" value="">
                        
                        <div class="mb-3">
                            <label for="parent_info" class="form-label">ìƒìœ„ ì½”ë“œ</label>
                            <input type="text" class="form-control" id="parent_info" readonly
                                   placeholder="ìƒìœ„ ì½”ë“œê°€ ì„ íƒë˜ë©´ í‘œì‹œë©ë‹ˆë‹¤">
                        </div>
                        
                        <div class="mb-3">
                            <label for="code" class="form-label">ì½”ë“œ *</label>
                            <input type="text" class="form-control" id="code" name="code" required 
                                   placeholder="ì˜ˆ: USER, DEPT, MENU">
                        </div>
                        
                        <div class="mb-3">
                            <label for="code_name" class="form-label">ì½”ë“œëª… *</label>
                            <input type="text" class="form-control" id="code_name" name="code_name" required 
                                   placeholder="ì˜ˆ: ì‚¬ìš©ì, ë¶€ì„œ, ë©”ë‰´">
                        </div>
                        
                        <div class="mb-3">
                            <label for="code_info" class="form-label">ì½”ë“œ ì„¤ëª…</label>
                            <textarea class="form-control" id="code_info" name="code_info" rows="3" 
                                      placeholder="ì½”ë“œì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sort" class="form-label">ì •ë ¬ ìˆœì„œ</label>
                            <input type="number" class="form-control" id="sort" name="sort" value="1" min="1">
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> <span id="submit-text">ì €ì¥</span>
                            </button>
                            <button type="button" class="btn btn-secondary" id="resetFormBtn">
                                <i class="fas fa-refresh"></i> ì´ˆê¸°í™”
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- ì½”ë“œ í†µê³„ ì •ë³´ -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-bar"></i> ì½”ë“œ í†µê³„</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h5 class="text-warning">{{ codes|selectattr("depth", "equalto", 0)|list|length }}</h5>
                            <small>Depth 0</small>
                        </div>
                        <div class="col-6">
                            <h5 class="text-info">{{ codes|selectattr("depth", "equalto", 1)|list|length }}</h5>
                            <small>Depth 1</small>
                        </div>
                        <div class="col-6">
                            <h5 class="text-success">{{ codes|selectattr("depth", "equalto", 2)|list|length }}</h5>
                            <small>Depth 2</small>
                        </div>
                        <div class="col-6">
                            <h5 class="text-secondary">{{ codes|selectattr("depth", "equalto", 3)|list|length }}</h5>
                            <small>Depth 3</small>
                        </div>
                        <div class="col-12 mt-2">
                            <h5 class="text-dark">{{ codes|selectattr("depth", "equalto", 4)|list|length }}</h5>
                            <small>Depth 4 (ìµœëŒ€)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì„œë²„ ë°ì´í„°ë¥¼ JavaScriptë¡œ ì „ë‹¬ -->
<script type="application/json" id="codesData">{{ codes|tojson|safe }}</script>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('âœ… ì½”ë“œ ê´€ë¦¬ í˜ì´ì§€ ì‹œì‘');
    
    // ì´ˆê¸° ì„¤ì •
    initializeData();
    setupEventHandlers();
    setupInfiniteScroll();
    
    // í† ê¸€ ì•„ì´ì½˜ ì´ˆê¸°í™”
    initializeToggleIcons();
    
    // í†µê³„ ì—…ë°ì´íŠ¸
    updateStatistics();
    
    console.log('âœ… ì½”ë“œ ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
});

// ì „ì—­ ë³€ìˆ˜
var allCodes = [];
var displayedCodes = 100;
var isLoading = false;

// ì„œë²„ ë°ì´í„° ì´ˆê¸°í™”
function initializeData() {
    try {
        var codesDataElement = document.getElementById('codesData');
        if (codesDataElement) {
            allCodes = JSON.parse(codesDataElement.textContent);
            console.log('âœ… ì½”ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', allCodes.length + 'ê°œ');
            console.log('ğŸ“‹ ì²« 5ê°œ ì½”ë“œ:', allCodes.slice(0, 5));
        } else {
            console.error('âŒ codesData ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
    } catch (e) {
        console.error('âŒ ì½”ë“œ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
        allCodes = [];
    }
    
    // í˜„ì¬ í‘œì‹œëœ ì½”ë“œ ê°œìˆ˜ í™•ì¸
    var visibleCodes = $('.code-item').length;
    console.log('ğŸ‘ï¸ í˜„ì¬ í‘œì‹œëœ ì½”ë“œ:', visibleCodes + 'ê°œ');
    
    // ë”ë³´ê¸° ë²„íŠ¼ ìƒíƒœ í™•ì¸
    var loadMoreBtn = $('#loadMoreBtn');
    if (loadMoreBtn.length > 0) {
        console.log('ğŸ”˜ ë”ë³´ê¸° ë²„íŠ¼ ì¡´ì¬í•¨');
    } else {
        console.log('âŒ ë”ë³´ê¸° ë²„íŠ¼ ì—†ìŒ');
    }
}

// ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
function setupEventHandlers() {
    // í† ê¸€ ì•„ì´ì½˜ í´ë¦­ ì´ë²¤íŠ¸ (íŠ¸ë¦¬ êµ¬ì¡°)
    $(document).on('click', '.toggle-icon:not(.empty)', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const seq = $(this).data('seq');
        const depth = parseInt($(this).data('depth'));
        
        console.log(`ğŸŒ³ í† ê¸€ ì•„ì´ì½˜ í´ë¦­: ì½”ë“œ ${seq}, ê¹Šì´ ${depth}`);
        toggleChildren(seq, depth);
    });
    
    // ì½”ë“œ í–‰ ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ (í† ê¸€)
    $(document).on('dblclick', '.toggleable-code', function(e) {
        // ë²„íŠ¼ì´ë‚˜ í† ê¸€ ì•„ì´ì½˜ í´ë¦­ì€ ì œì™¸
        if ($(e.target).closest('.btn, .toggle-icon').length > 0) {
            return;
        }
        
        const seq = $(this).data('seq');
        const depth = parseInt($(this).data('depth'));
        const hasChildren = $(this).data('has-children') === 'true' || $(this).data('has-children') === true;
        
        if (hasChildren) {
            console.log(`ğŸŒ³ í–‰ ë”ë¸”í´ë¦­: ì½”ë“œ ${seq}, ê¹Šì´ ${depth}`);
            toggleChildren(seq, depth);
        }
    });
    
    // ì½”ë“œ í–‰ ë‹¨ì¼í´ë¦­ ì´ë²¤íŠ¸ (ì„ íƒ í‘œì‹œ)
    $(document).on('click', '.toggleable-code', function(e) {
        // ë²„íŠ¼ì´ë‚˜ í† ê¸€ ì•„ì´ì½˜ í´ë¦­ì€ ì œì™¸
        if ($(e.target).closest('.btn, .toggle-icon').length > 0) {
            return;
        }
        
        // ê¸°ì¡´ ì„ íƒ í•´ì œ
        $('.toggleable-code').removeClass('selected');
        
        // í˜„ì¬ í–‰ ì„ íƒ
        $(this).addClass('selected');
        
        const seq = $(this).data('seq');
        const code = allCodes.find(c => c.seq == seq);
        if (code) {
            console.log(`ğŸ‘† ì½”ë“œ ì„ íƒ: ${code.code} - ${code.code_name}`);
        }
    });
    
    // ë”ë³´ê¸° ë²„íŠ¼ í´ë¦­
    $('#loadMoreBtn').on('click', function() {
        loadMoreCodes();
    });
    
    // ëª¨ë‘ í¼ì¹˜ê¸°
    $('#expandAllBtn').on('click', function() {
        expandAll();
    });
    
    // ëª¨ë‘ ì ‘ê¸° 
    $('#collapseAllBtn').on('click', function() {
        collapseAll();
    });
    
    // í•˜ìœ„ ì½”ë“œ ì¶”ê°€ ë²„íŠ¼
    $(document).on('click', '.add-child-btn', function(e) {
        e.stopPropagation();
        const parentSeq = $(this).data('parent-seq');
        const depth = $(this).data('depth');
        
        if (depth > 4) {
            alert('ìµœëŒ€ ê¹Šì´ëŠ” 4ê¹Œì§€ì…ë‹ˆë‹¤.');
            return;
        }
        
        showAddForm(parentSeq, depth);
        console.log('í•˜ìœ„ ì½”ë“œ ì¶”ê°€:', parentSeq, 'depth:', depth);
    });
    
    // ì½”ë“œ ìˆ˜ì • ë²„íŠ¼
    $(document).on('click', '.edit-code-btn', function(e) {
        e.stopPropagation();
        const seq = $(this).data('seq');
        showEditForm(seq);
        console.log('ì½”ë“œ ìˆ˜ì •:', seq);
    });
    
    // ì½”ë“œ ì‚­ì œ ë²„íŠ¼
    $(document).on('click', '.delete-code-btn', function(e) {
        e.stopPropagation();
        const seq = $(this).data('seq');
        
        if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•˜ìœ„ ì½”ë“œê°€ ìˆëŠ” ê²½ìš° í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) {
            deleteCode(seq);
        }
    });
    
    // ìµœìƒìœ„ ì½”ë“œ ì¶”ê°€
    $('#addRootCodeBtn').on('click', function() {
        showAddForm(0, 1);
    });
    
    // í¼ ë¦¬ì…‹
    $('#resetFormBtn').on('click', function() {
        resetForm();
    });
    
    // í¼ ì œì¶œ
    $('#codeForm').on('submit', function(e) {
        e.preventDefault();
        submitForm();
    });

    // Root í† ê¸€ í´ë¦­ ì´ë²¤íŠ¸ (íŠ¹ë³„ ì²˜ë¦¬) - ìˆ˜ì •ëœ ë²„ì „
    $(document).on('click', '#Root .toggle-icon, #Root', function(e) {
        // ë²„íŠ¼ í´ë¦­ì€ ì œì™¸
        if ($(e.target).closest('.btn').length > 0) {
            return;
        }
        
        e.preventDefault();
        e.stopPropagation();
        
        console.log('ğŸ  Root í† ê¸€ í´ë¦­');
        
        const $rootToggle = $('#Root .toggle-icon');
        const isExpanded = $rootToggle.hasClass('expanded');
        
        if (isExpanded) {
            // Root ì ‘ê¸°: ëª¨ë“  ì½”ë“œ ìˆ¨ê¸°ê¸°
            console.log('ğŸ“ Root ì ‘ê¸° - ëª¨ë“  ì½”ë“œ ìˆ¨ê¹€');
            $('.code-item').hide();
            $rootToggle.removeClass('expanded fa-chevron-down').addClass('fa-chevron-right');
            $('#Root').removeClass('expanded');
            
            // ëª¨ë“  í† ê¸€ ìƒíƒœ ì´ˆê¸°í™”
            $('.toggle-icon').removeClass('expanded fa-chevron-down').addClass('fa-chevron-right');
            $('.toggleable-code').removeClass('expanded');
            
        } else {
            // Root í¼ì¹˜ê¸°: Depth 0 ì½”ë“œë“¤ë§Œ í‘œì‹œ (parent_seq=0ì¸ ì½”ë“œë“¤)
            console.log('ğŸ“‚ Root í¼ì¹˜ê¸° - Depth 0 ì½”ë“œë“¤ í‘œì‹œ');
            
            // Depth 0 ì½”ë“œë“¤ ì°¾ê¸° ë° ì •ë ¬
            const depth0Codes = allCodes.filter(code => code.depth === 0);
            depth0Codes.sort((a, b) => (parseInt(a.sort) || 999) - (parseInt(b.sort) || 999));
            
            console.log(`ğŸŒ³ í‘œì‹œí•  Depth 0 ì½”ë“œë“¤: ${depth0Codes.length}ê°œ`);
            depth0Codes.forEach(code => {
                console.log(`  â”œâ”€ ${code.code} (${code.code_name}) - parent_seq: ${code.parent_seq}`);
            });
            
            // Depth 0 ì½”ë“œë“¤ì„ ìˆœì„œëŒ€ë¡œ í‘œì‹œ
            let $insertAfter = $('#Root');
            depth0Codes.forEach(code => {
                const $row = $(`#row-${code.seq}`);
                if ($row.length > 0) {
                    // DOM ìœ„ì¹˜ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ì´ë™
                    const currentIndex = $row.index();
                    const targetIndex = $insertAfter.index() + 1;
                    
                    if (currentIndex !== targetIndex) {
                        $row.detach();
                        $insertAfter.after($row);
                        console.log(`  ğŸ“ ${code.code} ìœ„ì¹˜ ì´ë™: ${currentIndex} â†’ ${targetIndex}`);
                    }
                    
                    // í–‰ í‘œì‹œ
                    $row.show();
                    
                    // í•˜ìœ„ ì½”ë“œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸í•˜ì—¬ í† ê¸€ ì•„ì´ì½˜ ì„¤ì •
                    updateToggleIcon(code.seq, code.depth);
                    
                    $insertAfter = $row;
                    console.log(`  âœ… ${code.code} í‘œì‹œë¨`);
                }
            });
            
            $rootToggle.removeClass('fa-chevron-right').addClass('expanded fa-chevron-down');
            $('#Root').addClass('expanded');
        }
        
        updateStatistics();
    });
}

// ë¬´í•œ ìŠ¤í¬ë¡¤ ì„¤ì •
function setupInfiniteScroll() {
    const tableContainer = $('.table-responsive');
    
    tableContainer.on('scroll', function() {
        if (isLoading || displayedCodes >= allCodes.length) return;
        
        const scrollTop = $(this).scrollTop();
        const scrollHeight = $(this)[0].scrollHeight;
        const clientHeight = $(this).height();
        
        // ìŠ¤í¬ë¡¤ì´ í•˜ë‹¨ ê·¼ì²˜ì— ë„ë‹¬í–ˆì„ ë•Œ
        if (scrollTop + clientHeight >= scrollHeight - 50) {
            loadMoreCodes();
        }
    });
}

// ë” ë§ì€ ì½”ë“œ ë¡œë“œ
function loadMoreCodes() {
    if (isLoading) return;
    
    isLoading = true;
    $('#loadingRow').show();
    $('#loadMoreRow').hide();
    
    setTimeout(() => {
        // ìˆ¨ê²¨ì§„ ì½”ë“œë“¤ì„ 50ê°œì”© í‘œì‹œ
        var hiddenCodes = $('.code-item:hidden').slice(0, 50);
        hiddenCodes.show();
        
        var totalVisible = $('.code-item:visible').length;
        var totalHidden = $('.code-item:hidden').length;
        
        // ë”ë³´ê¸° ë²„íŠ¼ ì—…ë°ì´íŠ¸
        if (totalHidden === 0) {
            $('#loadMoreRow').remove();
        } else {
            $('#loadMoreBtn').html(`<i class="fas fa-plus"></i> ë” ë³´ê¸° (${totalHidden}ê°œ ë‚¨ìŒ)`);
            $('#loadMoreRow').show();
        }
        
        $('#loadingRow').hide();
        isLoading = false;
        
        console.log(`âœ… ${hiddenCodes.length}ê°œ ì½”ë“œ í‘œì‹œ (ì´ ${totalVisible}ê°œ í‘œì‹œ ì¤‘, ${totalHidden}ê°œ ë‚¨ìŒ)`);
    }, 100);
}

// í•˜ìœ„ ì½”ë“œ í† ê¸€ í•¨ìˆ˜ (ìˆ˜ì •ëœ ë²„ì „)
function toggleChildren(parentSeq, depth) {
    console.log(`ğŸŒ³ íŠ¸ë¦¬ í† ê¸€: ë¶€ëª¨ ${parentSeq}, ê¹Šì´ ${depth}`);
    
    const $toggleIcon = $(`.toggle-icon[data-seq="${parentSeq}"]`);
    const $parentRow = parentSeq === 0 ? $('#Root') : $(`.toggleable-code[data-seq="${parentSeq}"]`);
    const isExpanded = $toggleIcon.hasClass('expanded');
    
    if (isExpanded) {
        // ì ‘ê¸°: í•´ë‹¹ ë¶€ëª¨ì˜ ëª¨ë“  í•˜ìœ„ ì½”ë“œë“¤ ìˆ¨ê¸°ê¸° (ì¬ê·€ì ìœ¼ë¡œ)
        console.log(`ğŸ“ ì½”ë“œ ${parentSeq} ì ‘ê¸°`);
        hideChildrenRecursive(parentSeq, true);
        $toggleIcon.removeClass('expanded fa-chevron-down').addClass('fa-chevron-right');
        $parentRow.removeClass('expanded');
    } else {
        // í¼ì¹˜ê¸°: ì§ê³„ í•˜ìœ„ ì½”ë“œë“¤ë§Œ í‘œì‹œ
        console.log(`ğŸ“‚ ì½”ë“œ ${parentSeq} í¼ì¹˜ê¸°`);
        showDirectChildren(parentSeq, depth, true);
        $toggleIcon.removeClass('fa-chevron-right').addClass('expanded fa-chevron-down');
        $parentRow.addClass('expanded');
    }
    
    updateStatistics();
}

// í•˜ìœ„ ì½”ë“œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (parent_seq=0ë„ Rootë¡œ ì¸ì‹)
function hasChildren(parentSeq) {
    // parentSeqê°€ 0ì´ë©´ Depth 0 ì½”ë“œë“¤ì„ ì°¾ê¸°
    if (parentSeq === 0 || parentSeq === '0') {
        return allCodes.some(code => code.depth === 0);
    }
    
    // ì¼ë°˜ì ì¸ ê²½ìš°: í•´ë‹¹ seqë¥¼ parent_seqë¡œ ê°€ì§„ ì½”ë“œë“¤ ì°¾ê¸°
    return allCodes.some(code => code.parent_seq == parentSeq);
}

// ì§ê³„ í•˜ìœ„ ì½”ë“œë“¤ë§Œ í‘œì‹œ (parent_seq=0 ì²˜ë¦¬ í¬í•¨)
function showDirectChildren(parentSeq, parentDepth, withAnimation = false) {
    console.log(`ğŸ“‚ ë¶€ëª¨ ì½”ë“œ ${parentSeq} (ê¹Šì´ ${parentDepth})ì˜ ì§ê³„ í•˜ìœ„ ì½”ë“œë§Œ í‘œì‹œ`);
    
    let directChildren;
    
    // Root (parentSeq=0)ì¸ ê²½ìš° Depth 0 ì½”ë“œë“¤ì„ ê°€ì ¸ì˜¤ê¸°
    if (parentSeq === 0 || parentSeq === '0') {
        directChildren = allCodes.filter(code => code.depth === 0);
        console.log(`ğŸ  Root í•˜ìœ„: Depth 0 ì½”ë“œë“¤ ${directChildren.length}ê°œ`);
    } else {
        // ì¼ë°˜ì ì¸ ê²½ìš°: parent_seqê°€ ì¼ì¹˜í•˜ëŠ” ì§ê³„ í•˜ìœ„ ì½”ë“œë§Œ
        directChildren = allCodes.filter(code => 
            code.parent_seq == parentSeq && code.depth === (parentDepth + 1)
        );
        console.log(`ğŸ“‚ ì§ê³„ í•˜ìœ„ ì½”ë“œ ${directChildren.length}ê°œ`);
    }
    
    if (directChildren.length === 0) {
        console.log(`ğŸ“­ í•˜ìœ„ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤`);
        return;
    }
    
    // ì •ë ¬ ê¸°ì¤€: Sort ê°’ì— ë”°ë¼ ì •ë ¬
    directChildren.sort((a, b) => {
        const sortA = parseInt(a.sort) || 999;
        const sortB = parseInt(b.sort) || 999;
        return sortA - sortB;
    });
    
    console.log(`ğŸ“‚ í‘œì‹œí•  í•˜ìœ„ ì½”ë“œë“¤:`);
    directChildren.forEach(code => {
        console.log(`  â”œâ”€ ${code.code} (${code.code_name}) - Depth: ${code.depth}, Sort: ${code.sort}`);
    });
    
    // ë¶€ëª¨ í–‰ ì°¾ê¸°
    const $parentRow = parentSeq === 0 ? $('#Root') : $(`#row-${parentSeq}`);
    
    if ($parentRow.length === 0) {
        console.error(`âŒ ë¶€ëª¨ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${parentSeq}`);
        return;
    }
    
    // ì§ê³„ í•˜ìœ„ ì½”ë“œë“¤ì„ ë¶€ëª¨ ë°”ë¡œ ë‹¤ìŒì— ìˆœì„œëŒ€ë¡œ ë°°ì¹˜
    let $insertAfter = $parentRow;
    
    directChildren.forEach((code, index) => {
        const $row = $(`#row-${code.seq}`);
        if ($row.length > 0) {
            // ì´ë¯¸ í‘œì‹œëœ ê²½ìš° ê±´ë„ˆë›°ê¸°
            if ($row.is(':visible')) {
                console.log(`  â­ï¸ ${code.code} ì´ë¯¸ í‘œì‹œë¨`);
                $insertAfter = $row; // ë‹¤ìŒ ì‚½ì… ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                return;
            }
            
            // DOMì—ì„œ í˜„ì¬ ìœ„ì¹˜ í™•ì¸í•˜ê³  ì˜¬ë°”ë¥¸ ìœ„ì¹˜ë¡œ ì´ë™
            $row.detach(); // DOMì—ì„œ ì œê±°
            $insertAfter.after($row); // ì •í™•í•œ ìœ„ì¹˜ì— ì‚½ì…
            
            // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
            if (withAnimation) {
                $row.addClass('slide-down');
                setTimeout(() => $row.removeClass('slide-down'), 300);
            }
            
            // í–‰ í‘œì‹œ
            $row.show();
            console.log(`  âœ… ${code.code} í‘œì‹œë¨ (Depth: ${code.depth})`);
            
            // í•˜ìœ„ ì½”ë“œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸í•˜ì—¬ í† ê¸€ ì•„ì´ì½˜ ì„¤ì •
            updateToggleIcon(code.seq, code.depth);
            
            // ë‹¤ìŒ ì‚½ì… ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            $insertAfter = $row;
            
        } else {
            console.warn(`  âŒ ì½”ë“œ ${code.seq}ì˜ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
        }
    });
    
    // ë§ˆì§€ë§‰ ìì‹ í‘œì‹œ ì—…ë°ì´íŠ¸
    updateTreeLastChild(parentSeq, parentDepth);
    
    updateLoadMoreButton();
}

// í•˜ìœ„ ì½”ë“œë“¤ì„ ì¬ê·€ì ìœ¼ë¡œ ìˆ¨ê¸°ê¸° (parent_seq=0 ì²˜ë¦¬ í¬í•¨)
function hideChildrenRecursive(parentSeq, withAnimation = false) {
    console.log(`ğŸ“ ë¶€ëª¨ ì½”ë“œ ${parentSeq}ì˜ ëª¨ë“  í•˜ìœ„ ì½”ë“œ ìˆ¨ê¸°ê¸°`);
    
    let directChildren;
    
    // Root (parentSeq=0)ì¸ ê²½ìš° Depth 0 ì½”ë“œë“¤
    if (parentSeq === 0 || parentSeq === '0') {
        directChildren = allCodes.filter(code => code.depth === 0);
    } else {
        // ì¼ë°˜ì ì¸ ê²½ìš°
        directChildren = allCodes.filter(code => code.parent_seq == parentSeq);
    }
    
    if (directChildren.length === 0) {
        console.log(`  ğŸ“­ ìˆ¨ê¸¸ í•˜ìœ„ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤`);
        return;
    }
    
    console.log(`  â””â”€ ìˆ¨ê¸¸ í•˜ìœ„ ì½”ë“œë“¤: ${directChildren.map(c => c.code).join(', ')}`);
    
    directChildren.forEach(child => {
        const $childRow = $(`#row-${child.seq}`);
        const $childToggleIcon = $(`.toggle-icon[data-seq="${child.seq}"]`);
        
        if ($childRow.is(':visible')) {
            // ë¨¼ì € ì´ ìì‹ì˜ í•˜ìœ„ ì½”ë“œë“¤ë„ ì¬ê·€ì ìœ¼ë¡œ ìˆ¨ê¸°ê¸°
            hideChildrenRecursive(child.seq, withAnimation);
            
            // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
            if (withAnimation) {
                $childRow.addClass('slide-up');
                setTimeout(() => {
                    $childRow.hide().removeClass('slide-up');
                }, 300);
            } else {
                $childRow.hide();
            }
            
            console.log(`  ğŸ«¥ ${child.code} ìˆ¨ê¹€ (Depth: ${child.depth})`);
        }
        
        // í† ê¸€ ìƒíƒœ ì´ˆê¸°í™”
        $childToggleIcon.removeClass('expanded fa-chevron-down').addClass('fa-chevron-right');
        $childRow.removeClass('expanded');
    });
    
    updateLoadMoreButton();
}

// íŠ¸ë¦¬ êµ¬ì¡°ì—ì„œ ë§ˆì§€ë§‰ ìì‹ í‘œì‹œ
function updateTreeLastChild(parentSeq, depth) {
    // ê°™ì€ ë¶€ëª¨ì˜ ëª¨ë“  ìì‹ ì½”ë“œ ì°¾ê¸°
    const siblings = allCodes.filter(code => 
        code.parent_seq == parentSeq && code.depth === (depth + 1)
    );
    
    if (siblings.length === 0) return;
    
    // ì •ë ¬í•˜ì—¬ ë§ˆì§€ë§‰ ìì‹ ì°¾ê¸°
    siblings.sort((a, b) => (parseInt(a.sort) || 999) - (parseInt(b.sort) || 999));
    
    // ëª¨ë“  í˜•ì œì—ì„œ last-child í´ë˜ìŠ¤ ì œê±°
    siblings.forEach(sibling => {
        $(`#row-${sibling.seq}`).removeClass('last-child');
    });
    
    // ë§ˆì§€ë§‰ ìì‹ì— last-child í´ë˜ìŠ¤ ì¶”ê°€
    if (siblings.length > 0) {
        const lastChild = siblings[siblings.length - 1];
        $(`#row-${lastChild.seq}`).addClass('last-child');
        console.log(`ğŸŒ² ë§ˆì§€ë§‰ ìì‹ í‘œì‹œ: ${lastChild.code}`);
    }
}

// íŠ¸ë¦¬ êµ¬ì¡° ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (ë§ˆì§€ë§‰ ìì‹ ì²˜ë¦¬ í¬í•¨)
function updateTreeStructure(codeSeq, depth, parentSeq) {
    // íŠ¸ë¦¬ êµ¬ì¡°ëŠ” CSSì˜ depth í´ë˜ìŠ¤ë¡œ ì¶©ë¶„íˆ í‘œí˜„ë˜ë¯€ë¡œ 
    // ë³µì¡í•œ íŠ¸ë¦¬ ë¼ì¸ ì²˜ë¦¬ëŠ” ì œê±°í•˜ê³  ê¹Šì´ë³„ ë“¤ì—¬ì“°ê¸°ë§Œ ìœ ì§€
    console.log(`ğŸ¨ ì½”ë“œ ${codeSeq} ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (Depth: ${depth})`);
}

// í† ê¸€ ì•„ì´ì½˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (parent_seq=0 ì²˜ë¦¬ í¬í•¨)
function updateToggleIcon(codeSeq, depth) {
    // í•˜ìœ„ ì½”ë“œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    const hasDirectChildren = hasChildren(codeSeq);
    
    const $toggleIcon = $(`.toggle-icon[data-seq="${codeSeq}"]`);
    const $row = $(`#row-${codeSeq}`);
    
    if (hasDirectChildren) {
        $toggleIcon.removeClass('empty').show();
        $row.attr('data-has-children', 'true').addClass('has-children');
        console.log(`ğŸ”§ ì½”ë“œ ${codeSeq}: í•˜ìœ„ ì½”ë“œ ìˆìŒ`);
    } else {
        $toggleIcon.addClass('empty').hide();
        $row.attr('data-has-children', 'false').removeClass('has-children');
        console.log(`ğŸ”§ ì½”ë“œ ${codeSeq}: í•˜ìœ„ ì½”ë“œ ì—†ìŒ`);
    }
}

// ëª¨ë“  ì½”ë“œ í† ê¸€ ì•„ì´ì½˜ ì´ˆê¸°í™” (ìˆ˜ì •ëœ ë²„ì „)
function initializeToggleIcons() {
    console.log('ğŸŒ³ í† ê¸€ ì•„ì´ì½˜ ì´ˆê¸°í™” (parent_seq=0 ì²˜ë¦¬)...');
    console.log('ğŸ“Š ì „ì²´ ì½”ë“œ ìˆ˜:', allCodes.length);
    
    if (allCodes.length === 0) {
        console.warn('âŒ allCodes ë°°ì—´ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
        return;
    }
    
    // 1. ëª¨ë“  ì½”ë“œ í–‰ ìˆ¨ê¸°ê¸°
    $('.code-item').hide();
    $('.toggleable-code').removeClass('expanded has-children selected');
    $('.toggle-icon').removeClass('expanded fa-chevron-down').addClass('fa-chevron-right');
    
    // 2. DOMì—ì„œ ì½”ë“œë“¤ì„ ì˜¬ë°”ë¥¸ ê³„ì¸µ ìˆœì„œë¡œ ì¬ì •ë ¬
    reorganizeCodeRows();
    
    // 3. ê° ì½”ë“œì˜ í•˜ìœ„ ì½”ë“œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    allCodes.forEach(code => {
        updateToggleIcon(code.seq, code.depth);
    });
    
    // 4. Root í† ê¸€ ì•„ì´ì½˜ ì„¤ì • (Depth 0 ì½”ë“œë“¤ì´ ìˆëŠ”ì§€ í™•ì¸)
    const depth0Codes = allCodes.filter(code => code.depth === 0);
    const $rootToggle = $('.toggle-icon[data-seq="0"]');
    if (depth0Codes.length > 0) {
        $rootToggle.removeClass('empty').show();
        $('#Root').attr('data-has-children', 'true').addClass('has-children');
        console.log(`ğŸ  Rootì— Depth 0 ì½”ë“œ ${depth0Codes.length}ê°œ ìˆìŒ`);
    } else {
        $rootToggle.addClass('empty').hide();
        $('#Root').attr('data-has-children', 'false');
        console.log('ğŸ  Rootì— í•˜ìœ„ ì½”ë“œ ì—†ìŒ');
    }
    
    // 5. ì´ˆê¸°ì—ëŠ” Rootë§Œ í‘œì‹œí•˜ê³  ëª¨ë“  ì½”ë“œ ìˆ¨ê¹€
    $('.code-item').hide();
    
    // 6. í†µê³„ ì—…ë°ì´íŠ¸
    updateStatistics();
    updateLoadMoreButton();
    
    console.log('âœ… í† ê¸€ ì•„ì´ì½˜ ì´ˆê¸°í™” ì™„ë£Œ');
}

// DOMì—ì„œ ì½”ë“œ í–‰ë“¤ì„ ê³„ì¸µ ìˆœì„œë¡œ ì¬ì •ë ¬
function reorganizeCodeRows() {
    console.log('ğŸ“ DOM ì½”ë“œ í–‰ ì¬ì •ë ¬ ì‹œì‘ (ê°œì„ ëœ íŠ¸ë¦¬ êµ¬ì¡°)...');
    
    // ë°±ì—”ë“œì™€ ë™ì¼í•œ ì •ë ¬: CodeSeq â†’ parent_seq â†’ Sort â†’ Seq
    const sortedCodes = [...allCodes].sort((a, b) => {
        // 1. code_seq ì˜¤ë¦„ì°¨ìˆœ (nullì€ ë§ˆì§€ë§‰ì—)
        const codeSeqA = a.code_seq || 999999;
        const codeSeqB = b.code_seq || 999999;
        if (codeSeqA !== codeSeqB) {
            return codeSeqA - codeSeqB;
        }
        
        // 2. parent_seq ì˜¤ë¦„ì°¨ìˆœ (nullì€ ë¨¼ì € - Root ì½”ë“œë“¤)
        const parentA = a.parent_seq || 0;
        const parentB = b.parent_seq || 0;
        if (parentA !== parentB) {
            return parentA - parentB;
        }
        
        // 3. sort ì˜¤ë¦„ì°¨ìˆœ
        const sortA = parseInt(a.sort) || 999;
        const sortB = parseInt(b.sort) || 999;
        if (sortA !== sortB) {
            return sortA - sortB;
        }
        
        // 4. seq ì˜¤ë¦„ì°¨ìˆœ
        return a.seq - b.seq;
    });
    
    console.log('ğŸ”§ ì •ë ¬ëœ ì½”ë“œ ìˆœì„œ (ì²« 10ê°œ):');
    sortedCodes.slice(0, 10).forEach((code, index) => {
        const parentText = code.parent_seq ? `Parent: ${code.parent_seq}` : 'Root';
        console.log(`  ${index + 1}. ${code.code} (CodeSeq: ${code.code_seq}, ${parentText}, Sort: ${code.sort})`);
    });
    
    // DOMì—ì„œ ìˆœì„œëŒ€ë¡œ ì¬ë°°ì¹˜
    const $tbody = $('#sortableCodeList');
    const $root = $('#Root');
    
    let $lastRow = $root;
    
    sortedCodes.forEach(code => {
        const $row = $(`#row-${code.seq}`);
        if ($row.length > 0) {
            // í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì œê±°í•˜ê³  ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— ì‚½ì…
            $row.detach();
            $lastRow.after($row);
            $lastRow = $row;
        }
    });
    
    console.log('âœ… DOM ì½”ë“œ í–‰ ì¬ì •ë ¬ ì™„ë£Œ (íŠ¸ë¦¬ êµ¬ì¡° ìµœì í™”)');
}

// ëª¨ë‘ í¼ì¹˜ê¸° (íŠ¸ë¦¬ êµ¬ì¡°)
function expandAll() {
    console.log('ğŸŒ³ ëª¨ë“  íŠ¸ë¦¬ í¼ì¹˜ê¸°');
    
    // ëª¨ë“  ì½”ë“œ í‘œì‹œ
    $('.code-item').show();
    
    // ëª¨ë“  í† ê¸€ ì•„ì´ì½˜ì„ í¼ì³ì§„ ìƒíƒœë¡œ
    $('.toggle-icon:not(.empty)').removeClass('fa-chevron-right').addClass('expanded fa-chevron-down');
    $('.toggleable-code[data-has-children="true"]').addClass('expanded');
    
    // íŠ¸ë¦¬ êµ¬ì¡° ìŠ¤íƒ€ì¼ ì ìš©
    allCodes.forEach(code => {
        updateTreeStructure(code.seq, code.depth, code.parent_seq);
    });
    
    updateStatistics();
    updateLoadMoreButton();
}

// ëª¨ë‘ ì ‘ê¸° (íŠ¸ë¦¬ êµ¬ì¡°)
function collapseAll() {
    console.log('ğŸŒ³ ëª¨ë“  íŠ¸ë¦¬ ì ‘ê¸°');
    
    // ëª¨ë“  ì½”ë“œ ìˆ¨ê¸°ê¸°
    $('.code-item').hide();
    
    // Depth 0ë§Œ í‘œì‹œ
    allCodes.filter(code => code.depth === 0)
        .sort((a, b) => (parseInt(a.sort) || 999) - (parseInt(b.sort) || 999))
        .forEach(code => {
            $(`#row-${code.seq}`).show();
            updateTreeStructure(code.seq, code.depth, code.parent_seq);
        });
    
    // ëª¨ë“  í† ê¸€ ìƒíƒœ ì´ˆê¸°í™”
    $('.toggle-icon').removeClass('expanded fa-chevron-down').addClass('fa-chevron-right');
    $('.toggleable-code').removeClass('expanded');
    
    updateStatistics();
    updateLoadMoreButton();
}

// ë”ë³´ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateLoadMoreButton() {
    const totalVisible = $('.code-item:visible').length;
    const totalHidden = $('.code-item:hidden').length;
    
    if (totalHidden === 0) {
        $('#loadMoreRow').hide();
    } else {
        $('#loadMoreBtn').html(`<i class="fas fa-plus"></i> ë” ë³´ê¸° (${totalHidden}ê°œ ë‚¨ìŒ)`);
        $('#loadMoreRow').show();
    }
}

// í†µê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateStatistics() {
    if (allCodes.length === 0) return;
    
    // ê¹Šì´ë³„ ì½”ë“œ ê°œìˆ˜ ê³„ì‚°
    const depthCounts = {0: 0, 1: 0, 2: 0, 3: 0, 4: 0};
    
    allCodes.forEach(code => {
        if (code.depth >= 0 && code.depth <= 4) {
            depthCounts[code.depth]++;
        }
    });
    
    // HTML ì—…ë°ì´íŠ¸ (ì¹´ë“œì— í‘œì‹œ)
    $('.card-body .row .col-6').each(function(index) {
        if (index < 5) { // Depth 0-4
            $(this).find('h5').text(depthCounts[index]);
        }
    });
    
    console.log('ğŸ“Š í†µê³„ ì—…ë°ì´íŠ¸:', depthCounts);
}

// ì½”ë“œ í–‰ ìƒì„±
function buildCodeRow(code) {
    const depthColors = {
        0: 'warning',
        1: 'info', 
        2: 'success',
        3: 'secondary',
        4: 'dark'
    };
    
    const icons = {
        0: 'folder text-warning',
        1: 'folder-open text-info',
        2: 'file-alt text-success', 
        3: 'file text-secondary',
        4: 'dot-circle text-muted'
    };
    
    return `
        <tr class="sortable-row depth-row-${code.depth} code-item" 
            id="row-${code.seq}" 
            data-seq="${code.seq}" 
            data-depth="${code.depth}" 
            data-parent-seq="${code.parent_seq || 0}"
            data-sort="${code.sort || 1}">
            <td class="drag-handle">
                <i class="fas fa-grip-vertical" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½"></i>
            </td>
            <td class="depth-${code.depth}">
                <i class="fas fa-${icons[code.depth]} hierarchy-icon"></i>
                <strong>${code.code}</strong>
            </td>
            <td class="depth-${code.depth}">${code.code_name}</td>
            <td class="depth-${code.depth}">${code.code_info || '-'}</td>
            <td class="text-center">
                <span class="badge bg-${depthColors[code.depth]}">${code.depth}</span>
            </td>
            <td class="text-center sort-number">${code.sort || 1}</td>
            <td class="code-actions">
                <div class="btn-group btn-group-sm">
                    ${code.depth < 4 ? `
                    <button class="btn btn-outline-success btn-sm add-child-btn" 
                            data-parent-seq="${code.seq}" 
                            data-depth="${code.depth + 1}" 
                            title="í•˜ìœ„ ì½”ë“œ ì¶”ê°€">
                        <i class="fas fa-plus"></i>
                    </button>` : ''}
                    <button class="btn btn-outline-primary btn-sm edit-code-btn" 
                            data-seq="${code.seq}" 
                            title="ìˆ˜ì •">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm delete-code-btn" 
                            data-seq="${code.seq}" 
                            title="ì‚­ì œ">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
}

// ì¶”ê°€ í¼ í‘œì‹œ
function showAddForm(parentSeq, depth) {
    resetForm();
    
    $('#parent_seq').val(parentSeq);
    $('#depth').val(depth);
    $('#form-title').text(`ì½”ë“œ ì¶”ê°€ (Depth ${depth})`);
    $('#submit-text').text('ì¶”ê°€');
    
    // ìƒìœ„ ì½”ë“œ ì •ë³´ í‘œì‹œ
    if (parentSeq == 0) {
        $('#parent_info').val('Root (ìµœìƒìœ„)');
    } else {
        const parentCode = allCodes.find(c => c.seq == parentSeq);
        if (parentCode) {
            $('#parent_info').val(`${parentCode.code} - ${parentCode.code_name}`);
        }
    }
}

// ìˆ˜ì • í¼ í‘œì‹œ
function showEditForm(seq) {
    const code = allCodes.find(c => c.seq == seq);
    if (!code) {
        alert('ì½”ë“œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    $('#edit_seq').val(seq);
    $('#parent_seq').val(code.parent_seq || 0);
    $('#depth').val(code.depth);
    $('#code').val(code.code);
    $('#code_name').val(code.code_name);
    $('#code_info').val(code.code_info || '');
    $('#sort').val(code.sort || 1);
    
    $('#form-title').text(`ì½”ë“œ ìˆ˜ì • (${code.code})`);
    $('#submit-text').text('ìˆ˜ì •');
    
    // ìƒìœ„ ì½”ë“œ ì •ë³´ í‘œì‹œ
    if (code.parent_seq == 0 || !code.parent_seq) {
        $('#parent_info').val('Root (ìµœìƒìœ„)');
    } else {
        const parentCode = allCodes.find(c => c.seq == code.parent_seq);
        if (parentCode) {
            $('#parent_info').val(`${parentCode.code} - ${parentCode.code_name}`);
        }
    }
}

// í¼ ë¦¬ì…‹
function resetForm() {
    $('#codeForm')[0].reset();
    $('#edit_seq').val('');
    $('#parent_seq').val('0');
    $('#depth').val('1');
    $('#sort').val('1');
    $('#form-title').text('ì½”ë“œ ë“±ë¡');
    $('#submit-text').text('ì €ì¥');
    $('#parent_info').val('');
}

// í¼ ì œì¶œ
function submitForm() {
    const formData = new FormData($('#codeForm')[0]);
    const isEdit = $('#edit_seq').val() !== '';
    
    const url = isEdit ? '/admin/api/codes/update' : '/admin/api/codes/create';
    
    $.ajax({
        url: url,
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                alert(isEdit ? 'ì½”ë“œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì½”ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            } else {
                alert('ì˜¤ë¥˜: ' + (response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        },
        error: function() {
            alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
}

// ì½”ë“œ ì‚­ì œ
function deleteCode(seq) {
    $.ajax({
        url: '/admin/api/codes/delete',
        method: 'POST',
        data: { seq: seq },
        success: function(response) {
            if (response.success) {
                alert('ì½”ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            } else {
                alert('ì˜¤ë¥˜: ' + (response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        },
        error: function() {
            alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
}

// ì„±ê³µ ì‹œ ì½”ë“œ ì¶”ê°€
function addCodeToTable(newCode) {
    console.log('âœ… ìƒˆ ì½”ë“œë¥¼ í…Œì´ë¸”ì— ì¶”ê°€:', newCode);
    
    // allCodes ë°°ì—´ì— ì¶”ê°€
    allCodes.push(newCode);
    
    // ë¶€ëª¨ ì½”ë“œ ì°¾ê¸° ë° ì •ë ¬ ìœ„ì¹˜ ê³„ì‚°
    const parentSeq = newCode.parent_seq || 0;
    const siblings = allCodes.filter(code => code.parent_seq === parentSeq && code.seq !== newCode.seq);
    
    // ì •ë ¬ ìˆœì„œì— ë”°ë¼ ì‚½ì… ìœ„ì¹˜ ì°¾ê¸°
    siblings.sort((a, b) => (parseInt(a.sort) || 999) - (parseInt(b.sort) || 999));
    
    let insertAfterRow = null;
    if (parentSeq === 0) {
        // ìµœìƒìœ„ ì½”ë“œì¸ ê²½ìš°
        insertAfterRow = $('#Root');
    } else {
        // í•˜ìœ„ ì½”ë“œì¸ ê²½ìš° ë¶€ëª¨ í–‰ ì°¾ê¸°
        insertAfterRow = $(`#row-${parentSeq}`);
    }
    
    // ê°™ì€ ë ˆë²¨ì˜ ì½”ë“œë“¤ ì¤‘ì—ì„œ ì •ë ¬ ìˆœì„œì— ë§ëŠ” ìœ„ì¹˜ ì°¾ê¸°
    const newSort = parseInt(newCode.sort) || 999;
    siblings.forEach(sibling => {
        if ((parseInt(sibling.sort) || 999) < newSort) {
            const siblingRow = $(`#row-${sibling.seq}`);
            if (siblingRow.length > 0) {
                insertAfterRow = siblingRow;
            }
        }
    });
    
    // ìƒˆ í–‰ ìƒì„± ë° ì‚½ì…
    const newRow = buildCodeRowWithToggle(newCode);
    insertAfterRow.after(newRow);
    
    // ë¶€ëª¨ì˜ í† ê¸€ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateToggleIcon(parentSeq, (newCode.depth || 1) - 1);
    
    // ìƒˆ ì½”ë“œì˜ í† ê¸€ ì•„ì´ì½˜ë„ ì„¤ì •
    updateToggleIcon(newCode.seq, newCode.depth);
    
    // ë¶€ëª¨ê°€ í¼ì³ì ¸ ìˆìœ¼ë©´ ìƒˆ ì½”ë“œ í‘œì‹œ
    const $parentToggle = $(`.toggle-icon[data-seq="${parentSeq}"]`);
    if (parentSeq === 0 || $parentToggle.hasClass('expanded')) {
        $(`#row-${newCode.seq}`).show();
    }
    
    // í†µê³„ ì—…ë°ì´íŠ¸
    updateStatistics();
    
    // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
    reloadCodeTable();
}

// í† ê¸€ ê¸°ëŠ¥ì´ í¬í•¨ëœ ì½”ë“œ í–‰ ìƒì„±
function buildCodeRowWithToggle(code) {
    const depthColors = {
        0: 'warning',
        1: 'info', 
        2: 'success',
        3: 'secondary',
        4: 'dark'
    };
    
    const icons = {
        0: 'folder text-warning',
        1: 'folder-open text-info',
        2: 'file-alt text-success', 
        3: 'file text-secondary',
        4: 'dot-circle text-muted'
    };
    
    return `
        <tr class="sortable-row depth-row-${code.depth} code-item toggleable-code" 
            id="row-${code.seq}" 
            data-seq="${code.seq}" 
            data-depth="${code.depth}" 
            data-parent-seq="${code.parent_seq || 0}"
            data-sort="${code.sort || 1}"
            data-has-children="false">
            <td class="drag-handle">
                <i class="fas fa-grip-vertical" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½"></i>
            </td>
            <td class="depth-${code.depth} code-cell">
                <!-- í† ê¸€ ì•„ì´ì½˜ -->
                <i class="toggle-icon fas fa-chevron-right empty" 
                   data-seq="${code.seq}" 
                   data-depth="${code.depth}"
                   title="í•˜ìœ„ ì½”ë“œ í† ê¸€" style="display: none;"></i>
                
                <i class="fas fa-${icons[code.depth]} hierarchy-icon"></i>
                <span class="code-text">${code.code}</span>
            </td>
            <td class="depth-${code.depth} code-cell">${code.code_name}</td>
            <td class="depth-${code.depth} code-cell">${code.code_info || '-'}</td>
            <td class="text-center">
                <span class="badge bg-${depthColors[code.depth]}">${code.depth}</span>
            </td>
            <td class="text-center sort-number">${code.sort || 1}</td>
            <td class="code-actions">
                <div class="btn-group btn-group-sm">
                    ${code.depth < 4 ? `
                    <button class="btn btn-outline-success btn-sm add-child-btn" 
                            data-parent-seq="${code.seq}" 
                            data-depth="${code.depth + 1}" 
                            title="í•˜ìœ„ ì½”ë“œ ì¶”ê°€">
                        <i class="fas fa-plus"></i>
                    </button>` : ''}
                    <button class="btn btn-outline-primary btn-sm edit-code-btn" 
                            data-seq="${code.seq}" 
                            title="ìˆ˜ì •">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm delete-code-btn" 
                            data-seq="${code.seq}" 
                            title="ì‚­ì œ">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
}
</script>
{% endblock %}