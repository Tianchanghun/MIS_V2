{% extends 'base.html' %}

{% block page_title %}ì‚¬ìš©ì ê´€ë¦¬{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-users"></i> ì‚¬ìš©ì ê´€ë¦¬</h2>
        <button class="btn btn-primary" onclick="showAddUserModal()">
            <i class="fas fa-plus"></i> ì‚¬ìš©ì ì¶”ê°€
        </button>
    </div>
    
    <!-- ê²€ìƒ‰ ë° í•„í„° -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="ì´ë¦„, ID, ì‚¬ë²ˆ, ì´ë©”ì¼ë¡œ ê²€ìƒ‰...">
                    </div>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-primary" onclick="searchUsers()">
                        <i class="fas fa-search"></i> ê²€ìƒ‰
                    </button>
                    <button class="btn btn-outline-secondary" onclick="resetSearch()">
                        <i class="fas fa-refresh"></i> ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì‚¬ìš©ì ëª©ë¡ -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-list"></i> ì‚¬ìš©ì ëª©ë¡
                <span id="userCount" class="badge bg-secondary ms-2">0</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-sm" id="usersTable">
                    <thead class="table-light">
                        <tr>
                            <th>ë²ˆí˜¸</th>
                            <th>ID</th>
                            <th>ì´ë¦„</th>
                            <th>ì‚¬ë²ˆ</th>
                            <th>ì´ë©”ì¼</th>
                            <th>í•¸ë“œí°</th>
                            <th>íšŒì‚¬ ì†Œì†</th>
                            <th>ë¶€ì„œ</th>
                            <th>ìŠˆí¼ìœ ì €</th>
                            <th>ìƒíƒœ</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                    </tbody>
                </table>
            </div>
            
            <!-- í˜ì´ì§• -->
            <nav aria-label="ì‚¬ìš©ì ëª©ë¡ í˜ì´ì§€ë„¤ì´ì…˜">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- ğŸ¨ ì‚¬ìš©ì ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ (AdminLTE 3 í†µì¼ ë°©ì‹) -->
{% set modal_id = 'userModal' %}
{% set modal_title = 'ì‚¬ìš©ì ì¶”ê°€' %}
{% set modal_size = 'lg' %}
{% set modal_icon = 'fas fa-user-plus' %}
{% set modal_body_content %}
    <form id="userForm">
        <input type="hidden" id="user_seq" name="user_seq">
        
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="login_id" class="form-label">ë¡œê·¸ì¸ ID <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="login_id" name="login_id" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="name" class="form-label">ì´ë¦„ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="name" name="name" required>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="password" class="form-label">ë¹„ë°€ë²ˆí˜¸ <span id="passwordRequired" class="text-danger">*</span></label>
                    <input type="password" class="form-control" id="password" name="password">
                    <div class="form-text">ìˆ˜ì • ì‹œì—ëŠ” ë³€ê²½í•  ë•Œë§Œ ì…ë ¥í•˜ì„¸ìš”.</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="id_number" class="form-label">ì‚¬ë²ˆ</label>
                    <input type="text" class="form-control" id="id_number" name="id_number">
                </div>
            </div>
        </div>
        
        <!-- ì—°ë½ì²˜ ì •ë³´ -->
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="email" class="form-label">ì´ë©”ì¼</label>
                    <input type="email" class="form-control" id="email" name="email">
                </div>
            </div>
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="mobile" class="form-label">í•¸ë“œí°</label>
                    <input type="text" class="form-control" id="mobile" name="mobile">
                </div>
            </div>
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="extension_number" class="form-label">ë‚´ì„ ë²ˆí˜¸</label>
                    <input type="text" class="form-control" id="extension_number" name="extension_number">
                </div>
            </div>
        </div>
        
        <!-- íšŒì‚¬ ì†Œì† -->
        <div class="mb-3">
            <label class="form-label">íšŒì‚¬ ì†Œì†</label>
            <div id="companiesSection">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCompanySelection()">
                <i class="fas fa-plus"></i> íšŒì‚¬ ì¶”ê°€
            </button>
        </div>
        
        <!-- ë¶€ì„œ ì„ íƒ -->
        <div class="mb-3">
            <label class="form-label">ë¶€ì„œ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
            <div id="departmentsSection">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
        </div>
        
        <!-- ì‹œìŠ¤í…œ ì„¤ì • -->
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="member_status" class="form-label">ìƒíƒœ</label>
                    <select class="form-control" id="member_status" name="member_status">
                        <option value="Y">ì¬ì§</option>
                        <option value="N">í‡´ì‚¬</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="super_user" class="form-label">ìŠˆí¼ìœ ì €</label>
                    <select class="form-control" id="super_user" name="super_user">
                        <option value="N">ì¼ë°˜ ì‚¬ìš©ì</option>
                        <option value="Y">ìŠˆí¼ìœ ì €</option>
                    </select>
                </div>
            </div>
        </div>
    </form>
{% endset %}
{% set footer_buttons %}
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-1"></i>ì·¨ì†Œ
    </button>
    <button type="button" class="btn btn-primary" onclick="saveUser()">
        <i class="fas fa-save me-1"></i>ì €ì¥
    </button>
{% endset %}
{% include 'components/modal_base.html' %}

<!-- ğŸ¨ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ (AdminLTE 3 í†µì¼ ë°©ì‹) -->
{% set modal_id = 'passwordModal' %}
{% set modal_title = 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½' %}
{% set modal_size = '' %}
{% set modal_icon = 'fas fa-key' %}
{% set modal_body_content %}
    <form id="passwordForm">
        <input type="hidden" id="pwd_user_seq">
        <div class="mb-3">
            <label for="new_password" class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ <span class="text-danger">*</span></label>
            <input type="password" class="form-control" id="new_password" name="new_password" required>
        </div>
        <div class="mb-3">
            <label for="confirm_password" class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span class="text-danger">*</span></label>
            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
        </div>
    </form>
{% endset %}
{% set footer_buttons %}
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-1"></i>ì·¨ì†Œ
    </button>
    <button type="button" class="btn btn-primary" onclick="changePassword()">
        <i class="fas fa-check me-1"></i>ë³€ê²½
    </button>
{% endset %}
{% include 'components/modal_base.html' %}

<script>
let currentPage = 1;
let usersData = [];
let companiesData = [];
let departmentsData = [];

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
$(document).ready(function() {
    loadInitialData();
    loadUsers();
    
    // ì—”í„°í‚¤ ê²€ìƒ‰ ì§€ì›
    $('#searchInput').on('keypress', function(e) {
        if (e.which === 13) {
            searchUsers();
        }
    });

    // ë¶€ì„œ ëª©ë¡ ë¡œë“œ (ì‚¬ìš©ì íšŒì‚¬ë³„ í•„í„°ë§)
    loadDepartments();

    // íšŒì‚¬ ì „í™˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    $(window).on('companyChanged', function() {
        console.log('íšŒì‚¬ ì „í™˜ ê°ì§€ - ë¶€ì„œ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ');
        loadDepartments();
    });
});

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ
function loadInitialData() {
    // íšŒì‚¬ ëª©ë¡ ë¡œë“œ
    $.get('/admin/api/companies')
        .done(function(response) {
            if (response.success) {
                companiesData = response.data;
            }
        })
        .fail(function() {
            showAlert('íšŒì‚¬ ëª©ë¡ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
        });
}

// ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
function loadUsers(page = 1, search = '') {
    const params = new URLSearchParams({
        page: page,
        per_page: 20
    });
    
    if (search) {
        params.append('search', search);
    }
    
    $.get(`/admin/api/users?${params.toString()}`)
        .done(function(response) {
            if (response.success) {
                usersData = response.data;
                renderUsersTable(response.data);
                renderPagination(response.pagination);
                $('#userCount').text(response.pagination.total);
            } else {
                showAlert(response.message, 'danger');
            }
        })
        .fail(function() {
            showAlert('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
        });
}

// ë¶€ì„œ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜ (ë³„ë„ ë¶„ë¦¬)
function loadDepartments() {
    $.get('/admin/api/departments/dropdown')
        .done(function(response) {
            if (response.success) {
                departmentsData = response.data;
                console.log('ë¶€ì„œ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', departmentsData.length + 'ê°œ ë¶€ì„œ');
                console.log('í˜„ì¬ íšŒì‚¬ ID:', response.current_company_id);
                
                // í˜„ì¬ ì—´ë ¤ìˆëŠ” ëª¨ë‹¬ì´ ìˆë‹¤ë©´ ë¶€ì„œ ì„¹ì…˜ ë‹¤ì‹œ ë Œë”ë§
                if ($('#userModal').hasClass('show')) {
                    const currentUserDepartments = [];
                    $('input[name="department_ids"]:checked').each(function() {
                        const deptSeq = parseInt($(this).val());
                        const deptName = $(this).next('label').text();
                        currentUserDepartments.push({seq: deptSeq, name: deptName});
                    });
                    renderDepartmentsSection(currentUserDepartments);
                }
            }
        })
        .fail(function() {
            showAlert('ë¶€ì„œ ëª©ë¡ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
        });
}

// íšŒì‚¬ ì „í™˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
$(document).ready(function() {
    // íšŒì‚¬ ì „í™˜ ì™„ë£Œ ì‹œ ë¶€ì„œ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
    $(window).on('companyChanged', function() {
        console.log('íšŒì‚¬ ì „í™˜ ê°ì§€ - ë¶€ì„œ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ');
        loadDepartments();
    });
});

// ì‚¬ìš©ì í…Œì´ë¸” ë Œë”ë§
function renderUsersTable(users) {
    const tbody = $('#usersTableBody');
    tbody.empty();
    
    if (users.length === 0) {
        tbody.append(`
            <tr>
                <td colspan="11" class="text-center text-muted">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
        `);
        return;
    }
    
    users.forEach((user, index) => {
        const companiesText = user.companies.map(c => {
            const primary = c.is_primary ? ' (ì£¼)' : '';
            return c.company_name + primary;
        }).join(', ');
        
        const departmentsText = user.departments.map(d => d.name).join(', ');
        
        const statusBadge = user.member_status === 'Y' ? 
            '<span class="badge bg-success">ì¬ì§</span>' : 
            '<span class="badge bg-secondary">í‡´ì‚¬</span>';
            
        const superUserBadge = user.super_user === 'Y' ?
            '<span class="badge bg-warning">ìŠˆí¼ìœ ì €</span>' :
            '<span class="badge bg-light text-dark">ì¼ë°˜</span>';
        
        tbody.append(`
            <tr>
                <td>${(currentPage - 1) * 20 + index + 1}</td>
                <td>${user.login_id}</td>
                <td>${user.name}</td>
                <td>${user.id_number || '-'}</td>
                <td>${user.email || '-'}</td>
                <td>${user.mobile || '-'}</td>
                <td class="small">${companiesText || '-'}</td>
                <td class="small">${departmentsText || '-'}</td>
                <td>${superUserBadge}</td>
                <td>${statusBadge}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editUser(${user.seq})" title="ìˆ˜ì •">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-warning" onclick="changeUserPassword(${user.seq})" title="ë¹„ë°€ë²ˆí˜¸ ë³€ê²½">
                            <i class="fas fa-key"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteUser(${user.seq})" title="ì‚­ì œ">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `);
    });
}

// í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
function renderPagination(pagination) {
    const paginationEl = $('#pagination');
    paginationEl.empty();
    
    if (pagination.pages <= 1) return;
    
    // ì´ì „ í˜ì´ì§€
    const prevDisabled = pagination.page === 1 ? 'disabled' : '';
    paginationEl.append(`
        <li class="page-item ${prevDisabled}">
            <a class="page-link" href="#" onclick="loadUsers(${pagination.page - 1})">ì´ì „</a>
        </li>
    `);
    
    // í˜ì´ì§€ ë²ˆí˜¸ë“¤
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const active = i === pagination.page ? 'active' : '';
        paginationEl.append(`
            <li class="page-item ${active}">
                <a class="page-link" href="#" onclick="loadUsers(${i})">${i}</a>
            </li>
        `);
    }
    
    // ë‹¤ìŒ í˜ì´ì§€
    const nextDisabled = pagination.page === pagination.pages ? 'disabled' : '';
    paginationEl.append(`
        <li class="page-item ${nextDisabled}">
            <a class="page-link" href="#" onclick="loadUsers(${pagination.page + 1})">ë‹¤ìŒ</a>
        </li>
    `);
    
    currentPage = pagination.page;
}

// ê²€ìƒ‰
function searchUsers() {
    const search = $('#searchInput').val().trim();
    currentPage = 1;
    loadUsers(1, search);
}

// ê²€ìƒ‰ ì´ˆê¸°í™”
function resetSearch() {
    $('#searchInput').val('');
    currentPage = 1;
    loadUsers();
}

// ì‚¬ìš©ì ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ (ğŸ¨ AdminLTE 3 ë°©ì‹)
function showAddUserModal() {
    $('#userModalTitle').text('ì‚¬ìš©ì ì¶”ê°€');
    $('#userForm')[0].reset();
    $('#user_seq').val('');
    $('#password').prop('required', true);
    $('#passwordRequired').show();
    
    // ModalHelper ì‚¬ìš©
    ModalHelper.setTitle('userModal', 'ì‚¬ìš©ì ì¶”ê°€', 'fas fa-user-plus');
    ModalHelper.show('userModal');
}

// íšŒì‚¬ ì„ íƒ ì„¹ì…˜ ë Œë”ë§
function renderCompaniesSection(userCompanies = []) {
    const section = $('#companiesSection');
    section.empty();
    
    if (userCompanies.length === 0) {
        // ì‹ ê·œ ì‚¬ìš©ì: í˜„ì¬ íšŒì‚¬ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ
        const currentCompanyId = parseInt($('meta[name="current-company-id"]').attr('content')) || 1;
        userCompanies = [{
            company_id: currentCompanyId,
            is_primary: true,
            role: 'user'
        }];
    }
    
    userCompanies.forEach((uc, index) => {
        section.append(`
            <div class="row mb-2" data-company-index="${index}">
                <div class="col-md-4">
                    <select class="form-control company-select" name="companies[${index}][company_id]">
                        ${companiesData.map(c => 
                            `<option value="${c.id}" ${c.id === uc.company_id ? 'selected' : ''}>${c.company_name}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-control" name="companies[${index}][role]">
                        <option value="user" ${uc.role === 'user' ? 'selected' : ''}>ì¼ë°˜ ì‚¬ìš©ì</option>
                        <option value="manager" ${uc.role === 'manager' ? 'selected' : ''}>ê´€ë¦¬ì</option>
                        <option value="admin" ${uc.role === 'admin' ? 'selected' : ''}>ìµœê³ ê´€ë¦¬ì</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="form-check">
                        <input class="form-check-input primary-check" type="checkbox" name="companies[${index}][is_primary]" ${uc.is_primary ? 'checked' : ''}>
                        <label class="form-check-label">ì£¼ ì†Œì†</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCompanySelection(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `);
    });
}

// ë¶€ì„œ ì„ íƒ ì„¹ì…˜ ë Œë”ë§
function renderDepartmentsSection(userDepartments = []) {
    const section = $('#departmentsSection');
    section.empty();
    
    departmentsData.forEach(dept => {
        const checked = userDepartments.some(ud => ud.seq === dept.seq) ? 'checked' : '';
        section.append(`
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="dept_${dept.seq}" name="department_ids" value="${dept.seq}" ${checked}>
                <label class="form-check-label" for="dept_${dept.seq}">${dept.dept_name}</label>
            </div>
        `);
    });
}

// íšŒì‚¬ ì„ íƒ ì¶”ê°€
function addCompanySelection() {
    const section = $('#companiesSection');
    const index = section.find('[data-company-index]').length;
    
    section.append(`
        <div class="row mb-2" data-company-index="${index}">
            <div class="col-md-4">
                <select class="form-control company-select" name="companies[${index}][company_id]">
                    ${companiesData.map(c => `<option value="${c.id}">${c.company_name}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-control" name="companies[${index}][role]">
                    <option value="user">ì¼ë°˜ ì‚¬ìš©ì</option>
                    <option value="manager">ê´€ë¦¬ì</option>
                    <option value="admin">ìµœê³ ê´€ë¦¬ì</option>
                </select>
            </div>
            <div class="col-md-3">
                <div class="form-check">
                    <input class="form-check-input primary-check" type="checkbox" name="companies[${index}][is_primary]">
                    <label class="form-check-label">ì£¼ ì†Œì†</label>
                </div>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCompanySelection(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `);
}

// íšŒì‚¬ ì„ íƒ ì œê±°
function removeCompanySelection(index) {
    $(`[data-company-index="${index}"]`).remove();
}

// ì‚¬ìš©ì ìˆ˜ì •
function editUser(userSeq) {
    const user = usersData.find(u => u.seq === userSeq);
    if (!user) {
        showAlert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'danger');
        return;
    }
    
    // ìƒì„¸ ì •ë³´ ë¡œë“œ
    $.get(`/admin/api/users/${userSeq}`)
        .done(function(response) {
            if (response.success) {
                const userData = response.data;
                
                $('#userModalTitle').text('ì‚¬ìš©ì ìˆ˜ì •');
                $('#user_seq').val(userData.seq);
                $('#login_id').val(userData.login_id);
                $('#name').val(userData.name);
                $('#id_number').val(userData.id_number);
                $('#email').val(userData.email);
                $('#mobile').val(userData.mobile);
                $('#extension_number').val(userData.extension_number);
                $('#member_status').val(userData.member_status);
                $('#super_user').val(userData.super_user);
                
                $('#passwordRequired').hide();
                $('#password').prop('required', false);
                
                renderCompaniesSection(userData.companies);
                renderDepartmentsSection(userData.departments);
                
                // ModalHelper ì‚¬ìš©
                ModalHelper.setTitle('userModal', 'ì‚¬ìš©ì ìˆ˜ì •', 'fas fa-user-edit');
                ModalHelper.show('userModal');
            } else {
                showAlert(response.message, 'danger');
            }
        })
        .fail(function() {
            showAlert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
        });
}

// ì‚¬ìš©ì ì €ì¥
function saveUser() {
    const formData = new FormData($('#userForm')[0]);
    const userData = {};
    
    // ê¸°ë³¸ í•„ë“œ
    ['login_id', 'name', 'password', 'id_number', 'email', 'mobile', 'extension_number', 'member_status', 'super_user'].forEach(field => {
        const value = formData.get(field);
        if (value !== null && value !== '') {
            userData[field] = value;
        }
    });
    
    // íšŒì‚¬ ì†Œì† ì •ë³´
    userData.companies = [];
    $('#companiesSection [data-company-index]').each(function() {
        const companyData = {
            company_id: parseInt($(this).find('.company-select').val()),
            role: $(this).find('select[name*="[role]"]').val(),
            is_primary: $(this).find('.primary-check').is(':checked')
        };
        userData.companies.push(companyData);
    });
    
    // ë¶€ì„œ ì •ë³´
    userData.department_ids = [];
    $('input[name="department_ids"]:checked').each(function() {
        userData.department_ids.push(parseInt($(this).val()));
    });
    
    const userSeq = $('#user_seq').val();
    const method = userSeq ? 'PUT' : 'POST';
    const url = userSeq ? `/admin/api/users/${userSeq}` : '/admin/api/users';
    
    $.ajax({
        url: url,
        method: method,
        contentType: 'application/json',
        data: JSON.stringify(userData)
    })
    .done(function(response) {
        if (response.success) {
            showAlert(response.message, 'success');
            ModalHelper.hide('userModal');
            loadUsers(currentPage);
        } else {
            showAlert(response.message, 'danger');
        }
    })
    .fail(function() {
        showAlert('ì‚¬ìš©ì ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
    });
}

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
function changeUserPassword(userSeq) {
    $('#pwd_user_seq').val(userSeq);
    $('#passwordForm')[0].reset();
    ModalHelper.show('passwordModal');
}

function changePassword() {
    const newPassword = $('#new_password').val();
    const confirmPassword = $('#confirm_password').val();
    
    if (newPassword !== confirmPassword) {
        showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'danger');
        return;
    }
    
    const userSeq = $('#pwd_user_seq').val();
    
    $.ajax({
        url: `/admin/api/users/${userSeq}/password`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ new_password: newPassword })
    })
    .done(function(response) {
        if (response.success) {
            showAlert(response.message, 'success');
            ModalHelper.hide('passwordModal');
        } else {
            showAlert(response.message, 'danger');
        }
    })
    .fail(function() {
        showAlert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
    });
}

// ì‚¬ìš©ì ì‚­ì œ
function deleteUser(userSeq) {
    const user = usersData.find(u => u.seq === userSeq);
    if (!user) return;
    
    if (!confirm(`'${user.name}' ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    $.ajax({
        url: `/admin/api/users/${userSeq}`,
        method: 'DELETE'
    })
    .done(function(response) {
        if (response.success) {
            showAlert(response.message, 'success');
            loadUsers(currentPage);
        } else {
            showAlert(response.message, 'danger');
        }
    })
    .fail(function() {
        showAlert('ì‚¬ìš©ì ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
    });
}

// ì•Œë¦¼ í‘œì‹œ
function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // ê¸°ì¡´ ì•Œë¦¼ ì œê±° í›„ ì¶”ê°€
    $('.alert').remove();
    $('.container-fluid').prepend(alertHtml);
    
    // 3ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        $('.alert').fadeOut();
    }, 3000);
}
</script>
{% endblock %} 