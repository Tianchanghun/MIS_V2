{% extends 'base.html' %}

{% block page_title %}ë§¤ì¥ ê´€ë¦¬{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-store"></i> ë§¤ì¥ ê´€ë¦¬</h2>
        <div class="d-flex gap-2">
            <!-- ë™ê¸°í™” ë²„íŠ¼ -->
            <button type="button" class="btn btn-primary" id="btnSyncShops" onclick="syncShopsFromErpia()">
                <i class="fas fa-sync-alt"></i> ERPia ë™ê¸°í™”
            </button>
            
            <!-- ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
            <button type="button" class="btn btn-success" id="btnExportExcel" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            </button>
            
            <div>
                <span id="shopStats" class="text-muted"></span>
            </div>
        </div>
    </div>
    
    <!-- í•„í„° ë° ê²€ìƒ‰ -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <!-- ë§¤ì¥ ìœ í˜• í•„í„° -->
                <div class="col-md-6">
                    <ul class="nav nav-pills">
                        <li class="nav-item">
                            <a class="nav-link {{ 'active' if shop_type == 'All' else '' }}" 
                               href="?ty=All">ì „ì²´</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ 'active' if shop_type == 'Shop' else '' }}" 
                               href="?ty=Shop">ë§¤ì¥</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ 'active' if shop_type == 'NoShop' else '' }}" 
                               href="?ty=NoShop">ë§¤ì¥ì•„ë‹˜</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ 'active' if shop_type == 'Nothing' else '' }}" 
                               href="?ty=Nothing">ë¯¸ë¶„ë¥˜</a>
                        </li>
                    </ul>
                </div>
                
                <!-- ê²€ìƒ‰ -->
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="ê±°ë˜ì²˜ëª…, ì½”ë“œ, ë‹´ë‹¹ì, ì£¼ì†Œë¡œ ê²€ìƒ‰...">
                        <button class="btn btn-outline-primary" onclick="searchShops()">
                            <i class="fas fa-search"></i> ê²€ìƒ‰
                        </button>
                        <button class="btn btn-outline-secondary" onclick="resetSearch()">
                            <i class="fas fa-refresh"></i> ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ë§¤ì¥ ëª©ë¡ -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-list"></i> ê±°ë˜ì²˜ ë¦¬ìŠ¤íŠ¸
                <span id="shopCount" class="badge bg-secondary ms-2">0</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-sm" id="shopsTable">
                    <thead class="table-light">
                        <tr>
                            <th>ë²ˆí˜¸</th>
                            <th>ê±°ë˜ì²˜ ì½”ë“œ</th>
                            <th>íŒë§¤ì±„ë„</th>
                            <th>ê±°ë˜ì²˜ëª…</th>
                            <th>ì „í™”ë²ˆí˜¸</th>
                            <th>ì‹œ/ë„</th>
                            <th>êµ¬</th>
                            <th>ë‹´ë‹¹ì</th>
                            <th>ê±°ë˜ì²˜ ë“±ê¸‰</th>
                            <th>ë§¤ì¥ì‚¬ìš©</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ë™ì ìœ¼ë¡œ ë¡œë“œ -->
                    </tbody>
                </table>
            </div>
            
            <!-- í˜ì´ì§• -->
            <nav aria-label="ë§¤ì¥ ëª©ë¡ í˜ì´ì§•">
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- ë§¤ì¥ ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="shopModal" tabindex="-1" aria-labelledby="shopModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shopModalLabel">ê±°ë˜ì²˜ ì •ë³´ ìˆ˜ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
                <nav>
                    <div class="nav nav-tabs" id="nav-tab" role="tablist">
                        <button class="nav-link active" id="nav-basic-tab" data-bs-toggle="tab" 
                                data-bs-target="#nav-basic" type="button" role="tab">ê¸°ë³¸ì •ë³´</button>
                        <button class="nav-link" id="nav-contact-tab" data-bs-toggle="tab" 
                                data-bs-target="#nav-contact" type="button" role="tab">ì—°ë½ì²˜</button>
                        <button class="nav-link" id="nav-address-tab" data-bs-toggle="tab" 
                                data-bs-target="#nav-address" type="button" role="tab">ì£¼ì†Œì •ë³´</button>
                        <button class="nav-link" id="nav-category-tab" data-bs-toggle="tab" 
                                data-bs-target="#nav-category" type="button" role="tab">ë¶„ë¥˜ì •ë³´</button>
                        <button class="nav-link" id="nav-etc-tab" data-bs-toggle="tab" 
                                data-bs-target="#nav-etc" type="button" role="tab">ê¸°íƒ€ì •ë³´</button>
                    </div>
                </nav>
                
                <!-- íƒ­ ë‚´ìš© -->
                <div class="tab-content" id="nav-tabContent">
                    <!-- ê¸°ë³¸ì •ë³´ íƒ­ -->
                    <div class="tab-pane fade show active" id="nav-basic" role="tabpanel">
                        <div class="row mt-3">
                            <!-- Hidden field for shop seq -->
                            <input type="hidden" id="shop_seq">
                            
                            <div class="col-md-6">
                                <label for="customer_code" class="form-label">ê±°ë˜ì²˜ ì½”ë“œ</label>
                                <input type="text" class="form-control" id="customer_code" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="customer_name" class="form-label">ê±°ë˜ì²˜ëª…</label>
                                <input type="text" class="form-control" id="customer_name">
                            </div>
                            <div class="col-md-6">
                                <label for="ceo" class="form-label">ëŒ€í‘œì</label>
                                <input type="text" class="form-control" id="ceo">
                            </div>
                            <div class="col-md-6">
                                <label for="business_number" class="form-label">ì‚¬ì—…ìë²ˆí˜¸</label>
                                <input type="text" class="form-control" id="business_number">
                            </div>
                            <div class="col-md-6">
                                <label for="business_type" class="form-label">ì—…íƒœ</label>
                                <input type="text" class="form-control" id="business_type">
                            </div>
                            <div class="col-md-6">
                                <label for="business_item" class="form-label">ì¢…ëª©</label>
                                <input type="text" class="form-control" id="business_item">
                            </div>
                            <div class="col-md-6">
                                <label for="shop_yn" class="form-label">ë§¤ì¥ì‚¬ìš©</label>
                                <select class="form-control" id="shop_yn">
                                    <option value="">ì„ íƒ</option>
                                    <option value="Y">ë§¤ì¥ì‚¬ìš©</option>
                                    <option value="N">ë§¤ì¥ì‚¬ìš©ì•ˆí•¨</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì—°ë½ì²˜ íƒ­ -->
                    <div class="tab-pane fade" id="nav-contact" role="tabpanel">
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="phone" class="form-label">ì „í™”</label>
                                <input type="text" class="form-control" id="phone">
                            </div>
                            <div class="col-md-6">
                                <label for="fax" class="form-label">íŒ©ìŠ¤</label>
                                <input type="text" class="form-control" id="fax">
                            </div>
                            <div class="col-md-6">
                                <label for="our_manager" class="form-label">ê±°ë˜ì²˜ ë‹´ë‹¹ì</label>
                                <input type="text" class="form-control" id="our_manager">
                            </div>
                            <div class="col-md-6">
                                <label for="customer_manager" class="form-label">ìƒëŒ€ë°© ë‹´ë‹¹ì</label>
                                <input type="text" class="form-control" id="customer_manager">
                            </div>
                            <div class="col-md-6">
                                <label for="customer_manager_tel" class="form-label">ìƒëŒ€ë°© ë‹´ë‹¹ì ì „í™”</label>
                                <input type="text" class="form-control" id="customer_manager_tel">
                            </div>
                            <div class="col-md-6">
                                <label for="tax_manager" class="form-label">ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì</label>
                                <input type="text" class="form-control" id="tax_manager">
                            </div>
                            <div class="col-md-6">
                                <label for="tax_manager_tel" class="form-label">ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì ì „í™”</label>
                                <input type="text" class="form-control" id="tax_manager_tel">
                            </div>
                            <div class="col-md-6">
                                <label for="tax_email" class="form-label">ì„¸ê¸ˆê³„ì‚°ì„œ ë‹´ë‹¹ì ì´ë©”ì¼</label>
                                <input type="email" class="form-control" id="tax_email">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì£¼ì†Œì •ë³´ íƒ­ -->
                    <div class="tab-pane fade" id="nav-address" role="tabpanel">
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="zip_code1" class="form-label">ì„¸ê¸ˆê³„ì‚°ì„œ ìš°í¸ë²ˆí˜¸</label>
                                <input type="text" class="form-control" id="zip_code1">
                            </div>
                            <div class="col-md-6">
                                <label for="location" class="form-label">ë¡œì¼€ì´ì…˜</label>
                                <input type="text" class="form-control" id="location">
                            </div>
                            <div class="col-md-12">
                                <label for="address1" class="form-label">ì„¸ê¸ˆê³„ì‚°ì„œ ì£¼ì†Œ</label>
                                <input type="text" class="form-control" id="address1">
                            </div>
                            <div class="col-md-6">
                                <label for="zip_code2" class="form-label">ë°°ì†¡ì§€ ìš°í¸ë²ˆí˜¸</label>
                                <input type="text" class="form-control" id="zip_code2">
                            </div>
                            <div class="col-md-6">
                                <!-- ê³µë°± -->
                            </div>
                            <div class="col-md-12">
                                <label for="address2" class="form-label">ë°°ì†¡ì§€ ì£¼ì†Œ</label>
                                <input type="text" class="form-control" id="address2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Classification Tab (ë™ì  ìƒì„±) -->
                    <div class="tab-pane fade" id="nav-category" role="tabpanel">
                        <div class="row mt-3" id="classificationsContainer">
                            <div class="col-12 text-center">
                                <i class="fas fa-spinner fa-spin"></i> ë¶„ë¥˜ ì •ë³´ ë¡œë”© ì¤‘...
                            </div>
                        </div>
                    </div>
                    
                    <!-- ê¸°íƒ€ì •ë³´ íƒ­ -->
                    <div class="tab-pane fade" id="nav-etc" role="tabpanel">
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <label for="remarks" class="form-label">ë¹„ê³ </label>
                                <textarea class="form-control" id="remarks" rows="3"></textarea>
                            </div>
                            <div class="col-md-12">
                                <label for="memo" class="form-label">ë©”ëª¨</label>
                                <textarea class="form-control" id="memo" rows="3"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="admin_code" class="form-label">ERPia ê´€ë¦¬ì ì½”ë“œ</label>
                                <input type="text" class="form-control" id="admin_code" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="edit_date" class="form-label">ìµœì¢…ìˆ˜ì •ì¼</label>
                                <input type="text" class="form-control" id="edit_date" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" id="btnSaveShop">
                    <i class="fas fa-save"></i> ì €ì¥
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
        </div>
        <div class="mt-2">ë§¤ì¥ ì •ë³´ ë¡œë”© ì¤‘...</div>
    </div>
</div>

<style>
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

.loading-spinner {
    background: white;
    padding: 2rem;
    border-radius: 0.5rem;
    text-align: center;
}

.table tbody tr {
    cursor: pointer;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
}
</style>

<script>
        // ì „ì—­ ë³€ìˆ˜
        let shopClassifications = {};
        let classificationGroups = [];
        let currentShopSeq = null;
        let currentPage = 1;
        let currentShopType = '{{ shop_type }}';
        let currentSearch = '';
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        $(document).ready(function() {
            loadShopStats();
            loadShops();
            loadClassificationGroups(); // ë¶„ë¥˜ ê·¸ë£¹ ì •ë³´ ë¨¼ì € ë¡œë“œ
            
            // ì—”í„°í‚¤ ê²€ìƒ‰ ì§€ì›
            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) {
                    searchShops();
                }
            });
            
            // í…Œì´ë¸” í–‰ í´ë¦­ ì´ë²¤íŠ¸
            $(document).on('click', '#shopsTable tbody tr', function() {
                const shopSeq = $(this).data('seq');
                if (shopSeq) {
                    showShopModal(shopSeq);
                }
            });
            
            // ì €ì¥ ë²„íŠ¼ í´ë¦­
            $('#btnSaveShop').on('click', saveShop);
        });
        
        // ë¶„ë¥˜ ê·¸ë£¹ ì •ë³´ ë¡œë“œ (UI êµ¬ì„±ìš©)
        function loadClassificationGroups() {
            $.get('/shop/api/classifications/groups')
                .done(function(response) {
                    if (response.success) {
                        classificationGroups = response.data;
                        console.log(`ğŸ“‚ ë¶„ë¥˜ ê·¸ë£¹ ë¡œë“œ ì™„ë£Œ: ${response.total}ê°œ ê·¸ë£¹`);
                        
                        // ë¶„ë¥˜ ì •ë³´ ìƒì„¸ ë¡œë“œ
                        loadClassifications();
                        
                        // ë¶„ë¥˜ UI ìƒì„±
                        buildClassificationUI();
                    } else {
                        console.error('âŒ ë¶„ë¥˜ ê·¸ë£¹ ë¡œë“œ ì‹¤íŒ¨:', response.message);
                        showClassificationError('ë¶„ë¥˜ ê·¸ë£¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                })
                .fail(function() {
                    console.error('âŒ ë¶„ë¥˜ ê·¸ë£¹ ë¡œë“œ ì„œë²„ ì˜¤ë¥˜');
                    showClassificationError('ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }
        
        // ë¶„ë¥˜ ì •ë³´ ë¡œë“œ
        function loadClassifications() {
            $.get('/shop/api/classifications')
                .done(function(response) {
                    if (response.success) {
                        shopClassifications = response.data;
                        console.log(`ğŸ·ï¸ ë¶„ë¥˜ ì •ë³´ ë¡œë“œ ì™„ë£Œ: ${response.meta?.total_groups || 0}ê°œ ê·¸ë£¹`);
                        
                        // ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì±„ìš°ê¸°
                        populateClassificationDropdowns();
                    } else {
                        console.error('âŒ ë¶„ë¥˜ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', response.message);
                        showClassificationError('ë¶„ë¥˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                })
                .fail(function() {
                    console.error('âŒ ë¶„ë¥˜ ì •ë³´ ë¡œë“œ ì„œë²„ ì˜¤ë¥˜');
                    showClassificationError('ë¶„ë¥˜ ì •ë³´ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }
        
        // ë¶„ë¥˜ UI ë™ì  ìƒì„±
        function buildClassificationUI() {
            const container = $('#classificationsContainer');
            
            if (!classificationGroups || classificationGroups.length === 0) {
                container.html(`
                    <div class="col-12 text-center text-muted">
                        <i class="fas fa-info-circle"></i> ì‚¬ìš© ê°€ëŠ¥í•œ ë¶„ë¥˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
                        <br><small>ì½”ë“œ ê´€ë¦¬ì—ì„œ CST ê·¸ë£¹ì— ë¶„ë¥˜ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</small>
                    </div>
                `);
                return;
            }
            
            let html = '';
            
            // ë¶„ë¥˜ ê·¸ë£¹ë³„ë¡œ ë“œë¡­ë‹¤ìš´ ìƒì„± (2ì—´ ë ˆì´ì•„ì›ƒ)
            classificationGroups.forEach(function(group, index) {
                const fieldId = group.key; // ì†Œë¬¸ì í‚¤ ì‚¬ìš©
                const fieldName = group.name;
                
                html += `
                    <div class="col-md-6 mb-3">
                        <label for="${fieldId}" class="form-label">
                            <i class="fas fa-tag text-primary"></i> ${fieldName}
                            <small class="text-muted">(${group.sub_codes_count}ê°œ ì˜µì…˜)</small>
                        </label>
                        <select class="form-control classification-select" 
                                id="${fieldId}" 
                                data-group-code="${group.code}"
                                data-group-seq="${group.seq}">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                `;
            });
            
            // ì¶”ê°€ ì •ë³´ í‘œì‹œ
            html += `
                <div class="col-12 mt-3">
                    <div class="alert alert-info alert-sm">
                        <i class="fas fa-lightbulb"></i> 
                        <strong>ë¶„ë¥˜ ì •ë³´ ì•ˆë‚´:</strong> 
                        ì´ ${classificationGroups.length}ê°œì˜ ë¶„ë¥˜ ê·¸ë£¹ì´ ìˆìŠµë‹ˆë‹¤. 
                        ë¶„ë¥˜ëŠ” <a href="/admin/code_management" target="_blank">ì½”ë“œ ê´€ë¦¬ > CST</a>ì—ì„œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                </div>
            `;
            
            container.html(html);
            console.log(`ğŸ¨ ë¶„ë¥˜ UI ìƒì„± ì™„ë£Œ: ${classificationGroups.length}ê°œ ë“œë¡­ë‹¤ìš´`);
        }
        
        // ë¶„ë¥˜ ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì±„ìš°ê¸°
        function populateClassificationDropdowns() {
            classificationGroups.forEach(function(group) {
                const selectElement = $(`#${group.key}`);
                if (selectElement.length === 0) return;
                
                // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ "ì„ íƒí•˜ì„¸ìš”" ì œì™¸)
                selectElement.find('option:not(:first)').remove();
                
                // í•´ë‹¹ ê·¸ë£¹ì˜ ë¶„ë¥˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const classificationData = shopClassifications[group.key];
                if (!classificationData || !classificationData.codes) {
                    console.warn(`âš ï¸ ${group.key} ë¶„ë¥˜ ë°ì´í„° ì—†ìŒ`);
                    return;
                }
                
                // ì˜µì…˜ ì¶”ê°€
                classificationData.codes.forEach(function(code) {
                    selectElement.append(`
                        <option value="${code.code}" title="${code.code_info || code.code_name}">
                            ${code.code_name}
                        </option>
                    `);
                });
                
                console.log(`  âœ… ${group.key}(${group.name}): ${classificationData.codes.length}ê°œ ì˜µì…˜ ì¶”ê°€`);
            });
        }
        
        // ë¶„ë¥˜ ì˜¤ë¥˜ í‘œì‹œ
        function showClassificationError(message) {
            $('#classificationsContainer').html(`
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> ${message}
                        <br><small>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</small>
                    </div>
                </div>
            `);
        }
        
        // ë§¤ì¥ í†µê³„ ë¡œë“œ
        function loadShopStats() {
            $.get('/shop/api/stats')
                .done(function(response) {
                    if (response.success) {
                        const stats = response.data;
                        $('#shopStats').html(`
                            ì „ì²´: ${stats.total} | 
                            ë§¤ì¥: ${stats.shops} | 
                            ë§¤ì¥ì•„ë‹˜: ${stats.no_shops} | 
                            ë¯¸ë¶„ë¥˜: ${stats.nothing}
                        `);
                    }
                })
                .fail(function() {
                    showAlert('í†µê³„ ì •ë³´ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
                });
        }

        // ë§¤ì¥ ëª©ë¡ ë¡œë“œ
        function loadShops(page = 1) {
            currentPage = page;
            
            const params = {
                ty: currentShopType,
                search: currentSearch,
                page: page,
                per_page: 20
            };
            
            $.get('/shop/api/shops', params)
                .done(function(response) {
                    if (response.success) {
                        renderShopsTable(response.data);
                        renderPagination(response.pagination);
                    } else {
                        showAlert('danger', 'ë§¤ì¥ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                })
                .fail(function() {
                    showAlert('danger', 'ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }
        
        // ë§¤ì¥ ê²€ìƒ‰
        function searchShops() {
            currentSearch = $('#searchInput').val().trim();
            currentPage = 1;
            loadShops(1);
        }
        
        // ê²€ìƒ‰ ì´ˆê¸°í™”
        function resetSearch() {
            $('#searchInput').val('');
            currentSearch = '';
            currentPage = 1;
            loadShops(1);
        }
        
        // ë§¤ì¥ ìœ í˜• í•„í„° ë³€ê²½
        function filterShops(shopType) {
            currentShopType = shopType;
            currentPage = 1;
            loadShops(1);
            
            // í™œì„± ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            $('.filter-btn').removeClass('btn-primary').addClass('btn-outline-primary');
            $(`[onclick="filterShops('${shopType}')"]`).removeClass('btn-outline-primary').addClass('btn-primary');
        }

        // ë§¤ì¥ í…Œì´ë¸” ë Œë”ë§
        function renderShopsTable(shops) {
            const tbody = $('#shopsTable tbody');
            tbody.empty();
            
            shops.forEach((shop, index) => {
                const shopYnBadge = shop.shop_yn === 'Y' ? 
                    '<span class="badge bg-success">ë§¤ì¥</span>' : 
                    shop.shop_yn === 'N' ? 
                    '<span class="badge bg-secondary">ë§¤ì¥ì•„ë‹˜</span>' : 
                    '<span class="badge bg-warning">ë¯¸ë¶„ë¥˜</span>';
            
                // ì£¼ì†Œì—ì„œ ì‹œ/ë„, êµ¬ ì¶”ì¶œ
                let sido = '', gungu = '';
                if (shop.address1) {
                    const addressParts = shop.address1.split(' ');
                    if (addressParts.length >= 2) {
                        sido = addressParts[0];
                        gungu = addressParts[1];
                    }
                }
                
                const row = `
                    <tr data-seq="${shop.seq}">
                        <td>${(currentPage - 1) * 20 + index + 1}</td>
                        <td>${shop.customer_code || ''}</td>
                        <td>${shop.channel_type || ''}</td>
                        <td><strong>${shop.customer_name || ''}</strong></td>
                        <td>${shop.phone || ''}</td>
                        <td>${sido}</td>
                        <td>${gungu}</td>
                        <td>${shop.our_manager || ''}</td>
                        <td></td>
                        <td>${shopYnBadge}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        // í˜ì´ì§• ë Œë”ë§
        function renderPagination(pagination) {
            const nav = $('#pagination');
            nav.empty();
            
            // ì´ì „ í˜ì´ì§€
            if (pagination.has_prev) {
                nav.append(`
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadShops(${pagination.page - 1})">ì´ì „</a>
                    </li>
                `);
            }
            
            // í˜ì´ì§€ ë²ˆí˜¸ë“¤
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.pages, pagination.page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                nav.append(`
                    <li class="page-item ${i === pagination.page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadShops(${i})">${i}</a>
                    </li>
                `);
            }
            
            // ë‹¤ìŒ í˜ì´ì§€
            if (pagination.has_next) {
                nav.append(`
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadShops(${pagination.page + 1})">ë‹¤ìŒ</a>
                    </li>
                `);
            }
        }
        
        // ë§¤ì¥ ëª¨ë‹¬ í‘œì‹œ
        function showShopModal(shopSeq) {
            currentShopSeq = shopSeq;
            $('#shopModal').modal('show');
            
            // ë§¤ì¥ ì •ë³´ ë¡œë“œ
            $.get(`/shop/api/shop/${shopSeq}`)
                .done(function(response) {
                    if (response.success) {
                        populateShopModal(response.data);
                    } else {
                        showAlert('danger', 'ë§¤ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                })
                .fail(function() {
                    showAlert('danger', 'ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }
        
        // ë§¤ì¥ ì •ë³´ ëª¨ë‹¬ì— ë¶„ë¥˜ ì •ë³´ ì±„ìš°ê¸°
        function populateShopModal(shop) {
            // ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
            $('#shop_seq').val(shop.seq || '');
            $('#customer_code').val(shop.customer_code || '');
            $('#customer_name').val(shop.customer_name || '');
            $('#ceo').val(shop.ceo || '');
            $('#business_number').val(shop.business_number || '');
            $('#business_type').val(shop.business_type || '');
            $('#business_item').val(shop.business_item || '');
            
            // ì—°ë½ì²˜ ì •ë³´
            $('#phone').val(shop.phone || '');
            $('#fax').val(shop.fax || '');
            $('#our_manager').val(shop.our_manager || '');
            $('#customer_manager').val(shop.customer_manager || '');
            $('#customer_manager_tel').val(shop.customer_manager_tel || '');
            
            // ì£¼ì†Œ ì •ë³´
            $('#location').val(shop.location || '');
            $('#zip_code1').val(shop.zip_code1 || '');
            $('#address1').val(shop.address1 || '');
            $('#zip_code2').val(shop.zip_code2 || '');
            $('#address2').val(shop.address2 || '');
            $('#remarks').val(shop.remarks || '');
            
            // ê¸°íƒ€ ì •ë³´
            $('#tax_manager').val(shop.tax_manager || '');
            $('#tax_manager_tel').val(shop.tax_manager_tel || '');
            $('#tax_email').val(shop.tax_email || '');
            $('#memo').val(shop.memo || '');
            $('#shop_yn').val(shop.shop_yn || '');
            
            // ë¶„ë¥˜ ì •ë³´ ë™ì  ì„¤ì •
            classificationGroups.forEach(function(group) {
                const fieldId = group.key;
                const selectElement = $(`#${fieldId}`);
                
                if (selectElement.length > 0) {
                    // ë§¤ì¥ ë°ì´í„°ì—ì„œ í•´ë‹¹ ë¶„ë¥˜ ê°’ ê°€ì ¸ì˜¤ê¸°
                    const fieldValue = shop[fieldId] || '';
                    selectElement.val(fieldValue);
                    
                    if (fieldValue) {
                        console.log(`ğŸ·ï¸ ${group.name}: ${fieldValue} ì„¤ì •`);
                    }
                }
            });
        }
        
        // ë§¤ì¥ ì •ë³´ ì €ì¥ì‹œ ë¶„ë¥˜ ì •ë³´ í¬í•¨
        function saveShop() {
            const shopSeq = $('#shop_seq').val();
            
            if (!shopSeq) {
                showAlert('danger', 'ë§¤ì¥ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘
            const shopData = {
                customer_name: $('#customer_name').val(),
                ceo: $('#ceo').val(),
                business_number: $('#business_number').val(),
                business_type: $('#business_type').val(),
                business_item: $('#business_item').val(),
                phone: $('#phone').val(),
                fax: $('#fax').val(),
                our_manager: $('#our_manager').val(),
                customer_manager: $('#customer_manager').val(),
                customer_manager_tel: $('#customer_manager_tel').val(),
                location: $('#location').val(),
                zip_code1: $('#zip_code1').val(),
                address1: $('#address1').val(),
                zip_code2: $('#zip_code2').val(),
                address2: $('#address2').val(),
                remarks: $('#remarks').val(),
                tax_manager: $('#tax_manager').val(),
                tax_manager_tel: $('#tax_manager_tel').val(),
                tax_email: $('#tax_email').val(),
                memo: $('#memo').val(),
                shop_yn: $('#shop_yn').val()
            };
            
            // ë¶„ë¥˜ ì •ë³´ ë™ì  ìˆ˜ì§‘
            classificationGroups.forEach(function(group) {
                const fieldId = group.key;
                const selectElement = $(`#${fieldId}`);
                
                if (selectElement.length > 0) {
                    shopData[fieldId] = selectElement.val() || '';
                }
            });
            
            showLoading(true);
            
            $.ajax({
                url: `/shop/api/shop/${shopSeq}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(shopData),
                success: function(response) {
                    showLoading(false);
                    if (response.success) {
                        showAlert('success', 'ë§¤ì¥ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        $('#shopModal').modal('hide');
                        loadShops(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        loadShopStats(); // í†µê³„ ìƒˆë¡œê³ ì¹¨
                    } else {
                        showAlert('danger', 'ì €ì¥ ì‹¤íŒ¨: ' + response.message);
                    }
                },
                error: function() {
                    showLoading(false);
                    showAlert('danger', 'ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(type = 'info', message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('.container-fluid').prepend(alertHtml);
            
            // 3ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                $('.alert').fadeOut();
            }, 3000);
        }

        // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ/ìˆ¨ê¹€
        function showLoading(show) {
            $('#loadingOverlay').toggle(show);
        }
        
        // ERPia ë§¤ì¥ ì •ë³´ ë™ê¸°í™”
        function syncShopsFromErpia() {
            if (!confirm('ERPiaì—ì„œ ë§¤ì¥ ì •ë³´ë¥¼ ë™ê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ëª‡ ë¶„ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© ìƒíƒœ
            $('#btnSyncShops').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> ë™ê¸°í™” ì¤‘...');
            showLoading(true);
            
            $.ajax({
                url: '/shop/api/sync-erpia',
                method: 'POST',
                timeout: 300000, // 5ë¶„ íƒ€ì„ì•„ì›ƒ
                success: function(response) {
                    if (response.success) {
                        showAlert('success', `âœ… ë™ê¸°í™” ì™„ë£Œ: ${response.data.updated}ê°œ ì—…ë°ì´íŠ¸, ${response.data.inserted}ê°œ ì‹ ê·œ ì¶”ê°€`);
                        loadShops(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        loadShopStats(); // í†µê³„ ìƒˆë¡œê³ ì¹¨
                    } else {
                        showAlert('danger', 'âŒ ë™ê¸°í™” ì‹¤íŒ¨: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    if (status === 'timeout') {
                        showAlert('warning', 'â° ë™ê¸°í™” ì‘ì—…ì´ ì‹œê°„ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê³„ì† ì§„í–‰ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    } else {
                        showAlert('danger', 'âŒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ' + error);
                    }
                },
                complete: function() {
                    // ë²„íŠ¼ ë³µì›
                    $('#btnSyncShops').prop('disabled', false).html('<i class="fas fa-sync-alt"></i> ERPia ë™ê¸°í™”');
                    showLoading(false);
                }
            });
        }
        
        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function exportToExcel() {
            // í˜„ì¬ í•„í„° ì¡°ê±´ ìˆ˜ì§‘
            const params = {
                ty: currentShopType,
                search: currentSearch,
                format: 'excel'
            };
            
            // íŒŒë¼ë¯¸í„°ë¥¼ ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ìœ¼ë¡œ ë³€í™˜
            const queryString = new URLSearchParams(params).toString();
            
            // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„± ë° í´ë¦­
            const downloadUrl = `/shop/api/export-excel?${queryString}`;
            
            // ë²„íŠ¼ ì¼ì‹œ ë¹„í™œì„±í™”
            $('#btnExportExcel').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> ìƒì„± ì¤‘...');
            
            // iframeì„ ì´ìš©í•œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = downloadUrl;
            document.body.appendChild(iframe);
            
            // 3ì´ˆ í›„ ë²„íŠ¼ ë³µì› ë° iframe ì œê±°
            setTimeout(() => {
                $('#btnExportExcel').prop('disabled', false).html('<i class="fas fa-file-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ');
                document.body.removeChild(iframe);
                showAlert('success', 'ğŸ“Š ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }, 3000);
        }
</script>
{% endblock %} 