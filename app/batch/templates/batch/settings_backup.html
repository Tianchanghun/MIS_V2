{% extends "base.html" %}

{% block title %}ERPia ë°°ì¹˜ ì„¤ì •{% endblock %}

{% block extra_css %}
<style>
.settings-card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 8px;
    margin-bottom: 20px;
}

.card-header {
    background: linear-gradient(135deg, #007bff, #6f42c1);
    color: white;
    border-radius: 8px 8px 0 0 !important;
    padding: 15px 20px;
}

.form-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.connection-status {
    padding: 10px 15px;
    border-radius: 6px;
    margin-bottom: 15px;
    font-weight: 500;
}

.status-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.status-error {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.status-unknown {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.schedule-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.schedule-option {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.schedule-option:hover {
    border-color: #007bff;
    background-color: #f8f9ff;
}

.schedule-option.active {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.time-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.btn-test {
    background: linear-gradient(45deg, #28a745, #20c997);
    border: none;
    color: white;
    transition: all 0.3s ease;
}

.btn-test:hover {
    background: linear-gradient(45deg, #218838, #1a9970);
    transform: translateY(-1px);
}

.batch-step {
    transition: all 0.3s ease;
    cursor: move;
}

.batch-step:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.batch-step.dragging {
    opacity: 0.5;
    transform: rotate(2deg);
}

.step-order {
    font-size: 0.9rem;
    min-width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-move-up, .btn-move-down {
    border: none !important;
    font-size: 0.8rem;
}

.batch-step.border-primary {
    border-width: 2px !important;
}

.batch-step .form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-cog text-primary me-2"></i>ERPia ë°°ì¹˜ ì„¤ì •</h2>
            <p class="text-muted mb-0">íšŒì‚¬ë³„ ERPia ì—°ë™ ë° ë°°ì¹˜ ìŠ¤ì¼€ì¤„ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
        </div>
        <div>
            <a href="{{ url_for('batch.index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>ë°°ì¹˜ ëŒ€ì‹œë³´ë“œ
            </a>
        </div>
    </div>

    <!-- íšŒì‚¬ ì„ íƒ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card settings-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-building me-2"></i>íšŒì‚¬ ì„ íƒ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">ì„¤ì •í•  íšŒì‚¬ ì„ íƒ</label>
                            <select class="form-select" id="companySelect" onchange="loadCompanySettings()">
                                <option value="">íšŒì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                {% if user_companies %}
                                    {% for uc in user_companies %}
                                    <option value="{{ uc.company_id }}" {% if current_company and uc.company_id == current_company.id %}selected{% endif %}>
                                        {{ uc.company.company_name }}
                                        {% if uc.is_primary %}<span class="badge bg-primary ms-1">ì£¼ì†</span>{% endif %}
                                    </option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ERPia ì—°ë™ ì„¤ì • -->
    <div class="row mb-4" id="settingsPanel" style="display: none;">
        <div class="col-md-6">
            <div class="card settings-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-plug me-2"></i>ERPia ì—°ë™ ì„¤ì •</h5>
                </div>
                <div class="card-body">
                    <!-- ì—°ê²° ìƒíƒœ -->
                    <div id="connectionStatus" class="connection-status status-unknown">
                        <i class="fas fa-question-circle me-2"></i>ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ë ¤ë©´ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.
                    </div>

                    <form id="erpiaConfigForm">
                        <div class="form-section">
                            <h6 class="text-primary mb-3"><i class="fas fa-key me-2"></i>ì¸ì¦ ì •ë³´</h6>
                            
                            <div class="mb-3">
                                <label for="adminCode" class="form-label">ERPia ê´€ë¦¬ì ì½”ë“œ</label>
                                <input type="text" class="form-control" id="adminCode" placeholder="ì˜ˆ: aone" required>
                                <div class="form-text">ERPia ì‹œìŠ¤í…œì—ì„œ ì œê³µë°›ì€ ê´€ë¦¬ì ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="erpiaPassword" class="form-label">ERPia ë¹„ë°€ë²ˆí˜¸</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="erpiaPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required>
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('erpiaPassword')">
                                        <i class="fas fa-eye" id="erpiaPasswordIcon"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="apiUrl" class="form-label">API URL</label>
                                <input type="url" class="form-control" id="apiUrl" value="http://www.erpia.net/xml/xml.asp">
                                <div class="form-text">ERPia API ì—”ë“œí¬ì¸íŠ¸ URL (ê¸°ë³¸ê°’ ìœ ì§€ ê¶Œì¥)</div>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isActive" checked>
                                <label class="form-check-label" for="isActive">
                                    ERPia ì—°ë™ í™œì„±í™”
                                </label>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-test" onclick="testConnection()">
                                <i class="fas fa-wifi me-2"></i>ì—°ê²° í…ŒìŠ¤íŠ¸
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>ì„¤ì • ì €ì¥
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ë°°ì¹˜ ìŠ¤ì¼€ì¤„ ì„¤ì • -->
        <div class="col-md-6">
            <div class="card settings-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>ë°°ì¹˜ ìŠ¤ì¼€ì¤„ ì„¤ì •</h5>
                </div>
                <div class="card-body">
                    <form id="batchScheduleForm">
                        <div class="form-section">
                            <h6 class="text-primary mb-3"><i class="fas fa-calendar me-2"></i>ìŠ¤ì¼€ì¤„ ìœ í˜•</h6>
                            
                            <div class="schedule-grid">
                                <div class="schedule-option" data-type="daily">
                                    <div class="text-center">
                                        <i class="fas fa-sun fa-2x text-warning mb-2"></i>
                                        <h6>ë§¤ì¼ ì‹¤í–‰</h6>
                                        <small class="text-muted">ë§¤ì¼ ì§€ì •ëœ ì‹œê°„ì— ìë™ ì‹¤í–‰</small>
                                    </div>
                                </div>
                                
                                <div class="schedule-option" data-type="weekly">
                                    <div class="text-center">
                                        <i class="fas fa-calendar-week fa-2x text-info mb-2"></i>
                                        <h6>ì£¼ê°„ ì‹¤í–‰</h6>
                                        <small class="text-muted">ì„ íƒí•œ ìš”ì¼ì—ë§Œ ì‹¤í–‰</small>
                                    </div>
                                </div>
                                
                                <div class="schedule-option" data-type="manual">
                                    <div class="text-center">
                                        <i class="fas fa-hand-paper fa-2x text-secondary mb-2"></i>
                                        <h6>ìˆ˜ë™ ì‹¤í–‰</h6>
                                        <small class="text-muted">í•„ìš”ì‹œì—ë§Œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ì‹¤í–‰ ì‹œê°„ ì„¤ì • -->
                        <div class="form-section" id="timeSettings" style="display: none;">
                            <h6 class="text-primary mb-3"><i class="fas fa-clock me-2"></i>ì‹¤í–‰ ì‹œê°„</h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">ì‹¤í–‰ ì‹œê°„</label>
                                    <input type="time" class="form-control" id="scheduleTime" value="02:00">
                                </div>
                            </div>
                            
                            <!-- ìš”ì¼ ì„ íƒ (ì£¼ê°„ ì‹¤í–‰ì‹œ) -->
                            <div id="weekdaySettings" style="display: none;">
                                <label class="form-label mt-3">ì‹¤í–‰ ìš”ì¼</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="day1" value="1">
                                        <label class="form-check-label" for="day1">ì›”</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="day2" value="2">
                                        <label class="form-check-label" for="day2">í™”</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="day3" value="3">
                                        <label class="form-check-label" for="day3">ìˆ˜</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="day4" value="4">
                                        <label class="form-check-label" for="day4">ëª©</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="day5" value="5">
                                        <label class="form-check-label" for="day5">ê¸ˆ</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="day6" value="6">
                                        <label class="form-check-label" for="day6">í† </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="day7" value="7">
                                        <label class="form-check-label" for="day7">ì¼</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ERPia ë°°ì¹˜ ì‹¤í–‰ ìˆœì„œ ì„¤ì • -->
                        <div class="form-section">
                            <h6 class="text-primary mb-3"><i class="fas fa-list-ol me-2"></i>ë°°ì¹˜ ì‹¤í–‰ ìˆœì„œ ì„¤ì •</h6>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>ë°°ì¹˜ ì‹¤í–‰ ìˆœì„œ:</strong> ì²´í¬ëœ í•­ëª©ë§Œ ì„ íƒí•œ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤. (ë§¤ì¥ì •ë³´ â†’ ì¬ê³ ì •ë³´ â†’ ìƒí’ˆì •ë³´ â†’ ë§¤ì¶œë°ì´í„°)
                            </div>
                            
                            <div id="batchStepsList">
                                <!-- 1. ë§¤ì¥ì •ë³´ ìˆ˜ì§‘ -->
                                <div class="batch-step card mb-2" data-step="customers">
                                    <div class="card-body py-2">
                                        <div class="row align-items-center">
                                            <div class="col-1">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="step_customers" checked>
                                                </div>
                                            </div>
                                            <div class="col-1 text-center">
                                                <span class="badge bg-secondary step-order">1</span>
                                            </div>
                                            <div class="col-7">
                                                <strong>ë§¤ì¥ì •ë³´ ìˆ˜ì§‘</strong> (mode=cust)
                                                <br><small class="text-muted">ê±°ë˜ì²˜(ë§¤ì¥) ë§ˆìŠ¤í„° ë°ì´í„° ìˆ˜ì§‘</small>
                                            </div>
                                            <div class="col-3">
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-secondary btn-move-up" onclick="moveStep(this, 'up')">
                                                        <i class="fas fa-arrow-up"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary btn-move-down" onclick="moveStep(this, 'down')">
                                                        <i class="fas fa-arrow-down"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 2. ì¬ê³  ì •ë³´ ìˆ˜ì§‘ -->
                                <div class="batch-step card mb-2" data-step="stock">
                                    <div class="card-body py-2">
                                        <div class="row align-items-center">
                                            <div class="col-1">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="step_stock" checked>
                                                </div>
                                            </div>
                                            <div class="col-1 text-center">
                                                <span class="badge bg-secondary step-order">2</span>
                                            </div>
                                            <div class="col-7">
                                                <strong>ì¬ê³  ì •ë³´ ìˆ˜ì§‘</strong> (mode=jegoAll)
                                                <br><small class="text-muted">ìƒí’ˆ ì¬ê³  ë°ì´í„° (ë ˆê±°ì‹œ í˜¸í™˜)</small>
                                            </div>
                                            <div class="col-3">
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-secondary btn-move-up" onclick="moveStep(this, 'up')">
                                                        <i class="fas fa-arrow-up"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary btn-move-down" onclick="moveStep(this, 'down')">
                                                        <i class="fas fa-arrow-down"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 3. ìƒí’ˆ ì •ë³´ ìˆ˜ì§‘ -->
                                <div class="batch-step card mb-2" data-step="goods">
                                    <div class="card-body py-2">
                                        <div class="row align-items-center">
                                            <div class="col-1">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="step_goods" checked>
                                                </div>
                                            </div>
                                            <div class="col-1 text-center">
                                                <span class="badge bg-secondary step-order">3</span>
                                            </div>
                                            <div class="col-7">
                                                <strong>ìƒí’ˆ ì •ë³´ ìˆ˜ì§‘</strong> (mode=goods)
                                                <br><small class="text-muted">ìƒí’ˆ ë§ˆìŠ¤í„° ìƒì„¸ ì •ë³´</small>
                                            </div>
                                            <div class="col-3">
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-secondary btn-move-up" onclick="moveStep(this, 'up')">
                                                        <i class="fas fa-arrow-up"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary btn-move-down" onclick="moveStep(this, 'down')">
                                                        <i class="fas fa-arrow-down"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 4. ë§¤ì¶œ ë°ì´í„° ìˆ˜ì§‘ (í•µì‹¬) -->
                                <div class="batch-step card mb-2 border-primary" data-step="sales">
                                    <div class="card-body py-2">
                                        <div class="row align-items-center">
                                            <div class="col-1">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="step_sales" checked>
                                                </div>
                                            </div>
                                            <div class="col-1 text-center">
                                                <span class="badge bg-primary step-order">4</span>
                                            </div>
                                            <div class="col-7">
                                                <strong>ë§¤ì¶œ ë°ì´í„° ìˆ˜ì§‘</strong> (mode=jumun) <span class="badge bg-danger ms-1">í•µì‹¬</span>
                                                <br><small class="text-muted">ì£¼ë¬¸/ë§¤ì¶œ ë°ì´í„° + ì‚¬ì€í’ˆ ìë™ ë¶„ë¥˜</small>
                                            </div>
                                            <div class="col-3">
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-secondary btn-move-up" onclick="moveStep(this, 'up')">
                                                        <i class="fas fa-arrow-up"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary btn-move-down" onclick="moveStep(this, 'down')">
                                                        <i class="fas fa-arrow-down"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="selectAllSteps()">
                                    <i class="fas fa-check-double"></i> ì „ì²´ ì„ íƒ
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="selectCoreSteps()">
                                    <i class="fas fa-star"></i> í•µì‹¬ 4ê°œ ì„ íƒ
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllSteps()">
                                    <i class="fas fa-times"></i> ì „ì²´ í•´ì œ
                                </button>
                            </div>
                        </div>

                        <!-- ê³ ê¸‰ ì„¤ì • -->
                        <div class="form-section">
                            <h6 class="text-primary mb-3"><i class="fas fa-sliders-h me-2"></i>ê³ ê¸‰ ì„¤ì •</h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">API í˜¸ì¶œ ê°„ê²© (ì´ˆ)</label>
                                    <input type="number" class="form-control" id="callInterval" min="1" max="60" value="3">
                                    <div class="form-text">ERPia API í˜¸ì¶œ ì‚¬ì´ì˜ ëŒ€ê¸° ì‹œê°„</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">í˜ì´ì§€ë‹¹ ë°ì´í„° ê±´ìˆ˜</label>
                                    <input type="number" class="form-control" id="pageSize" min="1" max="30" value="30">
                                    <div class="form-text">í•œ ë²ˆì— ê°€ì ¸ì˜¬ ë°ì´í„° ê±´ìˆ˜ (ìµœëŒ€ 30ê±´)</div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label">ì¬ì‹œë„ íšŸìˆ˜</label>
                                    <input type="number" class="form-control" id="retryCount" min="1" max="10" value="3">
                                    <div class="form-text">API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ íšŸìˆ˜</div>
                                </div>
                            </div>
                            
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="autoGiftClassify" checked>
                                <label class="form-check-label" for="autoGiftClassify">
                                    ì‚¬ì€í’ˆ ìë™ ë¶„ë¥˜ í™œì„±í™”
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>ìŠ¤ì¼€ì¤„ ì €ì¥
                        </button>
                        
                        <!-- ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ ì¶”ê°€ -->
                        <button type="button" class="btn btn-warning ms-2" onclick="showManualBatchModal()">
                            <i class="fas fa-play me-2"></i>ìˆ˜ë™ ì‹¤í–‰
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ìµœê·¼ ë°°ì¹˜ ë¡œê·¸ -->
    <div class="row" id="batchLogsPanel" style="display: none;">
        <div class="col-md-12">
            <div class="card settings-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>ìµœê·¼ ë°°ì¹˜ ì‹¤í–‰ ë¡œê·¸</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="batchLogsTable">
                            <thead>
                                <tr>
                                    <th>ì‹¤í–‰ ì‹œê°„</th>
                                    <th>ê´€ë¦¬ì ì½”ë“œ</th>
                                    <th>ìœ í˜•</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ì²˜ë¦¬ ê±´ìˆ˜</th>
                                    <th>ì‚¬ì€í’ˆ ìˆ˜</th>
                                    <th>ì†Œìš” ì‹œê°„</th>
                                    <th>ìƒì„¸</th>
                                </tr>
                            </thead>
                            <tbody id="batchLogsBody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin me-2"></i>ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ìˆ˜ë™ ë°°ì¹˜ ì‹¤í–‰ ëª¨ë‹¬ -->
<div class="modal fade" id="manualBatchModal" tabindex="-1" style="z-index: 1055;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-play me-2"></i>ìˆ˜ë™ ë°°ì¹˜ ì‹¤í–‰</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="manualBatchForm">
                    <!-- ê¸°ê°„ ì„¤ì • ì•ˆë‚´ -->
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>ìˆ˜ë™ ë°°ì¹˜ ì‹¤í–‰:</strong> ì§€ì •í•œ ê¸°ê°„ì˜ ERPia ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤.
                        <br><small class="mt-1 d-block">â€¢ ê¶Œì¥ ê¸°ê°„: ìµœëŒ€ 30ì¼ (ì„±ëŠ¥ ê³ ë ¤)</small>
                        <small>â€¢ ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì‹œ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                    </div>

                    <!-- ë¹ ë¥¸ ê¸°ê°„ ì„ íƒ -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">ğŸ“… ë¹ ë¥¸ ê¸°ê°„ ì„ íƒ</label>
                        <div class="row g-2">
                            <div class="col-6 col-md-3">
                                <button type="button" class="btn btn-outline-primary w-100 btn-sm" onclick="setDateRange('today')">
                                    <i class="fas fa-calendar-day me-1"></i>ì˜¤ëŠ˜
                                </button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button type="button" class="btn btn-outline-primary w-100 btn-sm" onclick="setDateRange('yesterday')">
                                    <i class="fas fa-calendar-minus me-1"></i>ì–´ì œ
                                </button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button type="button" class="btn btn-outline-primary w-100 btn-sm" onclick="setDateRange('week')">
                                    <i class="fas fa-calendar-week me-1"></i>ìµœê·¼ 7ì¼
                                </button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button type="button" class="btn btn-outline-primary w-100 btn-sm" onclick="setDateRange('month')">
                                    <i class="fas fa-calendar-alt me-1"></i>ìµœê·¼ 30ì¼
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ìƒì„¸ ê¸°ê°„ ì„¤ì • -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualStartDate" class="form-label fw-bold">ğŸ“… ì‹œì‘ì¼</label>
                                <input type="date" class="form-control form-control-lg" id="manualStartDate" required>
                                <div class="form-text">ë°ì´í„° ìˆ˜ì§‘ì„ ì‹œì‘í•  ë‚ ì§œ</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualEndDate" class="form-label fw-bold">ğŸ“… ì¢…ë£Œì¼</label>
                                <input type="date" class="form-control form-control-lg" id="manualEndDate" required>
                                <div class="form-text">ë°ì´í„° ìˆ˜ì§‘ì„ ì¢…ë£Œí•  ë‚ ì§œ</div>
                            </div>
                        </div>
                    </div>

                    <!-- ê¸°ê°„ ì •ë³´ í‘œì‹œ -->
                    <div class="alert alert-light border" id="dateRangeInfo" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>ì„ íƒëœ ê¸°ê°„:</strong> <span id="selectedRange"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>ì´ ì¼ìˆ˜:</strong> <span id="totalDays"></span>ì¼
                            </div>
                        </div>
                        <div class="mt-2" id="periodWarning" style="display: none;">
                            <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                            <small class="text-warning">30ì¼ì„ ì´ˆê³¼í•˜ëŠ” ê¸°ê°„ì€ ì²˜ë¦¬ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                        </div>
                    </div>

                    <!-- ë°°ì¹˜ ì˜µì…˜ -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">âš™ï¸ ë°°ì¹˜ ì˜µì…˜</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeCustomers" checked>
                                    <label class="form-check-label" for="includeCustomers">
                                        <i class="fas fa-store text-primary me-1"></i>ë§¤ì¥ì •ë³´ ìˆ˜ì§‘
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeSales" checked>
                                    <label class="form-check-label" for="includeSales">
                                        <i class="fas fa-chart-line text-success me-1"></i>ë§¤ì¶œë°ì´í„° ìˆ˜ì§‘
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeProducts" checked>
                                    <label class="form-check-label" for="includeProducts">
                                        <i class="fas fa-box text-info me-1"></i>ìƒí’ˆì •ë³´ ìˆ˜ì§‘
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoGiftProcess" checked>
                                    <label class="form-check-label" for="autoGiftProcess">
                                        <i class="fas fa-gift text-warning me-1"></i>ì‚¬ì€í’ˆ ìë™ ë¶„ë¥˜
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì˜ˆìƒ ì²˜ë¦¬ ì‹œê°„ -->
                    <div class="alert alert-secondary" id="estimatedTime">
                        <i class="fas fa-clock me-2"></i>
                        <strong>ì˜ˆìƒ ì²˜ë¦¬ ì‹œê°„:</strong> <span id="timeEstimate">ê³„ì‚° ì¤‘...</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>ì·¨ì†Œ
                </button>
                <button type="button" class="btn btn-success btn-lg" onclick="runManualBatch()" id="runBatchBtn">
                    <i class="fas fa-play me-2"></i>ë°°ì¹˜ ì‹¤í–‰
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentCompanyId = null;

// í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ íšŒì‚¬ ì„¤ì • ë¡œë“œ
$(document).ready(function() {
    const selectedCompany = $('#companySelect').val();
    if (selectedCompany) {
        currentCompanyId = selectedCompany;
        loadCompanySettings();
    }
    
    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ˆê¸°í™”
    const today = new Date().toISOString().split('T')[0];
    $('#manualStartDate').val(today);
    $('#manualEndDate').val(today);
    
    // ë‚ ì§œ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    $('#manualStartDate, #manualEndDate').on('change', function() {
        updateDateRangeInfo();
    });
    
    // ë°°ì¹˜ ì˜µì…˜ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    $('#includeCustomers, #includeSales, #includeProducts, #autoGiftProcess').on('change', function() {
        updateEstimatedTime();
    });
    
    // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ê¸°ê°„ ì •ë³´ ì—…ë°ì´íŠ¸
    $('#manualBatchModal').on('shown.bs.modal', function() {
        updateDateRangeInfo();
        $('#dateRangeInfo').show();
    });
});

// íšŒì‚¬ ì„¤ì • ë¡œë“œ
function loadCompanySettings() {
    const companyId = $('#companySelect').val();
    if (!companyId) {
        $('#settingsPanel').hide();
        $('#batchLogsPanel').hide();
        return;
    }
    
    currentCompanyId = companyId;
    $('#settingsPanel').show();
    $('#batchLogsPanel').show();
    
    // ERPia ì„¤ì • ë¡œë“œ
    $.get(`/batch/api/erpia/settings/${companyId}`)
        .done(function(response) {
            if (response.success) {
                populateSettings(response.data);
            } else {
                showAlert('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: ' + response.message, 'error');
            }
        })
        .fail(function() {
            showAlert('ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        });
    
    // ë°°ì¹˜ ë¡œê·¸ ë¡œë“œ
    loadBatchLogs(companyId);
}

// ì„¤ì • ë°ì´í„°ë¡œ í¼ ì±„ìš°ê¸°
function populateSettings(data) {
    const erpiaConfig = data.erpia_config;
    const batchSettings = data.batch_settings;
    
    if (erpiaConfig) {
        $('#adminCode').val(erpiaConfig.admin_code || '');
        $('#apiUrl').val(erpiaConfig.api_url || 'http://www.erpia.net/xml/xml.asp');
        $('#isActive').prop('checked', erpiaConfig.is_active);
        
        // ì—°ê²° ìƒíƒœ í‘œì‹œ
        updateConnectionStatus(erpiaConfig);
    }
    
    if (batchSettings) {
        $('#scheduleTime').val(batchSettings.schedule_time?.value || '02:00');
        $('#callInterval').val(batchSettings.call_interval?.value || '3');
        $('#pageSize').val(batchSettings.page_size?.value || '30');
        $('#retryCount').val(batchSettings.retry_count?.value || '3');
        $('#autoGiftClassify').prop('checked', 
            batchSettings.auto_gift_classify?.value === 'true');
        
        // ìŠ¤ì¼€ì¤„ íƒ€ì… ì„¤ì •
        const scheduleType = batchSettings.schedule_type?.value || 'daily';
        selectScheduleType(scheduleType);
        
        // ìš”ì¼ ì„¤ì •
        if (batchSettings.schedule_days?.value) {
            const days = batchSettings.schedule_days.value.split(',');
            days.forEach(day => {
                $(`#day${day.trim()}`).prop('checked', true);
            });
        }

        // ë°°ì¹˜ ì‹¤í–‰ ìˆœì„œ ì„¤ì •
        if (batchSettings.batch_steps) {
            try {
                const steps = JSON.parse(batchSettings.batch_steps.value || '[]');
                
                // ì €ì¥ëœ ìˆœì„œëŒ€ë¡œ ì¬ì •ë ¬
                const container = document.getElementById('batchStepsList');
                const stepElements = Array.from(container.querySelectorAll('.batch-step'));
                
                // ëª¨ë“  ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
                stepElements.forEach(stepElement => {
                    stepElement.querySelector('input[type="checkbox"]').checked = false;
                });
                
                // ì €ì¥ëœ ìˆœì„œëŒ€ë¡œ ì •ë ¬ ë° í™œì„±í™”
                steps.sort((a, b) => a.order - b.order).forEach((stepSetting, index) => {
                    const stepElement = stepElements.find(el => el.dataset.step === stepSetting.step);
                    if (stepElement && stepSetting.enabled) {
                        stepElement.querySelector('input[type="checkbox"]').checked = true;
                        // ìˆœì„œëŒ€ë¡œ DOMì—ì„œ ì´ë™
                        container.appendChild(stepElement);
                    }
                });
                
                updateStepNumbers();
            } catch (e) {
                console.error('ë°°ì¹˜ ë‹¨ê³„ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
                // ê¸°ë³¸ê°’ìœ¼ë¡œ í•µì‹¬ ë‹¨ê³„ë§Œ ì„ íƒ
                selectCoreSteps();
            }
        } else {
            // ì„¤ì •ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ í•µì‹¬ ë‹¨ê³„ë§Œ ì„ íƒ
            selectCoreSteps();
        }
    }
}

// ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
function updateConnectionStatus(config) {
    const statusDiv = $('#connectionStatus');
    const lastSync = config.last_sync_date;
    const errorCount = config.sync_error_count || 0;
    
    if (lastSync && errorCount === 0) {
        statusDiv.removeClass('status-unknown status-error').addClass('status-success');
        const syncTime = new Date(lastSync).toLocaleString('ko-KR');
        statusDiv.html(`<i class="fas fa-check-circle me-2"></i>ì—°ê²° ì •ìƒ (ë§ˆì§€ë§‰ í™•ì¸: ${syncTime})`);
    } else if (errorCount > 0) {
        statusDiv.removeClass('status-unknown status-success').addClass('status-error');
        const failText = errorCount === 1 ? '1íšŒ ì‹¤íŒ¨' : `${errorCount}íšŒ ì—°ì† ì‹¤íŒ¨`;
        if (lastSync) {
            const syncTime = new Date(lastSync).toLocaleString('ko-KR');
            statusDiv.html(`<i class="fas fa-exclamation-triangle me-2"></i>ì—°ê²° ì˜¤ë¥˜ (${failText}, ë§ˆì§€ë§‰ ì„±ê³µ: ${syncTime})`);
        } else {
            statusDiv.html(`<i class="fas fa-exclamation-triangle me-2"></i>ì—°ê²° ì˜¤ë¥˜ (${failText})`);
        }
    } else {
        statusDiv.removeClass('status-success status-error').addClass('status-unknown');
        statusDiv.html('<i class="fas fa-question-circle me-2"></i>ì—°ê²° ìƒíƒœ ë¯¸í™•ì¸ - ì„¤ì • í›„ ì—°ê²° í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”');
    }
}

// ìŠ¤ì¼€ì¤„ íƒ€ì… ì„ íƒ
$('.schedule-option').click(function() {
    $('.schedule-option').removeClass('active');
    $(this).addClass('active');
    
    const type = $(this).data('type');
    selectScheduleType(type);
});

function selectScheduleType(type) {
    $('.schedule-option').removeClass('active');
    $(`.schedule-option[data-type="${type}"]`).addClass('active');
    
    if (type === 'manual') {
        $('#timeSettings').hide();
    } else {
        $('#timeSettings').show();
        
        if (type === 'weekly') {
            $('#weekdaySettings').show();
        } else {
            $('#weekdaySettings').hide();
        }
    }
}

// ERPia ì—°ë™ ì„¤ì • ì €ì¥
$('#erpiaConfigForm').submit(function(e) {
    e.preventDefault();
    
    if (!currentCompanyId) {
        showAlert('íšŒì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    const formData = {
        erpia_config: {
            admin_code: $('#adminCode').val(),
            api_url: $('#apiUrl').val(),
            is_active: $('#isActive').prop('checked')
        }
    };
    
    // ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ëœ ê²½ìš°ì—ë§Œ ì¶”ê°€
    const password = $('#erpiaPassword').val();
    if (password && password.trim() !== '') {
        formData.erpia_config.password = password;
    }
    
    $.ajax({
        url: `/batch/api/erpia/settings/${currentCompanyId}`,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                showAlert('ERPia ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                // ë¹„ë°€ë²ˆí˜¸ í•„ë“œ ì´ˆê¸°í™” (ë³´ì•ˆìƒ)
                $('#erpiaPassword').val('');
                loadCompanySettings(); // ì„¤ì • ìƒˆë¡œê³ ì¹¨
            } else {
                showAlert('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + response.message, 'error');
            }
        },
        error: function(xhr) {
            let errorMessage = 'ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = 'ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + xhr.responseJSON.message;
            }
            showAlert(errorMessage, 'error');
        }
    });
});

// ë°°ì¹˜ ìŠ¤ì¼€ì¤„ ì„¤ì • ì €ì¥
$('#batchScheduleForm').submit(function(e) {
    e.preventDefault();
    
    if (!currentCompanyId) {
        showAlert('íšŒì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    const scheduleType = $('.schedule-option.active').data('type');
    let scheduleDays = '1,2,3,4,5,6,7'; // ê¸°ë³¸ê°’: ë§¤ì¼
    
    if (scheduleType === 'weekly') {
        const selectedDays = [];
        $('input[id^="day"]:checked').each(function() {
            selectedDays.push($(this).val());
        });
        
        if (selectedDays.length === 0) {
            showAlert('ì£¼ê°„ ì‹¤í–‰ì˜ ê²½ìš° ìµœì†Œ 1ê°œ ìš”ì¼ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
            return;
        }
        
        scheduleDays = selectedDays.join(',');
    }
    
    const formData = {
        batch_settings: {
            schedule_type: scheduleType,
            schedule_time: $('#scheduleTime').val(),
            schedule_days: scheduleDays,
            call_interval: $('#callInterval').val(),
            page_size: $('#pageSize').val(),
            retry_count: $('#retryCount').val(),
            auto_gift_classify: $('#autoGiftClassify').prop('checked') ? 'true' : 'false',
            batch_steps: JSON.stringify(getBatchStepsSettings())
        }
    };
    
    $.ajax({
        url: `/batch/api/erpia/settings/${currentCompanyId}`,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                showAlert('ë°°ì¹˜ ìŠ¤ì¼€ì¤„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                showAlert('ìŠ¤ì¼€ì¤„ ì €ì¥ ì‹¤íŒ¨: ' + response.message, 'error');
            }
        },
        error: function() {
            showAlert('ìŠ¤ì¼€ì¤„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    });
});

// ERPia ì—°ê²° í…ŒìŠ¤íŠ¸
function testConnection() {
    if (!currentCompanyId) {
        showAlert('íšŒì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    const btn = $('.btn-test');
    const originalHtml = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-2"></i>í…ŒìŠ¤íŠ¸ ì¤‘...').prop('disabled', true);
    
    $.post(`/batch/api/erpia/test-connection/${currentCompanyId}`)
        .done(function(response) {
            if (response.success) {
                showAlert('ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ: ' + response.message, 'success');
                // ì—°ê²° ìƒíƒœë¥¼ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                $('#connectionStatus').removeClass('status-unknown status-error').addClass('status-success');
                $('#connectionStatus').html('<i class="fas fa-check-circle me-2"></i>ì—°ê²° ì •ìƒ (ë°©ê¸ˆ í…ŒìŠ¤íŠ¸ ì™„ë£Œ)');
                // ì„¤ì •ì„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ìµœì‹  ìƒíƒœ ë°˜ì˜
                setTimeout(() => {
                    loadCompanySettings();
                }, 1000);
            } else {
                showAlert('ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + response.message, 'error');
                // ì—°ê²° ìƒíƒœë¥¼ ì˜¤ë¥˜ë¡œ ì—…ë°ì´íŠ¸
                $('#connectionStatus').removeClass('status-unknown status-success').addClass('status-error');
                $('#connectionStatus').html('<i class="fas fa-exclamation-triangle me-2"></i>ì—°ê²° ì‹¤íŒ¨ (ë°©ê¸ˆ í…ŒìŠ¤íŠ¸ ì™„ë£Œ)');
            }
        })
        .fail(function(xhr) {
            let errorMessage = 'ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = 'ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + xhr.responseJSON.message;
            }
            showAlert(errorMessage, 'error');
            // ì—°ê²° ìƒíƒœë¥¼ ì˜¤ë¥˜ë¡œ ì—…ë°ì´íŠ¸
            $('#connectionStatus').removeClass('status-unknown status-success').addClass('status-error');
            $('#connectionStatus').html('<i class="fas fa-exclamation-triangle me-2"></i>ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜');
        })
        .always(function() {
            btn.html(originalHtml).prop('disabled', false);
        });
}

// ë°°ì¹˜ ë¡œê·¸ ë¡œë“œ
function loadBatchLogs(companyId) {
    $.get(`/batch/api/erpia/batch-logs/${companyId}?per_page=5`)
        .done(function(response) {
            if (response.success) {
                displayBatchLogs(response.data.logs);
            } else {
                $('#batchLogsBody').html('<tr><td colspan="8" class="text-center text-muted">ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨</td></tr>');
            }
        })
        .fail(function() {
            $('#batchLogsBody').html('<tr><td colspan="8" class="text-center text-muted">ë¡œê·¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</td></tr>');
        });
}

// ë°°ì¹˜ ë¡œê·¸ í‘œì‹œ
function displayBatchLogs(logs) {
    const tbody = $('#batchLogsBody');
    tbody.empty();
    
    if (logs.length === 0) {
        tbody.html('<tr><td colspan="8" class="text-center text-muted">ë°°ì¹˜ ì‹¤í–‰ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
        return;
    }
    
    logs.forEach(log => {
        const startTime = new Date(log.start_time).toLocaleString('ko-KR');
        const endTime = log.end_time ? new Date(log.end_time) : null;
        const duration = endTime ? 
            Math.round((endTime - new Date(log.start_time)) / 1000) + 'ì´ˆ' : '-';
        
        let statusBadge = '';
        if (log.status === 'SUCCESS') {
            statusBadge = '<span class="badge bg-success">ì„±ê³µ</span>';
        } else if (log.status === 'FAILED') {
            statusBadge = '<span class="badge bg-danger">ì‹¤íŒ¨</span>';
        } else {
            statusBadge = '<span class="badge bg-warning">ì‹¤í–‰ì¤‘</span>';
        }
        
        const row = `
            <tr>
                <td>${startTime}</td>
                <td>${log.admin_code || 'N/A'}</td>
                <td><span class="badge bg-secondary">${log.batch_type}</span></td>
                <td>${statusBadge}</td>
                <td>${log.processed_orders || 0}ê±´</td>
                <td>${log.gift_products || 0}ê±´</td>
                <td>${duration}</td>
                <td>
                    ${log.error_message ? 
                        `<button class="btn btn-sm btn-outline-danger" onclick="showLogDetail('${log.error_message}')">ì˜¤ë¥˜</button>` :
                        '<span class="text-muted">-</span>'
                    }
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

// ë¡œê·¸ ìƒì„¸ ë³´ê¸°
function showLogDetail(message) {
    alert('ì˜¤ë¥˜ ìƒì„¸:\n' + message);
}

// ìˆ˜ë™ ë°°ì¹˜ ì‹¤í–‰
function runManualBatch() {
    const startDate = $('#manualStartDate').val();
    const endDate = $('#manualEndDate').val();
    
    if (!startDate || !endDate) {
        showAlert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    if (!currentCompanyId) {
        showAlert('íšŒì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) {
        showAlert('ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
    }
    
    // ë°°ì¹˜ ì˜µì…˜ ìˆ˜ì§‘
    const batchOptions = {
        include_customers: $('#includeCustomers').prop('checked'),
        include_sales: $('#includeSales').prop('checked'),
        include_products: $('#includeProducts').prop('checked'),
        auto_gift_process: $('#autoGiftProcess').prop('checked')
    };
    
    // ì„ íƒëœ ì˜µì…˜ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ê²½ê³ 
    if (!Object.values(batchOptions).some(option => option)) {
        showAlert('ìµœì†Œ í•˜ë‚˜ì˜ ë°°ì¹˜ ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    const formData = {
        start_date: startDate.replace(/-/g, ''),
        end_date: endDate.replace(/-/g, ''),
        batch_options: batchOptions
    };
    
    // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
    const runBtn = $('#runBatchBtn');
    const originalHtml = runBtn.html();
    runBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>ì‹¤í–‰ ì¤‘...');
    
    $.ajax({
        url: `/batch/api/erpia/manual-batch/${currentCompanyId}`,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        timeout: 300000, // 5ë¶„ íƒ€ì„ì•„ì›ƒ
        success: function(response) {
            if (response.success) {
                showAlert('âœ… ë°°ì¹˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                $('#manualBatchModal').modal('hide');
                loadBatchLogs(currentCompanyId); // ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
            } else {
                showAlert('âŒ ë°°ì¹˜ ì‹¤í–‰ ì‹¤íŒ¨: ' + response.message, 'error');
            }
        },
        error: function(xhr, status, error) {
            let errorMessage = 'ë°°ì¹˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = 'ë°°ì¹˜ ì‹¤í–‰ ì‹¤íŒ¨: ' + xhr.responseJSON.message;
            } else if (status === 'timeout') {
                errorMessage = 'â° ë°°ì¹˜ ì‹¤í–‰ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê³„ì† ì§„í–‰ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }
            showAlert(errorMessage, 'error');
        },
        complete: function() {
            runBtn.prop('disabled', false).html(originalHtml);
        }
    });
}

// ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ/ìˆ¨ê¹€
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(inputId + 'Icon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

// ì•Œë¦¼ í‘œì‹œ
function showAlert(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
    $('.alert').remove();
    
    // ìƒˆ ì•Œë¦¼ ì¶”ê°€
    $('.container-fluid').prepend(alertHtml);
    
    // 3ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        $('.alert').fadeOut();
    }, 3000);
}

// ìˆ˜ë™ ë°°ì¹˜ ì‹¤í–‰ ë²„íŠ¼ (ì¶”ê°€)
function showManualBatchModal() {
    console.log('ğŸ”§ ìˆ˜ë™ ë°°ì¹˜ ëª¨ë‹¬ ì—´ê¸° ì‹œë„');
    
    // íšŒì‚¬ê°€ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
    if (!currentCompanyId) {
        showAlert('ë¨¼ì € íšŒì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    // ë‚ ì§œ ì´ˆê¸°í™”
    const today = new Date().toISOString().split('T')[0];
    $('#manualStartDate').val(today);
    $('#manualEndDate').val(today);
    
    // ê¸°ê°„ ì •ë³´ ì—…ë°ì´íŠ¸
    updateDateRangeInfo();
    $('#dateRangeInfo').show();
    
    // ëª¨ë‹¬ í‘œì‹œ
    $('#manualBatchModal').modal('show');
}

// ë°°ì¹˜ ì‹¤í–‰ ìˆœì„œ ê´€ë¦¬ í•¨ìˆ˜ë“¤
function moveStep(button, direction) {
    const step = button.closest('.batch-step');
    const container = step.parentElement;
    
    if (direction === 'up' && step.previousElementSibling) {
        container.insertBefore(step, step.previousElementSibling);
    } else if (direction === 'down' && step.nextElementSibling) {
        container.insertBefore(step.nextElementSibling, step);
    }
    
    updateStepNumbers();
}

function updateStepNumbers() {
    const steps = document.querySelectorAll('.batch-step');
    steps.forEach((step, index) => {
        const orderBadge = step.querySelector('.step-order');
        orderBadge.textContent = index + 1;
        
        // ìˆœì„œì— ë”°ë¼ ë°°ì§€ ìƒ‰ìƒ ë³€ê²½
        orderBadge.className = 'badge step-order';
        if (index === 0) {
            orderBadge.classList.add('bg-success');
        } else if (step.dataset.step === 'sales') {
            orderBadge.classList.add('bg-primary');
        } else {
            orderBadge.classList.add('bg-secondary');
        }
    });
}

function selectAllSteps() {
    document.querySelectorAll('.batch-step input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = true;
    });
}

function selectCoreSteps() {
    // ëª¨ë“  ì²´í¬ë°•ìŠ¤ í•´ì œ
    document.querySelectorAll('.batch-step input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // í•µì‹¬ ë‹¨ê³„ë§Œ ì„ íƒ (ë§¤ì¥ì •ë³´, ì¬ê³ , ìƒí’ˆ, ë§¤ì¶œ)
    document.getElementById('step_customers').checked = true;
    document.getElementById('step_stock').checked = true;
    document.getElementById('step_goods').checked = true;
    document.getElementById('step_sales').checked = true;
}

function clearAllSteps() {
    document.querySelectorAll('.batch-step input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
}

function getBatchStepsSettings() {
    const steps = [];
    const stepElements = document.querySelectorAll('.batch-step');
    
    stepElements.forEach((stepElement, index) => {
        const checkbox = stepElement.querySelector('input[type="checkbox"]');
        if (checkbox.checked) {
            steps.push({
                step: stepElement.dataset.step,
                order: index + 1,
                enabled: true
            });
        }
    });
    
    return steps;
}

// ìˆ˜ë™ ë°°ì¹˜ ëª¨ë‹¬ ë‚ ì§œ ë²”ìœ„ ì„¤ì •
function setDateRange(type) {
    const today = new Date();
    let startDate, endDate;

    if (type === 'today') {
        startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    } else if (type === 'yesterday') {
        startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 1);
        endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 1);
    } else if (type === 'week') {
        startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 7);
        endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    } else if (type === 'month') {
        startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        endDate = new Date(today.getFullYear(), today.getMonth(), 0);
    }

    $('#manualStartDate').val(startDate.toISOString().split('T')[0]);
    $('#manualEndDate').val(endDate.toISOString().split('T')[0]);

    const start = startDate.toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric' });
    const end = endDate.toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric' });
    $('#selectedRange').text(`${start} ~ ${end}`);

    const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    $('#totalDays').text(totalDays);

    if (totalDays > 30) {
        $('#periodWarning').show();
    } else {
        $('#periodWarning').hide();
    }
}

// ìˆ˜ë™ ë°°ì¹˜ ëª¨ë‹¬ ì˜ˆìƒ ì²˜ë¦¬ ì‹œê°„ ê³„ì‚°
function calculateEstimatedTime() {
    const startDate = $('#manualStartDate').val();
    const endDate = $('#manualEndDate').val();
    const totalDays = $('#totalDays').text();

    if (totalDays === '0' || totalDays === '') {
        $('#timeEstimate').text('ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const start = new Date(startDate);
    const end = new Date(endDate);
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // ì´ ì¼ìˆ˜ + 1 (ì‹œì‘ì¼ í¬í•¨)

    let estimatedHours = 0;
    let estimatedMinutes = 0;

    if (diffDays <= 7) { // 7ì¼ ì´ë‚´
        estimatedHours = Math.ceil(diffDays * 0.5); // ì¼ë‹¹ í‰ê·  ì²˜ë¦¬ ì‹œê°„
    } else if (diffDays <= 14) { // 7ì¼ ~ 14ì¼
        estimatedHours = Math.ceil(diffDays * 0.7);
    } else if (diffDays <= 30) { // 14ì¼ ~ 30ì¼
        estimatedHours = Math.ceil(diffDays * 1.0);
    } else { // 30ì¼ ì´ˆê³¼
        estimatedHours = Math.ceil(diffDays * 1.5);
    }

    estimatedMinutes = (diffTime % (1000 * 60 * 60)) / (1000 * 60); // ë‚˜ë¨¸ì§€ ë¶„

    $('#timeEstimate').text(`${estimatedHours}ì‹œê°„ ${estimatedMinutes}ë¶„`);
}

$(document).on('change', '#manualStartDate, #manualEndDate', function() {
    calculateEstimatedTime();
});

$(document).on('shown.bs.modal', '#manualBatchModal', function() {
    calculateEstimatedTime();
});

// ê¸°ê°„ ì •ë³´ ì—…ë°ì´íŠ¸
function updateDateRangeInfo() {
    const startDate = $('#manualStartDate').val();
    const endDate = $('#manualEndDate').val();
    
    if (!startDate || !endDate) return;
    
    const start = new Date(startDate);
    const end = new Date(endDate);

    const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
    const startStr = start.toLocaleDateString('ko-KR', options);
    const endStr = end.toLocaleDateString('ko-KR', options);

    $('#selectedRange').text(`${startStr} ~ ${endStr}`);

    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // ì‹œì‘ì¼ë„ í¬í•¨
    $('#totalDays').text(diffDays);

    if (diffDays > 30) {
        $('#periodWarning').show();
    } else {
        $('#periodWarning').hide();
    }
    
    updateEstimatedTime();
}

// ì˜ˆìƒ ì²˜ë¦¬ ì‹œê°„ ê³„ì‚°
function updateEstimatedTime() {
    const startDate = $('#manualStartDate').val();
    const endDate = $('#manualEndDate').val();
    
    if (!startDate || !endDate) {
        $('#timeEstimate').text('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
    }
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

    if (diffDays === 1) {
        $('#timeEstimate').text('ì˜ˆìƒ ì‹œê°„: 5ë¶„ ë¯¸ë§Œ');
        return;
    }

    // ì„ íƒëœ ë°°ì¹˜ ì˜µì…˜ ê°œìˆ˜
    const selectedOptions = [
        $('#includeCustomers').prop('checked'),
        $('#includeSales').prop('checked'),
        $('#includeProducts').prop('checked'),
        $('#autoGiftProcess').prop('checked')
    ].filter(Boolean).length;

    // ê° ì˜µì…˜ë‹¹ ê¸°ë³¸ ì²˜ë¦¬ ì‹œê°„ (ë¶„)
    const baseTimePerOption = 3;
    const timePerDay = selectedOptions * baseTimePerOption;
    const totalMinutes = diffDays * timePerDay;
    
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;

    let timeText = '';
    if (hours > 0) {
        timeText += hours + 'ì‹œê°„ ';
    }
    if (minutes > 0 || hours === 0) {
        timeText += minutes + 'ë¶„';
    }

    $('#timeEstimate').text(`ì˜ˆìƒ ì‹œê°„: ${timeText}`);
}

</script>
{% endblock %} 
