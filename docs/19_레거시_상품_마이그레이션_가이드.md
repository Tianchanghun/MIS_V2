# 레거시 상품 데이터 마이그레이션 가이드

## 📅 작업 일자: 2025-08-08

## 🎯 **마이그레이션 목표**
- 레거시 `tbl_Product` → MIS v2 `products` 테이블로 안전한 데이터 이전
- 코드 체계 매핑 (브랜드, 품목, 타입)
- 회사별 데이터 분리 유지
- 데이터 무결성 보장

## 📋 **마이그레이션 범위**

### ✅ **포함 데이터**
- **tbl_Product (마스터)**: 상품 기본 정보
- **회사 매핑**: 에이원(580→1), 에이원월드(581→2)  
- **브랜드 매핑**: `tbl_brand` 테이블 연계
- **분류 매핑**: 품목(PRT), 타입(TP) 코드 연계

### ❌ **제외 데이터** (사용자 요청)
- 이미지 정보 (`tbl_Product_Image`)
- FAQ 연동 (`FaqYn`)
- 노출 상태 (`ShowYn`)
- SNS URL (네이버카페, 페이스북, 인스타그램)
- 동영상 정보

## 🔧 **매핑 규칙**

### 1️⃣ **회사 매핑**
```python
company_mapping = {
    580: 1,  # 에이원 → company_id 1
    581: 2,  # 에이원월드 → company_id 2
}
```

### 2️⃣ **브랜드 매핑**
- **우선순위**: 브랜드 코드 → 브랜드명 → 부분 매칭
- **대상 테이블**: `tbl_brand` → MIS v2 `Brand` 모델

### 3️⃣ **분류 코드 매핑**
- **품목**: `ProdGroup` → `category_code_seq` (PRT 그룹)
- **타입**: `ProdType` → `type_code_seq` (TP 그룹)

### 4️⃣ **상품코드 생성**
```python
product_code = f"LEG_{legacy_seq:06d}"
# 예: LEG_000001, LEG_000123
```

## 🛡️ **안전 장치**

### ✅ **UPSERT 방식**
- **기존 상품**: 상품명 + 회사 기준으로 업데이트
- **신규 상품**: 새로운 레코드 생성
- **중복 방지**: 상품명 + company_id 유니크 체크

### ✅ **이력 관리**
- **ProductHistory**: 모든 마이그레이션 작업 기록
- **레거시 추적**: `legacy_seq`, `legacy_company` 정보 보존

### ✅ **롤백 지원**
- **트랜잭션**: 개별 상품별 커밋/롤백
- **로그 파일**: 상세한 처리 결과 기록

## 🚀 **실행 방법**

### 1️⃣ **기본 실행**
```bash
cd C:\mis_v2
python legacy_product_migration.py
```

### 2️⃣ **DB 연결 순서**
1. **Docker MS-SQL** (localhost:1433)
2. **로컬 SQL Server Express**
3. **네트워크 연결** (mis.aone.co.kr)

### 3️⃣ **로그 확인**
```bash
# 실시간 로그
tail -f legacy_product_migration.log

# 결과 요약
grep "마이그레이션 완료" legacy_product_migration.log
```

## 📊 **예상 결과**

### 📈 **처리량 예상**
- **레거시 상품**: 100-500개 예상
- **처리 시간**: 5-15분 예상
- **성공률**: 95% 이상 목표

### 📋 **결과 검증**
```sql
-- 마이그레이션된 상품 수 확인
SELECT company_id, COUNT(*) 
FROM products 
WHERE created_by = 'legacy_migration'
GROUP BY company_id;

-- 브랜드별 상품 분포
SELECT b.brand_name, COUNT(p.id)
FROM products p 
LEFT JOIN tbl_brand b ON p.brand_seq = b.seq
WHERE p.created_by = 'legacy_migration'
GROUP BY b.brand_name;
```

## ⚠️ **주의사항**

### 🔒 **레거시 DB 보호**
- **읽기 전용**: SELECT 쿼리만 사용
- **타임아웃**: 10초 연결 제한
- **에러 시 즉시 중단**

### 🎯 **데이터 품질**
- **누락 필드**: NULL 값 허용
- **매핑 실패**: 로그에 기록, 계속 진행
- **중복 상품**: 기존 상품 업데이트

## 🔧 **문제 해결**

### ❌ **DB 연결 실패**
```bash
# SQL Server 서비스 확인
net start mssqlserver

# Docker 확인
docker ps | grep sql
```

### ❌ **매핑 실패**
- **브랜드 누락**: 로그에서 누락 브랜드 확인
- **코드 누락**: 수동으로 코드 추가 후 재실행

### ❌ **성능 이슈**
- **배치 크기**: 100개씩 처리 (필요시 조정)
- **메모리 부족**: 스크립트 재시작

## 📝 **마이그레이션 후 작업**

### 1️⃣ **데이터 검증**
- [ ] 상품 수 일치 확인
- [ ] 브랜드 매핑 정확성 확인  
- [ ] 회사별 분리 확인

### 2️⃣ **UI/UX 개선**
- [ ] 테이블 정렬 기능 추가
- [ ] 실시간 검색 기능 적용
- [ ] 레거시 표시 방법 개선

### 3️⃣ **추가 기능**
- [ ] 상품 이미지 업로드
- [ ] 매뉴얼 파일 관리
- [ ] ERPia 연동 확장

---

**작업자**: AI Assistant (Claude Sonnet 4)  
**생성일**: 2025-08-08  
**상태**: 🚀 **실행 준비 완료** 