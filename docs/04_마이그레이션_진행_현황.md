# 📊 MIS v2 마이그레이션 및 매출분석 시스템 현황

## 🎯 프로젝트 개요

**에이원 MIS v2 시스템 구축**: 기존 레거시 시스템(`mis.aone.co.kr`)을 분석하여 **ERPia 자동 수집 중심**의 현실적인 매출분석 시스템을 구축하고, **멀티테넌트 확장**을 통해 에이원 월드까지 지원하는 통합 시스템을 개발합니다.

## ✅ 레거시 DB 마이그레이션 현황

### **에이원 레거시 DB 마이그레이션** 
- **상태**: ✅ **100% 완료**
- **테이블**: 72개 
- **레코드**: 2,109,847건
- **완료일**: 2025-08-05

#### **데이터베이스 연결 정보** (확인 완료)
```
서버: 210.109.96.74,2521
데이터베이스: db_mis
사용자: user_mis
비밀번호: user_mis!@12
```

#### **마이그레이션된 주요 테이블**
- **회원/사용자**: `tbl_member`, `tbl_dept`, `tbl_dept_auth` 등
- **매출 관리**: `tbl_sales_orderinfo`, `tbl_erpia_order_mst` 등 
- **상품 관리**: `tbl_product`, `tbl_product_codematch` 등
- **거래처 관리**: `tbl_erpia_customer`, `tbl_erpia_sitecode` 등
- **시리얼 관리**: `tbl_serial`, `tbl_trade_order_mst` 등

### **데이터 검증 결과**
- **정합성**: 100% (원본 대비 일치)
- **외래키**: 100% (의존성 해결)
- **데이터 타입**: 100% (PostgreSQL 호환)

## 🔍 레거시 시스템 분석 결과

### **접근 권한 현황** ✅
- **소스코드**: `mis.aone.co.kr` 폴더 완전 접근 가능
- **데이터베이스**: 연결 정보 확보, 직접 접근 가능
- **운영 시스템**: `mis.aone.co.kr` 직접 접근 가능

### **ERPia 배치 프로세스 현황** (상세 분석 완료)

#### **1. 현재 동작 방식** ✅ **정상 운영 중**
```csharp
// BatchController.cs - 핵심 배치 메소드들
public void SendSmsDelivery()       // 일일 주문 수집 + SMS 발송
public void DaylySalesGathering()   // 월간 매출 데이터 취합  
public void SendInvoiceMonthly()    // 월말 거래명세서 자동 발송
```

#### **2. 실행 주기** 
- **방식**: ✅ **Windows 스케줄러 자동 실행**
- **주기**: ✅ **매일 정해진 시간** (현재 정상 동작)
- **ERPia API**: `http://www.erpia.net/xml/xml.asp?mode=jumun&admin_code=aone&pwd=ka22fslfod1vid`

#### **3. 데이터 품질 이슈** ⚠️ **개선 필요**
- **문제점**: 누락 데이터 다수 존재 (관리 부족)
- **해결책**: Excel 일괄 업로드 기능 추가 필요
- **추가 요구**: 사은품 (0원 매출) 별도 처리 로직 필요

#### **4. Flask 이관 요구사항**
- **배치 스케줄러**: 웹에서 설정 가능한 배치 시간
- **데이터 보완**: Excel 업로드를 통한 누락 데이터 보완
- **모니터링**: 배치 실행 로그 및 상태 확인

### **핵심 발견사항**

#### **1. ERPia 자동 수집 시스템 (이미 구현됨)** ✅
```csharp
// BatchController.cs - 이미 동작 중인 일일 배치
- ERPia XML API에서 매출 데이터 자동 수집
- tbl_Sales_OrderInfo에 자동 저장 (210만건)
- 일자, 거래처, 상품, 수량, 매출액 등 완전 자동화
- 지역 정보 자동 매핑 (네이버 지오코딩 API 활용)
```

#### **2. 거래처/상품 관리 시스템 (이미 구현됨)** ✅
```csharp
// ShopManagerController.cs, ProductController.cs
- 거래처 분류 관리 (유통구분, 채널구분, 지역)
- 상품 코드 매핑 (ERPia ↔ MIS)
- 브랜드, 제품군 등 분류 체계
```

#### **3. 매출분석 기능 (이미 구현됨)** ✅
```csharp  
// OrderController.cs - SaleList
- 일/주/월/분기별 집계
- 브랜드/채널/지역별 분석
- Excel 내보내기 기능
```

### **개선 방향**
- **기존 C# 로직 → Flask 이관**: 검증된 비즈니스 로직 재활용
- **ERPia 자동화 95%**: 일일 매출 데이터 완전 자동 수집
- **Excel 최소화 1%**: 마스터 데이터 및 시점 관리만
- **스케줄링 개선**: 웹 기반 배치 시간 설정

## 🏢 **에이원 월드 멀티테넌트 요구사항**

### **현재 상황**
- **에이원 월드**: 아직 회사 설립 전, 현재 에이원 계정 사용 중
- **ERPia 계정**: 에이원 기존, 에이원 월드는 설립 후 생성 예정
- **사용자 교육**: 메뉴얼 작업은 구현 완료 후 별도 계획

### **멀티테넌트 구조**
- **단일 DB**: `company_id`로 회사 구분
- **데이터 공유**: 공통 상품, 거래처 정보 활용
- **접근 제어**: 회사별 데이터 격리, 겸직자 지원
- **ERPia 연동**: 회사별 별도 계정 관리 (웹에서 설정)

### **겸직자 지원**
- **로그인 후 회사 전환**: UI에서 회사 선택/전환 기능
- **권한별 접근**: 겸직자는 소속 회사별 권한에 따라 데이터 접근
- **세션 관리**: 회사 전환 시 권한 재설정

## 🔐 **보안 및 운영 요구사항**

### **보안 정책**
- **접근 로그**: ✅ **필수 요구사항** - 모든 사용자 접근 기록
- **데이터 백업**: 구현 완료 후 메뉴얼과 함께 정책 수립
- **권한 관리**: 회사별, 역할별 세분화된 접근 제어

### **승인 프로세스**
- **Excel 업로드**: ❌ **별도 승인 프로세스 없음**
- **원가 변경**: 사용자가 상품 정보에서 직접 변경 → 시점 자동 기록
- **특수 매출**: 대부분 ERPia에 등록됨, 사은품(0원) 별도 처리

## 📊 Excel 업로드 시스템 (재정의)

### **특수 매출 처리 개선**
- **사은품 처리**: 0원 매출 → 사은품으로 자동 분류
- **전시회/이벤트**: 대부분 ERPia 등록, 일부만 Excel 업로드
- **발생 빈도**: 특수 매출은 잦은 편 (월 10-20건 예상)

### **생성된 현실적 템플릿**
- **파일**: `MIS_v2_현실적_템플릿_모음_20250805.xlsx`
- **구성**: 5개 시트 (가이드 + 4개 특화 템플릿)

#### **템플릿별 상세**

| 템플릿 | 컬럼 수 | 용도 | 주기 | 승인자 |
|--------|---------|------|------|--------|
| **A. 거래처 마스터** | 8개 | 신규 거래처 대량 등록 | 월 1회 | 없음 |
| **B. 상품 마스터** | 10개 | 신규 상품 대량 등록 | 신상품 출시시 | 없음 |
| **C. 원가 시점 관리** | 6개 | 원가 변경 이력 추적 | 원가 변경시 | 없음 |
| **D. 특수 매출** | 7개 | 전시회/이벤트/사은품 매출 | 이벤트 발생시 | 없음 |

### **원가 시점 관리 프로세스**
1. **변경 발생**: 사용자가 상품 정보에서 원가 변경
2. **시점 기록**: 변경 시점을 자동으로 기록
3. **이력 관리**: 과거 원가 적용 기간별 추적 가능
4. **분석 연동**: 매출분석 시 해당 시점 원가 자동 적용

## 🏗️ **개발 환경 및 배포 계획**

### **개발 환경** (기확립)
- **기술 스택**: Flask + PostgreSQL + Redis (Docker 환경)
- **가이드라인**: `docs/02_개발_스택_및_가이드라인.md` 완성
- **개발 서버**: 로컬 Docker 환경으로 구성

### **배포 일정**
- **로컬 테스트**: 완료 즉시
- **운영 배포**: ✅ **이상 없으면 바로 배포**
- **병행 운영**: ❌ **불필요** - DB 추가 마이그레이션 후 바로 전환
- **데이터 동기화**: 실제 운영 중 추가된 데이터만 마이그레이션

## 📈 **성능 및 용량 계획** (확인 필요)

### **현재 미확정 사항**
- **동시 사용자 수**: ?명 (확인 필요)
- **매출 데이터 보관 기간**: ?년 (정책 수립 필요)  
- **시스템 응답 속도**: 요구사항 명시 필요
- **다른 시스템 연동**: 필요 여부 확인 필요
- **모바일 접근**: 요구사항 확인 필요
- **외부 API 제공**: 필요 여부 확인 필요

## 🚀 **최종 구현 로드맵**

### **Phase 1: ERPia 배치 Flask 이관** (1주)
- **Day 1-2**: BatchController.cs 분석 및 Python 변환
- **Day 3-4**: 웹 기반 스케줄러 구현 (배치 시간 설정)
- **Day 5**: 배치 로그 및 모니터링 시스템

### **Phase 2: 누락 데이터 보완 시스템** (3일)
- **Day 1**: Excel 일괄 업로드 기능 (거래처/상품)
- **Day 2**: 사은품(0원) 별도 처리 로직
- **Day 3**: 특수 매출 업로드 기능

### **Phase 3: 멀티테넌트 아키텍처** (1주)
- **Day 1-2**: 스키마 확장 (`company_id` 추가)
- **Day 3-4**: 회사 전환 UI 및 권한 시스템
- **Day 5**: 회사별 ERPia 설정 관리

### **Phase 4: 매출분석 대시보드** (1주)
- **Day 1-3**: 기존 C# 매출분석 로직 Flask 이관
- **Day 4-5**: 실시간 대시보드 및 차트

### **Phase 5: 접근 로그 및 보안 강화** (3일)
- **Day 1**: 접근 로그 시스템 구현
- **Day 2**: 권한별 세분화된 접근 제어
- **Day 3**: 보안 정책 적용 및 테스트

## 🎯 **다음 단계**

### **즉시 확인 필요** 🔴
1. **성능 요구사항**: 동시 사용자 수, 응답 속도 기준
2. **데이터 정책**: 보관 기간, 백업 주기
3. **연동 범위**: 다른 시스템, 모바일, 외부 API 필요성

### **즉시 진행 가능** 🟢  
1. ✅ 레거시 시스템 분석 완료
2. ✅ 기술 스택 및 개발 환경 확립
3. ⏳ ERPia 배치 프로세스 Flask 이관 시작
4. ⏳ 웹 기반 스케줄러 개발
5. ⏳ Excel 업로드 시스템 구현

### **후속 작업** 🟡
1. 에이원 월드 설립 후 ERPia 계정 생성
2. 사용자 교육 메뉴얼 작성
3. 데이터 백업 정책 수립
4. 성능 튜닝 및 최적화

---

📅 **최종 업데이트**: 2025-08-05  
📝 **버전**: v4.0 (완전 기획)  
🎯 **상태**: 모든 기술적 요구사항 확인 완료, 일부 운영 정책만 추가 확인 필요 