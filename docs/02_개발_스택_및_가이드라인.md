# 🛠️ **MIS v2 개발 스택 및 가이드라인** (유지보수 최적화)

## 📋 **목차**
1. [기술 스택](#기술-스택)
2. [시스템 아키텍처](#시스템-아키텍처)
3. [개발 환경](#개발-환경)
4. [UI/UX 가이드라인](#uiux-가이드라인)
5. [코딩 컨벤션](#코딩-컨벤션)
6. [프로젝트 구조](#프로젝트-구조)
7. [보안 가이드라인](#보안-가이드라인)
8. [배치 및 스케줄링](#배치-및-스케줄링)
9. [사은품 분류 시스템](#사은품-분류-시스템)

---

## 🔧 **기술 스택** (유지보수 중심)

### **백엔드** 🐍
- **프레임워크**: Flask 3.0
- **ORM**: SQLAlchemy 2.0 (Flask-SQLAlchemy)
- **인증**: Flask-Login + Session 기반
- **폼 처리**: Flask-WTF + WTForms
- **API**: RESTful API (JSON 응답)
- **로깅**: Python logging + colorlog
- **캐시**: Redis 7.0 (세션, 데이터 캐싱)
- **⚙️ 스케줄러**: APScheduler 3.10 (웹 기반 배치 관리)
- **🎁 데이터 분류**: pandas 2.0 (사은품 자동 분류)

### **프론트엔드** 🎨 (단순하고 안정적)
- **템플릿 엔진**: Jinja2 (Flask 기본)
- **CSS 프레임워크**: Bootstrap 5.3 (학습곡선 낮음)
- **JavaScript**: Vanilla JS + jQuery 3.7 (간단하고 안정적)
- **차트**: Chart.js 4.0 (문서화 우수)
- **아이콘**: Bootstrap Icons + Font Awesome
- **테이블**: DataTables.js (한국어 지원)
- **📊 실시간 업데이트**: WebSocket (Flask-SocketIO) (배치 상태 모니터링)

### **데이터베이스** 🗄️
- **메인 DB**: PostgreSQL 15
- **캐시 DB**: Redis 7.0 (세션, 임시 데이터)
- **연결**: psycopg2-binary, redis-py
- **마이그레이션**: Alembic (Flask-Migrate)
- **백업**: pg_dump + redis-cli 자동화

### **개발 도구** ⚙️
- **컨테이너**: Docker + Docker Compose
- **코드 품질**: Black (포매터) + Flake8 (린터)
- **테스트**: pytest + pytest-flask
- **의존성 관리**: requirements.txt
- **환경 변수**: python-dotenv
- **📋 스케줄링**: APScheduler + Cron 표현식
- **🔍 로그 분석**: ELK Stack (선택사항)

---

## 🏗️ **시스템 아키텍처** (확장성 고려)

### **전체 구조** (업데이트)
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   브라우저        │◄──►│   Flask App     │◄──►│  PostgreSQL     │
│  (UI/UX)        │    │  (비즈니스 로직)   │    │   (메인 데이터)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │                       │
                       ┌─────────────────┐    ┌─────────────────┐
                       │   Redis Cache   │    │   레거시 MS-SQL  │
                       │  (세션, 캐시)     │    │   (읽기 전용)     │
                       └─────────────────┘    └─────────────────┘
                              │
                       ┌─────────────────┐    ┌─────────────────┐
                       │  APScheduler    │    │   ERPia API     │
                       │ (웹 기반 배치)    │    │ (XML 데이터 수집) │
                       └─────────────────┘    └─────────────────┘
                              │
                       ┌─────────────────┐
                       │ Gift Classifier │
                       │ (사은품 자동분류) │
                       └─────────────────┘
```

### **레이어 구조**
1. **Presentation Layer**: Jinja2 Templates + Bootstrap CSS
2. **Controller Layer**: Flask Blueprints + Routes
3. **Service Layer**: 비즈니스 로직 처리 + 배치 관리 + 사은품 분류
4. **Data Layer**: SQLAlchemy Models + Redis Cache
5. **Infrastructure Layer**: PostgreSQL + Redis + External APIs
6. **⚙️ Scheduling Layer**: APScheduler + 웹 배치 관리 (신규 추가)
7. **🎁 Classification Layer**: 사은품 자동 분류 엔진 (신규 추가)

---

## 💻 **개발 환경**

### **로컬 개발 환경**
```bash
# Docker 환경
- PostgreSQL: localhost:5432
- Redis: localhost:6379
- pgAdmin: localhost:5050
- Flask App: localhost:5000

# Python 환경
- Python 3.11+
- Virtual Environment 사용 권장
```

### **환경 변수 설정** (업데이트)
```env
# .env 파일
FLASK_ENV=development
FLASK_DEBUG=1
DATABASE_URL=postgresql://mis_user:mis123!@#@localhost:5432/db_mis
REDIS_URL=redis://localhost:6379/0
SECRET_KEY=your-secret-key-here
SESSION_TYPE=redis
LEGACY_DB_CONNECTION=DRIVER={ODBC Driver 17 for SQL Server};SERVER=210.109.96.74,2521;DATABASE=db_mis;UID=user_mis;PWD=user_mis!@12;ApplicationIntent=ReadOnly;

# 배치 관리 설정 (신규 추가)
BATCH_SCHEDULER_ENABLED=true
BATCH_DEFAULT_HOUR=2
BATCH_DEFAULT_MINUTE=0
BATCH_MAX_RETRY=3

# ERPia API 설정 (신규 추가)
ERPIA_API_URL=http://www.erpia.net/xml/xml.asp
ERPIA_DEFAULT_INTERVAL=3
ERPIA_DEFAULT_PAGE_SIZE=30
ERPIA_TIMEOUT=30

# 사은품 분류 설정 (신규 추가)
GIFT_AUTO_CLASSIFY=true
GIFT_DEFAULT_KEYWORDS=사은품,증정품,무료,샘플,체험
GIFT_EXCLUDE_FROM_REVENUE=true
```

---

## 🎨 **UI/UX 가이드라인** (Bootstrap 중심)

### **디자인 시스템**

#### **컬러 팔레트** 🎨 (Bootstrap 기본 + 브랜드)
```css
/* Bootstrap 기본 색상 (유지보수 용이) */
--primary-color: #0d6efd;      /* Bootstrap Blue */
--secondary-color: #6c757d;    /* Bootstrap Gray */
--success-color: #198754;      /* Bootstrap Green */
--danger-color: #dc3545;       /* Bootstrap Red */
--warning-color: #ffc107;      /* Bootstrap Yellow */
--info-color: #0dcaf0;         /* Bootstrap Cyan */

/* MIS 브랜드 색상 (회사 특화) */
--brand-primary: #1e3a8a;      /* 진한 파랑 (신뢰감) */
--brand-secondary: #3b82f6;    /* 밝은 파랑 (활동성) */
--brand-accent: #ef4444;       /* 포인트 빨강 (강조) */
--brand-success: #10b981;      /* 성공 초록 */

/* 사은품 시스템 색상 (신규 추가) */
--gift-primary: #f59e0b;       /* 사은품 주황 */
--gift-secondary: #fbbf24;     /* 사은품 연한 주황 */
--revenue-primary: #059669;    /* 매출 초록 */
--batch-primary: #7c3aed;      /* 배치 보라 */

/* 배경 색상 (깔끔함) */
--bg-light: #f8fafc;          /* 연한 회색 */
--bg-dark: #1e293b;           /* 다크 모드 */
--bg-card: #ffffff;           /* 카드 배경 */
--border-color: #e2e8f0;      /* 테두리 */
```

#### **타이포그래피** ✍️ (한국어 최적화)
```css
/* 폰트 스택 (한국어 우선) */
font-family: 'Noto Sans KR', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;

/* 폰트 크기 (16px 기준) */
--font-size-xs: 0.75rem;    /* 12px - 작은 텍스트 */
--font-size-sm: 0.875rem;   /* 14px - 보조 텍스트 */
--font-size-base: 1rem;     /* 16px - 기본 텍스트 */
--font-size-lg: 1.125rem;   /* 18px - 강조 텍스트 */
--font-size-xl: 1.25rem;    /* 20px - 부제목 */

/* 제목 크기 (가독성 중심) */
h1: 2.25rem (36px) - 페이지 제목
h2: 1.875rem (30px) - 섹션 제목
h3: 1.5rem (24px) - 서브 섹션
h4: 1.25rem (20px) - 카드 제목
h5: 1.125rem (18px) - 작은 제목
h6: 1rem (16px) - 레이블
```

#### **간격 시스템** 📏 (Bootstrap 표준)
```css
/* Bootstrap 간격 시스템 (0.25rem = 4px) */
--spacing-0: 0;
--spacing-1: 0.25rem;  /* 4px */
--spacing-2: 0.5rem;   /* 8px */
--spacing-3: 1rem;     /* 16px */
--spacing-4: 1.5rem;   /* 24px */
--spacing-5: 3rem;     /* 48px */

/* 커스텀 간격 (MIS 전용) */
--content-padding: 1.5rem;     /* 카드 내부 패딩 */
--section-margin: 2rem;        /* 섹션 간 여백 */
--form-spacing: 1rem;          /* 폼 요소 간격 */
```

### **신규 컴포넌트 가이드라인**

#### **배치 상태 표시** ⚙️
```html
<!-- 배치 상태 카드 -->
<div class="card border-batch">
    <div class="card-header bg-batch text-white">
        <h6 class="card-title mb-0">
            <i class="bi bi-clock"></i> ERPia 배치 상태
        </h6>
    </div>
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <span>다음 실행</span>
            <span class="badge bg-info">02:00 (자동)</span>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-2">
            <span>마지막 실행</span>
            <span class="text-success">성공 (2시간 전)</span>
        </div>
    </div>
</div>

<!-- 배치 설정 폼 -->
<div class="row">
    <div class="col-md-4">
        <label class="form-label">배치 실행 시간</label>
        <input type="time" class="form-control" name="batch_time" value="02:00">
    </div>
    <div class="col-md-4">
        <label class="form-label">호출 간격 (초)</label>
        <input type="number" class="form-control" name="api_interval" 
               value="3" min="1" max="60">
    </div>
    <div class="col-md-4">
        <label class="form-label">페이지 크기</label>
        <input type="number" class="form-control" name="page_size" 
               value="30" min="1" max="30">
    </div>
</div>
```

#### **사은품 표시** 🎁
```html
<!-- 사은품 표시 뱃지 -->
<span class="badge bg-gift me-1">
    <i class="bi bi-gift"></i> 사은품
</span>

<!-- 매출/사은품 구분 테이블 -->
<table class="table table-striped">
    <thead>
        <tr>
            <th>상품명</th>
            <th>수량</th>
            <th>단가</th>
            <th>분류</th>
            <th>매출 반영</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>NUNA 카시트</td>
            <td>1</td>
            <td>450,000원</td>
            <td><span class="badge bg-revenue">매출상품</span></td>
            <td><i class="bi bi-check-circle text-success"></i></td>
        </tr>
        <tr class="table-warning">
            <td>사은품 패드</td>
            <td>1</td>
            <td>0원</td>
            <td><span class="badge bg-gift">사은품</span></td>
            <td><i class="bi bi-x-circle text-danger"></i></td>
        </tr>
    </tbody>
</table>

<!-- 사은품 분석 차트 -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title">
            <i class="bi bi-pie-chart"></i> 사은품 부착률 분석
        </h5>
    </div>
    <div class="card-body">
        <canvas id="giftAttachmentChart" width="400" height="200"></canvas>
    </div>
</div>
```

### **레이아웃 구조** (관리자 시스템 최적화)

#### **기본 레이아웃** (사이드바 + 메인) - 업데이트
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIS v2 - {{ page_title }}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- 커스텀 CSS -->
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/batch.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/gift.css') }}" rel="stylesheet">
</head>
<body>
    <!-- 상단 네비게이션 (고정) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-brand-primary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-building"></i> MIS v2
            </a>
            
            <!-- 배치 상태 표시 (신규) -->
            <div class="navbar-nav me-auto">
                <div class="nav-item">
                    <span class="navbar-text">
                        <i class="bi bi-clock"></i>
                        <span id="batchStatus" class="badge bg-success">배치 정상</span>
                    </span>
                </div>
            </div>
            
            <!-- 사용자 정보 -->
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">{{ current_user.name }}님</span>
                <a class="nav-link" href="/logout">로그아웃</a>
            </div>
        </div>
    </nav>
    
    <!-- 메인 컨테이너 -->
    <div class="container-fluid" style="margin-top: 56px;">
        <div class="row">
            <!-- 사이드바 (고정) -->
            <nav class="col-md-2 col-lg-2 sidebar bg-light">
                <div class="sidebar-sticky">
                    {% include 'partials/sidebar.html' %}
                </div>
            </nav>
            
            <!-- 메인 컨텐츠 -->
            <main class="col-md-10 col-lg-10 main-content">
                <!-- 브레드크럼 -->
                <nav aria-label="breadcrumb" class="mt-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">홈</a></li>
                        {% block breadcrumb %}{% endblock %}
                    </ol>
                </nav>
                
                <!-- 페이지 헤더 -->
                <div class="page-header d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h2">{% block page_title %}{% endblock %}</h1>
                    <div class="btn-group">
                        {% block page_actions %}{% endblock %}
                    </div>
                </div>
                
                <!-- 알림 메시지 -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <!-- 컨텐츠 영역 -->
                <div class="content">
                    {% block content %}{% endblock %}
                </div>
            </main>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/batch.js') }}"></script>
    <script src="{{ url_for('static', filename='js/gift.js') }}"></script>
    {% block scripts %}{% endblock %}
</body>
</html>
```

---

## 📏 **코딩 컨벤션** (한국 환경 최적화)

### **Python 코드 스타일** (PEP 8 기반)

#### **네이밍 규칙** (업데이트)
```python
# 변수, 함수: snake_case (한국어 주석)
user_name = "홍길동"  # 사용자명
batch_schedule_time = "02:00"  # 배치 실행 시간
gift_keywords = ["사은품", "증정품"]  # 사은품 키워드

def get_user_info():
    """사용자 정보 조회"""
    pass

def schedule_batch_job():
    """배치 작업 스케줄링"""
    pass

def classify_gift_products():
    """사은품 자동 분류"""
    pass

# 클래스: PascalCase
class UserManager:
    """사용자 관리 클래스"""
    pass

class BatchScheduler:
    """배치 스케줄러 클래스"""
    pass

class GiftClassifier:
    """사은품 분류 클래스"""
    pass

# 상수: UPPER_SNAKE_CASE
MAX_LOGIN_ATTEMPTS = 5  # 최대 로그인 시도 횟수
DEFAULT_PAGE_SIZE = 20  # 기본 페이지 크기
DEFAULT_BATCH_HOUR = 2  # 기본 배치 실행 시간 (02시)
GIFT_AUTO_CLASSIFY = True  # 사은품 자동 분류 활성화

# 파일명: snake_case
user_controller.py      # 사용자 컨트롤러
batch_scheduler.py      # 배치 스케줄러
gift_classifier.py      # 사은품 분류기
erpia_api_client.py    # ERPia API 클라이언트
```

#### **배치 관리 템플릿**
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ERPia 배치 스케줄러
- 웹 기반 배치 시간 설정
- 회사별 독립 스케줄 관리
- 배치 상태 모니터링
"""

# 표준 라이브러리
from datetime import datetime, timedelta
from typing import Dict, List, Optional

# 서드파티 라이브러리
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.cron import CronTrigger
from flask import current_app
import requests

# 로컬 모듈
from app.models.company import Company
from app.models.erpia_config import ErpiaConfig
from app.services.gift_classifier import GiftClassifier
from app.utils.logging import BatchLogger

# 상수
DEFAULT_BATCH_HOUR = 2
DEFAULT_BATCH_MINUTE = 0
DEFAULT_API_INTERVAL = 3
DEFAULT_PAGE_SIZE = 30

class ErpiaBatchScheduler:
    """ERPia 배치 스케줄러
    
    웹에서 설정한 시간에 따라 회사별로 ERPia 데이터를 수집하고
    사은품 자동 분류를 수행합니다.
    """
    
    def __init__(self):
        """스케줄러 초기화"""
        self.scheduler = BackgroundScheduler(daemon=True)
        self.gift_classifier = GiftClassifier()
        self.logger = BatchLogger()
    
    def setup_company_batch(self, company_id: int):
        """회사별 배치 스케줄 설정
        
        Args:
            company_id (int): 회사 ID
        """
        try:
            config = ErpiaConfig.query.filter_by(company_id=company_id).first()
            if not config or not config.batch_enabled:
                return
            
            # 기존 스케줄 제거
            job_id = f'erpia_batch_{company_id}'
            if self.scheduler.get_job(job_id):
                self.scheduler.remove_job(job_id)
            
            # 새 스케줄 등록
            self.scheduler.add_job(
                func=self._run_batch_with_gift_classification,
                trigger=CronTrigger(
                    hour=config.batch_hour or DEFAULT_BATCH_HOUR,
                    minute=config.batch_minute or DEFAULT_BATCH_MINUTE
                ),
                args=[company_id],
                id=job_id,
                name=f'ERPia 배치 - 회사 {company_id}'
            )
            
            self.logger.info(f'배치 스케줄 등록 완료: 회사 {company_id}')
            
        except Exception as e:
            self.logger.error(f'배치 스케줄 설정 실패: {str(e)}')
    
    def _run_batch_with_gift_classification(self, company_id: int):
        """배치 실행 + 사은품 자동 분류
        
        Args:
            company_id (int): 회사 ID
        """
        try:
            # ERPia 데이터 수집
            sales_data = self._collect_erpia_data(company_id)
            
            # 사은품 자동 분류 적용
            classified_data = self.gift_classifier.classify_products(
                sales_data, company_id
            )
            
            # 데이터베이스 저장
            self._save_classified_data(classified_data, company_id)
            
            self.logger.info(f'배치 실행 완료: 회사 {company_id}, '
                           f'처리 건수 {len(classified_data)}')
            
        except Exception as e:
            self.logger.error(f'배치 실행 실패: 회사 {company_id}, 오류: {str(e)}')
```

---

## 📁 **프로젝트 구조** (유지보수 최적화) - 업데이트

```
mis_v2/
├── app/                          # Flask 애플리케이션
│   ├── __init__.py              # 앱 팩토리
│   ├── config.py                # 설정 파일
│   ├── models/                  # SQLAlchemy 모델
│   │   ├── __init__.py
│   │   ├── base.py             # 베이스 모델
│   │   ├── user.py             # 사용자 모델
│   │   ├── product.py          # 제품 모델
│   │   ├── trade.py            # 무역 모델
│   │   ├── admin.py            # 관리자 모델
│   │   ├── erpia_config.py     # ERPia 설정 모델 (신규)
│   │   ├── gift_master.py      # 사은품 마스터 모델 (신규)
│   │   └── batch_log.py        # 배치 로그 모델 (신규)
│   ├── controllers/             # 컨트롤러 (라우트)
│   │   ├── __init__.py
│   │   ├── main.py             # 메인 페이지
│   │   ├── auth.py             # 인증
│   │   ├── admin.py            # 관리자
│   │   ├── customer.py         # 고객관리
│   │   ├── stats.py            # 통계관리
│   │   ├── sales.py            # 영업관리
│   │   ├── trade.py            # 무역관리
│   │   ├── logistics.py        # 물류관리
│   │   ├── batch.py            # 배치 관리 (신규)
│   │   └── gift.py             # 사은품 관리 (신규)
│   ├── services/               # 비즈니스 로직
│   │   ├── __init__.py
│   │   ├── user_service.py     # 사용자 서비스
│   │   ├── trade_service.py    # 무역 서비스
│   │   ├── serial_service.py   # 시리얼 서비스
│   │   ├── cache_service.py    # 캐시 서비스
│   │   ├── batch_scheduler.py  # 배치 스케줄러 (신규)
│   │   ├── erpia_api_client.py # ERPia API 클라이언트 (신규)
│   │   ├── gift_classifier.py  # 사은품 분류기 (신규)
│   │   └── gift_analytics.py   # 사은품 분석 (신규)
│   ├── utils/                  # 유틸리티
│   │   ├── __init__.py
│   │   ├── helpers.py          # 헬퍼 함수
│   │   ├── decorators.py       # 데코레이터
│   │   ├── validators.py       # 검증 함수
│   │   ├── cache.py            # 캐시 유틸리티
│   │   ├── batch_logger.py     # 배치 로깅 (신규)
│   │   └── scheduler_utils.py  # 스케줄러 유틸리티 (신규)
│   ├── templates/              # Jinja2 템플릿
│   │   ├── base.html           # 기본 레이아웃
│   │   ├── partials/           # 공통 컴포넌트
│   │   │   ├── sidebar.html
│   │   │   ├── navbar.html
│   │   │   ├── pagination.html
│   │   │   ├── batch_status.html    # 배치 상태 (신규)
│   │   │   └── gift_badge.html      # 사은품 뱃지 (신규)
│   │   ├── admin/              # 관리자 템플릿
│   │   │   ├── batch/          # 배치 관리 템플릿 (신규)
│   │   │   └── gift/           # 사은품 설정 템플릿 (신규)
│   │   ├── customer/           # 고객관리 템플릿
│   │   ├── trade/              # 무역관리 템플릿
│   │   └── errors/             # 에러 페이지
│   └── static/                 # 정적 파일
│       ├── css/
│       │   ├── main.css        # 메인 스타일
│       │   ├── components.css  # 컴포넌트 스타일
│       │   ├── batch.css       # 배치 관련 스타일 (신규)
│       │   └── gift.css        # 사은품 관련 스타일 (신규)
│       ├── js/
│       │   ├── main.js         # 메인 스크립트
│       │   ├── components/     # 컴포넌트별 JS
│       │   ├── batch.js        # 배치 관리 JS (신규)
│       │   ├── gift.js         # 사은품 관리 JS (신규)
│       │   └── datatables.korean.json
│       └── images/
├── migrations/                 # DB 마이그레이션
├── tests/                     # 테스트 파일
│   ├── unit/                  # 단위 테스트
│   │   ├── test_batch.py      # 배치 테스트 (신규)
│   │   └── test_gift.py       # 사은품 테스트 (신규)
│   ├── integration/           # 통합 테스트
│   └── conftest.py            # 테스트 설정
├── docs/                      # 문서
├── sql_scripts/              # SQL 스크립트
├── docker-compose.yml        # Docker 설정
├── requirements.txt          # Python 의존성 (업데이트)
├── .env.example             # 환경 변수 예제 (업데이트)
├── .env                     # 환경 변수 (git 제외)
└── run.py                   # 앱 실행 파일
```

---

## 🔐 **보안 가이드라인** (실무 중심)

### **인증 및 권한**
- **Flask-Login**: 세션 기반 인증
- **Redis Session**: 세션 데이터 Redis 저장
- **CSRF 보호**: Flask-WTF 토큰 사용
- **권한 체크**: 데코레이터 패턴
- **메뉴별 접근 제어**: DB 기반 권한 관리

### **코드 보안 예제** (업데이트)
```python
# app/utils/decorators.py
from functools import wraps
from flask import session, redirect, url_for, flash, request
from app.models.user import User
from app.utils.cache import get_user_permissions

def login_required(f):
    """로그인 필수 데코레이터"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            flash('로그인이 필요합니다.', 'warning')
            return redirect(url_for('auth.login', next=request.url))
        return f(*args, **kwargs)
    return decorated_function

def batch_admin_required(f):
    """배치 관리자 권한 필요 데코레이터 (신규)"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        user_id = session.get('user_id')
        if not user_id:
            flash('로그인이 필요합니다.', 'warning')
            return redirect(url_for('auth.login'))
        
        permissions = get_user_permissions(user_id)
        if not permissions.get('admin_batch', {}).get('update', False):
            flash('배치 관리 권한이 없습니다.', 'danger')
            return redirect(url_for('main.index'))
        
        return f(*args, **kwargs)
    return decorated_function

def permission_required(menu_code, action='read'):
    """권한 체크 데코레이터
    
    Args:
        menu_code (str): 메뉴 코드
        action (str): 액션 (create, read, update, delete)
    """
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            user_id = session.get('user_id')
            if not user_id:
                flash('로그인이 필요합니다.', 'warning')
                return redirect(url_for('auth.login'))
            
            # 캐시에서 권한 확인
            permissions = get_user_permissions(user_id)
            if not permissions.get(menu_code, {}).get(action, False):
                flash('접근 권한이 없습니다.', 'danger')
                return redirect(url_for('main.index'))
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator

# 사용 예시
@app.route('/admin/users')
@login_required
@permission_required('admin_user', 'read')
def admin_users():
    return render_template('admin/users.html')

@app.route('/admin/batch/settings')
@login_required
@batch_admin_required
def batch_settings():
    return render_template('admin/batch/settings.html')

@app.route('/admin/gift/settings')
@login_required
@permission_required('admin_gift', 'update')
def gift_settings():
    return render_template('admin/gift/settings.html')
```

---

## ⚙️ **배치 및 스케줄링** (신규 추가)

### **APScheduler 설정**
```python
# app/config.py
class Config:
    # 기존 설정...
    
    # 배치 스케줄러 설정
    SCHEDULER_API_ENABLED = True
    SCHEDULER_TIMEZONE = 'Asia/Seoul'
    
    # ERPia 배치 기본 설정
    BATCH_DEFAULT_HOUR = 2
    BATCH_DEFAULT_MINUTE = 0
    BATCH_MAX_RETRY = 3
    
    # ERPia API 설정
    ERPIA_API_URL = 'http://www.erpia.net/xml/xml.asp'
    ERPIA_DEFAULT_INTERVAL = 3
    ERPIA_DEFAULT_PAGE_SIZE = 30
    ERPIA_TIMEOUT = 30

# app/__init__.py
from flask_apscheduler import APScheduler

def create_app():
    app = Flask(__name__)
    
    # 스케줄러 초기화
    scheduler = APScheduler()
    scheduler.init_app(app)
    scheduler.start()
    
    return app
```

### **배치 관리 API**
```python
# app/controllers/batch.py
from flask import Blueprint, render_template, request, jsonify
from app.services.batch_scheduler import ErpiaBatchScheduler
from app.utils.decorators import login_required, batch_admin_required

batch_bp = Blueprint('batch', __name__, url_prefix='/admin/batch')

@batch_bp.route('/settings')
@login_required
@batch_admin_required
def settings():
    """배치 설정 화면"""
    return render_template('admin/batch/settings.html')

@batch_bp.route('/api/schedule', methods=['POST'])
@login_required
@batch_admin_required
def update_schedule():
    """배치 스케줄 업데이트"""
    data = request.get_json()
    
    try:
        scheduler = ErpiaBatchScheduler()
        result = scheduler.update_company_schedule(
            company_id=data['company_id'],
            schedule_time=data['schedule_time'],
            api_settings=data['api_settings']
        )
        
        return jsonify({'success': True, 'message': '스케줄이 업데이트되었습니다.'})
    
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)}), 500

@batch_bp.route('/api/status/<int:company_id>')
@login_required
def get_status(company_id):
    """배치 상태 조회"""
    scheduler = ErpiaBatchScheduler()
    status = scheduler.get_batch_status(company_id)
    return jsonify(status)
```

---

## 🎁 **사은품 분류 시스템** (신규 추가)

### **사은품 분류 설정**
```python
# app/config.py
class Config:
    # 사은품 분류 기본 설정
    GIFT_AUTO_CLASSIFY = True
    GIFT_DEFAULT_KEYWORDS = ['사은품', '증정품', '무료', '샘플', '체험']
    GIFT_EXCLUDE_FROM_REVENUE = True
    
    # 사은품 분석 설정
    GIFT_ANALYTICS_CACHE_TTL = 3600  # 1시간
    GIFT_REPORT_MAX_DAYS = 365       # 최대 1년
```

### **사은품 분류 서비스**
```python
# app/services/gift_classifier.py
from typing import List, Dict, Any
from app.models.gift_master import GiftMaster
from app.models.erpia_config import ErpiaConfig

class GiftClassifier:
    """사은품 자동 분류 엔진"""
    
    def __init__(self):
        self.classification_cache = {}
    
    def classify_products(self, products: List[Dict], company_id: int) -> List[Dict]:
        """상품 목록 자동 분류"""
        
        # 회사별 사은품 설정 로드
        config = ErpiaConfig.query.filter_by(company_id=company_id).first()
        if not config or not config.auto_gift_classify:
            return products
        
        classified_products = []
        
        for product in products:
            classification = self._classify_single_product(
                product, config, company_id
            )
            product.update(classification)
            classified_products.append(product)
        
        return classified_products
    
    def _classify_single_product(self, product: Dict, config: ErpiaConfig, 
                                company_id: int) -> Dict:
        """단일 상품 분류"""
        
        gong_amt = int(product.get('gong_amt', 0))
        pan_amt = int(product.get('pan_amt', 0))
        product_name = product.get('product_name', '')
        
        # 1. 0원 상품 → 자동 사은품
        if gong_amt == 0 and pan_amt == 0:
            return {
                'product_type': 'GIFT',
                'is_revenue': not config.gift_exclude_from_revenue,
                'gift_type': 'ZERO_PRICE',
                'classification_reason': '공급가 0원 (자동분류)',
                'revenue_impact': 0
            }
        
        # 2. 키워드 기반 분류
        keywords = config.gift_keywords or []
        for keyword in keywords:
            if keyword in product_name:
                return {
                    'product_type': 'GIFT',
                    'is_revenue': not config.gift_exclude_from_revenue,
                    'gift_type': 'KEYWORD_BASED',
                    'classification_reason': f'키워드 매칭: {keyword}',
                    'revenue_impact': 0
                }
        
        # 3. 사은품 마스터 기반 분류
        gift_master = GiftMaster.query.filter_by(
            company_id=company_id,
            product_code=product.get('product_code'),
            is_active=True
        ).first()
        
        if gift_master:
            return {
                'product_type': 'GIFT',
                'is_revenue': not config.gift_exclude_from_revenue,
                'gift_type': 'MASTER_BASED',
                'classification_reason': '사은품 마스터 등록',
                'revenue_impact': 0
            }
        
        # 4. 일반 상품
        return {
            'product_type': 'PRODUCT',
            'is_revenue': True,
            'gift_type': None,
            'classification_reason': '일반 매출 상품',
            'revenue_impact': gong_amt
        }
```

---

## 📋 **개발 체크리스트** (단계별) - 업데이트

### **환경 설정**
- [ ] Docker 환경 구성 (PostgreSQL + Redis)
- [ ] Python 가상환경 생성
- [ ] 의존성 패키지 설치 (APScheduler, pandas 포함)
- [ ] 환경 변수 설정 (배치/사은품 설정 포함)
- [ ] DB 스키마 생성

### **개발 단계**
- [ ] 모델 정의 (SQLAlchemy) - 배치/사은품 모델 포함
- [ ] 컨트롤러 구현 (Flask Blueprint) - 배치/사은품 컨트롤러 포함
- [ ] 배치 스케줄러 구현 (APScheduler)
- [ ] 사은품 분류 엔진 구현
- [ ] 템플릿 작성 (Jinja2 + Bootstrap) - 배치/사은품 UI 포함
- [ ] JavaScript 기능 추가 (실시간 배치 상태)
- [ ] 단위 테스트 작성

### **배포 준비**
- [ ] 코드 품질 검사 (Black + Flake8)
- [ ] 통합 테스트 실행 (배치/사은품 테스트 포함)
- [ ] 보안 점검
- [ ] 성능 최적화 (배치 성능 튜닝)
- [ ] 문서 업데이트

---

**✅ 웹 기반 배치 설정과 사은품 자동 분류가 완전히 반영된 기술 스택 완료!**  
**📝 APScheduler, pandas 추가 및 관련 컴포넌트로 구성하여 고도화된 MIS v2 시스템 구축 가능!** 