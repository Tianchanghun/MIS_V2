# ğŸ¢ ë©€í‹° í…Œë„ŒíŠ¸ ì‹œìŠ¤í…œ ì„¤ê³„

## ğŸ“‹ ì„¤ê³„ ê°œìš”

ì—ì´ì›ê³¼ ì—ì´ì› ì›”ë“œê°€ **ë‹¨ì¼ ì‹œìŠ¤í…œ**ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ **ë©€í‹° í…Œë„ŒíŠ¸ ì•„í‚¤í…ì²˜**ë¥¼ ì„¤ê³„í•©ë‹ˆë‹¤. **íšŒì‚¬ë³„ ë…ë¦½ì„±**ì„ ë³´ì¥í•˜ë©´ì„œë„ **ë°ì´í„° ê³µìœ **ì™€ **ê²¸ì§ì ì§€ì›**ì´ ê°€ëŠ¥í•œ ìœ ì—°í•œ êµ¬ì¡°ë¥¼ êµ¬í˜„í•˜ê³ , **ì›¹ ê¸°ë°˜ ë°°ì¹˜ ì„¤ì •**ê³¼ **ì‚¬ì€í’ˆ ìë™ ë¶„ë¥˜**ë¥¼ íšŒì‚¬ë³„ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

## ğŸ¯ ë©€í‹° í…Œë„ŒíŠ¸ ìš”êµ¬ì‚¬í•­

### **1. íšŒì‚¬ êµ¬ë¶„ ë° ê´€ë¦¬**
- âœ… **ë…ë¦½ëœ íšŒì‚¬**: ì—ì´ì› â†” ì—ì´ì› ì›”ë“œ
- âœ… **ë‹¨ì¼ DB**: `company_id`ë¡œ ë°ì´í„° êµ¬ë¶„
- âœ… **ë°ì´í„° ê³µìœ **: ê³µí†µ ìƒí’ˆ/ê±°ë˜ì²˜ í™œìš© ê°€ëŠ¥
- âœ… **íšŒì‚¬ë³„ ì„¤ì •**: ERPia ê³„ì •, ë°°ì¹˜ ì‹œê°„, ì‚¬ì€í’ˆ ì •ì±… ë“±

### **2. ì‚¬ìš©ì ê¶Œí•œ ë° ì ‘ê·¼**
- âœ… **íšŒì‚¬ë³„ ë°ì´í„° ê²©ë¦¬**: ê¸°ë³¸ì ìœ¼ë¡œ ìì‹ ì˜ íšŒì‚¬ ë°ì´í„°ë§Œ
- âœ… **ìŠˆí¼ ê´€ë¦¬ì**: ëª¨ë“  íšŒì‚¬ ë°ì´í„° ê´€ë¦¬ ê°€ëŠ¥
- âœ… **ê²¸ì§ì ì§€ì›**: ì—¬ëŸ¬ íšŒì‚¬ ì†Œì† + ë¡œê·¸ì¸ í›„ íšŒì‚¬ ì „í™˜

### **3. ERPia ì—°ë™**
- âœ… **íšŒì‚¬ë³„ ERPia ê³„ì •**: ë³„ë„ admin_code, password
- âœ… **ì›¹ ê¸°ë°˜ ì„¤ì •**: ê´€ë¦¬ìê°€ ì›¹ì—ì„œ ERPia ì •ë³´ ì…ë ¥
- âœ… **ë°°ì¹˜ ë…ë¦½ ì‹¤í–‰**: íšŒì‚¬ë³„ ë°°ì¹˜ ì‹œê°„/ì„¤ì • ê´€ë¦¬

### **4. ì‹œìŠ¤í…œ êµ¬ì¡°**
- âœ… **URL êµ¬ì¡°**: ë¡œê·¸ì¸ í›„ íšŒì‚¬ ì„ íƒ
- âœ… **ì„¸ì…˜ ê´€ë¦¬**: í˜„ì¬ í™œì„± íšŒì‚¬ ì¶”ì 
- âœ… **ì‚¬ì€í’ˆ ì •ì±…**: íšŒì‚¬ë³„ ì‚¬ì€í’ˆ ë¶„ë¥˜ ê·œì¹™

## ğŸ—ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### **1. íšŒì‚¬ ê´€ë¦¬ í…Œì´ë¸”**
```sql
-- íšŒì‚¬ ë§ˆìŠ¤í„°
CREATE TABLE companies (
    id SERIAL PRIMARY KEY,
    company_code VARCHAR(20) UNIQUE NOT NULL,      -- 'AONE', 'AONE_WORLD'
    company_name VARCHAR(100) NOT NULL,            -- 'ì—ì´ì›', 'ì—ì´ì› ì›”ë“œ'
    company_name_en VARCHAR(100),                  -- 'AONE', 'AONE WORLD'
    
    -- íšŒì‚¬ ê¸°ë³¸ ì •ë³´
    business_number VARCHAR(20),                   -- ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸
    ceo_name VARCHAR(50),                         -- ëŒ€í‘œìëª…
    address TEXT,                                 -- íšŒì‚¬ ì£¼ì†Œ
    phone VARCHAR(20),                            -- ëŒ€í‘œ ì „í™”
    email VARCHAR(100),                           -- ëŒ€í‘œ ì´ë©”ì¼
    
    -- ì‹œìŠ¤í…œ ì„¤ì •
    is_active BOOLEAN DEFAULT TRUE,               -- í™œì„± ìƒíƒœ
    logo_url VARCHAR(500),                        -- íšŒì‚¬ ë¡œê³ 
    theme_color VARCHAR(10) DEFAULT '#007bff',    -- í…Œë§ˆ ìƒ‰ìƒ
    
    -- ë©€í‹°í…Œë„ŒíŠ¸ ì„¤ì •
    data_isolation_level VARCHAR(20) DEFAULT 'STRICT',  -- STRICT, SHARED
    allow_data_sharing BOOLEAN DEFAULT TRUE,             -- ë°ì´í„° ê³µìœ  í—ˆìš©
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ê¸°ë³¸ íšŒì‚¬ ë°ì´í„°
INSERT INTO companies (company_code, company_name, company_name_en) VALUES 
('AONE', 'ì—ì´ì›', 'AONE'),
('AONE_WORLD', 'ì—ì´ì› ì›”ë“œ', 'AONE WORLD');
```

### **2. ì‚¬ìš©ì-íšŒì‚¬ ê´€ê³„ í…Œì´ë¸”**
```sql
-- ì‚¬ìš©ì-íšŒì‚¬ ê´€ê³„ (ê²¸ì§ì ì§€ì›)
CREATE TABLE user_companies (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    company_id INTEGER REFERENCES companies(id) ON DELETE CASCADE,
    
    -- ê¶Œí•œ ì„¤ì •
    role VARCHAR(50) NOT NULL,                    -- 'admin', 'manager', 'user'
    permissions JSON,                             -- ì„¸ë¶€ ê¶Œí•œ ì„¤ì •
    
    -- ìƒíƒœ ì •ë³´
    is_primary BOOLEAN DEFAULT FALSE,             -- ì£¼ ì†Œì† íšŒì‚¬ ì—¬ë¶€
    is_active BOOLEAN DEFAULT TRUE,               -- í•´ë‹¹ íšŒì‚¬ì—ì„œ í™œì„± ìƒíƒœ
    
    -- ì ‘ê·¼ ì œí•œ
    access_start_date DATE,                       -- ì ‘ê·¼ ì‹œì‘ì¼
    access_end_date DATE,                         -- ì ‘ê·¼ ì¢…ë£Œì¼
    last_access_at TIMESTAMP,                     -- ë§ˆì§€ë§‰ ì ‘ê·¼ ì‹œê°„
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(user_id, company_id)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_user_companies_user_id ON user_companies(user_id);
CREATE INDEX idx_user_companies_company_id ON user_companies(company_id);
CREATE INDEX idx_user_companies_active ON user_companies(is_active);
```

### **3. íšŒì‚¬ë³„ ERPia ì„¤ì •**
```sql
-- íšŒì‚¬ë³„ ERPia ì—°ë™ ì„¤ì •
CREATE TABLE company_erpia_configs (
    id SERIAL PRIMARY KEY,
    company_id INTEGER REFERENCES companies(id) ON DELETE CASCADE,
    
    -- ERPia ì¸ì¦ ì •ë³´ (ì•”í˜¸í™” ì €ì¥)
    admin_code VARCHAR(100) NOT NULL,
    password_encrypted TEXT NOT NULL,             -- ì•”í˜¸í™”ëœ íŒ¨ìŠ¤ì›Œë“œ
    api_url VARCHAR(500) DEFAULT 'http://www.erpia.net/xml/xml.asp',
    
    -- ë°°ì¹˜ ìŠ¤ì¼€ì¤„ ì„¤ì • (ì›¹ì—ì„œ ê´€ë¦¬)
    batch_enabled BOOLEAN DEFAULT TRUE,
    batch_hour INTEGER DEFAULT 2,                -- 02ì‹œ
    batch_minute INTEGER DEFAULT 0,              -- 00ë¶„
    batch_timezone VARCHAR(50) DEFAULT 'Asia/Seoul',
    
    -- API í˜¸ì¶œ ì„¤ì • (ì›¹ì—ì„œ ê´€ë¦¬)
    api_call_interval INTEGER DEFAULT 3,         -- í˜¸ì¶œ ê°„ê²©(ì´ˆ)
    page_size INTEGER DEFAULT 30,                -- í˜ì´ì§€ë‹¹ ê±´ìˆ˜
    retry_count INTEGER DEFAULT 3,               -- ì¬ì‹œë„ íšŸìˆ˜
    timeout_seconds INTEGER DEFAULT 30,          -- íƒ€ì„ì•„ì›ƒ
    
    -- ì‚¬ì€í’ˆ ì²˜ë¦¬ ì„¤ì • (ì›¹ì—ì„œ ê´€ë¦¬)
    auto_gift_classify BOOLEAN DEFAULT TRUE,     -- ìë™ ì‚¬ì€í’ˆ ë¶„ë¥˜
    gift_keywords TEXT,                          -- JSON ë°°ì—´: ["ì‚¬ì€í’ˆ", "ì¦ì •í’ˆ", ...]
    gift_exclude_from_revenue BOOLEAN DEFAULT TRUE,  -- ì‚¬ì€í’ˆ ë§¤ì¶œ ì§‘ê³„ ì œì™¸
    
    -- ì•Œë¦¼ ì„¤ì •
    notification_email VARCHAR(200),             -- ë°°ì¹˜ ì™„ë£Œ ì•Œë¦¼
    error_notification BOOLEAN DEFAULT TRUE,     -- ì˜¤ë¥˜ ì•Œë¦¼
    
    -- ì—°ë™ ìƒíƒœ
    is_active BOOLEAN DEFAULT TRUE,
    last_sync_date TIMESTAMP,                    -- ë§ˆì§€ë§‰ ë™ê¸°í™” ì‹œê°„
    sync_error_count INTEGER DEFAULT 0,          -- ì—°ì† ì˜¤ë¥˜ íšŸìˆ˜
    last_error_message TEXT,                     -- ë§ˆì§€ë§‰ ì˜¤ë¥˜ ë©”ì‹œì§€
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(company_id)
);

-- ê¸°ë³¸ ERPia ì„¤ì • (ì—ì´ì›)
INSERT INTO company_erpia_configs (
    company_id, admin_code, password_encrypted, 
    batch_hour, batch_minute, auto_gift_classify
) VALUES (
    1, 'aone', encrypt_password('ka22fslfod1vid'), 
    2, 0, TRUE
);
```

### **4. ë©€í‹°í…Œë„ŒíŠ¸ í™•ì¥ (ê¸°ì¡´ í…Œì´ë¸”)**
```sql
-- ëª¨ë“  ë¹„ì¦ˆë‹ˆìŠ¤ í…Œì´ë¸”ì— company_id ì¶”ê°€

-- ë§¤ì¶œë¶„ì„ ë§ˆìŠ¤í„° (í™•ì¥)
ALTER TABLE sales_analysis_master 
ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;

-- ì‚¬ì€í’ˆ ë¶„ì„ í…Œì´ë¸” (í™•ì¥)
ALTER TABLE gift_analysis 
ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;

-- ê±°ë˜ì²˜ ê´€ë¦¬
ALTER TABLE tbl_erpia_customer 
ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;

-- ìƒí’ˆ ê´€ë¦¬
ALTER TABLE tbl_product_codematch 
ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;

-- ì‚¬ìš©ì ê´€ë¦¬
ALTER TABLE tbl_member 
ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;

-- ì£¼ìš” í…Œì´ë¸”ë“¤ company_id ì¶”ê°€
ALTER TABLE tbl_trade_order_mst ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;
ALTER TABLE tbl_trade_order_slv ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;
ALTER TABLE tbl_sales_orderinfo ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;
ALTER TABLE tbl_erpia_order_mst ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;
ALTER TABLE tbl_erpia_order_product ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;

-- ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX idx_sales_analysis_company ON sales_analysis_master(company_id);
CREATE INDEX idx_gift_analysis_company ON gift_analysis(company_id);
CREATE INDEX idx_customer_company ON tbl_erpia_customer(company_id);
CREATE INDEX idx_product_company ON tbl_product_codematch(company_id);
```

### **5. ë°ì´í„° ê³µìœ  ê´€ë¦¬**
```sql
-- ê³µìœ  ë°ì´í„° ê´€ë¦¬ í…Œì´ë¸”
CREATE TABLE shared_data_policies (
    id SERIAL PRIMARY KEY,
    source_company_id INTEGER REFERENCES companies(id),
    target_company_id INTEGER REFERENCES companies(id),
    
    -- ê³µìœ  ì„¤ì •
    data_type VARCHAR(50) NOT NULL,              -- 'customer', 'product', 'brand'
    sharing_type VARCHAR(20) NOT NULL,           -- 'READ_ONLY', 'READ_WRITE', 'SYNC'
    
    -- ê³µìœ  ì¡°ê±´
    filter_conditions JSON,                      -- ê³µìœ  ì¡°ê±´ (JSON)
    approval_required BOOLEAN DEFAULT FALSE,     -- ìŠ¹ì¸ í•„ìš” ì—¬ë¶€
    
    -- ìƒíƒœ ê´€ë¦¬
    is_active BOOLEAN DEFAULT TRUE,
    created_by INTEGER REFERENCES users(id),
    approved_by INTEGER REFERENCES users(id),
    approved_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ë°ì´í„° ê³µìœ  ì´ë ¥
CREATE TABLE shared_data_logs (
    id SERIAL PRIMARY KEY,
    policy_id INTEGER REFERENCES shared_data_policies(id),
    
    action_type VARCHAR(20) NOT NULL,            -- 'SHARE', 'UPDATE', 'REVOKE'
    data_id VARCHAR(100) NOT NULL,               -- ê³µìœ ëœ ë°ì´í„° ID
    data_type VARCHAR(50) NOT NULL,              -- ë°ì´í„° íƒ€ì…
    
    source_company_id INTEGER REFERENCES companies(id),
    target_company_id INTEGER REFERENCES companies(id),
    action_user_id INTEGER REFERENCES users(id),
    
    action_details JSON,                         -- ì•¡ì…˜ ìƒì„¸ ì •ë³´
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## ğŸ’» ë°±ì—”ë“œ êµ¬í˜„

### **1. ë©€í‹°í…Œë„ŒíŠ¸ ë¯¸ë“¤ì›¨ì–´**
```python
from flask import request, session, g, abort
from functools import wraps

class MultiTenantMiddleware:
    """ë©€í‹°í…Œë„ŒíŠ¸ ë¯¸ë“¤ì›¨ì–´"""
    
    def __init__(self, app=None):
        self.app = app
        if app:
            self.init_app(app)
    
    def init_app(self, app):
        app.before_request(self.before_request)
    
    def before_request(self):
        """ìš”ì²­ ì „ íšŒì‚¬ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •"""
        
        # í˜„ì¬ í™œì„± íšŒì‚¬ ID ê°€ì ¸ì˜¤ê¸°
        current_company_id = session.get('current_company_id')
        
        if current_company_id:
            # ì‚¬ìš©ìê°€ í•´ë‹¹ íšŒì‚¬ì— ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸
            user_id = session.get('user_id')
            if user_id and self.has_company_access(user_id, current_company_id):
                g.current_company_id = current_company_id
                g.current_company = self.get_company(current_company_id)
            else:
                g.current_company_id = None
                g.current_company = None
        else:
            g.current_company_id = None
            g.current_company = None
    
    def has_company_access(self, user_id: int, company_id: int) -> bool:
        """ì‚¬ìš©ìì˜ íšŒì‚¬ ì ‘ê·¼ ê¶Œí•œ í™•ì¸"""
        from app.models.user_company import UserCompany
        
        access = UserCompany.query.filter_by(
            user_id=user_id,
            company_id=company_id,
            is_active=True
        ).first()
        
        return access is not None
    
    def get_company(self, company_id: int):
        """íšŒì‚¬ ì •ë³´ ì¡°íšŒ"""
        from app.models.company import Company
        return Company.query.get(company_id)

# ë°ì½”ë ˆì´í„°
def require_company_access(permission=None):
    """íšŒì‚¬ ì ‘ê·¼ ê¶Œí•œ í•„ìš” ë°ì½”ë ˆì´í„°"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not g.current_company_id:
                abort(403, 'íšŒì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.')
            
            if permission:
                if not check_permission(g.current_company_id, permission):
                    abort(403, 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.')
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator

def company_context(company_id_param='company_id'):
    """URL íŒŒë¼ë¯¸í„°ë¡œ íšŒì‚¬ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            company_id = kwargs.get(company_id_param) or request.json.get(company_id_param)
            
            if company_id:
                # ì ‘ê·¼ ê¶Œí•œ í™•ì¸
                user_id = session.get('user_id')
                if not has_company_access(user_id, company_id):
                    abort(403, 'í•´ë‹¹ íšŒì‚¬ì— ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.')
                
                g.current_company_id = company_id
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator
```

### **2. íšŒì‚¬ë³„ ERPia ë°°ì¹˜ ê´€ë¦¬**
```python
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.cron import CronTrigger

class MultiTenantErpiaBatchManager:
    """ë©€í‹°í…Œë„ŒíŠ¸ ERPia ë°°ì¹˜ ê´€ë¦¬ì"""
    
    def __init__(self):
        self.scheduler = BackgroundScheduler(daemon=True)
        self.is_running = False
    
    def start_scheduler(self):
        """ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘"""
        if not self.is_running:
            self.scheduler.start()
            self.is_running = True
            self.setup_all_company_batches()
    
    def setup_all_company_batches(self):
        """ëª¨ë“  í™œì„± íšŒì‚¬ì˜ ë°°ì¹˜ ìŠ¤ì¼€ì¤„ ì„¤ì •"""
        from app.models.company import Company
        
        # í™œì„±í™”ëœ ëª¨ë“  íšŒì‚¬ ì¡°íšŒ
        companies = Company.query.filter_by(is_active=True).all()
        
        for company in companies:
            self.setup_company_batch(company.id)
    
    def setup_company_batch(self, company_id: int):
        """íŠ¹ì • íšŒì‚¬ì˜ ë°°ì¹˜ ìŠ¤ì¼€ì¤„ ì„¤ì •"""
        from app.models.company_erpia_config import CompanyErpiaConfig
        
        # íšŒì‚¬ë³„ ERPia ì„¤ì • ì¡°íšŒ
        config = CompanyErpiaConfig.query.filter_by(
            company_id=company_id,
            is_active=True
        ).first()
        
        if not config or not config.batch_enabled:
            return
        
        # ê¸°ì¡´ ìŠ¤ì¼€ì¤„ ì œê±°
        job_id = f'erpia_batch_{company_id}'
        if self.scheduler.get_job(job_id):
            self.scheduler.remove_job(job_id)
        
        # ìƒˆ ìŠ¤ì¼€ì¤„ ë“±ë¡
        self.scheduler.add_job(
            func=self.run_company_batch,
            trigger=CronTrigger(
                hour=config.batch_hour,
                minute=config.batch_minute,
                timezone=config.batch_timezone
            ),
            args=[company_id],
            id=job_id,
            name=f'ERPia ë°°ì¹˜ - {self.get_company_name(company_id)}',
            misfire_grace_time=300  # 5ë¶„ ì§€ì—° í—ˆìš©
        )
        
        self.log_batch_schedule(company_id, config)
    
    def run_company_batch(self, company_id: int):
        """íšŒì‚¬ë³„ ERPia ë°°ì¹˜ ì‹¤í–‰"""
        try:
            from app.services.erpia_batch_service import ErpiaBatchService
            
            # íšŒì‚¬ë³„ ë°°ì¹˜ ì„œë¹„ìŠ¤ ìƒì„±
            batch_service = ErpiaBatchService(company_id)
            
            # ì–´ì œ ë°ì´í„° ìˆ˜ì§‘
            yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y%m%d')
            
            # ë°°ì¹˜ ì‹¤í–‰ (ì‚¬ì€í’ˆ ìë™ ë¶„ë¥˜ í¬í•¨)
            result = batch_service.collect_daily_sales_with_gift_classification(
                start_date=yesterday,
                end_date=yesterday
            )
            
            self.log_batch_success(company_id, result)
            
        except Exception as e:
            self.log_batch_error(company_id, str(e))
            self.send_error_notification(company_id, str(e))
    
    def update_company_schedule(self, company_id: int):
        """íšŒì‚¬ ìŠ¤ì¼€ì¤„ ì—…ë°ì´íŠ¸ (ì›¹ì—ì„œ ì„¤ì • ë³€ê²½ ì‹œ í˜¸ì¶œ)"""
        self.setup_company_batch(company_id)
    
    def get_batch_status(self, company_id: int) -> dict:
        """íšŒì‚¬ë³„ ë°°ì¹˜ ìƒíƒœ ì¡°íšŒ"""
        job_id = f'erpia_batch_{company_id}'
        job = self.scheduler.get_job(job_id)
        
        if job:
            return {
                'scheduled': True,
                'next_run': job.next_run_time.isoformat() if job.next_run_time else None,
                'job_name': job.name,
                'trigger': str(job.trigger)
            }
        else:
            return {
                'scheduled': False,
                'next_run': None
            }
```

### **3. íšŒì‚¬ë³„ ì‚¬ì€í’ˆ ë¶„ë¥˜ ì—”ì§„**
```python
class MultiTenantGiftClassifier:
    """ë©€í‹°í…Œë„ŒíŠ¸ ì‚¬ì€í’ˆ ë¶„ë¥˜ ì—”ì§„"""
    
    def __init__(self, company_id: int):
        self.company_id = company_id
        self.config = self.load_company_gift_config()
    
    def load_company_gift_config(self):
        """íšŒì‚¬ë³„ ì‚¬ì€í’ˆ ì„¤ì • ë¡œë“œ"""
        from app.models.company_erpia_config import CompanyErpiaConfig
        
        config = CompanyErpiaConfig.query.filter_by(
            company_id=self.company_id
        ).first()
        
        return {
            'auto_classify': config.auto_gift_classify if config else True,
            'keywords': json.loads(config.gift_keywords) if config and config.gift_keywords else [],
            'exclude_from_revenue': config.gift_exclude_from_revenue if config else True
        }
    
    def classify_products(self, products: List[Dict]) -> List[Dict]:
        """íšŒì‚¬ë³„ ì‚¬ì€í’ˆ ë¶„ë¥˜ ê·œì¹™ ì ìš©"""
        
        classified_products = []
        
        for product in products:
            # ê¸°ë³¸ ë¶„ë¥˜ ì ìš©
            classification = self.apply_company_specific_rules(product)
            
            # íšŒì‚¬ ID ì¶”ê°€
            classification['company_id'] = self.company_id
            
            # ê²°ê³¼ ë³‘í•©
            product.update(classification)
            classified_products.append(product)
        
        return classified_products
    
    def apply_company_specific_rules(self, product: Dict) -> Dict:
        """íšŒì‚¬ë³„ ì‚¬ì€í’ˆ ë¶„ë¥˜ ê·œì¹™"""
        
        gong_amt = int(product.get('gong_amt', 0))
        pan_amt = int(product.get('pan_amt', 0))
        product_name = product.get('product_name', '')
        
        # 1. 0ì› ìƒí’ˆ â†’ ì‚¬ì€í’ˆ (ëª¨ë“  íšŒì‚¬ ê³µí†µ)
        if gong_amt == 0 and pan_amt == 0:
            return {
                'product_type': 'GIFT',
                'is_revenue': not self.config['exclude_from_revenue'],
                'gift_type': 'ZERO_PRICE',
                'classification_reason': 'ê³µê¸‰ê°€ 0ì› (ìë™ë¶„ë¥˜)',
                'revenue_impact': 0
            }
        
        # 2. íšŒì‚¬ë³„ í‚¤ì›Œë“œ ê¸°ë°˜ ë¶„ë¥˜
        if self.config['auto_classify']:
            for keyword in self.config['keywords']:
                if keyword in product_name:
                    return {
                        'product_type': 'GIFT',
                        'is_revenue': not self.config['exclude_from_revenue'],
                        'gift_type': 'KEYWORD_BASED',
                        'classification_reason': f'í‚¤ì›Œë“œ ë§¤ì¹­: {keyword}',
                        'revenue_impact': 0
                    }
        
        # 3. ì¼ë°˜ ìƒí’ˆ
        return {
            'product_type': 'PRODUCT',
            'is_revenue': True,
            'gift_type': None,
            'classification_reason': 'ì¼ë°˜ ë§¤ì¶œ ìƒí’ˆ',
            'revenue_impact': gong_amt
        }
```

### **4. ë©€í‹°í…Œë„ŒíŠ¸ ë°ì´í„° ì ‘ê·¼ ë ˆì´ì–´**
```python
class MultiTenantQueryBuilder:
    """ë©€í‹°í…Œë„ŒíŠ¸ ì¿¼ë¦¬ ë¹Œë”"""
    
    @staticmethod
    def apply_company_filter(query, model, company_id=None):
        """íšŒì‚¬ í•„í„° ìë™ ì ìš©"""
        
        if company_id is None:
            company_id = g.current_company_id
        
        if company_id and hasattr(model, 'company_id'):
            query = query.filter(model.company_id == company_id)
        
        return query
    
    @staticmethod
    def get_accessible_companies(user_id: int) -> List[int]:
        """ì‚¬ìš©ìê°€ ì ‘ê·¼ ê°€ëŠ¥í•œ íšŒì‚¬ ëª©ë¡"""
        from app.models.user_company import UserCompany
        
        companies = UserCompany.query.filter_by(
            user_id=user_id,
            is_active=True
        ).all()
        
        return [uc.company_id for uc in companies]
    
    @staticmethod
    def can_access_shared_data(source_company_id: int, target_company_id: int, 
                             data_type: str) -> bool:
        """ê³µìœ  ë°ì´í„° ì ‘ê·¼ ê¶Œí•œ í™•ì¸"""
        from app.models.shared_data_policy import SharedDataPolicy
        
        policy = SharedDataPolicy.query.filter_by(
            source_company_id=source_company_id,
            target_company_id=target_company_id,
            data_type=data_type,
            is_active=True
        ).first()
        
        return policy is not None

# ëª¨ë¸ ë¯¹ìŠ¤ì¸
class CompanyMixin:
    """íšŒì‚¬ ì •ë³´ ë¯¹ìŠ¤ì¸"""
    
    @declared_attr
    def company_id(cls):
        return Column(Integer, ForeignKey('companies.id'), nullable=False)
    
    @declared_attr  
    def company(cls):
        return relationship("Company")
    
    @classmethod
    def by_company(cls, company_id=None):
        """íšŒì‚¬ë³„ ì¿¼ë¦¬"""
        if company_id is None:
            company_id = g.current_company_id
        
        return cls.query.filter_by(company_id=company_id)
    
    @classmethod
    def accessible_by_user(cls, user_id: int):
        """ì‚¬ìš©ìê°€ ì ‘ê·¼ ê°€ëŠ¥í•œ ë°ì´í„°"""
        accessible_companies = MultiTenantQueryBuilder.get_accessible_companies(user_id)
        return cls.query.filter(cls.company_id.in_(accessible_companies))
```

## ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

### **1. íšŒì‚¬ ì „í™˜ UI**
```html
<!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <!-- ë¡œê³  ë° íšŒì‚¬ëª… -->
        <a class="navbar-brand d-flex align-items-center" href="#">
            <img src="{{ current_company.logo_url }}" alt="Logo" height="30" class="me-2">
            {{ current_company.company_name }} MIS
        </a>
        
        <!-- íšŒì‚¬ ì „í™˜ ë“œë¡­ë‹¤ìš´ -->
        <div class="navbar-nav ms-auto">
            <div class="nav-item dropdown">
                <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" 
                   id="companyDropdown" role="button" data-bs-toggle="dropdown">
                    <i class="bi bi-building me-1"></i>
                    <span class="me-1">{{ current_company.company_name }}</span>
                    {% if user_companies|length > 1 %}
                        <span class="badge bg-light text-dark ms-1">{{ user_companies|length }}</span>
                    {% endif %}
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    {% for uc in user_companies %}
                        <li>
                            <a class="dropdown-item d-flex align-items-center 
                               {% if uc.company_id == current_company.id %}active{% endif %}"
                               href="#" onclick="switchCompany({{ uc.company_id }})">
                                <i class="bi bi-building me-2"></i>
                                <div>
                                    <div>{{ uc.company.company_name }}</div>
                                    <small class="text-muted">{{ uc.role|title }}</small>
                                </div>
                                {% if uc.company_id == current_company.id %}
                                    <i class="bi bi-check2 ms-auto text-success"></i>
                                {% endif %}
                            </a>
                        </li>
                    {% endfor %}
                    
                    {% if current_user.is_super_admin %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="/admin/companies">
                                <i class="bi bi-gear me-2"></i>
                                íšŒì‚¬ ê´€ë¦¬
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</nav>

<!-- íšŒì‚¬ë³„ í…Œë§ˆ ì ìš© -->
<style>
:root {
    --company-primary-color: {{ current_company.theme_color }};
    --company-primary-rgb: {{ current_company.theme_color|hex_to_rgb }};
}

.btn-primary, .bg-primary {
    background-color: var(--company-primary-color) !important;
    border-color: var(--company-primary-color) !important;
}

.text-primary {
    color: var(--company-primary-color) !important;
}
</style>

<!-- íšŒì‚¬ ì „í™˜ JavaScript -->
<script>
async function switchCompany(companyId) {
    try {
        const response = await fetch('/api/user/switch-company', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                company_id: companyId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ íšŒì‚¬ ì»¨í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            window.location.reload();
        } else {
            showAlert('íšŒì‚¬ ì „í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message, 'error');
        }
    } catch (error) {
        showAlert('íšŒì‚¬ ì „í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// íšŒì‚¬ ë³€ê²½ ì‹œ ìë™ ì €ì¥ëœ í•„í„° ì ìš©
document.addEventListener('DOMContentLoaded', function() {
    // íšŒì‚¬ë³„ ì‚¬ìš©ì ì„¤ì • ë¡œë“œ
    loadCompanySpecificSettings();
    
    // íšŒì‚¬ë³„ ì‚¬ì€í’ˆ ì„¤ì • ìƒíƒœ í‘œì‹œ
    updateGiftSettingsDisplay();
});
</script>
```

### **2. íšŒì‚¬ë³„ ERPia ì„¤ì • í™”ë©´**
```html
<!-- íšŒì‚¬ë³„ ERPia ì„¤ì • ê´€ë¦¬ -->
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-cloud-arrow-down"></i>
                        {{ current_company.company_name }} ERPia ì—°ë™ ì„¤ì •
                    </h5>
                </div>
                <div class="card-body">
                    <form id="erpiaConfigForm">
                        <!-- ERPia ê³„ì • ì •ë³´ -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-primary">ERPia ê³„ì • ì •ë³´</h6>
                                <div class="mb-3">
                                    <label class="form-label">ê´€ë¦¬ì ì½”ë“œ</label>
                                    <input type="text" class="form-control" name="admin_code" 
                                           value="{{ config.admin_code if config else '' }}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                                    <input type="password" class="form-control" name="password" 
                                           placeholder="{% if config %}ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ìœ ì§€{% else %}ë¹„ë°€ë²ˆí˜¸ ì…ë ¥{% endif %}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">API URL</label>
                                    <input type="url" class="form-control" name="api_url" 
                                           value="{{ config.api_url if config else 'http://www.erpia.net/xml/xml.asp' }}">
                                </div>
                            </div>
                            
                            <!-- ë°°ì¹˜ ìŠ¤ì¼€ì¤„ ì„¤ì • -->
                            <div class="col-md-6">
                                <h6 class="text-primary">ë°°ì¹˜ ìŠ¤ì¼€ì¤„ ì„¤ì •</h6>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="batch_enabled" 
                                               {% if config and config.batch_enabled %}checked{% endif %}>
                                        <label class="form-check-label">ìë™ ë°°ì¹˜ ì‹¤í–‰</label>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">ì‹¤í–‰ ì‹œê°„</label>
                                        <input type="time" class="form-control" name="batch_time" 
                                               value="{% if config %}{{ '%02d:%02d'|format(config.batch_hour, config.batch_minute) }}{% else %}02:00{% endif %}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ì‹œê°„ëŒ€</label>
                                        <select class="form-select" name="batch_timezone">
                                            <option value="Asia/Seoul" {% if config and config.batch_timezone == 'Asia/Seoul' %}selected{% endif %}>
                                                í•œêµ­ ì‹œê°„ (KST)
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- API í˜¸ì¶œ ì„¤ì • -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label class="form-label">í˜¸ì¶œ ê°„ê²© (ì´ˆ)</label>
                                <input type="number" class="form-control" name="api_call_interval" 
                                       value="{{ config.api_call_interval if config else 3 }}" min="1" max="60">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">í˜ì´ì§€ í¬ê¸°</label>
                                <input type="number" class="form-control" name="page_size" 
                                       value="{{ config.page_size if config else 30 }}" min="1" max="30">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ì¬ì‹œë„ íšŸìˆ˜</label>
                                <input type="number" class="form-control" name="retry_count" 
                                       value="{{ config.retry_count if config else 3 }}" min="1" max="10">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">íƒ€ì„ì•„ì›ƒ (ì´ˆ)</label>
                                <input type="number" class="form-control" name="timeout_seconds" 
                                       value="{{ config.timeout_seconds if config else 30 }}" min="10" max="300">
                            </div>
                        </div>
                        
                        <!-- ì‚¬ì€í’ˆ ì²˜ë¦¬ ì„¤ì • -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">ì‚¬ì€í’ˆ ì²˜ë¦¬ ì„¤ì •</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" name="auto_gift_classify" 
                                                   {% if config and config.auto_gift_classify %}checked{% endif %}>
                                            <label class="form-check-label">0ì› ìƒí’ˆ ìë™ ì‚¬ì€í’ˆ ë¶„ë¥˜</label>
                                        </div>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" name="gift_exclude_from_revenue" 
                                                   {% if config and config.gift_exclude_from_revenue %}checked{% endif %}>
                                            <label class="form-check-label">ì‚¬ì€í’ˆ ë§¤ì¶œ ì§‘ê³„ ì œì™¸</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ì‚¬ì€í’ˆ ë¶„ë¥˜ í‚¤ì›Œë“œ</label>
                                        <input type="text" class="form-control" name="gift_keywords" 
                                               value="{% if config and config.gift_keywords %}{{ config.gift_keywords|join(',') }}{% else %}ì‚¬ì€í’ˆ,ì¦ì •í’ˆ,ë¬´ë£Œ,ìƒ˜í”Œ,ì²´í—˜{% endif %}"
                                               placeholder="ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥">
                                        <div class="form-text">ìƒí’ˆëª…ì— í¬í•¨ëœ ê²½ìš° ì‚¬ì€í’ˆìœ¼ë¡œ ë¶„ë¥˜í•  í‚¤ì›Œë“œë“¤ì…ë‹ˆë‹¤.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ì•Œë¦¼ ì„¤ì • -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-primary">ì•Œë¦¼ ì„¤ì •</h6>
                                <div class="mb-3">
                                    <label class="form-label">ì•Œë¦¼ ì´ë©”ì¼</label>
                                    <input type="email" class="form-control" name="notification_email" 
                                           value="{{ config.notification_email if config else '' }}"
                                           placeholder="ë°°ì¹˜ ì™„ë£Œ/ì˜¤ë¥˜ ì•Œë¦¼ì„ ë°›ì„ ì´ë©”ì¼">
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="error_notification" 
                                           {% if config and config.error_notification %}checked{% endif %}>
                                    <label class="form-check-label">ì˜¤ë¥˜ ë°œìƒ ì‹œ ì´ë©”ì¼ ì•Œë¦¼</label>
                                </div>
                            </div>
                            
                            <!-- ì—°ë™ ìƒíƒœ -->
                            <div class="col-md-6">
                                <h6 class="text-primary">ì—°ë™ ìƒíƒœ</h6>
                                {% if config %}
                                    <div class="mb-2">
                                        <span class="badge {% if config.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if config.is_active %}í™œì„±{% else %}ë¹„í™œì„±{% endif %}
                                        </span>
                                    </div>
                                    {% if config.last_sync_date %}
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                ë§ˆì§€ë§‰ ë™ê¸°í™”: {{ config.last_sync_date.strftime('%Y-%m-%d %H:%M') }}
                                            </small>
                                        </div>
                                    {% endif %}
                                    {% if config.sync_error_count > 0 %}
                                        <div class="alert alert-warning alert-sm">
                                            <small>
                                                ì—°ì† ì˜¤ë¥˜ {{ config.sync_error_count }}íšŒ
                                                {% if config.last_error_message %}
                                                    <br>{{ config.last_error_message }}
                                                {% endif %}
                                            </small>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="alert alert-info">
                                        <small>ERPia ì—°ë™ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- ë²„íŠ¼ -->
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-info me-2" onclick="testErpiaConnection()">
                                <i class="bi bi-wifi"></i> ì—°ê²° í…ŒìŠ¤íŠ¸
                            </button>
                            <button type="button" class="btn btn-warning me-2" onclick="runManualBatch()">
                                <i class="bi bi-play-fill"></i> ìˆ˜ë™ ë°°ì¹˜ ì‹¤í–‰
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> ì„¤ì • ì €ì¥
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ë°°ì¹˜ ì‹¤í–‰ ì´ë ¥ -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-clock-history"></i>
                        ë°°ì¹˜ ì‹¤í–‰ ì´ë ¥
                    </h5>
                </div>
                <div class="card-body">
                    <div id="batchHistoryTable">
                        <!-- ë°°ì¹˜ ì´ë ¥ í…Œì´ë¸”ì´ ë¡œë“œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ERPia ì„¤ì • í¼ ì²˜ë¦¬
document.getElementById('erpiaConfigForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const configData = {};
    
    // í¼ ë°ì´í„° ë³€í™˜
    for (let [key, value] of formData.entries()) {
        if (this.querySelector(`[name="${key}"]`).type === 'checkbox') {
            configData[key] = this.querySelector(`[name="${key}"]`).checked;
        } else if (key === 'gift_keywords') {
            configData[key] = value.split(',').map(k => k.trim()).filter(k => k);
        } else if (key === 'batch_time') {
            const [hour, minute] = value.split(':');
            configData['batch_hour'] = parseInt(hour);
            configData['batch_minute'] = parseInt(minute);
        } else {
            configData[key] = value;
        }
    }
    
    try {
        const response = await fetch(`/api/companies/${currentCompanyId}/erpia-config`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(configData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('ERPia ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            
            // ìŠ¤ì¼€ì¤„ ì—…ë°ì´íŠ¸
            if (configData.batch_enabled) {
                updateBatchSchedule();
            }
            
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message, 'error');
        }
    } catch (error) {
        showAlert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
});

async function testErpiaConnection() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> í…ŒìŠ¤íŠ¸ ì¤‘...';
    
    try {
        const response = await fetch(`/api/companies/${currentCompanyId}/erpia-test`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(`ì—°ê²° ì„±ê³µ! ${result.data_count}ê±´ì˜ ë°ì´í„°ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.`, 'success');
        } else {
            showAlert(`ì—°ê²° ì‹¤íŒ¨: ${result.message}`, 'error');
        }
    } catch (error) {
        showAlert('ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

async function runManualBatch() {
    const startDate = prompt('ì‹œì‘ì¼ì„ ì…ë ¥í•˜ì„¸ìš” (YYYYMMDD):', 
        new Date().toISOString().slice(0, 10).replace(/-/g, ''));
    
    if (!startDate) return;
    
    const endDate = prompt('ì¢…ë£Œì¼ì„ ì…ë ¥í•˜ì„¸ìš” (YYYYMMDD):', startDate);
    if (!endDate) return;
    
    try {
        const response = await fetch(`/api/companies/${currentCompanyId}/erpia-manual-batch`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                start_date: startDate,
                end_date: endDate
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('ë°°ì¹˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            loadBatchHistory();
        } else {
            showAlert(`ë°°ì¹˜ ì‹¤í–‰ ì‹¤íŒ¨: ${result.message}`, 'error');
        }
    } catch (error) {
        showAlert('ë°°ì¹˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}
</script>
```

## ğŸ”’ ë³´ì•ˆ ë° ê¶Œí•œ ê´€ë¦¬

### **1. íšŒì‚¬ë³„ ë°ì´í„° ê²©ë¦¬**
```python
# ìë™ íšŒì‚¬ í•„í„°ë§
@event.listens_for(Session, 'before_bulk_insert')
def auto_add_company_id(insert_context):
    """ëŒ€ëŸ‰ ì‚½ì… ì‹œ ìë™ìœ¼ë¡œ company_id ì¶”ê°€"""
    if hasattr(insert_context.mapper.class_, 'company_id'):
        if 'company_id' not in insert_context.values and g.current_company_id:
            insert_context.values['company_id'] = g.current_company_id

@event.listens_for(Query, 'before_cursor_execute')
def auto_filter_by_company(conn, cursor, statement, parameters, context, executemany):
    """ì¿¼ë¦¬ ì‹¤í–‰ ì‹œ ìë™ìœ¼ë¡œ íšŒì‚¬ í•„í„° ì ìš©"""
    # ì´ ê¸°ëŠ¥ì€ ì‹ ì¤‘í•˜ê²Œ êµ¬í˜„í•´ì•¼ í•¨ (ì„±ëŠ¥ ì˜í–¥)
    pass
```

### **2. ì ‘ê·¼ ë¡œê·¸ ê´€ë¦¬**
```sql
-- ë©€í‹°í…Œë„ŒíŠ¸ ì ‘ê·¼ ë¡œê·¸
CREATE TABLE user_access_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    company_id INTEGER REFERENCES companies(id),
    
    -- ì ‘ê·¼ ì •ë³´
    action_type VARCHAR(50) NOT NULL,            -- 'LOGIN', 'SWITCH_COMPANY', 'ACCESS_DATA'
    resource_type VARCHAR(50),                   -- 'SALES', 'CUSTOMER', 'PRODUCT'
    resource_id VARCHAR(100),                    -- ì ‘ê·¼í•œ ë°ì´í„° ID
    
    -- ìš”ì²­ ì •ë³´
    ip_address INET,
    user_agent TEXT,
    request_url TEXT,
    request_method VARCHAR(10),
    
    -- ê²°ê³¼ ì •ë³´
    success BOOLEAN DEFAULT TRUE,
    error_message TEXT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_access_logs_user_company ON user_access_logs(user_id, company_id);
CREATE INDEX idx_access_logs_action ON user_access_logs(action_type);
CREATE INDEX idx_access_logs_created ON user_access_logs(created_at);
```

## ğŸ“Š êµ¬í˜„ ë¡œë“œë§µ

### **Phase 1: ë©€í‹°í…Œë„ŒíŠ¸ ê¸°ë°˜ êµ¬ì¶•** (1ì£¼)
1. **ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ í™•ì¥**
   - íšŒì‚¬ ê´€ë¦¬ í…Œì´ë¸” ìƒì„±
   - ê¸°ì¡´ í…Œì´ë¸”ì— `company_id` ì¶”ê°€
   - ì‚¬ìš©ì-íšŒì‚¬ ê´€ê³„ í…Œì´ë¸” êµ¬ì„±

2. **ë©€í‹°í…Œë„ŒíŠ¸ ë¯¸ë“¤ì›¨ì–´**
   - íšŒì‚¬ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬
   - ìë™ ë°ì´í„° í•„í„°ë§
   - ê¶Œí•œ ê²€ì‚¬ ì‹œìŠ¤í…œ

### **Phase 2: íšŒì‚¬ë³„ ERPia ê´€ë¦¬** (1ì£¼)
1. **íšŒì‚¬ë³„ ERPia ì„¤ì •**
   - ì›¹ ê¸°ë°˜ ì„¤ì • ê´€ë¦¬
   - ì•”í˜¸í™”ëœ ì¸ì¦ ì •ë³´ ì €ì¥
   - ë°°ì¹˜ ìŠ¤ì¼€ì¤„ ê°œë³„ ê´€ë¦¬

2. **ë©€í‹°í…Œë„ŒíŠ¸ ë°°ì¹˜ ì‹œìŠ¤í…œ**
   - íšŒì‚¬ë³„ ë…ë¦½ ìŠ¤ì¼€ì¤„ ì‹¤í–‰
   - ì‚¬ì€í’ˆ ìë™ ë¶„ë¥˜ í†µí•©
   - ë°°ì¹˜ ìƒíƒœ ëª¨ë‹ˆí„°ë§

### **Phase 3: ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤** (3ì¼)
1. **íšŒì‚¬ ì „í™˜ UI**
   - íšŒì‚¬ ì„ íƒ ë“œë¡­ë‹¤ìš´
   - ê²¸ì§ì ê¶Œí•œ í‘œì‹œ
   - íšŒì‚¬ë³„ í…Œë§ˆ ì ìš©

2. **ê¶Œí•œ ê´€ë¦¬ í™”ë©´**
   - ì‚¬ìš©ì-íšŒì‚¬ ê´€ê³„ ê´€ë¦¬
   - ì—­í•  ë° ê¶Œí•œ ì„¤ì •
   - ì ‘ê·¼ ë¡œê·¸ ëª¨ë‹ˆí„°ë§

### **Phase 4: ë°ì´í„° ê³µìœ  ì‹œìŠ¤í…œ** (2ì¼)
1. **ê³µìœ  ì •ì±… ê´€ë¦¬**
   - íšŒì‚¬ ê°„ ë°ì´í„° ê³µìœ  ì„¤ì •
   - ìŠ¹ì¸ ì›Œí¬í”Œë¡œìš°
   - ê³µìœ  ì´ë ¥ ì¶”ì 

2. **ê³µìœ  ë°ì´í„° ì ‘ê·¼**
   - ì¡°ê±´ë¶€ ë°ì´í„° ê³µìœ 
   - ì½ê¸° ì „ìš©/ì½ê¸°-ì“°ê¸° ê¶Œí•œ
   - ì‹¤ì‹œê°„ ë™ê¸°í™”

## ğŸ¯ ì˜ˆìƒ íš¨ê³¼

### **í™•ì¥ì„±**
- âœ… **ë¬´ì œí•œ íšŒì‚¬ ì¶”ê°€**: ìƒˆë¡œìš´ íšŒì‚¬ ì‰½ê²Œ ì¶”ê°€ ê°€ëŠ¥
- âœ… **ë…ë¦½ì  ìš´ì˜**: íšŒì‚¬ë³„ ì„¤ì •/ë°ì´í„° ì™„ì „ ë¶„ë¦¬
- âœ… **ê³µìœ  íš¨ìœ¨ì„±**: í•„ìš”í•œ ë°ì´í„°ë§Œ ì„ íƒì  ê³µìœ 

### **ìš´ì˜ì„±**
- âœ… **ì›¹ ê¸°ë°˜ ê´€ë¦¬**: ì½”ë“œ ìˆ˜ì • ì—†ì´ ì„¤ì • ë³€ê²½
- âœ… **ê°œë³„ ë°°ì¹˜**: íšŒì‚¬ë³„ ERPia ë°°ì¹˜ ë…ë¦½ ì‹¤í–‰
- âœ… **ì‚¬ì€í’ˆ ì •ì±…**: íšŒì‚¬ë³„ ì‚¬ì€í’ˆ ë¶„ë¥˜ ê·œì¹™ ì ìš©

### **ë³´ì•ˆì„±**
- âœ… **ë°ì´í„° ê²©ë¦¬**: íšŒì‚¬ ê°„ ë°ì´í„° ì™„ì „ ë¶„ë¦¬
- âœ… **ì ‘ê·¼ ì œì–´**: ì„¸ë¶„í™”ëœ ê¶Œí•œ ê´€ë¦¬
- âœ… **ê°ì‚¬ ì¶”ì **: ëª¨ë“  ì ‘ê·¼ ë¡œê·¸ ê¸°ë¡

---

ğŸ“… **ì„¤ê³„ì¼**: 2025-08-05  
ğŸ“ **ë²„ì „**: v2.0 (ì›¹ ì„¤ì • + ì‚¬ì€í’ˆ ë¶„ë¥˜ í†µí•©)  
ğŸ¯ **ëª©í‘œ**: ì—ì´ì› + ì—ì´ì› ì›”ë“œ í†µí•© ìš´ì˜, ì›¹ ê¸°ë°˜ ê´€ë¦¬, íšŒì‚¬ë³„ ì‚¬ì€í’ˆ ì •ì±… 