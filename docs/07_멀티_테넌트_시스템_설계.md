# 🏢 멀티 테넌트 시스템 설계

## 📋 설계 개요

에이원과 에이원 월드가 **단일 시스템**을 사용할 수 있도록 **멀티 테넌트 아키텍처**를 설계합니다. **회사별 독립성**을 보장하면서도 **데이터 공유**와 **겸직자 지원**이 가능한 유연한 구조를 구현하고, **웹 기반 배치 설정**과 **사은품 자동 분류**를 회사별로 관리할 수 있도록 합니다.

## 🎯 멀티 테넌트 요구사항

### **1. 회사 구분 및 관리**
- ✅ **독립된 회사**: 에이원 ↔ 에이원 월드
- ✅ **단일 DB**: `company_id`로 데이터 구분
- ✅ **데이터 공유**: 공통 상품/거래처 활용 가능
- ✅ **회사별 설정**: ERPia 계정, 배치 시간, 사은품 정책 등

### **2. 사용자 권한 및 접근**
- ✅ **회사별 데이터 격리**: 기본적으로 자신의 회사 데이터만
- ✅ **슈퍼 관리자**: 모든 회사 데이터 관리 가능
- ✅ **겸직자 지원**: 여러 회사 소속 + 로그인 후 회사 전환

### **3. ERPia 연동**
- ✅ **회사별 ERPia 계정**: 별도 admin_code, password
- ✅ **웹 기반 설정**: 관리자가 웹에서 ERPia 정보 입력
- ✅ **배치 독립 실행**: 회사별 배치 시간/설정 관리

### **4. 시스템 구조**
- ✅ **URL 구조**: 로그인 후 회사 선택
- ✅ **세션 관리**: 현재 활성 회사 추적
- ✅ **사은품 정책**: 회사별 사은품 분류 규칙

## 🏗️ 데이터베이스 설계

### **1. 회사 관리 테이블**
```sql
-- 회사 마스터
CREATE TABLE companies (
    id SERIAL PRIMARY KEY,
    company_code VARCHAR(20) UNIQUE NOT NULL,      -- 'AONE', 'AONE_WORLD'
    company_name VARCHAR(100) NOT NULL,            -- '에이원', '에이원 월드'
    company_name_en VARCHAR(100),                  -- 'AONE', 'AONE WORLD'
    
    -- 회사 기본 정보
    business_number VARCHAR(20),                   -- 사업자등록번호
    ceo_name VARCHAR(50),                         -- 대표자명
    address TEXT,                                 -- 회사 주소
    phone VARCHAR(20),                            -- 대표 전화
    email VARCHAR(100),                           -- 대표 이메일
    
    -- 시스템 설정
    is_active BOOLEAN DEFAULT TRUE,               -- 활성 상태
    logo_url VARCHAR(500),                        -- 회사 로고
    theme_color VARCHAR(10) DEFAULT '#007bff',    -- 테마 색상
    
    -- 멀티테넌트 설정
    data_isolation_level VARCHAR(20) DEFAULT 'STRICT',  -- STRICT, SHARED
    allow_data_sharing BOOLEAN DEFAULT TRUE,             -- 데이터 공유 허용
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 기본 회사 데이터
INSERT INTO companies (company_code, company_name, company_name_en) VALUES 
('AONE', '에이원', 'AONE'),
('AONE_WORLD', '에이원 월드', 'AONE WORLD');
```

### **2. 사용자-회사 관계 테이블**
```sql
-- 사용자-회사 관계 (겸직자 지원)
CREATE TABLE user_companies (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    company_id INTEGER REFERENCES companies(id) ON DELETE CASCADE,
    
    -- 권한 설정
    role VARCHAR(50) NOT NULL,                    -- 'admin', 'manager', 'user'
    permissions JSON,                             -- 세부 권한 설정
    
    -- 상태 정보
    is_primary BOOLEAN DEFAULT FALSE,             -- 주 소속 회사 여부
    is_active BOOLEAN DEFAULT TRUE,               -- 해당 회사에서 활성 상태
    
    -- 접근 제한
    access_start_date DATE,                       -- 접근 시작일
    access_end_date DATE,                         -- 접근 종료일
    last_access_at TIMESTAMP,                     -- 마지막 접근 시간
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(user_id, company_id)
);

-- 인덱스
CREATE INDEX idx_user_companies_user_id ON user_companies(user_id);
CREATE INDEX idx_user_companies_company_id ON user_companies(company_id);
CREATE INDEX idx_user_companies_active ON user_companies(is_active);
```

### **3. 회사별 ERPia 설정**
```sql
-- 회사별 ERPia 연동 설정
CREATE TABLE company_erpia_configs (
    id SERIAL PRIMARY KEY,
    company_id INTEGER REFERENCES companies(id) ON DELETE CASCADE,
    
    -- ERPia 인증 정보 (암호화 저장)
    admin_code VARCHAR(100) NOT NULL,
    password_encrypted TEXT NOT NULL,             -- 암호화된 패스워드
    api_url VARCHAR(500) DEFAULT 'http://www.erpia.net/xml/xml.asp',
    
    -- 배치 스케줄 설정 (웹에서 관리)
    batch_enabled BOOLEAN DEFAULT TRUE,
    batch_hour INTEGER DEFAULT 2,                -- 02시
    batch_minute INTEGER DEFAULT 0,              -- 00분
    batch_timezone VARCHAR(50) DEFAULT 'Asia/Seoul',
    
    -- API 호출 설정 (웹에서 관리)
    api_call_interval INTEGER DEFAULT 3,         -- 호출 간격(초)
    page_size INTEGER DEFAULT 30,                -- 페이지당 건수
    retry_count INTEGER DEFAULT 3,               -- 재시도 횟수
    timeout_seconds INTEGER DEFAULT 30,          -- 타임아웃
    
    -- 사은품 처리 설정 (웹에서 관리)
    auto_gift_classify BOOLEAN DEFAULT TRUE,     -- 자동 사은품 분류
    gift_keywords TEXT,                          -- JSON 배열: ["사은품", "증정품", ...]
    gift_exclude_from_revenue BOOLEAN DEFAULT TRUE,  -- 사은품 매출 집계 제외
    
    -- 알림 설정
    notification_email VARCHAR(200),             -- 배치 완료 알림
    error_notification BOOLEAN DEFAULT TRUE,     -- 오류 알림
    
    -- 연동 상태
    is_active BOOLEAN DEFAULT TRUE,
    last_sync_date TIMESTAMP,                    -- 마지막 동기화 시간
    sync_error_count INTEGER DEFAULT 0,          -- 연속 오류 횟수
    last_error_message TEXT,                     -- 마지막 오류 메시지
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(company_id)
);

-- 기본 ERPia 설정 (에이원)
INSERT INTO company_erpia_configs (
    company_id, admin_code, password_encrypted, 
    batch_hour, batch_minute, auto_gift_classify
) VALUES (
    1, 'aone', encrypt_password('ka22fslfod1vid'), 
    2, 0, TRUE
);
```

### **4. 멀티테넌트 확장 (기존 테이블)**
```sql
-- 모든 비즈니스 테이블에 company_id 추가

-- 매출분석 마스터 (확장)
ALTER TABLE sales_analysis_master 
ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;

-- 사은품 분석 테이블 (확장)
ALTER TABLE gift_analysis 
ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;

-- 거래처 관리
ALTER TABLE tbl_erpia_customer 
ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;

-- 상품 관리
ALTER TABLE tbl_product_codematch 
ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;

-- 사용자 관리
ALTER TABLE tbl_member 
ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;

-- 주요 테이블들 company_id 추가
ALTER TABLE tbl_trade_order_mst ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;
ALTER TABLE tbl_trade_order_slv ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;
ALTER TABLE tbl_sales_orderinfo ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;
ALTER TABLE tbl_erpia_order_mst ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;
ALTER TABLE tbl_erpia_order_product ADD COLUMN company_id INTEGER REFERENCES companies(id) DEFAULT 1;

-- 인덱스 추가
CREATE INDEX idx_sales_analysis_company ON sales_analysis_master(company_id);
CREATE INDEX idx_gift_analysis_company ON gift_analysis(company_id);
CREATE INDEX idx_customer_company ON tbl_erpia_customer(company_id);
CREATE INDEX idx_product_company ON tbl_product_codematch(company_id);
```

### **5. 데이터 공유 관리**
```sql
-- 공유 데이터 관리 테이블
CREATE TABLE shared_data_policies (
    id SERIAL PRIMARY KEY,
    source_company_id INTEGER REFERENCES companies(id),
    target_company_id INTEGER REFERENCES companies(id),
    
    -- 공유 설정
    data_type VARCHAR(50) NOT NULL,              -- 'customer', 'product', 'brand'
    sharing_type VARCHAR(20) NOT NULL,           -- 'READ_ONLY', 'READ_WRITE', 'SYNC'
    
    -- 공유 조건
    filter_conditions JSON,                      -- 공유 조건 (JSON)
    approval_required BOOLEAN DEFAULT FALSE,     -- 승인 필요 여부
    
    -- 상태 관리
    is_active BOOLEAN DEFAULT TRUE,
    created_by INTEGER REFERENCES users(id),
    approved_by INTEGER REFERENCES users(id),
    approved_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 데이터 공유 이력
CREATE TABLE shared_data_logs (
    id SERIAL PRIMARY KEY,
    policy_id INTEGER REFERENCES shared_data_policies(id),
    
    action_type VARCHAR(20) NOT NULL,            -- 'SHARE', 'UPDATE', 'REVOKE'
    data_id VARCHAR(100) NOT NULL,               -- 공유된 데이터 ID
    data_type VARCHAR(50) NOT NULL,              -- 데이터 타입
    
    source_company_id INTEGER REFERENCES companies(id),
    target_company_id INTEGER REFERENCES companies(id),
    action_user_id INTEGER REFERENCES users(id),
    
    action_details JSON,                         -- 액션 상세 정보
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 💻 백엔드 구현

### **1. 멀티테넌트 미들웨어**
```python
from flask import request, session, g, abort
from functools import wraps

class MultiTenantMiddleware:
    """멀티테넌트 미들웨어"""
    
    def __init__(self, app=None):
        self.app = app
        if app:
            self.init_app(app)
    
    def init_app(self, app):
        app.before_request(self.before_request)
    
    def before_request(self):
        """요청 전 회사 컨텍스트 설정"""
        
        # 현재 활성 회사 ID 가져오기
        current_company_id = session.get('current_company_id')
        
        if current_company_id:
            # 사용자가 해당 회사에 접근 권한이 있는지 확인
            user_id = session.get('user_id')
            if user_id and self.has_company_access(user_id, current_company_id):
                g.current_company_id = current_company_id
                g.current_company = self.get_company(current_company_id)
            else:
                g.current_company_id = None
                g.current_company = None
        else:
            g.current_company_id = None
            g.current_company = None
    
    def has_company_access(self, user_id: int, company_id: int) -> bool:
        """사용자의 회사 접근 권한 확인"""
        from app.models.user_company import UserCompany
        
        access = UserCompany.query.filter_by(
            user_id=user_id,
            company_id=company_id,
            is_active=True
        ).first()
        
        return access is not None
    
    def get_company(self, company_id: int):
        """회사 정보 조회"""
        from app.models.company import Company
        return Company.query.get(company_id)

# 데코레이터
def require_company_access(permission=None):
    """회사 접근 권한 필요 데코레이터"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not g.current_company_id:
                abort(403, '회사를 선택해주세요.')
            
            if permission:
                if not check_permission(g.current_company_id, permission):
                    abort(403, '권한이 없습니다.')
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator

def company_context(company_id_param='company_id'):
    """URL 파라미터로 회사 컨텍스트 설정"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            company_id = kwargs.get(company_id_param) or request.json.get(company_id_param)
            
            if company_id:
                # 접근 권한 확인
                user_id = session.get('user_id')
                if not has_company_access(user_id, company_id):
                    abort(403, '해당 회사에 접근 권한이 없습니다.')
                
                g.current_company_id = company_id
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator
```

### **2. 회사별 ERPia 배치 관리**
```python
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.cron import CronTrigger

class MultiTenantErpiaBatchManager:
    """멀티테넌트 ERPia 배치 관리자"""
    
    def __init__(self):
        self.scheduler = BackgroundScheduler(daemon=True)
        self.is_running = False
    
    def start_scheduler(self):
        """스케줄러 시작"""
        if not self.is_running:
            self.scheduler.start()
            self.is_running = True
            self.setup_all_company_batches()
    
    def setup_all_company_batches(self):
        """모든 활성 회사의 배치 스케줄 설정"""
        from app.models.company import Company
        
        # 활성화된 모든 회사 조회
        companies = Company.query.filter_by(is_active=True).all()
        
        for company in companies:
            self.setup_company_batch(company.id)
    
    def setup_company_batch(self, company_id: int):
        """특정 회사의 배치 스케줄 설정"""
        from app.models.company_erpia_config import CompanyErpiaConfig
        
        # 회사별 ERPia 설정 조회
        config = CompanyErpiaConfig.query.filter_by(
            company_id=company_id,
            is_active=True
        ).first()
        
        if not config or not config.batch_enabled:
            return
        
        # 기존 스케줄 제거
        job_id = f'erpia_batch_{company_id}'
        if self.scheduler.get_job(job_id):
            self.scheduler.remove_job(job_id)
        
        # 새 스케줄 등록
        self.scheduler.add_job(
            func=self.run_company_batch,
            trigger=CronTrigger(
                hour=config.batch_hour,
                minute=config.batch_minute,
                timezone=config.batch_timezone
            ),
            args=[company_id],
            id=job_id,
            name=f'ERPia 배치 - {self.get_company_name(company_id)}',
            misfire_grace_time=300  # 5분 지연 허용
        )
        
        self.log_batch_schedule(company_id, config)
    
    def run_company_batch(self, company_id: int):
        """회사별 ERPia 배치 실행"""
        try:
            from app.services.erpia_batch_service import ErpiaBatchService
            
            # 회사별 배치 서비스 생성
            batch_service = ErpiaBatchService(company_id)
            
            # 어제 데이터 수집
            yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y%m%d')
            
            # 배치 실행 (사은품 자동 분류 포함)
            result = batch_service.collect_daily_sales_with_gift_classification(
                start_date=yesterday,
                end_date=yesterday
            )
            
            self.log_batch_success(company_id, result)
            
        except Exception as e:
            self.log_batch_error(company_id, str(e))
            self.send_error_notification(company_id, str(e))
    
    def update_company_schedule(self, company_id: int):
        """회사 스케줄 업데이트 (웹에서 설정 변경 시 호출)"""
        self.setup_company_batch(company_id)
    
    def get_batch_status(self, company_id: int) -> dict:
        """회사별 배치 상태 조회"""
        job_id = f'erpia_batch_{company_id}'
        job = self.scheduler.get_job(job_id)
        
        if job:
            return {
                'scheduled': True,
                'next_run': job.next_run_time.isoformat() if job.next_run_time else None,
                'job_name': job.name,
                'trigger': str(job.trigger)
            }
        else:
            return {
                'scheduled': False,
                'next_run': None
            }
```

### **3. 회사별 사은품 분류 엔진**
```python
class MultiTenantGiftClassifier:
    """멀티테넌트 사은품 분류 엔진"""
    
    def __init__(self, company_id: int):
        self.company_id = company_id
        self.config = self.load_company_gift_config()
    
    def load_company_gift_config(self):
        """회사별 사은품 설정 로드"""
        from app.models.company_erpia_config import CompanyErpiaConfig
        
        config = CompanyErpiaConfig.query.filter_by(
            company_id=self.company_id
        ).first()
        
        return {
            'auto_classify': config.auto_gift_classify if config else True,
            'keywords': json.loads(config.gift_keywords) if config and config.gift_keywords else [],
            'exclude_from_revenue': config.gift_exclude_from_revenue if config else True
        }
    
    def classify_products(self, products: List[Dict]) -> List[Dict]:
        """회사별 사은품 분류 규칙 적용"""
        
        classified_products = []
        
        for product in products:
            # 기본 분류 적용
            classification = self.apply_company_specific_rules(product)
            
            # 회사 ID 추가
            classification['company_id'] = self.company_id
            
            # 결과 병합
            product.update(classification)
            classified_products.append(product)
        
        return classified_products
    
    def apply_company_specific_rules(self, product: Dict) -> Dict:
        """회사별 사은품 분류 규칙"""
        
        gong_amt = int(product.get('gong_amt', 0))
        pan_amt = int(product.get('pan_amt', 0))
        product_name = product.get('product_name', '')
        
        # 1. 0원 상품 → 사은품 (모든 회사 공통)
        if gong_amt == 0 and pan_amt == 0:
            return {
                'product_type': 'GIFT',
                'is_revenue': not self.config['exclude_from_revenue'],
                'gift_type': 'ZERO_PRICE',
                'classification_reason': '공급가 0원 (자동분류)',
                'revenue_impact': 0
            }
        
        # 2. 회사별 키워드 기반 분류
        if self.config['auto_classify']:
            for keyword in self.config['keywords']:
                if keyword in product_name:
                    return {
                        'product_type': 'GIFT',
                        'is_revenue': not self.config['exclude_from_revenue'],
                        'gift_type': 'KEYWORD_BASED',
                        'classification_reason': f'키워드 매칭: {keyword}',
                        'revenue_impact': 0
                    }
        
        # 3. 일반 상품
        return {
            'product_type': 'PRODUCT',
            'is_revenue': True,
            'gift_type': None,
            'classification_reason': '일반 매출 상품',
            'revenue_impact': gong_amt
        }
```

### **4. 멀티테넌트 데이터 접근 레이어**
```python
class MultiTenantQueryBuilder:
    """멀티테넌트 쿼리 빌더"""
    
    @staticmethod
    def apply_company_filter(query, model, company_id=None):
        """회사 필터 자동 적용"""
        
        if company_id is None:
            company_id = g.current_company_id
        
        if company_id and hasattr(model, 'company_id'):
            query = query.filter(model.company_id == company_id)
        
        return query
    
    @staticmethod
    def get_accessible_companies(user_id: int) -> List[int]:
        """사용자가 접근 가능한 회사 목록"""
        from app.models.user_company import UserCompany
        
        companies = UserCompany.query.filter_by(
            user_id=user_id,
            is_active=True
        ).all()
        
        return [uc.company_id for uc in companies]
    
    @staticmethod
    def can_access_shared_data(source_company_id: int, target_company_id: int, 
                             data_type: str) -> bool:
        """공유 데이터 접근 권한 확인"""
        from app.models.shared_data_policy import SharedDataPolicy
        
        policy = SharedDataPolicy.query.filter_by(
            source_company_id=source_company_id,
            target_company_id=target_company_id,
            data_type=data_type,
            is_active=True
        ).first()
        
        return policy is not None

# 모델 믹스인
class CompanyMixin:
    """회사 정보 믹스인"""
    
    @declared_attr
    def company_id(cls):
        return Column(Integer, ForeignKey('companies.id'), nullable=False)
    
    @declared_attr  
    def company(cls):
        return relationship("Company")
    
    @classmethod
    def by_company(cls, company_id=None):
        """회사별 쿼리"""
        if company_id is None:
            company_id = g.current_company_id
        
        return cls.query.filter_by(company_id=company_id)
    
    @classmethod
    def accessible_by_user(cls, user_id: int):
        """사용자가 접근 가능한 데이터"""
        accessible_companies = MultiTenantQueryBuilder.get_accessible_companies(user_id)
        return cls.query.filter(cls.company_id.in_(accessible_companies))
```

## 🌐 프론트엔드 구현

### **1. 회사 전환 UI**
```html
<!-- 상단 네비게이션 바 -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <!-- 로고 및 회사명 -->
        <a class="navbar-brand d-flex align-items-center" href="#">
            <img src="{{ current_company.logo_url }}" alt="Logo" height="30" class="me-2">
            {{ current_company.company_name }} MIS
        </a>
        
        <!-- 회사 전환 드롭다운 -->
        <div class="navbar-nav ms-auto">
            <div class="nav-item dropdown">
                <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" 
                   id="companyDropdown" role="button" data-bs-toggle="dropdown">
                    <i class="bi bi-building me-1"></i>
                    <span class="me-1">{{ current_company.company_name }}</span>
                    {% if user_companies|length > 1 %}
                        <span class="badge bg-light text-dark ms-1">{{ user_companies|length }}</span>
                    {% endif %}
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    {% for uc in user_companies %}
                        <li>
                            <a class="dropdown-item d-flex align-items-center 
                               {% if uc.company_id == current_company.id %}active{% endif %}"
                               href="#" onclick="switchCompany({{ uc.company_id }})">
                                <i class="bi bi-building me-2"></i>
                                <div>
                                    <div>{{ uc.company.company_name }}</div>
                                    <small class="text-muted">{{ uc.role|title }}</small>
                                </div>
                                {% if uc.company_id == current_company.id %}
                                    <i class="bi bi-check2 ms-auto text-success"></i>
                                {% endif %}
                            </a>
                        </li>
                    {% endfor %}
                    
                    {% if current_user.is_super_admin %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="/admin/companies">
                                <i class="bi bi-gear me-2"></i>
                                회사 관리
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</nav>

<!-- 회사별 테마 적용 -->
<style>
:root {
    --company-primary-color: {{ current_company.theme_color }};
    --company-primary-rgb: {{ current_company.theme_color|hex_to_rgb }};
}

.btn-primary, .bg-primary {
    background-color: var(--company-primary-color) !important;
    border-color: var(--company-primary-color) !important;
}

.text-primary {
    color: var(--company-primary-color) !important;
}
</style>

<!-- 회사 전환 JavaScript -->
<script>
async function switchCompany(companyId) {
    try {
        const response = await fetch('/api/user/switch-company', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                company_id: companyId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 페이지 새로고침으로 회사 컨텍스트 업데이트
            window.location.reload();
        } else {
            showAlert('회사 전환에 실패했습니다: ' + result.message, 'error');
        }
    } catch (error) {
        showAlert('회사 전환 중 오류가 발생했습니다.', 'error');
    }
}

// 회사 변경 시 자동 저장된 필터 적용
document.addEventListener('DOMContentLoaded', function() {
    // 회사별 사용자 설정 로드
    loadCompanySpecificSettings();
    
    // 회사별 사은품 설정 상태 표시
    updateGiftSettingsDisplay();
});
</script>
```

### **2. 회사별 ERPia 설정 화면**
```html
<!-- 회사별 ERPia 설정 관리 -->
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-cloud-arrow-down"></i>
                        {{ current_company.company_name }} ERPia 연동 설정
                    </h5>
                </div>
                <div class="card-body">
                    <form id="erpiaConfigForm">
                        <!-- ERPia 계정 정보 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-primary">ERPia 계정 정보</h6>
                                <div class="mb-3">
                                    <label class="form-label">관리자 코드</label>
                                    <input type="text" class="form-control" name="admin_code" 
                                           value="{{ config.admin_code if config else '' }}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">비밀번호</label>
                                    <input type="password" class="form-control" name="password" 
                                           placeholder="{% if config %}기존 비밀번호 유지{% else %}비밀번호 입력{% endif %}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">API URL</label>
                                    <input type="url" class="form-control" name="api_url" 
                                           value="{{ config.api_url if config else 'http://www.erpia.net/xml/xml.asp' }}">
                                </div>
                            </div>
                            
                            <!-- 배치 스케줄 설정 -->
                            <div class="col-md-6">
                                <h6 class="text-primary">배치 스케줄 설정</h6>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="batch_enabled" 
                                               {% if config and config.batch_enabled %}checked{% endif %}>
                                        <label class="form-check-label">자동 배치 실행</label>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">실행 시간</label>
                                        <input type="time" class="form-control" name="batch_time" 
                                               value="{% if config %}{{ '%02d:%02d'|format(config.batch_hour, config.batch_minute) }}{% else %}02:00{% endif %}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">시간대</label>
                                        <select class="form-select" name="batch_timezone">
                                            <option value="Asia/Seoul" {% if config and config.batch_timezone == 'Asia/Seoul' %}selected{% endif %}>
                                                한국 시간 (KST)
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- API 호출 설정 -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label class="form-label">호출 간격 (초)</label>
                                <input type="number" class="form-control" name="api_call_interval" 
                                       value="{{ config.api_call_interval if config else 3 }}" min="1" max="60">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">페이지 크기</label>
                                <input type="number" class="form-control" name="page_size" 
                                       value="{{ config.page_size if config else 30 }}" min="1" max="30">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">재시도 횟수</label>
                                <input type="number" class="form-control" name="retry_count" 
                                       value="{{ config.retry_count if config else 3 }}" min="1" max="10">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">타임아웃 (초)</label>
                                <input type="number" class="form-control" name="timeout_seconds" 
                                       value="{{ config.timeout_seconds if config else 30 }}" min="10" max="300">
                            </div>
                        </div>
                        
                        <!-- 사은품 처리 설정 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">사은품 처리 설정</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" name="auto_gift_classify" 
                                                   {% if config and config.auto_gift_classify %}checked{% endif %}>
                                            <label class="form-check-label">0원 상품 자동 사은품 분류</label>
                                        </div>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" name="gift_exclude_from_revenue" 
                                                   {% if config and config.gift_exclude_from_revenue %}checked{% endif %}>
                                            <label class="form-check-label">사은품 매출 집계 제외</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">사은품 분류 키워드</label>
                                        <input type="text" class="form-control" name="gift_keywords" 
                                               value="{% if config and config.gift_keywords %}{{ config.gift_keywords|join(',') }}{% else %}사은품,증정품,무료,샘플,체험{% endif %}"
                                               placeholder="쉼표로 구분하여 입력">
                                        <div class="form-text">상품명에 포함된 경우 사은품으로 분류할 키워드들입니다.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 알림 설정 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-primary">알림 설정</h6>
                                <div class="mb-3">
                                    <label class="form-label">알림 이메일</label>
                                    <input type="email" class="form-control" name="notification_email" 
                                           value="{{ config.notification_email if config else '' }}"
                                           placeholder="배치 완료/오류 알림을 받을 이메일">
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="error_notification" 
                                           {% if config and config.error_notification %}checked{% endif %}>
                                    <label class="form-check-label">오류 발생 시 이메일 알림</label>
                                </div>
                            </div>
                            
                            <!-- 연동 상태 -->
                            <div class="col-md-6">
                                <h6 class="text-primary">연동 상태</h6>
                                {% if config %}
                                    <div class="mb-2">
                                        <span class="badge {% if config.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if config.is_active %}활성{% else %}비활성{% endif %}
                                        </span>
                                    </div>
                                    {% if config.last_sync_date %}
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                마지막 동기화: {{ config.last_sync_date.strftime('%Y-%m-%d %H:%M') }}
                                            </small>
                                        </div>
                                    {% endif %}
                                    {% if config.sync_error_count > 0 %}
                                        <div class="alert alert-warning alert-sm">
                                            <small>
                                                연속 오류 {{ config.sync_error_count }}회
                                                {% if config.last_error_message %}
                                                    <br>{{ config.last_error_message }}
                                                {% endif %}
                                            </small>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="alert alert-info">
                                        <small>ERPia 연동이 설정되지 않았습니다.</small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- 버튼 -->
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-info me-2" onclick="testErpiaConnection()">
                                <i class="bi bi-wifi"></i> 연결 테스트
                            </button>
                            <button type="button" class="btn btn-warning me-2" onclick="runManualBatch()">
                                <i class="bi bi-play-fill"></i> 수동 배치 실행
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> 설정 저장
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 배치 실행 이력 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="bi bi-clock-history"></i>
                        배치 실행 이력
                    </h5>
                </div>
                <div class="card-body">
                    <div id="batchHistoryTable">
                        <!-- 배치 이력 테이블이 로드됩니다 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ERPia 설정 폼 처리
document.getElementById('erpiaConfigForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const configData = {};
    
    // 폼 데이터 변환
    for (let [key, value] of formData.entries()) {
        if (this.querySelector(`[name="${key}"]`).type === 'checkbox') {
            configData[key] = this.querySelector(`[name="${key}"]`).checked;
        } else if (key === 'gift_keywords') {
            configData[key] = value.split(',').map(k => k.trim()).filter(k => k);
        } else if (key === 'batch_time') {
            const [hour, minute] = value.split(':');
            configData['batch_hour'] = parseInt(hour);
            configData['batch_minute'] = parseInt(minute);
        } else {
            configData[key] = value;
        }
    }
    
    try {
        const response = await fetch(`/api/companies/${currentCompanyId}/erpia-config`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(configData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('ERPia 설정이 저장되었습니다.', 'success');
            
            // 스케줄 업데이트
            if (configData.batch_enabled) {
                updateBatchSchedule();
            }
            
            // 페이지 새로고침
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('설정 저장에 실패했습니다: ' + result.message, 'error');
        }
    } catch (error) {
        showAlert('오류가 발생했습니다.', 'error');
    }
});

async function testErpiaConnection() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 테스트 중...';
    
    try {
        const response = await fetch(`/api/companies/${currentCompanyId}/erpia-test`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(`연결 성공! ${result.data_count}건의 데이터를 확인했습니다.`, 'success');
        } else {
            showAlert(`연결 실패: ${result.message}`, 'error');
        }
    } catch (error) {
        showAlert('연결 테스트 중 오류가 발생했습니다.', 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

async function runManualBatch() {
    const startDate = prompt('시작일을 입력하세요 (YYYYMMDD):', 
        new Date().toISOString().slice(0, 10).replace(/-/g, ''));
    
    if (!startDate) return;
    
    const endDate = prompt('종료일을 입력하세요 (YYYYMMDD):', startDate);
    if (!endDate) return;
    
    try {
        const response = await fetch(`/api/companies/${currentCompanyId}/erpia-manual-batch`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                start_date: startDate,
                end_date: endDate
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('배치가 성공적으로 실행되었습니다.', 'success');
            loadBatchHistory();
        } else {
            showAlert(`배치 실행 실패: ${result.message}`, 'error');
        }
    } catch (error) {
        showAlert('배치 실행 중 오류가 발생했습니다.', 'error');
    }
}
</script>
```

## 🔒 보안 및 권한 관리

### **1. 회사별 데이터 격리**
```python
# 자동 회사 필터링
@event.listens_for(Session, 'before_bulk_insert')
def auto_add_company_id(insert_context):
    """대량 삽입 시 자동으로 company_id 추가"""
    if hasattr(insert_context.mapper.class_, 'company_id'):
        if 'company_id' not in insert_context.values and g.current_company_id:
            insert_context.values['company_id'] = g.current_company_id

@event.listens_for(Query, 'before_cursor_execute')
def auto_filter_by_company(conn, cursor, statement, parameters, context, executemany):
    """쿼리 실행 시 자동으로 회사 필터 적용"""
    # 이 기능은 신중하게 구현해야 함 (성능 영향)
    pass
```

### **2. 접근 로그 관리**
```sql
-- 멀티테넌트 접근 로그
CREATE TABLE user_access_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    company_id INTEGER REFERENCES companies(id),
    
    -- 접근 정보
    action_type VARCHAR(50) NOT NULL,            -- 'LOGIN', 'SWITCH_COMPANY', 'ACCESS_DATA'
    resource_type VARCHAR(50),                   -- 'SALES', 'CUSTOMER', 'PRODUCT'
    resource_id VARCHAR(100),                    -- 접근한 데이터 ID
    
    -- 요청 정보
    ip_address INET,
    user_agent TEXT,
    request_url TEXT,
    request_method VARCHAR(10),
    
    -- 결과 정보
    success BOOLEAN DEFAULT TRUE,
    error_message TEXT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_access_logs_user_company ON user_access_logs(user_id, company_id);
CREATE INDEX idx_access_logs_action ON user_access_logs(action_type);
CREATE INDEX idx_access_logs_created ON user_access_logs(created_at);
```

## 📊 구현 로드맵

### **Phase 1: 멀티테넌트 기반 구축** (1주)
1. **데이터베이스 스키마 확장**
   - 회사 관리 테이블 생성
   - 기존 테이블에 `company_id` 추가
   - 사용자-회사 관계 테이블 구성

2. **멀티테넌트 미들웨어**
   - 회사 컨텍스트 관리
   - 자동 데이터 필터링
   - 권한 검사 시스템

### **Phase 2: 회사별 ERPia 관리** (1주)
1. **회사별 ERPia 설정**
   - 웹 기반 설정 관리
   - 암호화된 인증 정보 저장
   - 배치 스케줄 개별 관리

2. **멀티테넌트 배치 시스템**
   - 회사별 독립 스케줄 실행
   - 사은품 자동 분류 통합
   - 배치 상태 모니터링

### **Phase 3: 사용자 인터페이스** (3일)
1. **회사 전환 UI**
   - 회사 선택 드롭다운
   - 겸직자 권한 표시
   - 회사별 테마 적용

2. **권한 관리 화면**
   - 사용자-회사 관계 관리
   - 역할 및 권한 설정
   - 접근 로그 모니터링

### **Phase 4: 데이터 공유 시스템** (2일)
1. **공유 정책 관리**
   - 회사 간 데이터 공유 설정
   - 승인 워크플로우
   - 공유 이력 추적

2. **공유 데이터 접근**
   - 조건부 데이터 공유
   - 읽기 전용/읽기-쓰기 권한
   - 실시간 동기화

## 🎯 예상 효과

### **확장성**
- ✅ **무제한 회사 추가**: 새로운 회사 쉽게 추가 가능
- ✅ **독립적 운영**: 회사별 설정/데이터 완전 분리
- ✅ **공유 효율성**: 필요한 데이터만 선택적 공유

### **운영성**
- ✅ **웹 기반 관리**: 코드 수정 없이 설정 변경
- ✅ **개별 배치**: 회사별 ERPia 배치 독립 실행
- ✅ **사은품 정책**: 회사별 사은품 분류 규칙 적용

### **보안성**
- ✅ **데이터 격리**: 회사 간 데이터 완전 분리
- ✅ **접근 제어**: 세분화된 권한 관리
- ✅ **감사 추적**: 모든 접근 로그 기록

---

📅 **설계일**: 2025-08-05  
📝 **버전**: v2.0 (웹 설정 + 사은품 분류 통합)  
🎯 **목표**: 에이원 + 에이원 월드 통합 운영, 웹 기반 관리, 회사별 사은품 정책 